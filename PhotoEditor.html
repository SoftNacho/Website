<!DOCTYPE HTML>

<html>
	<head>
		<title>Lisa Gentil - Photo Editor</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<!--[if lte IE 8]><script src="assets/js/ie/html5shiv.js"></script><![endif]-->
		<link rel="stylesheet" href="assets/css/main.css" />
		<!--[if lte IE 8]><link rel="stylesheet" href="assets/css/ie8.css" /><![endif]-->
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
	</head>
	<body class="landing">

		<!-- Header -->
			<header id="header" class="alt ">
				<!--
                <h1><a href="index.html">Drift <span>by Pixelarity</span></a></h1>
                -->
				<nav id="nav">
					<ul>
						<li><a href="index.html">Home</a></li>
						<li><a href="index.html#one" class="icon fa-angle-down">About Me</a></li>
                        <li>
                            <a href="index.html#two" class="icon fa-angle-down">Projects</a>
							<ul>
                                <li><a href="OS.html">Operating System NachOS</a></li>
                                <li><a 
                                href="LC3b.html">LC-3b Processor
                                </a></li>
                                <li><a href="2048.html">2048</a></li>
                                <li><a href="TicTacToe.html">Tic Tac Toe</a></li>
                                <li><a href="Adventure.html">Adventure</a></li>
                                <li><a href="Sudoku.html">Sudoku</a></li>
                                <li><a href="PhotoEditor.html">Photo Editor</a></li>
                                <li><a href="FlappyBird.html">Flappy Bird</a></li>
                                <li><a href="Calculator.html">Calculator</a></li>
                            </ul>
                            <li><a href="Resume.html">Résumé</a></li>
					</ul>
				</nav>
			</header>

		<!-- Banner -->
			<section id="bannerPhoto">
				<div class="inner">
					<h2>Photo Editor</h2>
                    <ul class="actions">
						<li><a href="index.html" class="button big scrolly">BACK TO MAIN MENU</a></li>
					</ul>
				</div>
			</section>
        
        <!--Intro-->
        <section>
            <h5>This program was written in C. When the user inputs a .png file, they have the choice to blur the input picture, change it to gray scale, flip vertically or change it to a preset color threshold.</h5>
        </section>
        
        
        
        <!--Buttons-->
        <div align="center">
            
            <a href="#main.c" class="buttonInPage"> main.c </a>
            <a href="#lodepng.c"class="buttonInPage"> lodepng.c </a>
            <a href="#lodepng.h"class="buttonInPage"> lodepng.h </a>
            <a href="#imageData.c"class="buttonInPage"> imageData.c </a>
            <a href="#imageData.h"class="buttonInPage"> imageData.h </a>
            <a href="#functions.c"class="buttonInPage"> functions.c </a>
            <a href="#functions.h"class="buttonInPage"> functions.h </a>
            <a href="#LodePNG Documentation"class="buttonInPage"> LodePNG Documentation </a>
            <a href="#Makefile"class="buttonInPage"> Makefile </a>
        
        </div>
        <!--File-->
                            
                            <!--Main.c-->
                            <section>
                                <hnew id="main.c">main.c</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &quot;imageData.h&quot;</span>
<span style="color: #557799">#include &quot;functions.h&quot;</span>

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> gmonomult[<span style="color: #6666ff; font-weight: bold">3</span>]<span style="color: #333333">=</span>{<span style="color: #6600EE; font-weight: bold">.299</span>,<span style="color: #6600EE; font-weight: bold">.587</span>,<span style="color: #6600EE; font-weight: bold">.114</span>};

<span style="color: #6666ff; font-weight: bold">int</span> <span style="color: #55eedd; font-weight: bold">main</span>(<span style="color: #6666ff; font-weight: bold">int</span> argc,<span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>argv[])
{
  <span style="color: #666666; font-style: italic">//Handles user input, to get file names and command</span>
  <span style="color: #228899; font-weight: bold">if</span>(argc<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">||</span> argc<span style="color: #333333">&gt;</span><span style="color: #6666ff; font-weight: bold">6</span>)
  {
    printf(<span style="background-color: #e0e0ff">&quot;Incorrect number of arguments</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>);
    printf(<span style="background-color: #e0e0ff">&quot;Number of arguments: %d</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,argc);
    exit(<span style="color: #6666ff; font-weight: bold">1</span>);
  }

  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>input_filename<span style="color: #333333">=</span>argv[<span style="color: #6666ff; font-weight: bold">1</span>];
  printf(<span style="background-color: #e0e0ff">&quot;Inputfile: %s</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,input_filename);
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>output_filename<span style="color: #333333">=</span>argv[<span style="color: #6666ff; font-weight: bold">2</span>];
  printf(<span style="background-color: #e0e0ff">&quot;Outputfile: %s</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,output_filename);
  <span style="color: #6666ff; font-weight: bold">char</span> garbage[<span style="color: #6666ff; font-weight: bold">2</span>];
  <span style="color: #6666ff; font-weight: bold">int</span> command;
  <span style="color: #6666ff; font-weight: bold">int</span> radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">3</span>;

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">!=</span>sscanf(argv[<span style="color: #6666ff; font-weight: bold">3</span>],<span style="background-color: #e0e0ff">&quot;%d%1s&quot;</span>,<span style="color: #333333">&amp;</span>command,garbage) <span style="color: #333333">||</span> command<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> command<span style="color: #333333">&gt;</span><span style="color: #6666ff; font-weight: bold">10</span>)
  {
    printf(<span style="background-color: #e0e0ff">&quot;Incorrect command</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>);
    exit(<span style="color: #6666ff; font-weight: bold">1</span>);
  }

  <span style="color: #228899; font-weight: bold">if</span>(((command<span style="color: #333333">==</span><span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #333333">&amp;&amp;</span> argc<span style="color: #333333">==</span><span style="color: #6666ff; font-weight: bold">5</span> <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">!=</span>sscanf(argv[<span style="color: #6666ff; font-weight: bold">4</span>],<span style="background-color: #e0e0ff">&quot;%d%1s&quot;</span>,<span style="color: #333333">&amp;</span>radius,garbage)) <span style="color: #333333">||</span> radius<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">1</span>)
  {
    printf(<span style="background-color: #e0e0ff">&quot;Incorrect radius value</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>);
    exit(<span style="color: #6666ff; font-weight: bold">1</span>);
  }
  
  <span style="color: #666666; font-style: italic">//Create filters and images</span>
  Filter <span style="color: #333333">*</span>filters<span style="color: #333333">=</span>initialize_filters(radius);
  Image <span style="color: #333333">*</span>input_image<span style="color: #333333">=</span>decode(input_filename);
  printf(<span style="background-color: #e0e0ff">&quot;Width: %d, height: %d</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,input_image<span style="color: #333333">-&gt;</span>width,input_image<span style="color: #333333">-&gt;</span>height);
  Image <span style="color: #333333">*</span>output_image<span style="color: #333333">=</span>generate_output(input_image);

  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>red_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>blue_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>green_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>alpha_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red<span style="color: #333333">=</span>output_image<span style="color: #333333">-&gt;</span>red_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue<span style="color: #333333">=</span>output_image<span style="color: #333333">-&gt;</span>blue_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green<span style="color: #333333">=</span>output_image<span style="color: #333333">-&gt;</span>green_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha<span style="color: #333333">=</span>output_image<span style="color: #333333">-&gt;</span>alpha_channel;
  <span style="color: #6666ff; font-weight: bold">int</span> height<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>height;
  <span style="color: #6666ff; font-weight: bold">int</span> width<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>width;


  <span style="color: #666666; font-style: italic">//Run chosen command to call functions from functions.c</span>
  <span style="color: #228899; font-weight: bold">switch</span>(command)
  {
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">0</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">0</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">0</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">1</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">1</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">1</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">2</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">2</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">2</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">3</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">3</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">3</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">4</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">4</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">4</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">5</span>):
    {
      convolve_image(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,filters[<span style="color: #6666ff; font-weight: bold">5</span>].filter,filters[<span style="color: #6666ff; font-weight: bold">5</span>].radius,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">6</span>):
    {
      convert_to_gray(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                    out_alpha,gmonomult,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
     }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">7</span>):
    {
      flip_vertical(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                  out_alpha,width,height);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">case</span>(<span style="color: #6666ff; font-weight: bold">8</span>):
    {
      color_threshold(in_red,in_green,in_blue,in_alpha,out_red,out_green,out_blue,
                  out_alpha,width,height,<span style="color: #6666ff; font-weight: bold">10</span>,<span style="color: #6666ff; font-weight: bold">150</span>,<span style="color: #6666ff; font-weight: bold">10</span>);
      encode(output_filename,output_image);
      <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #997700; font-weight: bold">default:</span>
      exit(<span style="color: #6666ff; font-weight: bold">1</span>);
  }

 
  free((<span style="color: #6666ff; font-weight: bold">double</span><span style="color: #333333">*</span>)filters[<span style="color: #6666ff; font-weight: bold">0</span>].filter);
  free(filters);
  free_image(input_image);
  free_image(output_image);
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}
</pre></div>
<p></p>
                            </section>
                            
                            
        
        
        
        
        
                            <!--lodepng.c-->
                            <section>
                                <hnew id="lodepng.c">lodepng.c</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">LodePNG version 20140823</span>

<span style="color: #666666; font-style: italic">Copyright (c) 2005-2014 Lode Vandevenne</span>

<span style="color: #666666; font-style: italic">This software is provided &#39;as-is&#39;, without any express or implied</span>
<span style="color: #666666; font-style: italic">warranty. In no event will the authors be held liable for any damages</span>
<span style="color: #666666; font-style: italic">arising from the use of this software.</span>

<span style="color: #666666; font-style: italic">Permission is granted to anyone to use this software for any purpose,</span>
<span style="color: #666666; font-style: italic">including commercial applications, and to alter it and redistribute it</span>
<span style="color: #666666; font-style: italic">freely, subject to the following restrictions:</span>

<span style="color: #666666; font-style: italic">    1. The origin of this software must not be misrepresented; you must not</span>
<span style="color: #666666; font-style: italic">    claim that you wrote the original software. If you use this software</span>
<span style="color: #666666; font-style: italic">    in a product, an acknowledgment in the product documentation would be</span>
<span style="color: #666666; font-style: italic">    appreciated but is not required.</span>

<span style="color: #666666; font-style: italic">    2. Altered source versions must be plainly marked as such, and must not be</span>
<span style="color: #666666; font-style: italic">    misrepresented as being the original software.</span>

<span style="color: #666666; font-style: italic">    3. This notice may not be removed or altered from any source</span>
<span style="color: #666666; font-style: italic">    distribution.</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">The manual and changelog are in the header file &quot;lodepng.h&quot;</span>
<span style="color: #666666; font-style: italic">Rename this file to lodepng.cpp to use it for C++, or to lodepng.c to use it for C.</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #557799">#include &quot;lodepng.h&quot;</span>

<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#include &lt;stdlib.h&gt;</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_CPP</span>
<span style="color: #557799">#include &lt;fstream&gt;</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_CPP*/</span><span style="color: #557799"></span>

<span style="color: #557799">#define VERSION_STRING &quot;20140823&quot;</span>

<span style="color: #557799">#if defined(_MSC_VER) &amp;&amp; (_MSC_VER &gt;= 1310) </span><span style="color: #666666; font-style: italic">/*Visual Studio: A few warning types are not desired here.*/</span><span style="color: #557799"></span>
<span style="color: #557799">#pragma warning( disable : 4244 ) </span><span style="color: #666666; font-style: italic">/*implicit conversions: not warned by gcc -Wall -Wextra and requires too much casts*/</span><span style="color: #557799"></span>
<span style="color: #557799">#pragma warning( disable : 4996 ) </span><span style="color: #666666; font-style: italic">/*VS does not like fopen, but fopen_s is not standard C so unusable here*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*_MSC_VER */</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">This source file is built up in the following large parts. The code sections</span>
<span style="color: #666666; font-style: italic">with the &quot;LODEPNG_COMPILE_&quot; #defines divide this up further in an intermixed way.</span>
<span style="color: #666666; font-style: italic">-Tools for C and common code for PNG and Zlib</span>
<span style="color: #666666; font-style: italic">-C Code for Zlib (huffman, deflate, ...)</span>
<span style="color: #666666; font-style: italic">-C Code for PNG (file format chunks, adam7, PNG filters, color conversions, ...)</span>
<span style="color: #666666; font-style: italic">-The C++ wrapper around all of the above</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #666666; font-style: italic">/*The malloc, realloc and free functions defined here with &quot;lodepng_&quot; in front</span>
<span style="color: #666666; font-style: italic">of the name, so that you can easily change them to others related to your</span>
<span style="color: #666666; font-style: italic">platform if needed. Everything else in the code calls these. Pass</span>
<span style="color: #666666; font-style: italic">-DLODEPNG_NO_COMPILE_ALLOCATORS to the compiler, or comment out</span>
<span style="color: #666666; font-style: italic">#define LODEPNG_COMPILE_ALLOCATORS in the header, to disable the ones here and</span>
<span style="color: #666666; font-style: italic">define them in your own project&#39;s source files without needing to change</span>
<span style="color: #666666; font-style: italic">lodepng source code. Don&#39;t forget to remove &quot;static&quot; if you copypaste them</span>
<span style="color: #666666; font-style: italic">from here.*/</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ALLOCATORS</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_malloc</span>(<span style="color: #6666ff; font-weight: bold">size_t</span> size)
{
  <span style="color: #228899; font-weight: bold">return</span> malloc(size);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_realloc</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> ptr, <span style="color: #6666ff; font-weight: bold">size_t</span> new_size)
{
  <span style="color: #228899; font-weight: bold">return</span> realloc(ptr, new_size);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_free</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> ptr)
{
  free(ptr);
}
<span style="color: #557799">#else </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ALLOCATORS*/</span><span style="color: #557799"></span>
<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_malloc</span>(<span style="color: #6666ff; font-weight: bold">size_t</span> size);
<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_realloc</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> ptr, <span style="color: #6666ff; font-weight: bold">size_t</span> new_size);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_free</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> ptr);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ALLOCATORS*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* // Tools for C, and common code for PNG and Zlib.                       // */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Often in case of an error a value is assigned to a variable and then it breaks</span>
<span style="color: #666666; font-style: italic">out of a loop (to go to the cleanup phase of a function). This macro does that.</span>
<span style="color: #666666; font-style: italic">It makes the error handling code shorter and more readable.</span>

<span style="color: #666666; font-style: italic">Example: if(!uivector_resizev(&amp;frequencies_ll, 286, 0)) ERROR_BREAK(83);</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #557799">#define CERROR_BREAK(errorvar, code)\</span>
<span style="color: #557799">{\</span>
<span style="color: #557799">  errorvar = code;\</span>
<span style="color: #557799">  break;\</span>
<span style="color: #557799">}</span>

<span style="color: #666666; font-style: italic">/*version of CERROR_BREAK that assumes the common case where the error variable is named &quot;error&quot;*/</span>
<span style="color: #557799">#define ERROR_BREAK(code) CERROR_BREAK(error, code)</span>

<span style="color: #666666; font-style: italic">/*Set error var to the error code, and return it.*/</span>
<span style="color: #557799">#define CERROR_RETURN_ERROR(errorvar, code)\</span>
<span style="color: #557799">{\</span>
<span style="color: #557799">  errorvar = code;\</span>
<span style="color: #557799">  return code;\</span>
<span style="color: #557799">}</span>

<span style="color: #666666; font-style: italic">/*Try the code, if it returns error, also return the error.*/</span>
<span style="color: #557799">#define CERROR_TRY_RETURN(call)\</span>
<span style="color: #557799">{\</span>
<span style="color: #557799">  unsigned error = call;\</span>
<span style="color: #557799">  if(error) return error;\</span>
<span style="color: #557799">}</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">About uivector, ucvector and string:</span>
<span style="color: #666666; font-style: italic">-All of them wrap dynamic arrays or text strings in a similar way.</span>
<span style="color: #666666; font-style: italic">-LodePNG was originally written in C++. The vectors replace the std::vectors that were used in the C++ version.</span>
<span style="color: #666666; font-style: italic">-The string tools are made to avoid problems with compilers that declare things like strncat as deprecated.</span>
<span style="color: #666666; font-style: italic">-They&#39;re not used in the interface, only internally in this file as static functions.</span>
<span style="color: #666666; font-style: italic">-As with many other structs in this file, the init and cleanup functions serve as ctor and dtor.</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #666666; font-style: italic">/*dynamic vector of unsigned ints*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> uivector
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> data;
  <span style="color: #6666ff; font-weight: bold">size_t</span> size; <span style="color: #666666; font-style: italic">/*size in number of unsigned longs*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> allocsize; <span style="color: #666666; font-style: italic">/*allocated size in bytes*/</span>
} uivector;

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">uivector_cleanup</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> p)
{
  ((uivector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> ((uivector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  lodepng_free(((uivector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>data);
  ((uivector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
}

<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">uivector_reserve</span>(uivector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> allocsize)
{
  <span style="color: #228899; font-weight: bold">if</span>(allocsize <span style="color: #333333">&gt;</span> p<span style="color: #333333">-&gt;</span>allocsize)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> newsize <span style="color: #333333">=</span> (allocsize <span style="color: #333333">&gt;</span> p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #333333">?</span> allocsize <span style="color: #333333">:</span> (allocsize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>);
    <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> lodepng_realloc(p<span style="color: #333333">-&gt;</span>data, newsize);
    <span style="color: #228899; font-weight: bold">if</span>(data)
    {
      p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> newsize;
      p<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)data;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*error: not enough memory*/</span>
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">uivector_resize</span>(uivector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> size)
{
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_reserve(p, size <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>))) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> size;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*success*/</span>
}

<span style="color: #666666; font-style: italic">/*resize and give all new elements the value*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">uivector_resizev</span>(uivector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> size, <span style="color: #6666ff; font-weight: bold">unsigned</span> value)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> oldsize <span style="color: #333333">=</span> p<span style="color: #333333">-&gt;</span>size, i;
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(p, size)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> oldsize; i <span style="color: #333333">&lt;</span> size; i<span style="color: #333333">++</span>) p<span style="color: #333333">-&gt;</span>data[i] <span style="color: #333333">=</span> value;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">uivector_init</span>(uivector<span style="color: #333333">*</span> p)
{
  p<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">uivector_push_back</span>(uivector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">unsigned</span> c)
{
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(p, p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  p<span style="color: #333333">-&gt;</span>data[p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> c;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #666666; font-style: italic">/*copy q to p, returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">uivector_copy</span>(uivector<span style="color: #333333">*</span> p, <span style="color: #228899; font-weight: bold">const</span> uivector<span style="color: #333333">*</span> q)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(p, q<span style="color: #333333">-&gt;</span>size)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> q<span style="color: #333333">-&gt;</span>size; i<span style="color: #333333">++</span>) p<span style="color: #333333">-&gt;</span>data[i] <span style="color: #333333">=</span> q<span style="color: #333333">-&gt;</span>data[i];
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ZLIB*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* /////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*dynamic vector of unsigned chars*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> ucvector
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data;
  <span style="color: #6666ff; font-weight: bold">size_t</span> size; <span style="color: #666666; font-style: italic">/*used size*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> allocsize; <span style="color: #666666; font-style: italic">/*allocated size*/</span>
} ucvector;

<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">ucvector_reserve</span>(ucvector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> allocsize)
{
  <span style="color: #228899; font-weight: bold">if</span>(allocsize <span style="color: #333333">&gt;</span> p<span style="color: #333333">-&gt;</span>allocsize)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> newsize <span style="color: #333333">=</span> (allocsize <span style="color: #333333">&gt;</span> p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #333333">?</span> allocsize <span style="color: #333333">:</span> (allocsize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>);
    <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> lodepng_realloc(p<span style="color: #333333">-&gt;</span>data, newsize);
    <span style="color: #228899; font-weight: bold">if</span>(data)
    {
      p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> newsize;
      p<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)data;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*error: not enough memory*/</span>
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">ucvector_resize</span>(ucvector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> size)
{
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_reserve(p, size <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>))) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> size;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*success*/</span>
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">ucvector_cleanup</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> p)
{
  ((ucvector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> ((ucvector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  lodepng_free(((ucvector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>data);
  ((ucvector<span style="color: #333333">*</span>)p)<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">ucvector_init</span>(ucvector<span style="color: #333333">*</span> p)
{
  p<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*resize and give all new elements the value*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">ucvector_resizev</span>(ucvector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">size_t</span> size, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> value)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> oldsize <span style="color: #333333">=</span> p<span style="color: #333333">-&gt;</span>size, i;
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(p, size)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> oldsize; i <span style="color: #333333">&lt;</span> size; i<span style="color: #333333">++</span>) p<span style="color: #333333">-&gt;</span>data[i] <span style="color: #333333">=</span> value;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #666666; font-style: italic">/*you can both convert from vector to buffer&amp;size and vica versa. If you use</span>
<span style="color: #666666; font-style: italic">init_buffer to take over a buffer and size, it is not needed to use cleanup*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">ucvector_init_buffer</span>(ucvector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">size_t</span> size)
{
  p<span style="color: #333333">-&gt;</span>data <span style="color: #333333">=</span> buffer;
  p<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">=</span> size;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ZLIB*/</span><span style="color: #557799"></span>

<span style="color: #557799">#if (defined(LODEPNG_COMPILE_PNG) &amp;&amp; defined(LODEPNG_COMPILE_ANCILLARY_CHUNKS)) || defined(LODEPNG_COMPILE_ENCODER)</span>
<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">ucvector_push_back</span>(ucvector<span style="color: #333333">*</span> p, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> c)
{
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(p, p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  p<span style="color: #333333">-&gt;</span>data[p<span style="color: #333333">-&gt;</span>size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> c;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*defined(LODEPNG_COMPILE_PNG) || defined(LODEPNG_COMPILE_ENCODER)*/</span><span style="color: #557799"></span>


<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #666666; font-style: italic">/*returns 1 if success, 0 if failure ==&gt; nothing done*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">string_resize</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span> size)
{
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_realloc(<span style="color: #333333">*</span>out, size <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
  <span style="color: #228899; font-weight: bold">if</span>(data)
  {
    data[size] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*null termination char*/</span>
    <span style="color: #333333">*</span>out <span style="color: #333333">=</span> data;
  }
  <span style="color: #228899; font-weight: bold">return</span> data <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/*init a {char*, size_t} pair for use as string*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">string_init</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out)
{
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  string_resize(out, <span style="color: #6666ff; font-weight: bold">0</span>);
}

<span style="color: #666666; font-style: italic">/*free the above pair again*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">string_cleanup</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out)
{
  lodepng_free(<span style="color: #333333">*</span>out);
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">string_set</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> insize <span style="color: #333333">=</span> strlen(in), i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(string_resize(out, insize))
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> insize; i<span style="color: #333333">++</span>)
    {
      (<span style="color: #333333">*</span>out)[i] <span style="color: #333333">=</span> in[i];
    }
  }
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_read32bitInt</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer)
{
  <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)((buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">24</span>) <span style="color: #333333">|</span> (buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">16</span>) <span style="color: #333333">|</span> (buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">|</span> buffer[<span style="color: #6666ff; font-weight: bold">3</span>]);
}

<span style="color: #557799">#if defined(LODEPNG_COMPILE_PNG) || defined(LODEPNG_COMPILE_ENCODER)</span>
<span style="color: #666666; font-style: italic">/*buffer must have at least 4 allocated bytes available*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_set32bitInt</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">unsigned</span> value)
{
  buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">24</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xff</span>);
  buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">16</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xff</span>);
  buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value <span style="color: #333333">&gt;&gt;</span>  <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xff</span>);
  buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value      ) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xff</span>);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*defined(LODEPNG_COMPILE_PNG) || defined(LODEPNG_COMPILE_ENCODER)*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_add32bitInt</span>(ucvector<span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">unsigned</span> value)
{
  ucvector_resize(buffer, buffer<span style="color: #333333">-&gt;</span>size <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>); <span style="color: #666666; font-style: italic">/*todo: give error if resize failed*/</span>
  lodepng_set32bitInt(<span style="color: #333333">&amp;</span>buffer<span style="color: #333333">-&gt;</span>data[buffer<span style="color: #333333">-&gt;</span>size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">4</span>], value);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / File IO                                                                / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_load_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename)
{
  <span style="color: #6666ff; font-weight: bold">FILE</span><span style="color: #333333">*</span> file;
  <span style="color: #6666ff; font-weight: bold">long</span> size;

  <span style="color: #666666; font-style: italic">/*provide some proper output values if error will happen*/</span>
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  file <span style="color: #333333">=</span> fopen(filename, <span style="background-color: #e0e0ff">&quot;rb&quot;</span>);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>file) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">78</span>;

  <span style="color: #666666; font-style: italic">/*get filesize:*/</span>
  fseek(file , <span style="color: #6666ff; font-weight: bold">0</span> , SEEK_END);
  size <span style="color: #333333">=</span> ftell(file);
  rewind(file);

  <span style="color: #666666; font-style: italic">/*read contents of the file into the vector*/</span>
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc((<span style="color: #6666ff; font-weight: bold">size_t</span>)size);
  <span style="color: #228899; font-weight: bold">if</span>(size <span style="color: #333333">&amp;&amp;</span> (<span style="color: #333333">*</span>out)) (<span style="color: #333333">*</span>outsize) <span style="color: #333333">=</span> fread(<span style="color: #333333">*</span>out, <span style="color: #6666ff; font-weight: bold">1</span>, (<span style="color: #6666ff; font-weight: bold">size_t</span>)size, file);

  fclose(file);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(<span style="color: #333333">*</span>out) <span style="color: #333333">&amp;&amp;</span> size) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*the above malloc failed*/</span>
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/*write given buffer to the file, overwriting the file, it doesn&#39;t append to it.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_save_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename)
{
  <span style="color: #6666ff; font-weight: bold">FILE</span><span style="color: #333333">*</span> file;
  file <span style="color: #333333">=</span> fopen(filename, <span style="background-color: #e0e0ff">&quot;wb&quot;</span> );
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>file) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">79</span>;
  fwrite((<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)buffer , <span style="color: #6666ff; font-weight: bold">1</span> , buffersize, file);
  fclose(file);
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* // End of common code and tools. Begin of Zlib related code.            // */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*TODO: this ignores potential out of memory errors*/</span>
<span style="color: #557799">#define addBitToStream(</span><span style="color: #666666; font-style: italic">/*size_t**/</span><span style="color: #557799"> bitpointer, </span><span style="color: #666666; font-style: italic">/*ucvector**/</span><span style="color: #557799"> bitstream, </span><span style="color: #666666; font-style: italic">/*unsigned char*/</span><span style="color: #557799"> bit)\</span>
<span style="color: #557799">{\</span>
<span style="color: #557799">  </span><span style="color: #666666; font-style: italic">/*add a new byte at the end*/</span><span style="color: #557799">\</span>
<span style="color: #557799">  if(((*bitpointer) &amp; 7) == 0) ucvector_push_back(bitstream, (unsigned char)0);\</span>
<span style="color: #557799">  </span><span style="color: #666666; font-style: italic">/*earlier bit of huffman code is in a lesser significant bit of an earlier byte*/</span><span style="color: #557799">\</span>
<span style="color: #557799">  (bitstream-&gt;data[bitstream-&gt;size - 1]) |= (bit &lt;&lt; ((*bitpointer) &amp; 0x7));\</span>
<span style="color: #557799">  (*bitpointer)++;\</span>
<span style="color: #557799">}</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addBitsToStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, ucvector<span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">unsigned</span> value, <span style="color: #6666ff; font-weight: bold">size_t</span> nbits)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> nbits; i<span style="color: #333333">++</span>) addBitToStream(bitpointer, bitstream, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value <span style="color: #333333">&gt;&gt;</span> i) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>));
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addBitsToStreamReversed</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, ucvector<span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">unsigned</span> value, <span style="color: #6666ff; font-weight: bold">size_t</span> nbits)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> nbits; i<span style="color: #333333">++</span>) addBitToStream(bitpointer, bitstream, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((value <span style="color: #333333">&gt;&gt;</span> (nbits <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">-</span> i)) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>));
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #557799">#define READBIT(bitpointer, bitstream) ((bitstream[bitpointer &gt;&gt; 3] &gt;&gt; (bitpointer &amp; 0x7)) &amp; (unsigned char)1)</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">readBitFromStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> result <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(READBIT(<span style="color: #333333">*</span>bitpointer, bitstream));
  (<span style="color: #333333">*</span>bitpointer)<span style="color: #333333">++</span>;
  <span style="color: #228899; font-weight: bold">return</span> result;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readBitsFromStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">size_t</span> nbits)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> result <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> nbits; i<span style="color: #333333">++</span>)
  {
    result <span style="color: #333333">+=</span> ((<span style="color: #6666ff; font-weight: bold">unsigned</span>)READBIT(<span style="color: #333333">*</span>bitpointer, bitstream)) <span style="color: #333333">&lt;&lt;</span> i;
    (<span style="color: #333333">*</span>bitpointer)<span style="color: #333333">++</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> result;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Deflate - Huffman                                                      / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#define FIRST_LENGTH_CODE_INDEX 257</span>
<span style="color: #557799">#define LAST_LENGTH_CODE_INDEX 285</span>
<span style="color: #666666; font-style: italic">/*256 literals, the end code, some length codes, and 2 unused codes*/</span>
<span style="color: #557799">#define NUM_DEFLATE_CODE_SYMBOLS 288</span>
<span style="color: #666666; font-style: italic">/*the distance codes have their own symbols, 30 used, 2 unused*/</span>
<span style="color: #557799">#define NUM_DISTANCE_SYMBOLS 32</span>
<span style="color: #666666; font-style: italic">/*the code length codes. 0-15: code lengths, 16: copy previous 3-6 times, 17: 3-10 zeros, 18: 11-138 zeros*/</span>
<span style="color: #557799">#define NUM_CODE_LENGTH_CODES 19</span>

<span style="color: #666666; font-style: italic">/*the base lengths represented by codes 257-285*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> LENGTHBASE[<span style="color: #6666ff; font-weight: bold">29</span>]
  <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">3</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">5</span>, <span style="color: #6666ff; font-weight: bold">6</span>, <span style="color: #6666ff; font-weight: bold">7</span>, <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">9</span>, <span style="color: #6666ff; font-weight: bold">10</span>, <span style="color: #6666ff; font-weight: bold">11</span>, <span style="color: #6666ff; font-weight: bold">13</span>, <span style="color: #6666ff; font-weight: bold">15</span>, <span style="color: #6666ff; font-weight: bold">17</span>, <span style="color: #6666ff; font-weight: bold">19</span>, <span style="color: #6666ff; font-weight: bold">23</span>, <span style="color: #6666ff; font-weight: bold">27</span>, <span style="color: #6666ff; font-weight: bold">31</span>, <span style="color: #6666ff; font-weight: bold">35</span>, <span style="color: #6666ff; font-weight: bold">43</span>, <span style="color: #6666ff; font-weight: bold">51</span>, <span style="color: #6666ff; font-weight: bold">59</span>,
     <span style="color: #6666ff; font-weight: bold">67</span>, <span style="color: #6666ff; font-weight: bold">83</span>, <span style="color: #6666ff; font-weight: bold">99</span>, <span style="color: #6666ff; font-weight: bold">115</span>, <span style="color: #6666ff; font-weight: bold">131</span>, <span style="color: #6666ff; font-weight: bold">163</span>, <span style="color: #6666ff; font-weight: bold">195</span>, <span style="color: #6666ff; font-weight: bold">227</span>, <span style="color: #6666ff; font-weight: bold">258</span>};

<span style="color: #666666; font-style: italic">/*the extra bits used by codes 257-285 (added to base length)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> LENGTHEXTRA[<span style="color: #6666ff; font-weight: bold">29</span>]
  <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>,  <span style="color: #6666ff; font-weight: bold">0</span>,  <span style="color: #6666ff; font-weight: bold">1</span>,  <span style="color: #6666ff; font-weight: bold">1</span>,  <span style="color: #6666ff; font-weight: bold">1</span>,  <span style="color: #6666ff; font-weight: bold">1</span>,  <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,
      <span style="color: #6666ff; font-weight: bold">4</span>,  <span style="color: #6666ff; font-weight: bold">4</span>,  <span style="color: #6666ff; font-weight: bold">4</span>,   <span style="color: #6666ff; font-weight: bold">4</span>,   <span style="color: #6666ff; font-weight: bold">5</span>,   <span style="color: #6666ff; font-weight: bold">5</span>,   <span style="color: #6666ff; font-weight: bold">5</span>,   <span style="color: #6666ff; font-weight: bold">5</span>,   <span style="color: #6666ff; font-weight: bold">0</span>};

<span style="color: #666666; font-style: italic">/*the base backwards distances (the bits of distance codes appear after length codes and use their own huffman tree)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> DISTANCEBASE[<span style="color: #6666ff; font-weight: bold">30</span>]
  <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">3</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">5</span>, <span style="color: #6666ff; font-weight: bold">7</span>, <span style="color: #6666ff; font-weight: bold">9</span>, <span style="color: #6666ff; font-weight: bold">13</span>, <span style="color: #6666ff; font-weight: bold">17</span>, <span style="color: #6666ff; font-weight: bold">25</span>, <span style="color: #6666ff; font-weight: bold">33</span>, <span style="color: #6666ff; font-weight: bold">49</span>, <span style="color: #6666ff; font-weight: bold">65</span>, <span style="color: #6666ff; font-weight: bold">97</span>, <span style="color: #6666ff; font-weight: bold">129</span>, <span style="color: #6666ff; font-weight: bold">193</span>, <span style="color: #6666ff; font-weight: bold">257</span>, <span style="color: #6666ff; font-weight: bold">385</span>, <span style="color: #6666ff; font-weight: bold">513</span>,
     <span style="color: #6666ff; font-weight: bold">769</span>, <span style="color: #6666ff; font-weight: bold">1025</span>, <span style="color: #6666ff; font-weight: bold">1537</span>, <span style="color: #6666ff; font-weight: bold">2049</span>, <span style="color: #6666ff; font-weight: bold">3073</span>, <span style="color: #6666ff; font-weight: bold">4097</span>, <span style="color: #6666ff; font-weight: bold">6145</span>, <span style="color: #6666ff; font-weight: bold">8193</span>, <span style="color: #6666ff; font-weight: bold">12289</span>, <span style="color: #6666ff; font-weight: bold">16385</span>, <span style="color: #6666ff; font-weight: bold">24577</span>};

<span style="color: #666666; font-style: italic">/*the extra bits of backwards distances (added to base)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> DISTANCEEXTRA[<span style="color: #6666ff; font-weight: bold">30</span>]
  <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">2</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,  <span style="color: #6666ff; font-weight: bold">3</span>,  <span style="color: #6666ff; font-weight: bold">4</span>,  <span style="color: #6666ff; font-weight: bold">4</span>,  <span style="color: #6666ff; font-weight: bold">5</span>,  <span style="color: #6666ff; font-weight: bold">5</span>,   <span style="color: #6666ff; font-weight: bold">6</span>,   <span style="color: #6666ff; font-weight: bold">6</span>,   <span style="color: #6666ff; font-weight: bold">7</span>,   <span style="color: #6666ff; font-weight: bold">7</span>,   <span style="color: #6666ff; font-weight: bold">8</span>,
       <span style="color: #6666ff; font-weight: bold">8</span>,    <span style="color: #6666ff; font-weight: bold">9</span>,    <span style="color: #6666ff; font-weight: bold">9</span>,   <span style="color: #6666ff; font-weight: bold">10</span>,   <span style="color: #6666ff; font-weight: bold">10</span>,   <span style="color: #6666ff; font-weight: bold">11</span>,   <span style="color: #6666ff; font-weight: bold">11</span>,   <span style="color: #6666ff; font-weight: bold">12</span>,    <span style="color: #6666ff; font-weight: bold">12</span>,    <span style="color: #6666ff; font-weight: bold">13</span>,    <span style="color: #6666ff; font-weight: bold">13</span>};

<span style="color: #666666; font-style: italic">/*the order in which &quot;code length alphabet code lengths&quot; are stored, out of this</span>
<span style="color: #666666; font-style: italic">the huffman tree of the dynamic huffman tree lengths is generated*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> CLCL_ORDER[NUM_CODE_LENGTH_CODES]
  <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">16</span>, <span style="color: #6666ff; font-weight: bold">17</span>, <span style="color: #6666ff; font-weight: bold">18</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">7</span>, <span style="color: #6666ff; font-weight: bold">9</span>, <span style="color: #6666ff; font-weight: bold">6</span>, <span style="color: #6666ff; font-weight: bold">10</span>, <span style="color: #6666ff; font-weight: bold">5</span>, <span style="color: #6666ff; font-weight: bold">11</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">12</span>, <span style="color: #6666ff; font-weight: bold">3</span>, <span style="color: #6666ff; font-weight: bold">13</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">14</span>, <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">15</span>};

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Huffman tree struct, containing multiple representations of the tree</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> HuffmanTree
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> tree2d;
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> tree1d;
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> lengths; <span style="color: #666666; font-style: italic">/*the lengths of the codes of the 1d-tree*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> maxbitlen; <span style="color: #666666; font-style: italic">/*maximum number of bits a single code can get*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> numcodes; <span style="color: #666666; font-style: italic">/*number of symbols in the alphabet = number of codes*/</span>
} HuffmanTree;

<span style="color: #666666; font-style: italic">/*function used for debug purposes to draw the tree in ascii art with C++*/</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">static void HuffmanTree_draw(HuffmanTree* tree)</span>
<span style="color: #666666; font-style: italic">{</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;tree. length: &quot; &lt;&lt; tree-&gt;numcodes &lt;&lt; &quot; maxbitlen: &quot; &lt;&lt; tree-&gt;maxbitlen &lt;&lt; std::endl;</span>
<span style="color: #666666; font-style: italic">  for(size_t i = 0; i &lt; tree-&gt;tree1d.size; i++)</span>
<span style="color: #666666; font-style: italic">  {</span>
<span style="color: #666666; font-style: italic">    if(tree-&gt;lengths.data[i])</span>
<span style="color: #666666; font-style: italic">      std::cout &lt;&lt; i &lt;&lt; &quot; &quot; &lt;&lt; tree-&gt;tree1d.data[i] &lt;&lt; &quot; &quot; &lt;&lt; tree-&gt;lengths.data[i] &lt;&lt; std::endl;</span>
<span style="color: #666666; font-style: italic">  }</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; std::endl;</span>
<span style="color: #666666; font-style: italic">}*/</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_init</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  tree<span style="color: #333333">-&gt;</span>tree2d <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  tree<span style="color: #333333">-&gt;</span>tree1d <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  tree<span style="color: #333333">-&gt;</span>lengths <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_cleanup</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  lodepng_free(tree<span style="color: #333333">-&gt;</span>tree2d);
  lodepng_free(tree<span style="color: #333333">-&gt;</span>tree1d);
  lodepng_free(tree<span style="color: #333333">-&gt;</span>lengths);
}

<span style="color: #666666; font-style: italic">/*the tree representation used by the decoder. return value is error*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_make2DTree</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> nodefilled <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*up to which node it is filled*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> treepos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*position in the tree (1 of the numcodes columns)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> n, i;

  tree<span style="color: #333333">-&gt;</span>tree2d <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>tree2d) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  convert tree1d[] to tree2d[][]. In the 2D array, a value of 32767 means</span>
<span style="color: #666666; font-style: italic">  uninited, a value &gt;= numcodes is an address to another bit, a value &lt; numcodes</span>
<span style="color: #666666; font-style: italic">  is a code. The 2 rows are the 2 possible bit values (0 or 1), there are as</span>
<span style="color: #666666; font-style: italic">  many columns as codes - 1.</span>
<span style="color: #666666; font-style: italic">  A good huffmann tree has N * 2 - 1 nodes, of which N - 1 are internal nodes.</span>
<span style="color: #666666; font-style: italic">  Here, the internal nodes are stored (what their 0 and 1 option point to).</span>
<span style="color: #666666; font-style: italic">  There is only memory for such good tree currently, if there are more nodes</span>
<span style="color: #666666; font-style: italic">  (due to too long length codes), error 55 will happen</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>; n<span style="color: #333333">++</span>)
  {
    tree<span style="color: #333333">-&gt;</span>tree2d[n] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">32767</span>; <span style="color: #666666; font-style: italic">/*32767 here means the tree2d isn&#39;t filled there yet*/</span>
  }

  <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>numcodes; n<span style="color: #333333">++</span>) <span style="color: #666666; font-style: italic">/*the codes*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>lengths[n]; i<span style="color: #333333">++</span>) <span style="color: #666666; font-style: italic">/*the bits for this code*/</span>
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((tree<span style="color: #333333">-&gt;</span>tree1d[n] <span style="color: #333333">&gt;&gt;</span> (tree<span style="color: #333333">-&gt;</span>lengths[n] <span style="color: #333333">-</span> i <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>)) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>);
      <span style="color: #228899; font-weight: bold">if</span>(treepos <span style="color: #333333">&gt;</span> tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">55</span>; <span style="color: #666666; font-style: italic">/*oversubscribed, see comment in lodepng_error_text*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(tree<span style="color: #333333">-&gt;</span>tree2d[<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> treepos <span style="color: #333333">+</span> bit] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">32767</span>) <span style="color: #666666; font-style: italic">/*not yet filled in*/</span>
      {
        <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">==</span> tree<span style="color: #333333">-&gt;</span>lengths[n]) <span style="color: #666666; font-style: italic">/*last bit*/</span>
        {
          tree<span style="color: #333333">-&gt;</span>tree2d[<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> treepos <span style="color: #333333">+</span> bit] <span style="color: #333333">=</span> n; <span style="color: #666666; font-style: italic">/*put the current code in it*/</span>
          treepos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        }
        <span style="color: #228899; font-weight: bold">else</span>
        {
          <span style="color: #666666; font-style: italic">/*put address of the next step in here, first that address has to be found of course</span>
<span style="color: #666666; font-style: italic">          (it&#39;s just nodefilled + 1)...*/</span>
          nodefilled<span style="color: #333333">++</span>;
          <span style="color: #666666; font-style: italic">/*addresses encoded with numcodes added to it*/</span>
          tree<span style="color: #333333">-&gt;</span>tree2d[<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> treepos <span style="color: #333333">+</span> bit] <span style="color: #333333">=</span> nodefilled <span style="color: #333333">+</span> tree<span style="color: #333333">-&gt;</span>numcodes;
          treepos <span style="color: #333333">=</span> nodefilled;
        }
      }
      <span style="color: #228899; font-weight: bold">else</span> treepos <span style="color: #333333">=</span> tree<span style="color: #333333">-&gt;</span>tree2d[<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> treepos <span style="color: #333333">+</span> bit] <span style="color: #333333">-</span> tree<span style="color: #333333">-&gt;</span>numcodes;
    }
  }

  <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>; n<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(tree<span style="color: #333333">-&gt;</span>tree2d[n] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">32767</span>) tree<span style="color: #333333">-&gt;</span>tree2d[n] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*remove possible remaining 32767&#39;s*/</span>
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Second step for the ...makeFromLengths and ...makeFromFrequencies functions.</span>
<span style="color: #666666; font-style: italic">numcodes, lengths and maxbitlen must already be filled in correctly. return</span>
<span style="color: #666666; font-style: italic">value is error.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_makeFromLengths2</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  uivector blcount;
  uivector nextcode;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bits, n, error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  uivector_init(<span style="color: #333333">&amp;</span>blcount);
  uivector_init(<span style="color: #333333">&amp;</span>nextcode);

  tree<span style="color: #333333">-&gt;</span>tree1d <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>tree1d) error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resizev(<span style="color: #333333">&amp;</span>blcount, tree<span style="color: #333333">-&gt;</span>maxbitlen <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">0</span>)
  <span style="color: #333333">||</span> <span style="color: #333333">!</span>uivector_resizev(<span style="color: #333333">&amp;</span>nextcode, tree<span style="color: #333333">-&gt;</span>maxbitlen <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">0</span>))
    error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
  {
    <span style="color: #666666; font-style: italic">/*step 1: count number of instances of each code length*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; bits <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>numcodes; bits<span style="color: #333333">++</span>) blcount.data[tree<span style="color: #333333">-&gt;</span>lengths[bits]]<span style="color: #333333">++</span>;
    <span style="color: #666666; font-style: italic">/*step 2: generate the nextcode values*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; bits <span style="color: #333333">&lt;=</span> tree<span style="color: #333333">-&gt;</span>maxbitlen; bits<span style="color: #333333">++</span>)
    {
      nextcode.data[bits] <span style="color: #333333">=</span> (nextcode.data[bits <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">+</span> blcount.data[bits <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]) <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    }
    <span style="color: #666666; font-style: italic">/*step 3: generate all the codes*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> tree<span style="color: #333333">-&gt;</span>numcodes; n<span style="color: #333333">++</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(tree<span style="color: #333333">-&gt;</span>lengths[n] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) tree<span style="color: #333333">-&gt;</span>tree1d[n] <span style="color: #333333">=</span> nextcode.data[tree<span style="color: #333333">-&gt;</span>lengths[n]]<span style="color: #333333">++</span>;
    }
  }

  uivector_cleanup(<span style="color: #333333">&amp;</span>blcount);
  uivector_cleanup(<span style="color: #333333">&amp;</span>nextcode);

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) <span style="color: #228899; font-weight: bold">return</span> HuffmanTree_make2DTree(tree);
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">given the code lengths (as stored in the PNG file), generate the tree as defined</span>
<span style="color: #666666; font-style: italic">by Deflate. maxbitlen is the maximum bits that a code in the tree can have.</span>
<span style="color: #666666; font-style: italic">return value is error.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_makeFromLengths</span>(HuffmanTree<span style="color: #333333">*</span> tree, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen,
                                            <span style="color: #6666ff; font-weight: bold">size_t</span> numcodes, <span style="color: #6666ff; font-weight: bold">unsigned</span> maxbitlen)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  tree<span style="color: #333333">-&gt;</span>lengths <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(numcodes <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>lengths) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes; i<span style="color: #333333">++</span>) tree<span style="color: #333333">-&gt;</span>lengths[i] <span style="color: #333333">=</span> bitlen[i];
  tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)numcodes; <span style="color: #666666; font-style: italic">/*number of symbols*/</span>
  tree<span style="color: #333333">-&gt;</span>maxbitlen <span style="color: #333333">=</span> maxbitlen;
  <span style="color: #228899; font-weight: bold">return</span> HuffmanTree_makeFromLengths2(tree);
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">A coin, this is the terminology used for the package-merge algorithm and the</span>
<span style="color: #666666; font-style: italic">coin collector&#39;s problem. This is used to generate the huffman tree.</span>
<span style="color: #666666; font-style: italic">A coin can be multiple coins (when they&#39;re merged)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> Coin
{
  uivector symbols;
  <span style="color: #6666ff; font-weight: bold">float</span> weight; <span style="color: #666666; font-style: italic">/*the sum of all weights in this coin*/</span>
} Coin;

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">coin_init</span>(Coin<span style="color: #333333">*</span> c)
{
  uivector_init(<span style="color: #333333">&amp;</span>c<span style="color: #333333">-&gt;</span>symbols);
}

<span style="color: #666666; font-style: italic">/*argument c is void* so that this dtor can be given as function pointer to the vector resize function*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">coin_cleanup</span>(<span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> c)
{
  uivector_cleanup(<span style="color: #333333">&amp;</span>((Coin<span style="color: #333333">*</span>)c)<span style="color: #333333">-&gt;</span>symbols);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">coin_copy</span>(Coin<span style="color: #333333">*</span> c1, <span style="color: #228899; font-weight: bold">const</span> Coin<span style="color: #333333">*</span> c2)
{
  c1<span style="color: #333333">-&gt;</span>weight <span style="color: #333333">=</span> c2<span style="color: #333333">-&gt;</span>weight;
  uivector_copy(<span style="color: #333333">&amp;</span>c1<span style="color: #333333">-&gt;</span>symbols, <span style="color: #333333">&amp;</span>c2<span style="color: #333333">-&gt;</span>symbols);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">add_coins</span>(Coin<span style="color: #333333">*</span> c1, <span style="color: #228899; font-weight: bold">const</span> Coin<span style="color: #333333">*</span> c2)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> c2<span style="color: #333333">-&gt;</span>symbols.size; i<span style="color: #333333">++</span>) uivector_push_back(<span style="color: #333333">&amp;</span>c1<span style="color: #333333">-&gt;</span>symbols, c2<span style="color: #333333">-&gt;</span>symbols.data[i]);
  c1<span style="color: #333333">-&gt;</span>weight <span style="color: #333333">+=</span> c2<span style="color: #333333">-&gt;</span>weight;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">init_coins</span>(Coin<span style="color: #333333">*</span> coins, <span style="color: #6666ff; font-weight: bold">size_t</span> num)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> num; i<span style="color: #333333">++</span>) coin_init(<span style="color: #333333">&amp;</span>coins[i]);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">cleanup_coins</span>(Coin<span style="color: #333333">*</span> coins, <span style="color: #6666ff; font-weight: bold">size_t</span> num)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> num; i<span style="color: #333333">++</span>) coin_cleanup(<span style="color: #333333">&amp;</span>coins[i]);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">int</span> <span style="color: #55eedd; font-weight: bold">coin_compare</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> a, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> b) {
  <span style="color: #6666ff; font-weight: bold">float</span> wa <span style="color: #333333">=</span> ((<span style="color: #228899; font-weight: bold">const</span> Coin<span style="color: #333333">*</span>)a)<span style="color: #333333">-&gt;</span>weight;
  <span style="color: #6666ff; font-weight: bold">float</span> wb <span style="color: #333333">=</span> ((<span style="color: #228899; font-weight: bold">const</span> Coin<span style="color: #333333">*</span>)b)<span style="color: #333333">-&gt;</span>weight;
  <span style="color: #228899; font-weight: bold">return</span> wa <span style="color: #333333">&gt;</span> wb <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> wa <span style="color: #333333">&lt;</span> wb <span style="color: #333333">?</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">append_symbol_coins</span>(Coin<span style="color: #333333">*</span> coins, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> frequencies, <span style="color: #6666ff; font-weight: bold">unsigned</span> numcodes, <span style="color: #6666ff; font-weight: bold">size_t</span> sum)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*index of present symbols*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(frequencies[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #666666; font-style: italic">/*only include symbols that are present*/</span>
    {
      coins[j].weight <span style="color: #333333">=</span> frequencies[i] <span style="color: #333333">/</span> (<span style="color: #6666ff; font-weight: bold">float</span>)sum;
      uivector_push_back(<span style="color: #333333">&amp;</span>coins[j].symbols, i);
      j<span style="color: #333333">++</span>;
    }
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_huffman_code_lengths</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> lengths, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> frequencies,
                                      <span style="color: #6666ff; font-weight: bold">size_t</span> numcodes, <span style="color: #6666ff; font-weight: bold">unsigned</span> maxbitlen)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i, j;
  <span style="color: #6666ff; font-weight: bold">size_t</span> sum <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, numpresent <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  Coin<span style="color: #333333">*</span> coins; <span style="color: #666666; font-style: italic">/*the coins of the currently calculated row*/</span>
  Coin<span style="color: #333333">*</span> prev_row; <span style="color: #666666; font-style: italic">/*the previous row of coins*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> numcoins;
  <span style="color: #6666ff; font-weight: bold">size_t</span> coinmem;

  <span style="color: #228899; font-weight: bold">if</span>(numcodes <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">80</span>; <span style="color: #666666; font-style: italic">/*error: a tree of 0 symbols is not supposed to be made*/</span>

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(frequencies[i] <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
    {
      numpresent<span style="color: #333333">++</span>;
      sum <span style="color: #333333">+=</span> frequencies[i];
    }
  }

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes; i<span style="color: #333333">++</span>) lengths[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #666666; font-style: italic">/*ensure at least two present symbols. There should be at least one symbol</span>
<span style="color: #666666; font-style: italic">  according to RFC 1951 section 3.2.7. To decoders incorrectly require two. To</span>
<span style="color: #666666; font-style: italic">  make these work as well ensure there are at least two symbols. The</span>
<span style="color: #666666; font-style: italic">  Package-Merge code below also doesn&#39;t work correctly if there&#39;s only one</span>
<span style="color: #666666; font-style: italic">  symbol, it&#39;d give it the theoritical 0 bits but in practice zlib wants 1 bit*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(numpresent <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    lengths[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> lengths[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*note that for RFC 1951 section 3.2.7, only lengths[0] = 1 is needed*/</span>
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(numpresent <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span>)
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes; i<span style="color: #333333">++</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(frequencies[i])
      {
        lengths[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        lengths[i <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #666666; font-style: italic">/*Package-Merge algorithm represented by coin collector&#39;s problem</span>
<span style="color: #666666; font-style: italic">    For every symbol, maxbitlen coins will be created*/</span>

    coinmem <span style="color: #333333">=</span> numpresent <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>; <span style="color: #666666; font-style: italic">/*max amount of coins needed with the current algo*/</span>
    coins <span style="color: #333333">=</span> (Coin<span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(Coin) <span style="color: #333333">*</span> coinmem);
    prev_row <span style="color: #333333">=</span> (Coin<span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(Coin) <span style="color: #333333">*</span> coinmem);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>coins <span style="color: #333333">||</span> <span style="color: #333333">!</span>prev_row)
    {
      lodepng_free(coins);
      lodepng_free(prev_row);
      <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    }
    init_coins(coins, coinmem);
    init_coins(prev_row, coinmem);

    <span style="color: #666666; font-style: italic">/*first row, lowest denominator*/</span>
    error <span style="color: #333333">=</span> append_symbol_coins(coins, frequencies, numcodes, sum);
    numcoins <span style="color: #333333">=</span> numpresent;
    qsort(coins, numcoins, <span style="color: #228899; font-weight: bold">sizeof</span>(Coin), coin_compare);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> numprev <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">for</span>(j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; j <span style="color: #333333">&lt;=</span> maxbitlen <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>error; j<span style="color: #333333">++</span>) <span style="color: #666666; font-style: italic">/*each of the remaining rows*/</span>
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> tempnum;
        Coin<span style="color: #333333">*</span> tempcoins;
        <span style="color: #666666; font-style: italic">/*swap prev_row and coins, and their amounts*/</span>
        tempcoins <span style="color: #333333">=</span> prev_row; prev_row <span style="color: #333333">=</span> coins; coins <span style="color: #333333">=</span> tempcoins;
        tempnum <span style="color: #333333">=</span> numprev; numprev <span style="color: #333333">=</span> numcoins; numcoins <span style="color: #333333">=</span> tempnum;

        cleanup_coins(coins, numcoins);
        init_coins(coins, numcoins);

        numcoins <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

        <span style="color: #666666; font-style: italic">/*fill in the merged coins of the previous row*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">&lt;</span> numprev; i <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">2</span>)
        {
          <span style="color: #666666; font-style: italic">/*merge prev_row[i] and prev_row[i + 1] into new coin*/</span>
          Coin<span style="color: #333333">*</span> coin <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>coins[numcoins<span style="color: #333333">++</span>];
          coin_copy(coin, <span style="color: #333333">&amp;</span>prev_row[i]);
          add_coins(coin, <span style="color: #333333">&amp;</span>prev_row[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
        }
        <span style="color: #666666; font-style: italic">/*fill in all the original symbols again*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(j <span style="color: #333333">&lt;</span> maxbitlen)
        {
          error <span style="color: #333333">=</span> append_symbol_coins(coins <span style="color: #333333">+</span> numcoins, frequencies, numcodes, sum);
          numcoins <span style="color: #333333">+=</span> numpresent;
        }
        qsort(coins, numcoins, <span style="color: #228899; font-weight: bold">sizeof</span>(Coin), coin_compare);
      }
    }

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #666666; font-style: italic">/*calculate the lenghts of each symbol, as the amount of times a coin of each symbol is used*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpresent <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>; i<span style="color: #333333">++</span>)
      {
        Coin<span style="color: #333333">*</span> coin <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>coins[i];
        <span style="color: #228899; font-weight: bold">for</span>(j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; j <span style="color: #333333">&lt;</span> coin<span style="color: #333333">-&gt;</span>symbols.size; j<span style="color: #333333">++</span>) lengths[coin<span style="color: #333333">-&gt;</span>symbols.data[j]]<span style="color: #333333">++</span>;
      }
    }

    cleanup_coins(coins, coinmem);
    lodepng_free(coins);
    cleanup_coins(prev_row, coinmem);
    lodepng_free(prev_row);
  }

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*Create the Huffman tree given the symbol frequencies*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_makeFromFrequencies</span>(HuffmanTree<span style="color: #333333">*</span> tree, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> frequencies,
                                                <span style="color: #6666ff; font-weight: bold">size_t</span> mincodes, <span style="color: #6666ff; font-weight: bold">size_t</span> numcodes, <span style="color: #6666ff; font-weight: bold">unsigned</span> maxbitlen)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>frequencies[numcodes <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&amp;&amp;</span> numcodes <span style="color: #333333">&gt;</span> mincodes) numcodes<span style="color: #333333">--</span>; <span style="color: #666666; font-style: italic">/*trim zeroes*/</span>
  tree<span style="color: #333333">-&gt;</span>maxbitlen <span style="color: #333333">=</span> maxbitlen;
  tree<span style="color: #333333">-&gt;</span>numcodes <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)numcodes; <span style="color: #666666; font-style: italic">/*number of symbols*/</span>
  tree<span style="color: #333333">-&gt;</span>lengths <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_realloc(tree<span style="color: #333333">-&gt;</span>lengths, numcodes <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>lengths) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  <span style="color: #666666; font-style: italic">/*initialize all lengths to 0*/</span>
  memset(tree<span style="color: #333333">-&gt;</span>lengths, <span style="color: #6666ff; font-weight: bold">0</span>, numcodes <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));

  error <span style="color: #333333">=</span> lodepng_huffman_code_lengths(tree<span style="color: #333333">-&gt;</span>lengths, frequencies, numcodes, maxbitlen);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths2(tree);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_getCode</span>(<span style="color: #228899; font-weight: bold">const</span> HuffmanTree<span style="color: #333333">*</span> tree, <span style="color: #6666ff; font-weight: bold">unsigned</span> index)
{
  <span style="color: #228899; font-weight: bold">return</span> tree<span style="color: #333333">-&gt;</span>tree1d[index];
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">HuffmanTree_getLength</span>(<span style="color: #228899; font-weight: bold">const</span> HuffmanTree<span style="color: #333333">*</span> tree, <span style="color: #6666ff; font-weight: bold">unsigned</span> index)
{
  <span style="color: #228899; font-weight: bold">return</span> tree<span style="color: #333333">-&gt;</span>lengths[index];
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*get the literal and length code tree of a deflated block with fixed tree, as per the deflate specification*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">generateFixedLitLenTree</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i, error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(NUM_DEFLATE_CODE_SYMBOLS <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>bitlen) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #666666; font-style: italic">/*288 possible codes: 0-255=literals, 256=endcode, 257-285=lengthcodes, 286-287=unused*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span>   <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">143</span>; i<span style="color: #333333">++</span>) bitlen[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">144</span>; i <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">255</span>; i<span style="color: #333333">++</span>) bitlen[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">9</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span>; i <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">279</span>; i<span style="color: #333333">++</span>) bitlen[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">7</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">280</span>; i <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">287</span>; i<span style="color: #333333">++</span>) bitlen[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>;

  error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths(tree, bitlen, NUM_DEFLATE_CODE_SYMBOLS, <span style="color: #6666ff; font-weight: bold">15</span>);

  lodepng_free(bitlen);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*get the distance code tree of a deflated block with fixed tree, as specified in the deflate specification*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">generateFixedDistanceTree</span>(HuffmanTree<span style="color: #333333">*</span> tree)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i, error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(NUM_DISTANCE_SYMBOLS <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>bitlen) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #666666; font-style: italic">/*there are 32 distance codes, but 30-31 are unused*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> NUM_DISTANCE_SYMBOLS; i<span style="color: #333333">++</span>) bitlen[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">5</span>;
  error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths(tree, bitlen, NUM_DISTANCE_SYMBOLS, <span style="color: #6666ff; font-weight: bold">15</span>);

  lodepng_free(bitlen);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">returns the code, or (unsigned)(-1) if error happened</span>
<span style="color: #666666; font-style: italic">inbitlength is the length of the complete buffer, in bits (so its byte length times 8)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">huffmanDecodeSymbol</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp,
                                    <span style="color: #228899; font-weight: bold">const</span> HuffmanTree<span style="color: #333333">*</span> codetree, <span style="color: #6666ff; font-weight: bold">size_t</span> inbitlength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> treepos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, ct;
  <span style="color: #228899; font-weight: bold">for</span>(;;)
  {
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*error: end of input memory reached without endcode*/</span>
    <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">    decode the symbol from the tree. The &quot;readBitFromStream&quot; code is inlined in</span>
<span style="color: #666666; font-style: italic">    the expression below because this is the biggest bottleneck while decoding</span>
<span style="color: #666666; font-style: italic">    */</span>
    ct <span style="color: #333333">=</span> codetree<span style="color: #333333">-&gt;</span>tree2d[(treepos <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> READBIT(<span style="color: #333333">*</span>bp, in)];
    (<span style="color: #333333">*</span>bp)<span style="color: #333333">++</span>;
    <span style="color: #228899; font-weight: bold">if</span>(ct <span style="color: #333333">&lt;</span> codetree<span style="color: #333333">-&gt;</span>numcodes) <span style="color: #228899; font-weight: bold">return</span> ct; <span style="color: #666666; font-style: italic">/*the symbol is decoded, return it*/</span>
    <span style="color: #228899; font-weight: bold">else</span> treepos <span style="color: #333333">=</span> ct <span style="color: #333333">-</span> codetree<span style="color: #333333">-&gt;</span>numcodes; <span style="color: #666666; font-style: italic">/*symbol not yet decoded, instead move tree position*/</span>

    <span style="color: #228899; font-weight: bold">if</span>(treepos <span style="color: #333333">&gt;=</span> codetree<span style="color: #333333">-&gt;</span>numcodes) <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*error: it appeared outside the codetree*/</span>
  }
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Inflator (Decompressor)                                                / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*get the tree of a deflated block with fixed tree, as specified in the deflate specification*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">getTreeInflateFixed</span>(HuffmanTree<span style="color: #333333">*</span> tree_ll, HuffmanTree<span style="color: #333333">*</span> tree_d)
{
  <span style="color: #666666; font-style: italic">/*TODO: check for out of memory errors*/</span>
  generateFixedLitLenTree(tree_ll);
  generateFixedDistanceTree(tree_d);
}

<span style="color: #666666; font-style: italic">/*get the tree of a deflated block with dynamic tree, the tree itself is also Huffman compressed with a known tree*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">getTreeInflateDynamic</span>(HuffmanTree<span style="color: #333333">*</span> tree_ll, HuffmanTree<span style="color: #333333">*</span> tree_d,
                                      <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, <span style="color: #6666ff; font-weight: bold">size_t</span> inlength)
{
  <span style="color: #666666; font-style: italic">/*make sure that length values that aren&#39;t filled in will be 0, or a wrong tree will be generated*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> n, HLIT, HDIST, HCLEN, i;
  <span style="color: #6666ff; font-weight: bold">size_t</span> inbitlength <span style="color: #333333">=</span> inlength <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>;

  <span style="color: #666666; font-style: italic">/*see comments in deflateDynamic for explanation of the context and these variables, it is analogous*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen_ll <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*lit,len code lengths*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen_d <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*dist code lengths*/</span>
  <span style="color: #666666; font-style: italic">/*code length code lengths (&quot;clcl&quot;), the bit lengths of the huffman tree used to compress bitlen_ll and bitlen_d*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> bitlen_cl <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  HuffmanTree tree_cl; <span style="color: #666666; font-style: italic">/*the code tree for code length codes (the huffman tree for compressed huffman trees)*/</span>

  <span style="color: #228899; font-weight: bold">if</span>((<span style="color: #333333">*</span>bp) <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&gt;=</span> inlength <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">49</span>; <span style="color: #666666; font-style: italic">/*error: the bit pointer is or will go past the memory*/</span>

  <span style="color: #666666; font-style: italic">/*number of literal/length codes + 257. Unlike the spec, the value 257 is added to it here already*/</span>
  HLIT <span style="color: #333333">=</span>  readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">5</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">257</span>;
  <span style="color: #666666; font-style: italic">/*number of distance codes. Unlike the spec, the value 1 is added to it here already*/</span>
  HDIST <span style="color: #333333">=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">5</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #666666; font-style: italic">/*number of code length codes. Unlike the spec, the value 4 is added to it here already*/</span>
  HCLEN <span style="color: #333333">=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">4</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>;

  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_cl);

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error)
  {
    <span style="color: #666666; font-style: italic">/*read the code length codes out of 3 * (amount of code length codes) bits*/</span>

    bitlen_cl <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(NUM_CODE_LENGTH_CODES <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>bitlen_cl) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);

    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> NUM_CODE_LENGTH_CODES; i<span style="color: #333333">++</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HCLEN) bitlen_cl[CLCL_ORDER[i]] <span style="color: #333333">=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">3</span>);
      <span style="color: #228899; font-weight: bold">else</span> bitlen_cl[CLCL_ORDER[i]] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*if not, it must stay 0*/</span>
    }

    error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths(<span style="color: #333333">&amp;</span>tree_cl, bitlen_cl, NUM_CODE_LENGTH_CODES, <span style="color: #6666ff; font-weight: bold">7</span>);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;

    <span style="color: #666666; font-style: italic">/*now we can use this tree to read the lengths for the tree that this function will return*/</span>
    bitlen_ll <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(NUM_DEFLATE_CODE_SYMBOLS <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
    bitlen_d <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span>)lodepng_malloc(NUM_DISTANCE_SYMBOLS <span style="color: #333333">*</span> <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span>));
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>bitlen_ll <span style="color: #333333">||</span> <span style="color: #333333">!</span>bitlen_d) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> NUM_DEFLATE_CODE_SYMBOLS; i<span style="color: #333333">++</span>) bitlen_ll[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> NUM_DISTANCE_SYMBOLS; i<span style="color: #333333">++</span>) bitlen_d[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

    <span style="color: #666666; font-style: italic">/*i is the current symbol we&#39;re reading in the part that contains the code lengths of lit/len and dist codes*/</span>
    i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">while</span>(i <span style="color: #333333">&lt;</span> HLIT <span style="color: #333333">+</span> HDIST)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> code <span style="color: #333333">=</span> huffmanDecodeSymbol(in, bp, <span style="color: #333333">&amp;</span>tree_cl, inbitlength);
      <span style="color: #228899; font-weight: bold">if</span>(code <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">15</span>) <span style="color: #666666; font-style: italic">/*a length code*/</span>
      {
        <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HLIT) bitlen_ll[i] <span style="color: #333333">=</span> code;
        <span style="color: #228899; font-weight: bold">else</span> bitlen_d[i <span style="color: #333333">-</span> HLIT] <span style="color: #333333">=</span> code;
        i<span style="color: #333333">++</span>;
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(code <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>) <span style="color: #666666; font-style: italic">/*repeat previous*/</span>
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> replength <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">3</span>; <span style="color: #666666; font-style: italic">/*read in the 2 bits that indicate repeat length (3-6)*/</span>
        <span style="color: #6666ff; font-weight: bold">unsigned</span> value; <span style="color: #666666; font-style: italic">/*set value to the previous code*/</span>

        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">50</span>); <span style="color: #666666; font-style: italic">/*error, bit pointer jumps past memory*/</span>
        <span style="color: #228899; font-weight: bold">if</span> (i <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">54</span>); <span style="color: #666666; font-style: italic">/*can&#39;t repeat previous if i is 0*/</span>

        replength <span style="color: #333333">+=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">2</span>);

        <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HLIT <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>) value <span style="color: #333333">=</span> bitlen_ll[i <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>];
        <span style="color: #228899; font-weight: bold">else</span> value <span style="color: #333333">=</span> bitlen_d[i <span style="color: #333333">-</span> HLIT <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>];
        <span style="color: #666666; font-style: italic">/*repeat this value in the next lengths*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> replength; n<span style="color: #333333">++</span>)
        {
          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&gt;=</span> HLIT <span style="color: #333333">+</span> HDIST) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">13</span>); <span style="color: #666666; font-style: italic">/*error: i is larger than the amount of codes*/</span>
          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HLIT) bitlen_ll[i] <span style="color: #333333">=</span> value;
          <span style="color: #228899; font-weight: bold">else</span> bitlen_d[i <span style="color: #333333">-</span> HLIT] <span style="color: #333333">=</span> value;
          i<span style="color: #333333">++</span>;
        }
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(code <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">17</span>) <span style="color: #666666; font-style: italic">/*repeat &quot;0&quot; 3-10 times*/</span>
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> replength <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">3</span>; <span style="color: #666666; font-style: italic">/*read in the bits that indicate repeat length*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">50</span>); <span style="color: #666666; font-style: italic">/*error, bit pointer jumps past memory*/</span>

        replength <span style="color: #333333">+=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">3</span>);

        <span style="color: #666666; font-style: italic">/*repeat this value in the next lengths*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> replength; n<span style="color: #333333">++</span>)
        {
          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&gt;=</span> HLIT <span style="color: #333333">+</span> HDIST) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">14</span>); <span style="color: #666666; font-style: italic">/*error: i is larger than the amount of codes*/</span>

          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HLIT) bitlen_ll[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
          <span style="color: #228899; font-weight: bold">else</span> bitlen_d[i <span style="color: #333333">-</span> HLIT] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
          i<span style="color: #333333">++</span>;
        }
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(code <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">18</span>) <span style="color: #666666; font-style: italic">/*repeat &quot;0&quot; 11-138 times*/</span>
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> replength <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">11</span>; <span style="color: #666666; font-style: italic">/*read in the bits that indicate repeat length*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">50</span>); <span style="color: #666666; font-style: italic">/*error, bit pointer jumps past memory*/</span>

        replength <span style="color: #333333">+=</span> readBitsFromStream(bp, in, <span style="color: #6666ff; font-weight: bold">7</span>);

        <span style="color: #666666; font-style: italic">/*repeat this value in the next lengths*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> replength; n<span style="color: #333333">++</span>)
        {
          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&gt;=</span> HLIT <span style="color: #333333">+</span> HDIST) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">15</span>); <span style="color: #666666; font-style: italic">/*error: i is larger than the amount of codes*/</span>

          <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> HLIT) bitlen_ll[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
          <span style="color: #228899; font-weight: bold">else</span> bitlen_d[i <span style="color: #333333">-</span> HLIT] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
          i<span style="color: #333333">++</span>;
        }
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*if(code == (unsigned)(-1))*/</span> <span style="color: #666666; font-style: italic">/*huffmanDecodeSymbol returns (unsigned)(-1) in case of error*/</span>
      {
        <span style="color: #228899; font-weight: bold">if</span>(code <span style="color: #333333">==</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>))
        {
          <span style="color: #666666; font-style: italic">/*return error code 10 or 11 depending on the situation that happened in huffmanDecodeSymbol</span>
<span style="color: #666666; font-style: italic">          (10=no endcode, 11=wrong jump outside of tree)*/</span>
          error <span style="color: #333333">=</span> (<span style="color: #333333">*</span>bp) <span style="color: #333333">&gt;</span> inbitlength <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">10</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">11</span>;
        }
        <span style="color: #228899; font-weight: bold">else</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">16</span>; <span style="color: #666666; font-style: italic">/*unexisting code, this can never happen*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;

    <span style="color: #228899; font-weight: bold">if</span>(bitlen_ll[<span style="color: #6666ff; font-weight: bold">256</span>] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">64</span>); <span style="color: #666666; font-style: italic">/*the length of the end code 256 must be larger than 0*/</span>

    <span style="color: #666666; font-style: italic">/*now we&#39;ve finally got HLIT and HDIST, so generate the code trees, and the function is done*/</span>
    error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths(tree_ll, bitlen_ll, NUM_DEFLATE_CODE_SYMBOLS, <span style="color: #6666ff; font-weight: bold">15</span>);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
    error <span style="color: #333333">=</span> HuffmanTree_makeFromLengths(tree_d, bitlen_d, NUM_DISTANCE_SYMBOLS, <span style="color: #6666ff; font-weight: bold">15</span>);

    <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*end of error-while*/</span>
  }

  lodepng_free(bitlen_cl);
  lodepng_free(bitlen_ll);
  lodepng_free(bitlen_d);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_cl);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*inflate a block with dynamic of fixed Huffman tree*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">inflateHuffmanBlock</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp,
                                    <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> pos, <span style="color: #6666ff; font-weight: bold">size_t</span> inlength, <span style="color: #6666ff; font-weight: bold">unsigned</span> btype)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  HuffmanTree tree_ll; <span style="color: #666666; font-style: italic">/*the huffman tree for literal and length codes*/</span>
  HuffmanTree tree_d; <span style="color: #666666; font-style: italic">/*the huffman tree for distance codes*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> inbitlength <span style="color: #333333">=</span> inlength <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>;

  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_d);

  <span style="color: #228899; font-weight: bold">if</span>(btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span>) getTreeInflateFixed(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #333333">&amp;</span>tree_d);
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span>) error <span style="color: #333333">=</span> getTreeInflateDynamic(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #333333">&amp;</span>tree_d, in, bp, inlength);

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error) <span style="color: #666666; font-style: italic">/*decode all symbols until end reached, breaks at end code*/</span>
  {
    <span style="color: #666666; font-style: italic">/*code_ll is literal, length or end code*/</span>
    <span style="color: #6666ff; font-weight: bold">unsigned</span> code_ll <span style="color: #333333">=</span> huffmanDecodeSymbol(in, bp, <span style="color: #333333">&amp;</span>tree_ll, inbitlength);
    <span style="color: #228899; font-weight: bold">if</span>(code_ll <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #666666; font-style: italic">/*literal symbol*/</span>
    {
      <span style="color: #666666; font-style: italic">/*ucvector_push_back would do the same, but for some reason the two lines below run 10% faster*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(out, (<span style="color: #333333">*</span>pos) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
      out<span style="color: #333333">-&gt;</span>data[<span style="color: #333333">*</span>pos] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)code_ll;
      (<span style="color: #333333">*</span>pos)<span style="color: #333333">++</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(code_ll <span style="color: #333333">&gt;=</span> FIRST_LENGTH_CODE_INDEX <span style="color: #333333">&amp;&amp;</span> code_ll <span style="color: #333333">&lt;=</span> LAST_LENGTH_CODE_INDEX) <span style="color: #666666; font-style: italic">/*length code*/</span>
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> code_d, distance;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> numextrabits_l, numextrabits_d; <span style="color: #666666; font-style: italic">/*extra bits for length and distance*/</span>
      <span style="color: #6666ff; font-weight: bold">size_t</span> start, forward, backward, length;

      <span style="color: #666666; font-style: italic">/*part 1: get length base*/</span>
      length <span style="color: #333333">=</span> LENGTHBASE[code_ll <span style="color: #333333">-</span> FIRST_LENGTH_CODE_INDEX];

      <span style="color: #666666; font-style: italic">/*part 2: get extra bits and add the value of that to length*/</span>
      numextrabits_l <span style="color: #333333">=</span> LENGTHEXTRA[code_ll <span style="color: #333333">-</span> FIRST_LENGTH_CODE_INDEX];
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">51</span>); <span style="color: #666666; font-style: italic">/*error, bit pointer will jump past memory*/</span>
      length <span style="color: #333333">+=</span> readBitsFromStream(bp, in, numextrabits_l);

      <span style="color: #666666; font-style: italic">/*part 3: get distance code*/</span>
      code_d <span style="color: #333333">=</span> huffmanDecodeSymbol(in, bp, <span style="color: #333333">&amp;</span>tree_d, inbitlength);
      <span style="color: #228899; font-weight: bold">if</span>(code_d <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">29</span>)
      {
        <span style="color: #228899; font-weight: bold">if</span>(code_ll <span style="color: #333333">==</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>)) <span style="color: #666666; font-style: italic">/*huffmanDecodeSymbol returns (unsigned)(-1) in case of error*/</span>
        {
          <span style="color: #666666; font-style: italic">/*return error code 10 or 11 depending on the situation that happened in huffmanDecodeSymbol</span>
<span style="color: #666666; font-style: italic">          (10=no endcode, 11=wrong jump outside of tree)*/</span>
          error <span style="color: #333333">=</span> (<span style="color: #333333">*</span>bp) <span style="color: #333333">&gt;</span> inlength <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">10</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">11</span>;
        }
        <span style="color: #228899; font-weight: bold">else</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">18</span>; <span style="color: #666666; font-style: italic">/*error: invalid distance code (30-31 are never used)*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
      distance <span style="color: #333333">=</span> DISTANCEBASE[code_d];

      <span style="color: #666666; font-style: italic">/*part 4: get extra bits from distance*/</span>
      numextrabits_d <span style="color: #333333">=</span> DISTANCEEXTRA[code_d];
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">*</span>bp <span style="color: #333333">&gt;=</span> inbitlength) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">51</span>); <span style="color: #666666; font-style: italic">/*error, bit pointer will jump past memory*/</span>

      distance <span style="color: #333333">+=</span> readBitsFromStream(bp, in, numextrabits_d);

      <span style="color: #666666; font-style: italic">/*part 5: fill in all the out[n] values based on the length and dist*/</span>
      start <span style="color: #333333">=</span> (<span style="color: #333333">*</span>pos);
      <span style="color: #228899; font-weight: bold">if</span>(distance <span style="color: #333333">&gt;</span> start) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">52</span>); <span style="color: #666666; font-style: italic">/*too long backward distance*/</span>
      backward <span style="color: #333333">=</span> start <span style="color: #333333">-</span> distance;

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(out, (<span style="color: #333333">*</span>pos) <span style="color: #333333">+</span> length)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
      <span style="color: #228899; font-weight: bold">for</span>(forward <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; forward <span style="color: #333333">&lt;</span> length; forward<span style="color: #333333">++</span>)
      {
        out<span style="color: #333333">-&gt;</span>data[(<span style="color: #333333">*</span>pos)] <span style="color: #333333">=</span> out<span style="color: #333333">-&gt;</span>data[backward];
        (<span style="color: #333333">*</span>pos)<span style="color: #333333">++</span>;
        backward<span style="color: #333333">++</span>;
        <span style="color: #228899; font-weight: bold">if</span>(backward <span style="color: #333333">&gt;=</span> start) backward <span style="color: #333333">=</span> start <span style="color: #333333">-</span> distance;
      }
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(code_ll <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">256</span>)
    {
      <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*end code, break the loop*/</span>
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*if(code == (unsigned)(-1))*/</span> <span style="color: #666666; font-style: italic">/*huffmanDecodeSymbol returns (unsigned)(-1) in case of error*/</span>
    {
      <span style="color: #666666; font-style: italic">/*return error code 10 or 11 depending on the situation that happened in huffmanDecodeSymbol</span>
<span style="color: #666666; font-style: italic">      (10=no endcode, 11=wrong jump outside of tree)*/</span>
      error <span style="color: #333333">=</span> (<span style="color: #333333">*</span>bp) <span style="color: #333333">&gt;</span> inlength <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">10</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">11</span>;
      <span style="color: #228899; font-weight: bold">break</span>;
    }
  }

  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_d);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">inflateNoCompression</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> pos, <span style="color: #6666ff; font-weight: bold">size_t</span> inlength)
{
  <span style="color: #666666; font-style: italic">/*go to first boundary of byte*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> p;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> LEN, NLEN, n, error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">while</span>(((<span style="color: #333333">*</span>bp) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0x7</span>) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) (<span style="color: #333333">*</span>bp)<span style="color: #333333">++</span>;
  p <span style="color: #333333">=</span> (<span style="color: #333333">*</span>bp) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>; <span style="color: #666666; font-style: italic">/*byte position*/</span>

  <span style="color: #666666; font-style: italic">/*read LEN (2 bytes) and NLEN (2 bytes)*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(p <span style="color: #333333">&gt;=</span> inlength <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">4</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">52</span>; <span style="color: #666666; font-style: italic">/*error, bit pointer will jump past memory*/</span>
  LEN <span style="color: #333333">=</span> in[p] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> in[p <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>]; p <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">2</span>;
  NLEN <span style="color: #333333">=</span> in[p] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> in[p <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>]; p <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">2</span>;

  <span style="color: #666666; font-style: italic">/*check if 16-bit NLEN is really the one&#39;s complement of LEN*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(LEN <span style="color: #333333">+</span> NLEN <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">65535</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">21</span>; <span style="color: #666666; font-style: italic">/*error: NLEN is not one&#39;s complement of LEN*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(out, (<span style="color: #333333">*</span>pos) <span style="color: #333333">+</span> LEN)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

  <span style="color: #666666; font-style: italic">/*read the literal data: LEN bytes are now stored in the out buffer*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(p <span style="color: #333333">+</span> LEN <span style="color: #333333">&gt;</span> inlength) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">23</span>; <span style="color: #666666; font-style: italic">/*error: reading outside of in buffer*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> LEN; n<span style="color: #333333">++</span>) out<span style="color: #333333">-&gt;</span>data[(<span style="color: #333333">*</span>pos)<span style="color: #333333">++</span>] <span style="color: #333333">=</span> in[p<span style="color: #333333">++</span>];

  (<span style="color: #333333">*</span>bp) <span style="color: #333333">=</span> p <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>;

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_inflatev</span>(ucvector<span style="color: #333333">*</span> out,
                                 <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                                 <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #666666; font-style: italic">/*bit pointer in the &quot;in&quot; data, current byte is bp &gt;&gt; 3, current bit is bp &amp; 0x7 (from lsb to msb of the byte)*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> bp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> BFINAL <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> pos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*byte position in the out buffer*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  (<span style="color: #6666ff; font-weight: bold">void</span>)settings;

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>BFINAL)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> BTYPE;
    <span style="color: #228899; font-weight: bold">if</span>(bp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">&gt;=</span> insize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">52</span>; <span style="color: #666666; font-style: italic">/*error, bit pointer will jump past memory*/</span>
    BFINAL <span style="color: #333333">=</span> readBitFromStream(<span style="color: #333333">&amp;</span>bp, in);
    BTYPE <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1u</span> <span style="color: #333333">*</span> readBitFromStream(<span style="color: #333333">&amp;</span>bp, in);
    BTYPE <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">2u</span> <span style="color: #333333">*</span> readBitFromStream(<span style="color: #333333">&amp;</span>bp, in);

    <span style="color: #228899; font-weight: bold">if</span>(BTYPE <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">3</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">20</span>; <span style="color: #666666; font-style: italic">/*error: invalid BTYPE*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(BTYPE <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) error <span style="color: #333333">=</span> inflateNoCompression(out, in, <span style="color: #333333">&amp;</span>bp, <span style="color: #333333">&amp;</span>pos, insize); <span style="color: #666666; font-style: italic">/*no compression*/</span>
    <span style="color: #228899; font-weight: bold">else</span> error <span style="color: #333333">=</span> inflateHuffmanBlock(out, in, <span style="color: #333333">&amp;</span>bp, <span style="color: #333333">&amp;</span>pos, insize, BTYPE); <span style="color: #666666; font-style: italic">/*compression, BTYPE 01 or 10*/</span>

    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">return</span> error;
  }

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_inflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                         <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  ucvector v;
  ucvector_init_buffer(<span style="color: #333333">&amp;</span>v, <span style="color: #333333">*</span>out, <span style="color: #333333">*</span>outsize);
  error <span style="color: #333333">=</span> lodepng_inflatev(<span style="color: #333333">&amp;</span>v, in, insize, settings);
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> v.data;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> v.size;
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">inflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                        <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>custom_inflate)
  {
    <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_inflate(out, outsize, in, insize, settings);
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #228899; font-weight: bold">return</span> lodepng_inflate(out, outsize, in, insize, settings);
  }
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Deflator (Compressor)                                                  / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">size_t</span> MAX_SUPPORTED_DEFLATE_LENGTH <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">258</span>;

<span style="color: #666666; font-style: italic">/*bitlen is the size in bits of the code*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addHuffmanSymbol</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, ucvector<span style="color: #333333">*</span> compressed, <span style="color: #6666ff; font-weight: bold">unsigned</span> code, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitlen)
{
  addBitsToStreamReversed(bp, compressed, code, bitlen);
}

<span style="color: #666666; font-style: italic">/*search the index in the array, that has the largest value smaller than or equal to the given value,</span>
<span style="color: #666666; font-style: italic">given array must be sorted (if no value is smaller, it returns the size of the given array)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">size_t</span> <span style="color: #55eedd; font-weight: bold">searchCodeIndex</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> array, <span style="color: #6666ff; font-weight: bold">size_t</span> array_size, <span style="color: #6666ff; font-weight: bold">size_t</span> value)
{
  <span style="color: #666666; font-style: italic">/*linear search implementation*/</span>
  <span style="color: #666666; font-style: italic">/*for(size_t i = 1; i &lt; array_size; i++) if(array[i] &gt; value) return i - 1;</span>
<span style="color: #666666; font-style: italic">  return array_size - 1;*/</span>

  <span style="color: #666666; font-style: italic">/*binary search implementation (not that much faster) (precondition: array_size &gt; 0)*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> left  <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> right <span style="color: #333333">=</span> array_size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #228899; font-weight: bold">while</span>(left <span style="color: #333333">&lt;=</span> right)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> mid <span style="color: #333333">=</span> (left <span style="color: #333333">+</span> right) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>;
    <span style="color: #228899; font-weight: bold">if</span>(array[mid] <span style="color: #333333">&lt;=</span> value) left <span style="color: #333333">=</span> mid <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*the value to find is more to the right*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(array[mid <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&gt;</span> value) right <span style="color: #333333">=</span> mid <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*the value to find is more to the left*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> mid <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> array_size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addLengthDistance</span>(uivector<span style="color: #333333">*</span> values, <span style="color: #6666ff; font-weight: bold">size_t</span> length, <span style="color: #6666ff; font-weight: bold">size_t</span> distance)
{
  <span style="color: #666666; font-style: italic">/*values in encoded vector are those used by deflate:</span>
<span style="color: #666666; font-style: italic">  0-255: literal bytes</span>
<span style="color: #666666; font-style: italic">  256: end</span>
<span style="color: #666666; font-style: italic">  257-285: length/distance pair (length code, followed by extra length bits, distance code, extra distance bits)</span>
<span style="color: #666666; font-style: italic">  286-287: invalid*/</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> length_code <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)searchCodeIndex(LENGTHBASE, <span style="color: #6666ff; font-weight: bold">29</span>, length);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> extra_length <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(length <span style="color: #333333">-</span> LENGTHBASE[length_code]);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> dist_code <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)searchCodeIndex(DISTANCEBASE, <span style="color: #6666ff; font-weight: bold">30</span>, distance);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> extra_distance <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(distance <span style="color: #333333">-</span> DISTANCEBASE[dist_code]);

  uivector_push_back(values, length_code <span style="color: #333333">+</span> FIRST_LENGTH_CODE_INDEX);
  uivector_push_back(values, extra_length);
  uivector_push_back(values, dist_code);
  uivector_push_back(values, extra_distance);
}

<span style="color: #666666; font-style: italic">/*3 bytes of data get encoded into two bytes. The hash cannot use more than 3</span>
<span style="color: #666666; font-style: italic">bytes as input because 3 is the minimum match length for deflate*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> HASH_NUM_VALUES <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65536</span>;
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> HASH_BIT_MASK <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span>; <span style="color: #666666; font-style: italic">/*HASH_NUM_VALUES - 1, but C90 does not like that as initializer*/</span>

<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> Hash
{
  <span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span> head; <span style="color: #666666; font-style: italic">/*hash value to head circular pos - can be outdated if went around window*/</span>
  <span style="color: #666666; font-style: italic">/*circular pos to prev circular pos*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> chain;
  <span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span> val; <span style="color: #666666; font-style: italic">/*circular pos to hash value*/</span>

  <span style="color: #666666; font-style: italic">/*TODO: do this not only for zeros but for any repeated byte. However for PNG</span>
<span style="color: #666666; font-style: italic">  it&#39;s always going to be the zeros that dominate, so not important for PNG*/</span>
  <span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span> headz; <span style="color: #666666; font-style: italic">/*similar to head, but for chainz*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> chainz; <span style="color: #666666; font-style: italic">/*those with same amount of zeros*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> zeros; <span style="color: #666666; font-style: italic">/*length of zeros streak, used as a second hash chain*/</span>
} Hash;

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">hash_init</span>(Hash<span style="color: #333333">*</span> hash, <span style="color: #6666ff; font-weight: bold">unsigned</span> windowsize)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  hash<span style="color: #333333">-&gt;</span>head <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">int</span>) <span style="color: #333333">*</span> HASH_NUM_VALUES);
  hash<span style="color: #333333">-&gt;</span>val <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">int</span>) <span style="color: #333333">*</span> windowsize);
  hash<span style="color: #333333">-&gt;</span>chain <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span>) <span style="color: #333333">*</span> windowsize);

  hash<span style="color: #333333">-&gt;</span>zeros <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span>) <span style="color: #333333">*</span> windowsize);
  hash<span style="color: #333333">-&gt;</span>headz <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">int</span>) <span style="color: #333333">*</span> (MAX_SUPPORTED_DEFLATE_LENGTH <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>));
  hash<span style="color: #333333">-&gt;</span>chainz <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span>) <span style="color: #333333">*</span> windowsize);

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>head <span style="color: #333333">||</span> <span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>chain <span style="color: #333333">||</span> <span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>val  <span style="color: #333333">||</span> <span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>headz<span style="color: #333333">||</span> <span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>chainz <span style="color: #333333">||</span> <span style="color: #333333">!</span>hash<span style="color: #333333">-&gt;</span>zeros)
  {
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  }

  <span style="color: #666666; font-style: italic">/*initialize hash table*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> HASH_NUM_VALUES; i<span style="color: #333333">++</span>) hash<span style="color: #333333">-&gt;</span>head[i] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> windowsize; i<span style="color: #333333">++</span>) hash<span style="color: #333333">-&gt;</span>val[i] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> windowsize; i<span style="color: #333333">++</span>) hash<span style="color: #333333">-&gt;</span>chain[i] <span style="color: #333333">=</span> i; <span style="color: #666666; font-style: italic">/*same value as index indicates uninitialized*/</span>

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;=</span> MAX_SUPPORTED_DEFLATE_LENGTH; i<span style="color: #333333">++</span>) hash<span style="color: #333333">-&gt;</span>headz[i] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> windowsize; i<span style="color: #333333">++</span>) hash<span style="color: #333333">-&gt;</span>chainz[i] <span style="color: #333333">=</span> i; <span style="color: #666666; font-style: italic">/*same value as index indicates uninitialized*/</span>

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">hash_cleanup</span>(Hash<span style="color: #333333">*</span> hash)
{
  lodepng_free(hash<span style="color: #333333">-&gt;</span>head);
  lodepng_free(hash<span style="color: #333333">-&gt;</span>val);
  lodepng_free(hash<span style="color: #333333">-&gt;</span>chain);

  lodepng_free(hash<span style="color: #333333">-&gt;</span>zeros);
  lodepng_free(hash<span style="color: #333333">-&gt;</span>headz);
  lodepng_free(hash<span style="color: #333333">-&gt;</span>chainz);
}



<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">getHash</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> size, <span style="color: #6666ff; font-weight: bold">size_t</span> pos)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> result <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span> (pos <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">&lt;</span> size)
  {
    <span style="color: #666666; font-style: italic">/*A simple shift and xor hash is used. Since the data of PNGs is dominated</span>
<span style="color: #666666; font-style: italic">    by zeroes due to the filters, a better hash does not have a significant</span>
<span style="color: #666666; font-style: italic">    effect on speed in traversing the chain, and causes more time spend on</span>
<span style="color: #666666; font-style: italic">    calculating the hash.*/</span>
    result <span style="color: #333333">^=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(data[pos <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">0u</span>);
    result <span style="color: #333333">^=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(data[pos <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">4u</span>);
    result <span style="color: #333333">^=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(data[pos <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">8u</span>);
  } <span style="color: #228899; font-weight: bold">else</span> {
    <span style="color: #6666ff; font-weight: bold">size_t</span> amount, i;
    <span style="color: #228899; font-weight: bold">if</span>(pos <span style="color: #333333">&gt;=</span> size) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    amount <span style="color: #333333">=</span> size <span style="color: #333333">-</span> pos;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> amount; i<span style="color: #333333">++</span>) result <span style="color: #333333">^=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(data[pos <span style="color: #333333">+</span> i] <span style="color: #333333">&lt;&lt;</span> (i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8u</span>));
  }
  <span style="color: #228899; font-weight: bold">return</span> result <span style="color: #333333">&amp;</span> HASH_BIT_MASK;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">countZeros</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> size, <span style="color: #6666ff; font-weight: bold">size_t</span> pos)
{
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> start <span style="color: #333333">=</span> data <span style="color: #333333">+</span> pos;
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> end <span style="color: #333333">=</span> start <span style="color: #333333">+</span> MAX_SUPPORTED_DEFLATE_LENGTH;
  <span style="color: #228899; font-weight: bold">if</span>(end <span style="color: #333333">&gt;</span> data <span style="color: #333333">+</span> size) end <span style="color: #333333">=</span> data <span style="color: #333333">+</span> size;
  data <span style="color: #333333">=</span> start;
  <span style="color: #228899; font-weight: bold">while</span> (data <span style="color: #333333">!=</span> end <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>data <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) data<span style="color: #333333">++</span>;
  <span style="color: #666666; font-style: italic">/*subtracting two addresses returned as 32-bit number (max value is MAX_SUPPORTED_DEFLATE_LENGTH)*/</span>
  <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(data <span style="color: #333333">-</span> start);
}

<span style="color: #666666; font-style: italic">/*wpos = pos &amp; (windowsize - 1)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">updateHashChain</span>(Hash<span style="color: #333333">*</span> hash, <span style="color: #6666ff; font-weight: bold">size_t</span> wpos, <span style="color: #6666ff; font-weight: bold">unsigned</span> hashval, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> numzeros)
{
  hash<span style="color: #333333">-&gt;</span>val[wpos] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">int</span>)hashval;
  <span style="color: #228899; font-weight: bold">if</span>(hash<span style="color: #333333">-&gt;</span>head[hashval] <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>) hash<span style="color: #333333">-&gt;</span>chain[wpos] <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>head[hashval];
  hash<span style="color: #333333">-&gt;</span>head[hashval] <span style="color: #333333">=</span> wpos;

  hash<span style="color: #333333">-&gt;</span>zeros[wpos] <span style="color: #333333">=</span> numzeros;
  <span style="color: #228899; font-weight: bold">if</span>(hash<span style="color: #333333">-&gt;</span>headz[numzeros] <span style="color: #333333">!=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>) hash<span style="color: #333333">-&gt;</span>chainz[wpos] <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>headz[numzeros];
  hash<span style="color: #333333">-&gt;</span>headz[numzeros] <span style="color: #333333">=</span> wpos;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">LZ77-encode the data. Return value is error code. The input are raw bytes, the output</span>
<span style="color: #666666; font-style: italic">is in the form of unsigned integers with codes representing for example literal bytes, or</span>
<span style="color: #666666; font-style: italic">length/distance pairs.</span>
<span style="color: #666666; font-style: italic">It uses a hash table technique to let it encode faster. When doing LZ77 encoding, a</span>
<span style="color: #666666; font-style: italic">sliding window (of windowsize) is used, and all past bytes in that window can be used as</span>
<span style="color: #666666; font-style: italic">the &quot;dictionary&quot;. A brute force search through all possible distances would be slow, and</span>
<span style="color: #666666; font-style: italic">this hash technique is one out of several ways to speed this up.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encodeLZ77</span>(uivector<span style="color: #333333">*</span> out, Hash<span style="color: #333333">*</span> hash,
                           <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> inpos, <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #6666ff; font-weight: bold">unsigned</span> windowsize,
                           <span style="color: #6666ff; font-weight: bold">unsigned</span> minmatch, <span style="color: #6666ff; font-weight: bold">unsigned</span> nicematch, <span style="color: #6666ff; font-weight: bold">unsigned</span> lazymatching)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> pos;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i, error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #666666; font-style: italic">/*for large window lengths, assume the user wants no compression loss. Otherwise, max hash chain length speedup.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> maxchainlength <span style="color: #333333">=</span> windowsize <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">8192</span> <span style="color: #333333">?</span> windowsize <span style="color: #333333">:</span> windowsize <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> maxlazymatch <span style="color: #333333">=</span> windowsize <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">8192</span> <span style="color: #333333">?</span> MAX_SUPPORTED_DEFLATE_LENGTH <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">64</span>;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> usezeros <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*not sure if setting it to false for windowsize &lt; 8192 is better or worse*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> numzeros <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> offset; <span style="color: #666666; font-style: italic">/*the offset represents the distance in LZ77 terminology*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> length;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> lazy <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> lazylength <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, lazyoffset <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> hashval;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> current_offset, current_length;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> prev_offset;
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>lastptr, <span style="color: #333333">*</span>foreptr, <span style="color: #333333">*</span>backptr;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> hashpos;

  <span style="color: #228899; font-weight: bold">if</span>(windowsize <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> windowsize <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">32768</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">60</span>; <span style="color: #666666; font-style: italic">/*error: windowsize smaller/larger than allowed*/</span>
  <span style="color: #228899; font-weight: bold">if</span>((windowsize <span style="color: #333333">&amp;</span> (windowsize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>)) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">90</span>; <span style="color: #666666; font-style: italic">/*error: must be power of two*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(nicematch <span style="color: #333333">&gt;</span> MAX_SUPPORTED_DEFLATE_LENGTH) nicematch <span style="color: #333333">=</span> MAX_SUPPORTED_DEFLATE_LENGTH;

  <span style="color: #228899; font-weight: bold">for</span>(pos <span style="color: #333333">=</span> inpos; pos <span style="color: #333333">&lt;</span> insize; pos<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> wpos <span style="color: #333333">=</span> pos <span style="color: #333333">&amp;</span> (windowsize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*position for in &#39;circular&#39; hash buffers*/</span>
    <span style="color: #6666ff; font-weight: bold">unsigned</span> chainlength <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

    hashval <span style="color: #333333">=</span> getHash(in, insize, pos);

    <span style="color: #228899; font-weight: bold">if</span>(usezeros <span style="color: #333333">&amp;&amp;</span> hashval <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span> (numzeros <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) numzeros <span style="color: #333333">=</span> countZeros(in, insize, pos);
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span> (pos <span style="color: #333333">+</span> numzeros <span style="color: #333333">&gt;</span> insize <span style="color: #333333">||</span> in[pos <span style="color: #333333">+</span> numzeros <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) numzeros<span style="color: #333333">--</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      numzeros <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    }

    updateHashChain(hash, wpos, hashval, numzeros);

    <span style="color: #666666; font-style: italic">/*the length and offset found for the current position*/</span>
    length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    offset <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

    hashpos <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>chain[wpos];

    lastptr <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[insize <span style="color: #333333">&lt;</span> pos <span style="color: #333333">+</span> MAX_SUPPORTED_DEFLATE_LENGTH <span style="color: #333333">?</span> insize <span style="color: #333333">:</span> pos <span style="color: #333333">+</span> MAX_SUPPORTED_DEFLATE_LENGTH];

    <span style="color: #666666; font-style: italic">/*search for the longest string*/</span>
    prev_offset <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(;;)
    {
      <span style="color: #228899; font-weight: bold">if</span>(chainlength<span style="color: #333333">++</span> <span style="color: #333333">&gt;=</span> maxchainlength) <span style="color: #228899; font-weight: bold">break</span>;
      current_offset <span style="color: #333333">=</span> hashpos <span style="color: #333333">&lt;=</span> wpos <span style="color: #333333">?</span> wpos <span style="color: #333333">-</span> hashpos <span style="color: #333333">:</span> wpos <span style="color: #333333">-</span> hashpos <span style="color: #333333">+</span> windowsize;

      <span style="color: #228899; font-weight: bold">if</span>(current_offset <span style="color: #333333">&lt;</span> prev_offset) <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*stop when went completely around the circular buffer*/</span>
      prev_offset <span style="color: #333333">=</span> current_offset;
      <span style="color: #228899; font-weight: bold">if</span>(current_offset <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
      {
        <span style="color: #666666; font-style: italic">/*test the next characters*/</span>
        foreptr <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[pos];
        backptr <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[pos <span style="color: #333333">-</span> current_offset];

        <span style="color: #666666; font-style: italic">/*common case in PNGs is lots of zeros. Quickly skip over them as a speedup*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(numzeros <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span>)
        {
          <span style="color: #6666ff; font-weight: bold">unsigned</span> skip <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>zeros[hashpos];
          <span style="color: #228899; font-weight: bold">if</span>(skip <span style="color: #333333">&gt;</span> numzeros) skip <span style="color: #333333">=</span> numzeros;
          backptr <span style="color: #333333">+=</span> skip;
          foreptr <span style="color: #333333">+=</span> skip;
        }

        <span style="color: #228899; font-weight: bold">while</span>(foreptr <span style="color: #333333">!=</span> lastptr <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>backptr <span style="color: #333333">==</span> <span style="color: #333333">*</span>foreptr) <span style="color: #666666; font-style: italic">/*maximum supported length by deflate is max length*/</span>
        {
          <span style="color: #333333">++</span>backptr;
          <span style="color: #333333">++</span>foreptr;
        }
        current_length <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(foreptr <span style="color: #333333">-</span> <span style="color: #333333">&amp;</span>in[pos]);

        <span style="color: #228899; font-weight: bold">if</span>(current_length <span style="color: #333333">&gt;</span> length)
        {
          length <span style="color: #333333">=</span> current_length; <span style="color: #666666; font-style: italic">/*the longest length*/</span>
          offset <span style="color: #333333">=</span> current_offset; <span style="color: #666666; font-style: italic">/*the offset that is related to this longest length*/</span>
          <span style="color: #666666; font-style: italic">/*jump out once a length of max length is found (speed gain). This also jumps</span>
<span style="color: #666666; font-style: italic">          out if length is MAX_SUPPORTED_DEFLATE_LENGTH*/</span>
          <span style="color: #228899; font-weight: bold">if</span>(current_length <span style="color: #333333">&gt;=</span> nicematch) <span style="color: #228899; font-weight: bold">break</span>;
        }
      }

      <span style="color: #228899; font-weight: bold">if</span>(hashpos <span style="color: #333333">==</span> hash<span style="color: #333333">-&gt;</span>chain[hashpos]) <span style="color: #228899; font-weight: bold">break</span>;
      
      <span style="color: #228899; font-weight: bold">if</span>(numzeros <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&amp;&amp;</span> length <span style="color: #333333">&gt;</span> numzeros) {
        hashpos <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>chainz[hashpos];
        <span style="color: #228899; font-weight: bold">if</span>(hash<span style="color: #333333">-&gt;</span>zeros[hashpos] <span style="color: #333333">!=</span> numzeros) <span style="color: #228899; font-weight: bold">break</span>;
      } <span style="color: #228899; font-weight: bold">else</span> {
        hashpos <span style="color: #333333">=</span> hash<span style="color: #333333">-&gt;</span>chain[hashpos];
        <span style="color: #666666; font-style: italic">/*outdated hash value, happens if particular value was not encountered in whole last window*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(hash<span style="color: #333333">-&gt;</span>val[hashpos] <span style="color: #333333">!=</span> (<span style="color: #6666ff; font-weight: bold">int</span>)hashval) <span style="color: #228899; font-weight: bold">break</span>;
      }
    }

    <span style="color: #228899; font-weight: bold">if</span>(lazymatching)
    {
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>lazy <span style="color: #333333">&amp;&amp;</span> length <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&amp;&amp;</span> length <span style="color: #333333">&lt;=</span> maxlazymatch <span style="color: #333333">&amp;&amp;</span> length <span style="color: #333333">&lt;</span> MAX_SUPPORTED_DEFLATE_LENGTH)
      {
        lazy <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        lazylength <span style="color: #333333">=</span> length;
        lazyoffset <span style="color: #333333">=</span> offset;
        <span style="color: #228899; font-weight: bold">continue</span>; <span style="color: #666666; font-style: italic">/*try the next byte*/</span>
      }
      <span style="color: #228899; font-weight: bold">if</span>(lazy)
      {
        lazy <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        <span style="color: #228899; font-weight: bold">if</span>(pos <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">81</span>);
        <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&gt;</span> lazylength <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)
        {
          <span style="color: #666666; font-style: italic">/*push the previous character as literal*/</span>
          <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_push_back(out, in[pos <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>])) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
        }
        <span style="color: #228899; font-weight: bold">else</span>
        {
          length <span style="color: #333333">=</span> lazylength;
          offset <span style="color: #333333">=</span> lazyoffset;
          hash<span style="color: #333333">-&gt;</span>head[hashval] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*the same hashchain update will be done, this ensures no wrong alteration*/</span>
          hash<span style="color: #333333">-&gt;</span>headz[numzeros] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*idem*/</span>
          pos<span style="color: #333333">--</span>;
        }
      }
    }
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&amp;&amp;</span> offset <span style="color: #333333">&gt;</span> windowsize) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">86</span> <span style="color: #666666; font-style: italic">/*too big (or overflown negative) offset*/</span>);

    <span style="color: #666666; font-style: italic">/*encode it as length/distance pair or literal value*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">3</span>) <span style="color: #666666; font-style: italic">/*only lengths of 3 or higher are supported as length/distance pair*/</span>
    {
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_push_back(out, in[pos])) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&lt;</span> minmatch <span style="color: #333333">||</span> (length <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&amp;&amp;</span> offset <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">4096</span>))
    {
      <span style="color: #666666; font-style: italic">/*compensate for the fact that longer offsets have more extra bits, a</span>
<span style="color: #666666; font-style: italic">      length of only 3 may be not worth it then*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_push_back(out, in[pos])) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      addLengthDistance(out, length, offset);
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>)
      {
        pos<span style="color: #333333">++</span>;
        wpos <span style="color: #333333">=</span> pos <span style="color: #333333">&amp;</span> (windowsize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
        hashval <span style="color: #333333">=</span> getHash(in, insize, pos);
        <span style="color: #228899; font-weight: bold">if</span>(usezeros <span style="color: #333333">&amp;&amp;</span> hashval <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
        {
          <span style="color: #228899; font-weight: bold">if</span> (numzeros <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) numzeros <span style="color: #333333">=</span> countZeros(in, insize, pos);
          <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span> (pos <span style="color: #333333">+</span> numzeros <span style="color: #333333">&gt;</span> insize <span style="color: #333333">||</span> in[pos <span style="color: #333333">+</span> numzeros <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) numzeros<span style="color: #333333">--</span>;
        }
        <span style="color: #228899; font-weight: bold">else</span>
        {
          numzeros <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        }
        updateHashChain(hash, wpos, hashval, numzeros);
      }
    }
  } <span style="color: #666666; font-style: italic">/*end of the loop through each character of input*/</span>

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/* /////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">deflateNoCompression</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> datasize)
{
  <span style="color: #666666; font-style: italic">/*non compressed deflate block data: 1 bit BFINAL,2 bits BTYPE,(5 bits): it jumps to start of next byte,</span>
<span style="color: #666666; font-style: italic">  2 bytes LEN, 2 bytes NLEN, LEN bytes literal DATA*/</span>

  <span style="color: #6666ff; font-weight: bold">size_t</span> i, j, numdeflateblocks <span style="color: #333333">=</span> (datasize <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">65534</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">65535</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> datapos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numdeflateblocks; i<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> BFINAL, BTYPE, LEN, NLEN;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> firstbyte;

    BFINAL <span style="color: #333333">=</span> (i <span style="color: #333333">==</span> numdeflateblocks <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    BTYPE <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

    firstbyte <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(BFINAL <span style="color: #333333">+</span> ((BTYPE <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> ((BTYPE <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>));
    ucvector_push_back(out, firstbyte);

    LEN <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span>;
    <span style="color: #228899; font-weight: bold">if</span>(datasize <span style="color: #333333">-</span> datapos <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">65535</span>) LEN <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)datasize <span style="color: #333333">-</span> datapos;
    NLEN <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span> <span style="color: #333333">-</span> LEN;

    ucvector_push_back(out, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(LEN <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(out, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(LEN <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(out, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(NLEN <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(out, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(NLEN <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));

    <span style="color: #666666; font-style: italic">/*Decompressed data*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; j <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">65535</span> <span style="color: #333333">&amp;&amp;</span> datapos <span style="color: #333333">&lt;</span> datasize; j<span style="color: #333333">++</span>)
    {
      ucvector_push_back(out, data[datapos<span style="color: #333333">++</span>]);
    }
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">write the lz77-encoded data, which has lit, len and dist codes, to compressed stream using huffman trees.</span>
<span style="color: #666666; font-style: italic">tree_ll: the tree for lit and len codes.</span>
<span style="color: #666666; font-style: italic">tree_d: the tree for distance codes.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">writeLZ77data</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> uivector<span style="color: #333333">*</span> lz77_encoded,
                          <span style="color: #228899; font-weight: bold">const</span> HuffmanTree<span style="color: #333333">*</span> tree_ll, <span style="color: #228899; font-weight: bold">const</span> HuffmanTree<span style="color: #333333">*</span> tree_d)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> lz77_encoded<span style="color: #333333">-&gt;</span>size; i<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> val <span style="color: #333333">=</span> lz77_encoded<span style="color: #333333">-&gt;</span>data[i];
    addHuffmanSymbol(bp, out, HuffmanTree_getCode(tree_ll, val), HuffmanTree_getLength(tree_ll, val));
    <span style="color: #228899; font-weight: bold">if</span>(val <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">256</span>) <span style="color: #666666; font-style: italic">/*for a length code, 3 more things have to be added*/</span>
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> length_index <span style="color: #333333">=</span> val <span style="color: #333333">-</span> FIRST_LENGTH_CODE_INDEX;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> n_length_extra_bits <span style="color: #333333">=</span> LENGTHEXTRA[length_index];
      <span style="color: #6666ff; font-weight: bold">unsigned</span> length_extra_bits <span style="color: #333333">=</span> lz77_encoded<span style="color: #333333">-&gt;</span>data[<span style="color: #333333">++</span>i];

      <span style="color: #6666ff; font-weight: bold">unsigned</span> distance_code <span style="color: #333333">=</span> lz77_encoded<span style="color: #333333">-&gt;</span>data[<span style="color: #333333">++</span>i];

      <span style="color: #6666ff; font-weight: bold">unsigned</span> distance_index <span style="color: #333333">=</span> distance_code;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> n_distance_extra_bits <span style="color: #333333">=</span> DISTANCEEXTRA[distance_index];
      <span style="color: #6666ff; font-weight: bold">unsigned</span> distance_extra_bits <span style="color: #333333">=</span> lz77_encoded<span style="color: #333333">-&gt;</span>data[<span style="color: #333333">++</span>i];

      addBitsToStream(bp, out, length_extra_bits, n_length_extra_bits);
      addHuffmanSymbol(bp, out, HuffmanTree_getCode(tree_d, distance_code),
                       HuffmanTree_getLength(tree_d, distance_code));
      addBitsToStream(bp, out, distance_extra_bits, n_distance_extra_bits);
    }
  }
}

<span style="color: #666666; font-style: italic">/*Deflate for a block of type &quot;dynamic&quot;, that is, with freely, optimally, created huffman trees*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">deflateDynamic</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, Hash<span style="color: #333333">*</span> hash,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> datapos, <span style="color: #6666ff; font-weight: bold">size_t</span> dataend,
                               <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings, <span style="color: #6666ff; font-weight: bold">unsigned</span> final)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  A block is compressed as follows: The PNG data is lz77 encoded, resulting in</span>
<span style="color: #666666; font-style: italic">  literal bytes and length/distance pairs. This is then huffman compressed with</span>
<span style="color: #666666; font-style: italic">  two huffman trees. One huffman tree is used for the lit and len values (&quot;ll&quot;),</span>
<span style="color: #666666; font-style: italic">  another huffman tree is used for the dist values (&quot;d&quot;). These two trees are</span>
<span style="color: #666666; font-style: italic">  stored using their code lengths, and to compress even more these code lengths</span>
<span style="color: #666666; font-style: italic">  are also run-length encoded and huffman compressed. This gives a huffman tree</span>
<span style="color: #666666; font-style: italic">  of code lengths &quot;cl&quot;. The code lenghts used to describe this third tree are</span>
<span style="color: #666666; font-style: italic">  the code length code lengths (&quot;clcl&quot;).</span>
<span style="color: #666666; font-style: italic">  */</span>

  <span style="color: #666666; font-style: italic">/*The lz77 encoded data, represented with integers since there will also be length and distance codes in it*/</span>
  uivector lz77_encoded;
  HuffmanTree tree_ll; <span style="color: #666666; font-style: italic">/*tree for lit,len values*/</span>
  HuffmanTree tree_d; <span style="color: #666666; font-style: italic">/*tree for distance codes*/</span>
  HuffmanTree tree_cl; <span style="color: #666666; font-style: italic">/*tree for encoding the code lengths representing tree_ll and tree_d*/</span>
  uivector frequencies_ll; <span style="color: #666666; font-style: italic">/*frequency of lit,len codes*/</span>
  uivector frequencies_d; <span style="color: #666666; font-style: italic">/*frequency of dist codes*/</span>
  uivector frequencies_cl; <span style="color: #666666; font-style: italic">/*frequency of code length codes*/</span>
  uivector bitlen_lld; <span style="color: #666666; font-style: italic">/*lit,len,dist code lenghts (int bits), literally (without repeat codes).*/</span>
  uivector bitlen_lld_e; <span style="color: #666666; font-style: italic">/*bitlen_lld encoded with repeat codes (this is a rudemtary run length compression)*/</span>
  <span style="color: #666666; font-style: italic">/*bitlen_cl is the code length code lengths (&quot;clcl&quot;). The bit lengths of codes to represent tree_cl</span>
<span style="color: #666666; font-style: italic">  (these are written as is in the file, it would be crazy to compress these using yet another huffman</span>
<span style="color: #666666; font-style: italic">  tree that needs to be represented by yet another set of code lengths)*/</span>
  uivector bitlen_cl;
  <span style="color: #6666ff; font-weight: bold">size_t</span> datasize <span style="color: #333333">=</span> dataend <span style="color: #333333">-</span> datapos;

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  Due to the huffman compression of huffman tree representations (&quot;two levels&quot;), there are some anologies:</span>
<span style="color: #666666; font-style: italic">  bitlen_lld is to tree_cl what data is to tree_ll and tree_d.</span>
<span style="color: #666666; font-style: italic">  bitlen_lld_e is to bitlen_lld what lz77_encoded is to data.</span>
<span style="color: #666666; font-style: italic">  bitlen_cl is to bitlen_lld_e what bitlen_lld is to lz77_encoded.</span>
<span style="color: #666666; font-style: italic">  */</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> BFINAL <span style="color: #333333">=</span> final;
  <span style="color: #6666ff; font-weight: bold">size_t</span> numcodes_ll, numcodes_d, i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> HLIT, HDIST, HCLEN;

  uivector_init(<span style="color: #333333">&amp;</span>lz77_encoded);
  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_d);
  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_cl);
  uivector_init(<span style="color: #333333">&amp;</span>frequencies_ll);
  uivector_init(<span style="color: #333333">&amp;</span>frequencies_d);
  uivector_init(<span style="color: #333333">&amp;</span>frequencies_cl);
  uivector_init(<span style="color: #333333">&amp;</span>bitlen_lld);
  uivector_init(<span style="color: #333333">&amp;</span>bitlen_lld_e);
  uivector_init(<span style="color: #333333">&amp;</span>bitlen_cl);

  <span style="color: #666666; font-style: italic">/*This while loop never loops due to a break at the end, it is here to</span>
<span style="color: #666666; font-style: italic">  allow breaking out of it to the cleanup phase on error conditions.*/</span>
  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error)
  {
    <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>use_lz77)
    {
      error <span style="color: #333333">=</span> encodeLZ77(<span style="color: #333333">&amp;</span>lz77_encoded, hash, data, datapos, dataend, settings<span style="color: #333333">-&gt;</span>windowsize,
                         settings<span style="color: #333333">-&gt;</span>minmatch, settings<span style="color: #333333">-&gt;</span>nicematch, settings<span style="color: #333333">-&gt;</span>lazymatching);
      <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(<span style="color: #333333">&amp;</span>lz77_encoded, datasize)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> datapos; i <span style="color: #333333">&lt;</span> dataend; i<span style="color: #333333">++</span>) lz77_encoded.data[i] <span style="color: #333333">=</span> data[i]; <span style="color: #666666; font-style: italic">/*no LZ77, but still will be Huffman compressed*/</span>
    }

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resizev(<span style="color: #333333">&amp;</span>frequencies_ll, <span style="color: #6666ff; font-weight: bold">286</span>, <span style="color: #6666ff; font-weight: bold">0</span>)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resizev(<span style="color: #333333">&amp;</span>frequencies_d, <span style="color: #6666ff; font-weight: bold">30</span>, <span style="color: #6666ff; font-weight: bold">0</span>)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);

    <span style="color: #666666; font-style: italic">/*Count the frequencies of lit, len and dist codes*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> lz77_encoded.size; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> symbol <span style="color: #333333">=</span> lz77_encoded.data[i];
      frequencies_ll.data[symbol]<span style="color: #333333">++</span>;
      <span style="color: #228899; font-weight: bold">if</span>(symbol <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">256</span>)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> dist <span style="color: #333333">=</span> lz77_encoded.data[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        frequencies_d.data[dist]<span style="color: #333333">++</span>;
        i <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">3</span>;
      }
    }
    frequencies_ll.data[<span style="color: #6666ff; font-weight: bold">256</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*there will be exactly 1 end code, at the end of the block*/</span>

    <span style="color: #666666; font-style: italic">/*Make both huffman trees, one for the lit and len codes, one for the dist codes*/</span>
    error <span style="color: #333333">=</span> HuffmanTree_makeFromFrequencies(<span style="color: #333333">&amp;</span>tree_ll, frequencies_ll.data, <span style="color: #6666ff; font-weight: bold">257</span>, frequencies_ll.size, <span style="color: #6666ff; font-weight: bold">15</span>);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #666666; font-style: italic">/*2, not 1, is chosen for mincodes: some buggy PNG decoders require at least 2 symbols in the dist tree*/</span>
    error <span style="color: #333333">=</span> HuffmanTree_makeFromFrequencies(<span style="color: #333333">&amp;</span>tree_d, frequencies_d.data, <span style="color: #6666ff; font-weight: bold">2</span>, frequencies_d.size, <span style="color: #6666ff; font-weight: bold">15</span>);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;

    numcodes_ll <span style="color: #333333">=</span> tree_ll.numcodes; <span style="color: #228899; font-weight: bold">if</span>(numcodes_ll <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">286</span>) numcodes_ll <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">286</span>;
    numcodes_d <span style="color: #333333">=</span> tree_d.numcodes; <span style="color: #228899; font-weight: bold">if</span>(numcodes_d <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">30</span>) numcodes_d <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">30</span>;
    <span style="color: #666666; font-style: italic">/*store the code lengths of both generated trees in bitlen_lld*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes_ll; i<span style="color: #333333">++</span>) uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld, HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_ll, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)i));
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numcodes_d; i<span style="color: #333333">++</span>) uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld, HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_d, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)i));

    <span style="color: #666666; font-style: italic">/*run-length compress bitlen_ldd into bitlen_lld_e by using repeat codes 16 (copy length 3-6 times),</span>
<span style="color: #666666; font-style: italic">    17 (3-10 zeroes), 18 (11-138 zeroes)*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)bitlen_lld.size; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*amount of repititions*/</span>
      <span style="color: #228899; font-weight: bold">while</span>(i <span style="color: #333333">+</span> j <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">&lt;</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)bitlen_lld.size <span style="color: #333333">&amp;&amp;</span> bitlen_lld.data[i <span style="color: #333333">+</span> j <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> bitlen_lld.data[i]) j<span style="color: #333333">++</span>;

      <span style="color: #228899; font-weight: bold">if</span>(bitlen_lld.data[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">&amp;&amp;</span> j <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #666666; font-style: italic">/*repeat code for zeroes*/</span>
      {
        j<span style="color: #333333">++</span>; <span style="color: #666666; font-style: italic">/*include the first zero*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(j <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">10</span>) <span style="color: #666666; font-style: italic">/*repeat code 17 supports max 10 zeroes*/</span>
        {
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, <span style="color: #6666ff; font-weight: bold">17</span>);
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, j <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">3</span>);
        }
        <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*repeat code 18 supports max 138 zeroes*/</span>
        {
          <span style="color: #228899; font-weight: bold">if</span>(j <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">138</span>) j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">138</span>;
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, <span style="color: #6666ff; font-weight: bold">18</span>);
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, j <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">11</span>);
        }
        i <span style="color: #333333">+=</span> (j <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(j <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span>) <span style="color: #666666; font-style: italic">/*repeat code for value other than zero*/</span>
      {
        <span style="color: #6666ff; font-weight: bold">size_t</span> k;
        <span style="color: #6666ff; font-weight: bold">unsigned</span> num <span style="color: #333333">=</span> j <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">6</span>, rest <span style="color: #333333">=</span> j <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">6</span>;
        uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, bitlen_lld.data[i]);
        <span style="color: #228899; font-weight: bold">for</span>(k <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; k <span style="color: #333333">&lt;</span> num; k<span style="color: #333333">++</span>)
        {
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, <span style="color: #6666ff; font-weight: bold">16</span>);
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">3</span>);
        }
        <span style="color: #228899; font-weight: bold">if</span>(rest <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">3</span>)
        {
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, <span style="color: #6666ff; font-weight: bold">16</span>);
          uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, rest <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">3</span>);
        }
        <span style="color: #228899; font-weight: bold">else</span> j <span style="color: #333333">-=</span> rest;
        i <span style="color: #333333">+=</span> j;
      }
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*too short to benefit from repeat code*/</span>
      {
        uivector_push_back(<span style="color: #333333">&amp;</span>bitlen_lld_e, bitlen_lld.data[i]);
      }
    }

    <span style="color: #666666; font-style: italic">/*generate tree_cl, the huffmantree of huffmantrees*/</span>

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resizev(<span style="color: #333333">&amp;</span>frequencies_cl, NUM_CODE_LENGTH_CODES, <span style="color: #6666ff; font-weight: bold">0</span>)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bitlen_lld_e.size; i<span style="color: #333333">++</span>)
    {
      frequencies_cl.data[bitlen_lld_e.data[i]]<span style="color: #333333">++</span>;
      <span style="color: #666666; font-style: italic">/*after a repeat code come the bits that specify the number of repetitions,</span>
<span style="color: #666666; font-style: italic">      those don&#39;t need to be in the frequencies_cl calculation*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(bitlen_lld_e.data[i] <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">16</span>) i<span style="color: #333333">++</span>;
    }

    error <span style="color: #333333">=</span> HuffmanTree_makeFromFrequencies(<span style="color: #333333">&amp;</span>tree_cl, frequencies_cl.data,
                                            frequencies_cl.size, frequencies_cl.size, <span style="color: #6666ff; font-weight: bold">7</span>);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(<span style="color: #333333">&amp;</span>bitlen_cl, tree_cl.numcodes)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> tree_cl.numcodes; i<span style="color: #333333">++</span>)
    {
      <span style="color: #666666; font-style: italic">/*lenghts of code length tree is in the order as specified by deflate*/</span>
      bitlen_cl.data[i] <span style="color: #333333">=</span> HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_cl, CLCL_ORDER[i]);
    }
    <span style="color: #228899; font-weight: bold">while</span>(bitlen_cl.data[bitlen_cl.size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">&amp;&amp;</span> bitlen_cl.size <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">4</span>)
    {
      <span style="color: #666666; font-style: italic">/*remove zeros at the end, but minimum size must be 4*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>uivector_resize(<span style="color: #333333">&amp;</span>bitlen_cl, bitlen_cl.size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>)) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
    }
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;

    <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">    Write everything into the output</span>

<span style="color: #666666; font-style: italic">    After the BFINAL and BTYPE, the dynamic block consists out of the following:</span>
<span style="color: #666666; font-style: italic">    - 5 bits HLIT, 5 bits HDIST, 4 bits HCLEN</span>
<span style="color: #666666; font-style: italic">    - (HCLEN+4)*3 bits code lengths of code length alphabet</span>
<span style="color: #666666; font-style: italic">    - HLIT + 257 code lenghts of lit/length alphabet (encoded using the code length</span>
<span style="color: #666666; font-style: italic">      alphabet, + possible repetition codes 16, 17, 18)</span>
<span style="color: #666666; font-style: italic">    - HDIST + 1 code lengths of distance alphabet (encoded using the code length</span>
<span style="color: #666666; font-style: italic">      alphabet, + possible repetition codes 16, 17, 18)</span>
<span style="color: #666666; font-style: italic">    - compressed data</span>
<span style="color: #666666; font-style: italic">    - 256 (end code)</span>
<span style="color: #666666; font-style: italic">    */</span>

    <span style="color: #666666; font-style: italic">/*Write block type*/</span>
    addBitToStream(bp, out, BFINAL);
    addBitToStream(bp, out, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*first bit of BTYPE &quot;dynamic&quot;*/</span>
    addBitToStream(bp, out, <span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*second bit of BTYPE &quot;dynamic&quot;*/</span>

    <span style="color: #666666; font-style: italic">/*write the HLIT, HDIST and HCLEN values*/</span>
    HLIT <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(numcodes_ll <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">257</span>);
    HDIST <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(numcodes_d <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    HCLEN <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)bitlen_cl.size <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">4</span>;
    <span style="color: #666666; font-style: italic">/*trim zeroes for HCLEN. HLIT and HDIST were already trimmed at tree creation*/</span>
    <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>bitlen_cl.data[HCLEN <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&amp;&amp;</span> HCLEN <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>) HCLEN<span style="color: #333333">--</span>;
    addBitsToStream(bp, out, HLIT, <span style="color: #6666ff; font-weight: bold">5</span>);
    addBitsToStream(bp, out, HDIST, <span style="color: #6666ff; font-weight: bold">5</span>);
    addBitsToStream(bp, out, HCLEN, <span style="color: #6666ff; font-weight: bold">4</span>);

    <span style="color: #666666; font-style: italic">/*write the code lenghts of the code length alphabet*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> HCLEN <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>; i<span style="color: #333333">++</span>) addBitsToStream(bp, out, bitlen_cl.data[i], <span style="color: #6666ff; font-weight: bold">3</span>);

    <span style="color: #666666; font-style: italic">/*write the lenghts of the lit/len AND the dist alphabet*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bitlen_lld_e.size; i<span style="color: #333333">++</span>)
    {
      addHuffmanSymbol(bp, out, HuffmanTree_getCode(<span style="color: #333333">&amp;</span>tree_cl, bitlen_lld_e.data[i]),
                       HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_cl, bitlen_lld_e.data[i]));
      <span style="color: #666666; font-style: italic">/*extra bits of repeat codes*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(bitlen_lld_e.data[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>) addBitsToStream(bp, out, bitlen_lld_e.data[<span style="color: #333333">++</span>i], <span style="color: #6666ff; font-weight: bold">2</span>);
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(bitlen_lld_e.data[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">17</span>) addBitsToStream(bp, out, bitlen_lld_e.data[<span style="color: #333333">++</span>i], <span style="color: #6666ff; font-weight: bold">3</span>);
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(bitlen_lld_e.data[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">18</span>) addBitsToStream(bp, out, bitlen_lld_e.data[<span style="color: #333333">++</span>i], <span style="color: #6666ff; font-weight: bold">7</span>);
    }

    <span style="color: #666666; font-style: italic">/*write the compressed data symbols*/</span>
    writeLZ77data(bp, out, <span style="color: #333333">&amp;</span>lz77_encoded, <span style="color: #333333">&amp;</span>tree_ll, <span style="color: #333333">&amp;</span>tree_d);
    <span style="color: #666666; font-style: italic">/*error: the length of the end code 256 must be larger than 0*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #6666ff; font-weight: bold">256</span>) <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">64</span>);

    <span style="color: #666666; font-style: italic">/*write the end code*/</span>
    addHuffmanSymbol(bp, out, HuffmanTree_getCode(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #6666ff; font-weight: bold">256</span>), HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #6666ff; font-weight: bold">256</span>));

    <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*end of error-while*/</span>
  }

  <span style="color: #666666; font-style: italic">/*cleanup*/</span>
  uivector_cleanup(<span style="color: #333333">&amp;</span>lz77_encoded);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_d);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_cl);
  uivector_cleanup(<span style="color: #333333">&amp;</span>frequencies_ll);
  uivector_cleanup(<span style="color: #333333">&amp;</span>frequencies_d);
  uivector_cleanup(<span style="color: #333333">&amp;</span>frequencies_cl);
  uivector_cleanup(<span style="color: #333333">&amp;</span>bitlen_lld_e);
  uivector_cleanup(<span style="color: #333333">&amp;</span>bitlen_lld);
  uivector_cleanup(<span style="color: #333333">&amp;</span>bitlen_cl);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">deflateFixed</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bp, Hash<span style="color: #333333">*</span> hash,
                             <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data,
                             <span style="color: #6666ff; font-weight: bold">size_t</span> datapos, <span style="color: #6666ff; font-weight: bold">size_t</span> dataend,
                             <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings, <span style="color: #6666ff; font-weight: bold">unsigned</span> final)
{
  HuffmanTree tree_ll; <span style="color: #666666; font-style: italic">/*tree for literal values and length codes*/</span>
  HuffmanTree tree_d; <span style="color: #666666; font-style: italic">/*tree for distance codes*/</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> BFINAL <span style="color: #333333">=</span> final;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;

  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_init(<span style="color: #333333">&amp;</span>tree_d);

  generateFixedLitLenTree(<span style="color: #333333">&amp;</span>tree_ll);
  generateFixedDistanceTree(<span style="color: #333333">&amp;</span>tree_d);

  addBitToStream(bp, out, BFINAL);
  addBitToStream(bp, out, <span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*first bit of BTYPE*/</span>
  addBitToStream(bp, out, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*second bit of BTYPE*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>use_lz77) <span style="color: #666666; font-style: italic">/*LZ77 encoded*/</span>
  {
    uivector lz77_encoded;
    uivector_init(<span style="color: #333333">&amp;</span>lz77_encoded);
    error <span style="color: #333333">=</span> encodeLZ77(<span style="color: #333333">&amp;</span>lz77_encoded, hash, data, datapos, dataend, settings<span style="color: #333333">-&gt;</span>windowsize,
                       settings<span style="color: #333333">-&gt;</span>minmatch, settings<span style="color: #333333">-&gt;</span>nicematch, settings<span style="color: #333333">-&gt;</span>lazymatching);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) writeLZ77data(bp, out, <span style="color: #333333">&amp;</span>lz77_encoded, <span style="color: #333333">&amp;</span>tree_ll, <span style="color: #333333">&amp;</span>tree_d);
    uivector_cleanup(<span style="color: #333333">&amp;</span>lz77_encoded);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*no LZ77, but still will be Huffman compressed*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> datapos; i <span style="color: #333333">&lt;</span> dataend; i<span style="color: #333333">++</span>)
    {
      addHuffmanSymbol(bp, out, HuffmanTree_getCode(<span style="color: #333333">&amp;</span>tree_ll, data[i]), HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_ll, data[i]));
    }
  }
  <span style="color: #666666; font-style: italic">/*add END code*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) addHuffmanSymbol(bp, out, HuffmanTree_getCode(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #6666ff; font-weight: bold">256</span>), HuffmanTree_getLength(<span style="color: #333333">&amp;</span>tree_ll, <span style="color: #6666ff; font-weight: bold">256</span>));

  <span style="color: #666666; font-style: italic">/*cleanup*/</span>
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_ll);
  HuffmanTree_cleanup(<span style="color: #333333">&amp;</span>tree_d);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_deflatev</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                                 <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i, blocksize, numdeflateblocks;
  <span style="color: #6666ff; font-weight: bold">size_t</span> bp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*the bit pointer*/</span>
  Hash hash;

  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">61</span>;
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> deflateNoCompression(out, in, insize);
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span>) blocksize <span style="color: #333333">=</span> insize;
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*if(settings-&gt;btype == 2)*/</span>
  {
    blocksize <span style="color: #333333">=</span> insize <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">8</span>;
    <span style="color: #228899; font-weight: bold">if</span>(blocksize <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">65535</span>) blocksize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span>;
  }

  numdeflateblocks <span style="color: #333333">=</span> (insize <span style="color: #333333">+</span> blocksize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">/</span> blocksize;
  <span style="color: #228899; font-weight: bold">if</span>(numdeflateblocks <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) numdeflateblocks <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;

  error <span style="color: #333333">=</span> hash_init(<span style="color: #333333">&amp;</span>hash, settings<span style="color: #333333">-&gt;</span>windowsize);
  <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">return</span> error;

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numdeflateblocks <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>error; i<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> final <span style="color: #333333">=</span> (i <span style="color: #333333">==</span> numdeflateblocks <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #6666ff; font-weight: bold">size_t</span> start <span style="color: #333333">=</span> i <span style="color: #333333">*</span> blocksize;
    <span style="color: #6666ff; font-weight: bold">size_t</span> end <span style="color: #333333">=</span> start <span style="color: #333333">+</span> blocksize;
    <span style="color: #228899; font-weight: bold">if</span>(end <span style="color: #333333">&gt;</span> insize) end <span style="color: #333333">=</span> insize;

    <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span>) error <span style="color: #333333">=</span> deflateFixed(out, <span style="color: #333333">&amp;</span>bp, <span style="color: #333333">&amp;</span>hash, in, start, end, settings, final);
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span>) error <span style="color: #333333">=</span> deflateDynamic(out, <span style="color: #333333">&amp;</span>bp, <span style="color: #333333">&amp;</span>hash, in, start, end, settings, final);
  }

  hash_cleanup(<span style="color: #333333">&amp;</span>hash);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_deflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                         <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  ucvector v;
  ucvector_init_buffer(<span style="color: #333333">&amp;</span>v, <span style="color: #333333">*</span>out, <span style="color: #333333">*</span>outsize);
  error <span style="color: #333333">=</span> lodepng_deflatev(<span style="color: #333333">&amp;</span>v, in, insize, settings);
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> v.data;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> v.size;
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">deflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                        <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>custom_deflate)
  {
    <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_deflate(out, outsize, in, insize, settings);
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #228899; font-weight: bold">return</span> lodepng_deflate(out, outsize, in, insize, settings);
  }
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Adler32                                                                  */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">update_adler32</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> adler, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">unsigned</span> len)
{
   <span style="color: #6666ff; font-weight: bold">unsigned</span> s1 <span style="color: #333333">=</span> adler <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xffff</span>;
   <span style="color: #6666ff; font-weight: bold">unsigned</span> s2 <span style="color: #333333">=</span> (adler <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">16</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xffff</span>;

  <span style="color: #228899; font-weight: bold">while</span>(len <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    <span style="color: #666666; font-style: italic">/*at least 5550 sums can be done before the sums overflow, saving a lot of module divisions*/</span>
    <span style="color: #6666ff; font-weight: bold">unsigned</span> amount <span style="color: #333333">=</span> len <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">5550</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">5550</span> <span style="color: #333333">:</span> len;
    len <span style="color: #333333">-=</span> amount;
    <span style="color: #228899; font-weight: bold">while</span>(amount <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
    {
      s1 <span style="color: #333333">+=</span> (<span style="color: #333333">*</span>data<span style="color: #333333">++</span>);
      s2 <span style="color: #333333">+=</span> s1;
      amount<span style="color: #333333">--</span>;
    }
    s1 <span style="color: #333333">%=</span> <span style="color: #6666ff; font-weight: bold">65521</span>;
    s2 <span style="color: #333333">%=</span> <span style="color: #6666ff; font-weight: bold">65521</span>;
  }

  <span style="color: #228899; font-weight: bold">return</span> (s2 <span style="color: #333333">&lt;&lt;</span> <span style="color: #6666ff; font-weight: bold">16</span>) <span style="color: #333333">|</span> s1;
}

<span style="color: #666666; font-style: italic">/*Return the adler32 of the bytes data[0..len-1]*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">adler32</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">unsigned</span> len)
{
  <span style="color: #228899; font-weight: bold">return</span> update_adler32(<span style="color: #6666ff; font-weight: bold">1L</span>, data, len);
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Zlib                                                                   / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_zlib_decompress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                 <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> CM, CINFO, FDICT;

  <span style="color: #228899; font-weight: bold">if</span>(insize <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">53</span>; <span style="color: #666666; font-style: italic">/*error, size of zlib data too small*/</span>
  <span style="color: #666666; font-style: italic">/*read information from zlib header*/</span>
  <span style="color: #228899; font-weight: bold">if</span>((in[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">+</span> in[<span style="color: #6666ff; font-weight: bold">1</span>]) <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">31</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    <span style="color: #666666; font-style: italic">/*error: 256 * in[0] + in[1] must be a multiple of 31, the FCHECK value is supposed to be made that way*/</span>
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">24</span>;
  }

  CM <span style="color: #333333">=</span> in[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">15</span>;
  CINFO <span style="color: #333333">=</span> (in[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">4</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">15</span>;
  <span style="color: #666666; font-style: italic">/*FCHECK = in[1] &amp; 31;*/</span> <span style="color: #666666; font-style: italic">/*FCHECK is already tested above*/</span>
  FDICT <span style="color: #333333">=</span> (in[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">5</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #666666; font-style: italic">/*FLEVEL = (in[1] &gt;&gt; 6) &amp; 3;*/</span> <span style="color: #666666; font-style: italic">/*FLEVEL is not used here*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(CM <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">||</span> CINFO <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">7</span>)
  {
    <span style="color: #666666; font-style: italic">/*error: only compression method 8: inflate with sliding window of 32k is supported by the PNG spec*/</span>
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">25</span>;
  }
  <span style="color: #228899; font-weight: bold">if</span>(FDICT <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    <span style="color: #666666; font-style: italic">/*error: the specification of PNG says about the zlib stream:</span>
<span style="color: #666666; font-style: italic">      &quot;The additional flags shall not specify a preset dictionary.&quot;*/</span>
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">26</span>;
  }

  error <span style="color: #333333">=</span> inflate(out, outsize, in <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>, insize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">2</span>, settings);
  <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">return</span> error;

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>settings<span style="color: #333333">-&gt;</span>ignore_adler32)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> ADLER32 <span style="color: #333333">=</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>in[insize <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">4</span>]);
    <span style="color: #6666ff; font-weight: bold">unsigned</span> checksum <span style="color: #333333">=</span> adler32(<span style="color: #333333">*</span>out, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)(<span style="color: #333333">*</span>outsize));
    <span style="color: #228899; font-weight: bold">if</span>(checksum <span style="color: #333333">!=</span> ADLER32) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">58</span>; <span style="color: #666666; font-style: italic">/*error, adler checksum not correct, data must be corrupted*/</span>
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*no error*/</span>
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">zlib_decompress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>custom_zlib)
  {
    <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_zlib(out, outsize, in, insize, settings);
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #228899; font-weight: bold">return</span> lodepng_zlib_decompress(out, outsize, in, insize, settings);
  }
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_zlib_compress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                               <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #666666; font-style: italic">/*initially, *out must be NULL and outsize 0, if you just give some random *out</span>
<span style="color: #666666; font-style: italic">  that&#39;s pointing to a non allocated buffer, this&#39;ll crash*/</span>
  ucvector outv;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> deflatedata <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> deflatesize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> ADLER32;
  <span style="color: #666666; font-style: italic">/*zlib data: 1 byte CMF (CM+CINFO), 1 byte FLG, deflate data, 4 byte ADLER32 checksum of the Decompressed data*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> CMF <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">120</span>; <span style="color: #666666; font-style: italic">/*0b01111000: CM 8, CINFO 7. With CINFO 7, any window size up to 32768 can be used.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> FLEVEL <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> FDICT <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> CMFFLG <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> CMF <span style="color: #333333">+</span> FDICT <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">32</span> <span style="color: #333333">+</span> FLEVEL <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">64</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> FCHECK <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">31</span> <span style="color: #333333">-</span> CMFFLG <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">31</span>;
  CMFFLG <span style="color: #333333">+=</span> FCHECK;

  <span style="color: #666666; font-style: italic">/*ucvector-controlled version of the output buffer, for dynamic array*/</span>
  ucvector_init_buffer(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">*</span>out, <span style="color: #333333">*</span>outsize);

  ucvector_push_back(<span style="color: #333333">&amp;</span>outv, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(CMFFLG <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
  ucvector_push_back(<span style="color: #333333">&amp;</span>outv, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(CMFFLG <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));

  error <span style="color: #333333">=</span> deflate(<span style="color: #333333">&amp;</span>deflatedata, <span style="color: #333333">&amp;</span>deflatesize, in, insize, settings);

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
  {
    ADLER32 <span style="color: #333333">=</span> adler32(in, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)insize);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> deflatesize; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>outv, deflatedata[i]);
    lodepng_free(deflatedata);
    lodepng_add32bitInt(<span style="color: #333333">&amp;</span>outv, ADLER32);
  }

  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> outv.data;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> outv.size;

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/* compress using the default or custom zlib function */</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">zlib_compress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                              <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>custom_zlib)
  {
    <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_zlib(out, outsize, in, insize, settings);
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #228899; font-weight: bold">return</span> lodepng_zlib_compress(out, outsize, in, insize, settings);
  }
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#else </span><span style="color: #666666; font-style: italic">/*no LODEPNG_COMPILE_ZLIB*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">zlib_decompress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span> (<span style="color: #333333">!</span>settings<span style="color: #333333">-&gt;</span>custom_zlib) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">87</span>; <span style="color: #666666; font-style: italic">/*no custom zlib function provided */</span>
  <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_zlib(out, outsize, in, insize, settings);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">zlib_compress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                              <span style="color: #6666ff; font-weight: bold">size_t</span> insize, <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #228899; font-weight: bold">if</span> (<span style="color: #333333">!</span>settings<span style="color: #333333">-&gt;</span>custom_zlib) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">87</span>; <span style="color: #666666; font-style: italic">/*no custom zlib function provided */</span>
  <span style="color: #228899; font-weight: bold">return</span> settings<span style="color: #333333">-&gt;</span>custom_zlib(out, outsize, in, insize, settings);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ZLIB*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #666666; font-style: italic">/*this is a good tradeoff between speed and compression ratio*/</span>
<span style="color: #557799">#define DEFAULT_WINDOWSIZE 2048</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_compress_settings_init</span>(LodePNGCompressSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #666666; font-style: italic">/*compress with dynamic huffman tree (not in the mathematical sense, just not the predefined one)*/</span>
  settings<span style="color: #333333">-&gt;</span>btype <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">2</span>;
  settings<span style="color: #333333">-&gt;</span>use_lz77 <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  settings<span style="color: #333333">-&gt;</span>windowsize <span style="color: #333333">=</span> DEFAULT_WINDOWSIZE;
  settings<span style="color: #333333">-&gt;</span>minmatch <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">3</span>;
  settings<span style="color: #333333">-&gt;</span>nicematch <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">128</span>;
  settings<span style="color: #333333">-&gt;</span>lazymatching <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;

  settings<span style="color: #333333">-&gt;</span>custom_zlib <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>custom_deflate <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>custom_context <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings lodepng_default_compress_settings <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">1</span>, DEFAULT_WINDOWSIZE, <span style="color: #6666ff; font-weight: bold">3</span>, <span style="color: #6666ff; font-weight: bold">128</span>, <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>};


<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_decompress_settings_init</span>(LodePNGDecompressSettings<span style="color: #333333">*</span> settings)
{
  settings<span style="color: #333333">-&gt;</span>ignore_adler32 <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  settings<span style="color: #333333">-&gt;</span>custom_zlib <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>custom_inflate <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>custom_context <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings lodepng_default_decompress_settings <span style="color: #333333">=</span> {<span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>};

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* // End of Zlib related code. Begin of PNG related code.                 // */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / CRC32                                                                  / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/* CRC polynomial: 0xedb88320 */</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> lodepng_crc32_table[<span style="color: #6666ff; font-weight: bold">256</span>] <span style="color: #333333">=</span> {
           <span style="color: #6666ff; font-weight: bold">0u</span>, <span style="color: #6666ff; font-weight: bold">1996959894u</span>, <span style="color: #6666ff; font-weight: bold">3993919788u</span>, <span style="color: #6666ff; font-weight: bold">2567524794u</span>,  <span style="color: #6666ff; font-weight: bold">124634137u</span>, <span style="color: #6666ff; font-weight: bold">1886057615u</span>, <span style="color: #6666ff; font-weight: bold">3915621685u</span>, <span style="color: #6666ff; font-weight: bold">2657392035u</span>,
   <span style="color: #6666ff; font-weight: bold">249268274u</span>, <span style="color: #6666ff; font-weight: bold">2044508324u</span>, <span style="color: #6666ff; font-weight: bold">3772115230u</span>, <span style="color: #6666ff; font-weight: bold">2547177864u</span>,  <span style="color: #6666ff; font-weight: bold">162941995u</span>, <span style="color: #6666ff; font-weight: bold">2125561021u</span>, <span style="color: #6666ff; font-weight: bold">3887607047u</span>, <span style="color: #6666ff; font-weight: bold">2428444049u</span>,
   <span style="color: #6666ff; font-weight: bold">498536548u</span>, <span style="color: #6666ff; font-weight: bold">1789927666u</span>, <span style="color: #6666ff; font-weight: bold">4089016648u</span>, <span style="color: #6666ff; font-weight: bold">2227061214u</span>,  <span style="color: #6666ff; font-weight: bold">450548861u</span>, <span style="color: #6666ff; font-weight: bold">1843258603u</span>, <span style="color: #6666ff; font-weight: bold">4107580753u</span>, <span style="color: #6666ff; font-weight: bold">2211677639u</span>,
   <span style="color: #6666ff; font-weight: bold">325883990u</span>, <span style="color: #6666ff; font-weight: bold">1684777152u</span>, <span style="color: #6666ff; font-weight: bold">4251122042u</span>, <span style="color: #6666ff; font-weight: bold">2321926636u</span>,  <span style="color: #6666ff; font-weight: bold">335633487u</span>, <span style="color: #6666ff; font-weight: bold">1661365465u</span>, <span style="color: #6666ff; font-weight: bold">4195302755u</span>, <span style="color: #6666ff; font-weight: bold">2366115317u</span>,
   <span style="color: #6666ff; font-weight: bold">997073096u</span>, <span style="color: #6666ff; font-weight: bold">1281953886u</span>, <span style="color: #6666ff; font-weight: bold">3579855332u</span>, <span style="color: #6666ff; font-weight: bold">2724688242u</span>, <span style="color: #6666ff; font-weight: bold">1006888145u</span>, <span style="color: #6666ff; font-weight: bold">1258607687u</span>, <span style="color: #6666ff; font-weight: bold">3524101629u</span>, <span style="color: #6666ff; font-weight: bold">2768942443u</span>,
   <span style="color: #6666ff; font-weight: bold">901097722u</span>, <span style="color: #6666ff; font-weight: bold">1119000684u</span>, <span style="color: #6666ff; font-weight: bold">3686517206u</span>, <span style="color: #6666ff; font-weight: bold">2898065728u</span>,  <span style="color: #6666ff; font-weight: bold">853044451u</span>, <span style="color: #6666ff; font-weight: bold">1172266101u</span>, <span style="color: #6666ff; font-weight: bold">3705015759u</span>, <span style="color: #6666ff; font-weight: bold">2882616665u</span>,
   <span style="color: #6666ff; font-weight: bold">651767980u</span>, <span style="color: #6666ff; font-weight: bold">1373503546u</span>, <span style="color: #6666ff; font-weight: bold">3369554304u</span>, <span style="color: #6666ff; font-weight: bold">3218104598u</span>,  <span style="color: #6666ff; font-weight: bold">565507253u</span>, <span style="color: #6666ff; font-weight: bold">1454621731u</span>, <span style="color: #6666ff; font-weight: bold">3485111705u</span>, <span style="color: #6666ff; font-weight: bold">3099436303u</span>,
   <span style="color: #6666ff; font-weight: bold">671266974u</span>, <span style="color: #6666ff; font-weight: bold">1594198024u</span>, <span style="color: #6666ff; font-weight: bold">3322730930u</span>, <span style="color: #6666ff; font-weight: bold">2970347812u</span>,  <span style="color: #6666ff; font-weight: bold">795835527u</span>, <span style="color: #6666ff; font-weight: bold">1483230225u</span>, <span style="color: #6666ff; font-weight: bold">3244367275u</span>, <span style="color: #6666ff; font-weight: bold">3060149565u</span>,
  <span style="color: #6666ff; font-weight: bold">1994146192u</span>,   <span style="color: #6666ff; font-weight: bold">31158534u</span>, <span style="color: #6666ff; font-weight: bold">2563907772u</span>, <span style="color: #6666ff; font-weight: bold">4023717930u</span>, <span style="color: #6666ff; font-weight: bold">1907459465u</span>,  <span style="color: #6666ff; font-weight: bold">112637215u</span>, <span style="color: #6666ff; font-weight: bold">2680153253u</span>, <span style="color: #6666ff; font-weight: bold">3904427059u</span>,
  <span style="color: #6666ff; font-weight: bold">2013776290u</span>,  <span style="color: #6666ff; font-weight: bold">251722036u</span>, <span style="color: #6666ff; font-weight: bold">2517215374u</span>, <span style="color: #6666ff; font-weight: bold">3775830040u</span>, <span style="color: #6666ff; font-weight: bold">2137656763u</span>,  <span style="color: #6666ff; font-weight: bold">141376813u</span>, <span style="color: #6666ff; font-weight: bold">2439277719u</span>, <span style="color: #6666ff; font-weight: bold">3865271297u</span>,
  <span style="color: #6666ff; font-weight: bold">1802195444u</span>,  <span style="color: #6666ff; font-weight: bold">476864866u</span>, <span style="color: #6666ff; font-weight: bold">2238001368u</span>, <span style="color: #6666ff; font-weight: bold">4066508878u</span>, <span style="color: #6666ff; font-weight: bold">1812370925u</span>,  <span style="color: #6666ff; font-weight: bold">453092731u</span>, <span style="color: #6666ff; font-weight: bold">2181625025u</span>, <span style="color: #6666ff; font-weight: bold">4111451223u</span>,
  <span style="color: #6666ff; font-weight: bold">1706088902u</span>,  <span style="color: #6666ff; font-weight: bold">314042704u</span>, <span style="color: #6666ff; font-weight: bold">2344532202u</span>, <span style="color: #6666ff; font-weight: bold">4240017532u</span>, <span style="color: #6666ff; font-weight: bold">1658658271u</span>,  <span style="color: #6666ff; font-weight: bold">366619977u</span>, <span style="color: #6666ff; font-weight: bold">2362670323u</span>, <span style="color: #6666ff; font-weight: bold">4224994405u</span>,
  <span style="color: #6666ff; font-weight: bold">1303535960u</span>,  <span style="color: #6666ff; font-weight: bold">984961486u</span>, <span style="color: #6666ff; font-weight: bold">2747007092u</span>, <span style="color: #6666ff; font-weight: bold">3569037538u</span>, <span style="color: #6666ff; font-weight: bold">1256170817u</span>, <span style="color: #6666ff; font-weight: bold">1037604311u</span>, <span style="color: #6666ff; font-weight: bold">2765210733u</span>, <span style="color: #6666ff; font-weight: bold">3554079995u</span>,
  <span style="color: #6666ff; font-weight: bold">1131014506u</span>,  <span style="color: #6666ff; font-weight: bold">879679996u</span>, <span style="color: #6666ff; font-weight: bold">2909243462u</span>, <span style="color: #6666ff; font-weight: bold">3663771856u</span>, <span style="color: #6666ff; font-weight: bold">1141124467u</span>,  <span style="color: #6666ff; font-weight: bold">855842277u</span>, <span style="color: #6666ff; font-weight: bold">2852801631u</span>, <span style="color: #6666ff; font-weight: bold">3708648649u</span>,
  <span style="color: #6666ff; font-weight: bold">1342533948u</span>,  <span style="color: #6666ff; font-weight: bold">654459306u</span>, <span style="color: #6666ff; font-weight: bold">3188396048u</span>, <span style="color: #6666ff; font-weight: bold">3373015174u</span>, <span style="color: #6666ff; font-weight: bold">1466479909u</span>,  <span style="color: #6666ff; font-weight: bold">544179635u</span>, <span style="color: #6666ff; font-weight: bold">3110523913u</span>, <span style="color: #6666ff; font-weight: bold">3462522015u</span>,
  <span style="color: #6666ff; font-weight: bold">1591671054u</span>,  <span style="color: #6666ff; font-weight: bold">702138776u</span>, <span style="color: #6666ff; font-weight: bold">2966460450u</span>, <span style="color: #6666ff; font-weight: bold">3352799412u</span>, <span style="color: #6666ff; font-weight: bold">1504918807u</span>,  <span style="color: #6666ff; font-weight: bold">783551873u</span>, <span style="color: #6666ff; font-weight: bold">3082640443u</span>, <span style="color: #6666ff; font-weight: bold">3233442989u</span>,
  <span style="color: #6666ff; font-weight: bold">3988292384u</span>, <span style="color: #6666ff; font-weight: bold">2596254646u</span>,   <span style="color: #6666ff; font-weight: bold">62317068u</span>, <span style="color: #6666ff; font-weight: bold">1957810842u</span>, <span style="color: #6666ff; font-weight: bold">3939845945u</span>, <span style="color: #6666ff; font-weight: bold">2647816111u</span>,   <span style="color: #6666ff; font-weight: bold">81470997u</span>, <span style="color: #6666ff; font-weight: bold">1943803523u</span>,
  <span style="color: #6666ff; font-weight: bold">3814918930u</span>, <span style="color: #6666ff; font-weight: bold">2489596804u</span>,  <span style="color: #6666ff; font-weight: bold">225274430u</span>, <span style="color: #6666ff; font-weight: bold">2053790376u</span>, <span style="color: #6666ff; font-weight: bold">3826175755u</span>, <span style="color: #6666ff; font-weight: bold">2466906013u</span>,  <span style="color: #6666ff; font-weight: bold">167816743u</span>, <span style="color: #6666ff; font-weight: bold">2097651377u</span>,
  <span style="color: #6666ff; font-weight: bold">4027552580u</span>, <span style="color: #6666ff; font-weight: bold">2265490386u</span>,  <span style="color: #6666ff; font-weight: bold">503444072u</span>, <span style="color: #6666ff; font-weight: bold">1762050814u</span>, <span style="color: #6666ff; font-weight: bold">4150417245u</span>, <span style="color: #6666ff; font-weight: bold">2154129355u</span>,  <span style="color: #6666ff; font-weight: bold">426522225u</span>, <span style="color: #6666ff; font-weight: bold">1852507879u</span>,
  <span style="color: #6666ff; font-weight: bold">4275313526u</span>, <span style="color: #6666ff; font-weight: bold">2312317920u</span>,  <span style="color: #6666ff; font-weight: bold">282753626u</span>, <span style="color: #6666ff; font-weight: bold">1742555852u</span>, <span style="color: #6666ff; font-weight: bold">4189708143u</span>, <span style="color: #6666ff; font-weight: bold">2394877945u</span>,  <span style="color: #6666ff; font-weight: bold">397917763u</span>, <span style="color: #6666ff; font-weight: bold">1622183637u</span>,
  <span style="color: #6666ff; font-weight: bold">3604390888u</span>, <span style="color: #6666ff; font-weight: bold">2714866558u</span>,  <span style="color: #6666ff; font-weight: bold">953729732u</span>, <span style="color: #6666ff; font-weight: bold">1340076626u</span>, <span style="color: #6666ff; font-weight: bold">3518719985u</span>, <span style="color: #6666ff; font-weight: bold">2797360999u</span>, <span style="color: #6666ff; font-weight: bold">1068828381u</span>, <span style="color: #6666ff; font-weight: bold">1219638859u</span>,
  <span style="color: #6666ff; font-weight: bold">3624741850u</span>, <span style="color: #6666ff; font-weight: bold">2936675148u</span>,  <span style="color: #6666ff; font-weight: bold">906185462u</span>, <span style="color: #6666ff; font-weight: bold">1090812512u</span>, <span style="color: #6666ff; font-weight: bold">3747672003u</span>, <span style="color: #6666ff; font-weight: bold">2825379669u</span>,  <span style="color: #6666ff; font-weight: bold">829329135u</span>, <span style="color: #6666ff; font-weight: bold">1181335161u</span>,
  <span style="color: #6666ff; font-weight: bold">3412177804u</span>, <span style="color: #6666ff; font-weight: bold">3160834842u</span>,  <span style="color: #6666ff; font-weight: bold">628085408u</span>, <span style="color: #6666ff; font-weight: bold">1382605366u</span>, <span style="color: #6666ff; font-weight: bold">3423369109u</span>, <span style="color: #6666ff; font-weight: bold">3138078467u</span>,  <span style="color: #6666ff; font-weight: bold">570562233u</span>, <span style="color: #6666ff; font-weight: bold">1426400815u</span>,
  <span style="color: #6666ff; font-weight: bold">3317316542u</span>, <span style="color: #6666ff; font-weight: bold">2998733608u</span>,  <span style="color: #6666ff; font-weight: bold">733239954u</span>, <span style="color: #6666ff; font-weight: bold">1555261956u</span>, <span style="color: #6666ff; font-weight: bold">3268935591u</span>, <span style="color: #6666ff; font-weight: bold">3050360625u</span>,  <span style="color: #6666ff; font-weight: bold">752459403u</span>, <span style="color: #6666ff; font-weight: bold">1541320221u</span>,
  <span style="color: #6666ff; font-weight: bold">2607071920u</span>, <span style="color: #6666ff; font-weight: bold">3965973030u</span>, <span style="color: #6666ff; font-weight: bold">1969922972u</span>,   <span style="color: #6666ff; font-weight: bold">40735498u</span>, <span style="color: #6666ff; font-weight: bold">2617837225u</span>, <span style="color: #6666ff; font-weight: bold">3943577151u</span>, <span style="color: #6666ff; font-weight: bold">1913087877u</span>,   <span style="color: #6666ff; font-weight: bold">83908371u</span>,
  <span style="color: #6666ff; font-weight: bold">2512341634u</span>, <span style="color: #6666ff; font-weight: bold">3803740692u</span>, <span style="color: #6666ff; font-weight: bold">2075208622u</span>,  <span style="color: #6666ff; font-weight: bold">213261112u</span>, <span style="color: #6666ff; font-weight: bold">2463272603u</span>, <span style="color: #6666ff; font-weight: bold">3855990285u</span>, <span style="color: #6666ff; font-weight: bold">2094854071u</span>,  <span style="color: #6666ff; font-weight: bold">198958881u</span>,
  <span style="color: #6666ff; font-weight: bold">2262029012u</span>, <span style="color: #6666ff; font-weight: bold">4057260610u</span>, <span style="color: #6666ff; font-weight: bold">1759359992u</span>,  <span style="color: #6666ff; font-weight: bold">534414190u</span>, <span style="color: #6666ff; font-weight: bold">2176718541u</span>, <span style="color: #6666ff; font-weight: bold">4139329115u</span>, <span style="color: #6666ff; font-weight: bold">1873836001u</span>,  <span style="color: #6666ff; font-weight: bold">414664567u</span>,
  <span style="color: #6666ff; font-weight: bold">2282248934u</span>, <span style="color: #6666ff; font-weight: bold">4279200368u</span>, <span style="color: #6666ff; font-weight: bold">1711684554u</span>,  <span style="color: #6666ff; font-weight: bold">285281116u</span>, <span style="color: #6666ff; font-weight: bold">2405801727u</span>, <span style="color: #6666ff; font-weight: bold">4167216745u</span>, <span style="color: #6666ff; font-weight: bold">1634467795u</span>,  <span style="color: #6666ff; font-weight: bold">376229701u</span>,
  <span style="color: #6666ff; font-weight: bold">2685067896u</span>, <span style="color: #6666ff; font-weight: bold">3608007406u</span>, <span style="color: #6666ff; font-weight: bold">1308918612u</span>,  <span style="color: #6666ff; font-weight: bold">956543938u</span>, <span style="color: #6666ff; font-weight: bold">2808555105u</span>, <span style="color: #6666ff; font-weight: bold">3495958263u</span>, <span style="color: #6666ff; font-weight: bold">1231636301u</span>, <span style="color: #6666ff; font-weight: bold">1047427035u</span>,
  <span style="color: #6666ff; font-weight: bold">2932959818u</span>, <span style="color: #6666ff; font-weight: bold">3654703836u</span>, <span style="color: #6666ff; font-weight: bold">1088359270u</span>,  <span style="color: #6666ff; font-weight: bold">936918000u</span>, <span style="color: #6666ff; font-weight: bold">2847714899u</span>, <span style="color: #6666ff; font-weight: bold">3736837829u</span>, <span style="color: #6666ff; font-weight: bold">1202900863u</span>,  <span style="color: #6666ff; font-weight: bold">817233897u</span>,
  <span style="color: #6666ff; font-weight: bold">3183342108u</span>, <span style="color: #6666ff; font-weight: bold">3401237130u</span>, <span style="color: #6666ff; font-weight: bold">1404277552u</span>,  <span style="color: #6666ff; font-weight: bold">615818150u</span>, <span style="color: #6666ff; font-weight: bold">3134207493u</span>, <span style="color: #6666ff; font-weight: bold">3453421203u</span>, <span style="color: #6666ff; font-weight: bold">1423857449u</span>,  <span style="color: #6666ff; font-weight: bold">601450431u</span>,
  <span style="color: #6666ff; font-weight: bold">3009837614u</span>, <span style="color: #6666ff; font-weight: bold">3294710456u</span>, <span style="color: #6666ff; font-weight: bold">1567103746u</span>,  <span style="color: #6666ff; font-weight: bold">711928724u</span>, <span style="color: #6666ff; font-weight: bold">3020668471u</span>, <span style="color: #6666ff; font-weight: bold">3272380065u</span>, <span style="color: #6666ff; font-weight: bold">1510334235u</span>,  <span style="color: #6666ff; font-weight: bold">755167117u</span>
};

<span style="color: #666666; font-style: italic">/*Return the CRC of the bytes buf[0..len-1].*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_crc32</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buf, <span style="color: #6666ff; font-weight: bold">size_t</span> len)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> c <span style="color: #333333">=</span> <span style="color: #005588; font-weight: bold">0xffffffffL</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> n;

  <span style="color: #228899; font-weight: bold">for</span>(n <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; n <span style="color: #333333">&lt;</span> len; n<span style="color: #333333">++</span>)
  {
    c <span style="color: #333333">=</span> lodepng_crc32_table[(c <span style="color: #333333">^</span> buf[n]) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xff</span>] <span style="color: #333333">^</span> (c <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>);
  }
  <span style="color: #228899; font-weight: bold">return</span> c <span style="color: #333333">^</span> <span style="color: #005588; font-weight: bold">0xffffffffL</span>;
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Reading and writing single bits and bytes from/to stream for LodePNG   / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">readBitFromReversedStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> result <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)((bitstream[(<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">&gt;&gt;</span> (<span style="color: #6666ff; font-weight: bold">7</span> <span style="color: #333333">-</span> ((<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0x7</span>))) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>);
  (<span style="color: #333333">*</span>bitpointer)<span style="color: #333333">++</span>;
  <span style="color: #228899; font-weight: bold">return</span> result;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readBitsFromReversedStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">size_t</span> nbits)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> result <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> nbits <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>; i <span style="color: #333333">&lt;</span> nbits; i<span style="color: #333333">--</span>)
  {
    result <span style="color: #333333">+=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span>)readBitFromReversedStream(bitpointer, bitstream) <span style="color: #333333">&lt;&lt;</span> i;
  }
  <span style="color: #228899; font-weight: bold">return</span> result;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">setBitOfReversedStream0</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit)
{
  <span style="color: #666666; font-style: italic">/*the current bit in bitstream must be 0 for this to work*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(bit)
  {
    <span style="color: #666666; font-style: italic">/*earlier bit of huffman code is in a lesser significant bit of an earlier byte*/</span>
    bitstream[(<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">|=</span> (bit <span style="color: #333333">&lt;&lt;</span> (<span style="color: #6666ff; font-weight: bold">7</span> <span style="color: #333333">-</span> ((<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0x7</span>)));
  }
  (<span style="color: #333333">*</span>bitpointer)<span style="color: #333333">++</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">setBitOfReversedStream</span>(<span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> bitpointer, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> bitstream, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit)
{
  <span style="color: #666666; font-style: italic">/*the current bit in bitstream may be 0 or 1 for this to work*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(bit <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) bitstream[(<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">&amp;=</span>  (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(<span style="color: #333333">~</span>(<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">&lt;&lt;</span> (<span style="color: #6666ff; font-weight: bold">7</span> <span style="color: #333333">-</span> ((<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0x7</span>))));
  <span style="color: #228899; font-weight: bold">else</span>         bitstream[(<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">|=</span>  (<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">&lt;&lt;</span> (<span style="color: #6666ff; font-weight: bold">7</span> <span style="color: #333333">-</span> ((<span style="color: #333333">*</span>bitpointer) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0x7</span>)));
  (<span style="color: #333333">*</span>bitpointer)<span style="color: #333333">++</span>;
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / PNG chunks                                                             / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_length</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>chunk[<span style="color: #6666ff; font-weight: bold">0</span>]);
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_type</span>(<span style="color: #6666ff; font-weight: bold">char</span> type[<span style="color: #6666ff; font-weight: bold">5</span>], <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">4</span>; i<span style="color: #333333">++</span>) type[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)chunk[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> i];
  type[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*null termination char*/</span>
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_type_equals</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> type)
{
  <span style="color: #228899; font-weight: bold">if</span>(strlen(type) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">4</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">return</span> (chunk[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">==</span> type[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&amp;&amp;</span> chunk[<span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">==</span> type[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&amp;&amp;</span> chunk[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">==</span> type[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">&amp;&amp;</span> chunk[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">==</span> type[<span style="color: #6666ff; font-weight: bold">3</span>]);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_ancillary</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span>((chunk[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">32</span>) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_private</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span>((chunk[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">32</span>) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_safetocopy</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span>((chunk[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">32</span>) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_data</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">&amp;</span>chunk[<span style="color: #6666ff; font-weight: bold">8</span>];
}

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_data_const</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">&amp;</span>chunk[<span style="color: #6666ff; font-weight: bold">8</span>];
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_check_crc</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> length <span style="color: #333333">=</span> lodepng_chunk_length(chunk);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> CRC <span style="color: #333333">=</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>chunk[length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">8</span>]);
  <span style="color: #666666; font-style: italic">/*the CRC is taken of the data and the 4 chunk type letters, not the length*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> checksum <span style="color: #333333">=</span> lodepng_crc32(<span style="color: #333333">&amp;</span>chunk[<span style="color: #6666ff; font-weight: bold">4</span>], length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>);
  <span style="color: #228899; font-weight: bold">if</span>(CRC <span style="color: #333333">!=</span> checksum) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_generate_crc</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> length <span style="color: #333333">=</span> lodepng_chunk_length(chunk);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> CRC <span style="color: #333333">=</span> lodepng_crc32(<span style="color: #333333">&amp;</span>chunk[<span style="color: #6666ff; font-weight: bold">4</span>], length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>);
  lodepng_set32bitInt(chunk <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> length, CRC);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_next</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> total_chunk_length <span style="color: #333333">=</span> lodepng_chunk_length(chunk) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">&amp;</span>chunk[total_chunk_length];
}

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_next_const</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> total_chunk_length <span style="color: #333333">=</span> lodepng_chunk_length(chunk) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">&amp;</span>chunk[total_chunk_length];
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_append</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outlength, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> total_chunk_length <span style="color: #333333">=</span> lodepng_chunk_length(chunk) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>chunk_start, <span style="color: #333333">*</span>new_buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> new_length <span style="color: #333333">=</span> (<span style="color: #333333">*</span>outlength) <span style="color: #333333">+</span> total_chunk_length;
  <span style="color: #228899; font-weight: bold">if</span>(new_length <span style="color: #333333">&lt;</span> total_chunk_length <span style="color: #333333">||</span> new_length <span style="color: #333333">&lt;</span> (<span style="color: #333333">*</span>outlength)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">77</span>; <span style="color: #666666; font-style: italic">/*integer overflow happened*/</span>

  new_buffer <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_realloc(<span style="color: #333333">*</span>out, new_length);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>new_buffer) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  (<span style="color: #333333">*</span>out) <span style="color: #333333">=</span> new_buffer;
  (<span style="color: #333333">*</span>outlength) <span style="color: #333333">=</span> new_length;
  chunk_start <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>(<span style="color: #333333">*</span>out)[new_length <span style="color: #333333">-</span> total_chunk_length];

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> total_chunk_length; i<span style="color: #333333">++</span>) chunk_start[i] <span style="color: #333333">=</span> chunk[i];

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_create</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outlength, <span style="color: #6666ff; font-weight: bold">unsigned</span> length,
                              <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> type, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>chunk, <span style="color: #333333">*</span>new_buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> new_length <span style="color: #333333">=</span> (<span style="color: #333333">*</span>outlength) <span style="color: #333333">+</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>;
  <span style="color: #228899; font-weight: bold">if</span>(new_length <span style="color: #333333">&lt;</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span> <span style="color: #333333">||</span> new_length <span style="color: #333333">&lt;</span> (<span style="color: #333333">*</span>outlength)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">77</span>; <span style="color: #666666; font-style: italic">/*integer overflow happened*/</span>
  new_buffer <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_realloc(<span style="color: #333333">*</span>out, new_length);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>new_buffer) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  (<span style="color: #333333">*</span>out) <span style="color: #333333">=</span> new_buffer;
  (<span style="color: #333333">*</span>outlength) <span style="color: #333333">=</span> new_length;
  chunk <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>(<span style="color: #333333">*</span>out)[(<span style="color: #333333">*</span>outlength) <span style="color: #333333">-</span> length <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">12</span>];

  <span style="color: #666666; font-style: italic">/*1: length*/</span>
  lodepng_set32bitInt(chunk, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)length);

  <span style="color: #666666; font-style: italic">/*2: chunk name (4 letters)*/</span>
  chunk[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)type[<span style="color: #6666ff; font-weight: bold">0</span>];
  chunk[<span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)type[<span style="color: #6666ff; font-weight: bold">1</span>];
  chunk[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)type[<span style="color: #6666ff; font-weight: bold">2</span>];
  chunk[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)type[<span style="color: #6666ff; font-weight: bold">3</span>];

  <span style="color: #666666; font-style: italic">/*3: the data*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) chunk[<span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> i] <span style="color: #333333">=</span> data[i];

  <span style="color: #666666; font-style: italic">/*4: CRC (of the chunkname characters and the data)*/</span>
  lodepng_chunk_generate_crc(chunk);

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / Color types and such                                                   / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*return type is a LodePNG error code*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">checkColorValidity</span>(LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bd) <span style="color: #666666; font-style: italic">/*bd = bitdepth*/</span>
{
  <span style="color: #228899; font-weight: bold">switch</span>(colortype)
  {
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">0</span>: <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">37</span>; <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*grey*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">2</span>: <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(                                 bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">37</span>; <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*RGB*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">3</span>: <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>            )) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">37</span>; <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*palette*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">4</span>: <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(                                 bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">37</span>; <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*grey + alpha*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">6</span>: <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(                                 bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">||</span> bd <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">37</span>; <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*RGBA*/</span>
    <span style="color: #997700; font-weight: bold">default:</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">31</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*allowed color type / bits combination*/</span>
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">getNumColorChannels</span>(LodePNGColorType colortype)
{
  <span style="color: #228899; font-weight: bold">switch</span>(colortype)
  {
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">0</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*grey*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">2</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">3</span>; <span style="color: #666666; font-style: italic">/*RGB*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">3</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*palette*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">4</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">2</span>; <span style="color: #666666; font-style: italic">/*grey + alpha*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">6</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">4</span>; <span style="color: #666666; font-style: italic">/*RGBA*/</span>
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*unexisting color type*/</span>
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_bpp_lct</span>(LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #666666; font-style: italic">/*bits per pixel is amount of channels * bits per channel*/</span>
  <span style="color: #228899; font-weight: bold">return</span> getNumColorChannels(colortype) <span style="color: #333333">*</span> bitdepth;
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_init</span>(LodePNGColorMode<span style="color: #333333">*</span> info)
{
  info<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">=</span> LCT_RGBA;
  info<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  info<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_cleanup</span>(LodePNGColorMode<span style="color: #333333">*</span> info)
{
  lodepng_palette_clear(info);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_copy</span>(LodePNGColorMode<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> source)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  lodepng_color_mode_cleanup(dest);
  <span style="color: #333333">*</span>dest <span style="color: #333333">=</span> <span style="color: #333333">*</span>source;
  <span style="color: #228899; font-weight: bold">if</span>(source<span style="color: #333333">-&gt;</span>palette)
  {
    dest<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #6666ff; font-weight: bold">1024</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>dest<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">&amp;&amp;</span> source<span style="color: #333333">-&gt;</span>palettesize) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> source<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span>; i<span style="color: #333333">++</span>) dest<span style="color: #333333">-&gt;</span>palette[i] <span style="color: #333333">=</span> source<span style="color: #333333">-&gt;</span>palette[i];
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">int</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_equal</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> a, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> b)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>colortype) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>bitdepth) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>key_defined) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>key_defined)
  {
    <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>key_r) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>key_g) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>key_b) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  }
  <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>palettesize) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> a<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span>; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(a<span style="color: #333333">-&gt;</span>palette[i] <span style="color: #333333">!=</span> b<span style="color: #333333">-&gt;</span>palette[i]) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_palette_clear</span>(LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>palette) lodepng_free(info<span style="color: #333333">-&gt;</span>palette);
  info<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_palette_add</span>(LodePNGColorMode<span style="color: #333333">*</span> info,
                             <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data;
  <span style="color: #666666; font-style: italic">/*the same resize technique as C++ std::vectors is used, and here it&#39;s made so that for a palette with</span>
<span style="color: #666666; font-style: italic">  the max of 256 colors, it&#39;ll have the exact alloc size*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>info<span style="color: #333333">-&gt;</span>palette) <span style="color: #666666; font-style: italic">/*allocate palette if empty*/</span>
  {
    <span style="color: #666666; font-style: italic">/*room for 256 colors with 4 bytes each*/</span>
    data <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_realloc(info<span style="color: #333333">-&gt;</span>palette, <span style="color: #6666ff; font-weight: bold">1024</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>data) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    <span style="color: #228899; font-weight: bold">else</span> info<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">=</span> data;
  }
  info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> r;
  info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> g;
  info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> b;
  info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> a;
  info<span style="color: #333333">-&gt;</span>palettesize<span style="color: #333333">++</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_bpp</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #666666; font-style: italic">/*calculate bits per pixel out of colortype and bitdepth*/</span>
  <span style="color: #228899; font-weight: bold">return</span> lodepng_get_bpp_lct(info<span style="color: #333333">-&gt;</span>colortype, info<span style="color: #333333">-&gt;</span>bitdepth);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_channels</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">return</span> getNumColorChannels(info<span style="color: #333333">-&gt;</span>colortype);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_greyscale_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">return</span> info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_alpha_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">return</span> (info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">4</span>) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*4 or 6*/</span>
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_palette_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">return</span> info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_has_palette_alpha</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info<span style="color: #333333">-&gt;</span>palettesize; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>palette[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_can_have_alpha</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #228899; font-weight: bold">return</span> info<span style="color: #333333">-&gt;</span>key_defined
      <span style="color: #333333">||</span> lodepng_is_alpha_type(info)
      <span style="color: #333333">||</span> lodepng_has_palette_alpha(info);
}

<span style="color: #6666ff; font-weight: bold">size_t</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_raw_size</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> color)
{
  <span style="color: #228899; font-weight: bold">return</span> (w <span style="color: #333333">*</span> h <span style="color: #333333">*</span> lodepng_get_bpp(color) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
}

<span style="color: #6666ff; font-weight: bold">size_t</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_raw_size_lct</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #228899; font-weight: bold">return</span> (w <span style="color: #333333">*</span> h <span style="color: #333333">*</span> lodepng_get_bpp_lct(colortype, bitdepth) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
}


<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*in an idat chunk, each scanline is a multiple of 8 bits, unlike the lodepng output buffer*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">size_t</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_raw_size_idat</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> color)
{
  <span style="color: #228899; font-weight: bold">return</span> h <span style="color: #333333">*</span> ((w <span style="color: #333333">*</span> lodepng_get_bpp(color) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGUnknownChunks_init</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">3</span>; i<span style="color: #333333">++</span>) info<span style="color: #333333">-&gt;</span>unknown_chunks_data[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">3</span>; i<span style="color: #333333">++</span>) info<span style="color: #333333">-&gt;</span>unknown_chunks_size[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGUnknownChunks_cleanup</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">3</span>; i<span style="color: #333333">++</span>) lodepng_free(info<span style="color: #333333">-&gt;</span>unknown_chunks_data[i]);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">LodePNGUnknownChunks_copy</span>(LodePNGInfo<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> src)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  LodePNGUnknownChunks_cleanup(dest);

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">3</span>; i<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> j;
    dest<span style="color: #333333">-&gt;</span>unknown_chunks_size[i] <span style="color: #333333">=</span> src<span style="color: #333333">-&gt;</span>unknown_chunks_size[i];
    dest<span style="color: #333333">-&gt;</span>unknown_chunks_data[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(src<span style="color: #333333">-&gt;</span>unknown_chunks_size[i]);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>dest<span style="color: #333333">-&gt;</span>unknown_chunks_data[i] <span style="color: #333333">&amp;&amp;</span> dest<span style="color: #333333">-&gt;</span>unknown_chunks_size[i]) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; j <span style="color: #333333">&lt;</span> src<span style="color: #333333">-&gt;</span>unknown_chunks_size[i]; j<span style="color: #333333">++</span>)
    {
      dest<span style="color: #333333">-&gt;</span>unknown_chunks_data[i][j] <span style="color: #333333">=</span> src<span style="color: #333333">-&gt;</span>unknown_chunks_data[i][j];
    }
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/******************************************************************************/</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGText_init</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>text_keys <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  info<span style="color: #333333">-&gt;</span>text_strings <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGText_cleanup</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info<span style="color: #333333">-&gt;</span>text_num; i<span style="color: #333333">++</span>)
  {
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_keys[i]);
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_strings[i]);
  }
  lodepng_free(info<span style="color: #333333">-&gt;</span>text_keys);
  lodepng_free(info<span style="color: #333333">-&gt;</span>text_strings);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">LodePNGText_copy</span>(LodePNGInfo<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> source)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>text_keys <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>text_strings <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> source<span style="color: #333333">-&gt;</span>text_num; i<span style="color: #333333">++</span>)
  {
    CERROR_TRY_RETURN(lodepng_add_text(dest, source<span style="color: #333333">-&gt;</span>text_keys[i], source<span style="color: #333333">-&gt;</span>text_strings[i]));
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_clear_text</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  LodePNGText_cleanup(info);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_add_text</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> key, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> str)
{
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_keys <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>text_keys, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_strings <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>text_strings, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>new_keys <span style="color: #333333">||</span> <span style="color: #333333">!</span>new_strings)
  {
    lodepng_free(new_keys);
    lodepng_free(new_strings);
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  }

  info<span style="color: #333333">-&gt;</span>text_num<span style="color: #333333">++</span>;
  info<span style="color: #333333">-&gt;</span>text_keys <span style="color: #333333">=</span> new_keys;
  info<span style="color: #333333">-&gt;</span>text_strings <span style="color: #333333">=</span> new_strings;

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_keys[info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_keys[info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], key);

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_strings[info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>text_strings[info<span style="color: #333333">-&gt;</span>text_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], str);

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/******************************************************************************/</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGIText_init</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>itext_keys <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  info<span style="color: #333333">-&gt;</span>itext_langtags <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  info<span style="color: #333333">-&gt;</span>itext_transkeys <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  info<span style="color: #333333">-&gt;</span>itext_strings <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">LodePNGIText_cleanup</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info<span style="color: #333333">-&gt;</span>itext_num; i<span style="color: #333333">++</span>)
  {
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_keys[i]);
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_langtags[i]);
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_transkeys[i]);
    string_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_strings[i]);
  }
  lodepng_free(info<span style="color: #333333">-&gt;</span>itext_keys);
  lodepng_free(info<span style="color: #333333">-&gt;</span>itext_langtags);
  lodepng_free(info<span style="color: #333333">-&gt;</span>itext_transkeys);
  lodepng_free(info<span style="color: #333333">-&gt;</span>itext_strings);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">LodePNGIText_copy</span>(LodePNGInfo<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> source)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>itext_keys <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>itext_langtags <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>itext_transkeys <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>itext_strings <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  dest<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> source<span style="color: #333333">-&gt;</span>itext_num; i<span style="color: #333333">++</span>)
  {
    CERROR_TRY_RETURN(lodepng_add_itext(dest, source<span style="color: #333333">-&gt;</span>itext_keys[i], source<span style="color: #333333">-&gt;</span>itext_langtags[i],
                                        source<span style="color: #333333">-&gt;</span>itext_transkeys[i], source<span style="color: #333333">-&gt;</span>itext_strings[i]));
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_clear_itext</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  LodePNGIText_cleanup(info);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_add_itext</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> key, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> langtag,
                           <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> transkey, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> str)
{
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_keys <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>itext_keys, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_langtags <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>itext_langtags, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_transkeys <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>itext_transkeys, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> new_strings <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>)(lodepng_realloc(info<span style="color: #333333">-&gt;</span>itext_strings, <span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>) <span style="color: #333333">*</span> (info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)));
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>new_keys <span style="color: #333333">||</span> <span style="color: #333333">!</span>new_langtags <span style="color: #333333">||</span> <span style="color: #333333">!</span>new_transkeys <span style="color: #333333">||</span> <span style="color: #333333">!</span>new_strings)
  {
    lodepng_free(new_keys);
    lodepng_free(new_langtags);
    lodepng_free(new_transkeys);
    lodepng_free(new_strings);
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  }

  info<span style="color: #333333">-&gt;</span>itext_num<span style="color: #333333">++</span>;
  info<span style="color: #333333">-&gt;</span>itext_keys <span style="color: #333333">=</span> new_keys;
  info<span style="color: #333333">-&gt;</span>itext_langtags <span style="color: #333333">=</span> new_langtags;
  info<span style="color: #333333">-&gt;</span>itext_transkeys <span style="color: #333333">=</span> new_transkeys;
  info<span style="color: #333333">-&gt;</span>itext_strings <span style="color: #333333">=</span> new_strings;

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_keys[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_keys[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], key);

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_langtags[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_langtags[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], langtag);

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_transkeys[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_transkeys[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], transkey);

  string_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_strings[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>]);
  string_set(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>itext_strings[info<span style="color: #333333">-&gt;</span>itext_num <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], str);

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_init</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  lodepng_color_mode_init(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>color);
  info<span style="color: #333333">-&gt;</span>interlace_method <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>compression_method <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>filter_method <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  info<span style="color: #333333">-&gt;</span>background_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  LodePNGText_init(info);
  LodePNGIText_init(info);

  info<span style="color: #333333">-&gt;</span>time_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  info<span style="color: #333333">-&gt;</span>phys_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  LodePNGUnknownChunks_init(info);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_cleanup</span>(LodePNGInfo<span style="color: #333333">*</span> info)
{
  lodepng_color_mode_cleanup(<span style="color: #333333">&amp;</span>info<span style="color: #333333">-&gt;</span>color);
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  LodePNGText_cleanup(info);
  LodePNGIText_cleanup(info);

  LodePNGUnknownChunks_cleanup(info);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_copy</span>(LodePNGInfo<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> source)
{
  lodepng_info_cleanup(dest);
  <span style="color: #333333">*</span>dest <span style="color: #333333">=</span> <span style="color: #333333">*</span>source;
  lodepng_color_mode_init(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>color);
  CERROR_TRY_RETURN(lodepng_color_mode_copy(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>color, <span style="color: #333333">&amp;</span>source<span style="color: #333333">-&gt;</span>color));

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  CERROR_TRY_RETURN(LodePNGText_copy(dest, source));
  CERROR_TRY_RETURN(LodePNGIText_copy(dest, source));

  LodePNGUnknownChunks_init(dest);
  CERROR_TRY_RETURN(LodePNGUnknownChunks_copy(dest, source));
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_swap</span>(LodePNGInfo<span style="color: #333333">*</span> a, LodePNGInfo<span style="color: #333333">*</span> b)
{
  LodePNGInfo temp <span style="color: #333333">=</span> <span style="color: #333333">*</span>a;
  <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #333333">*</span>b;
  <span style="color: #333333">*</span>b <span style="color: #333333">=</span> temp;
}

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*index: bitgroup index, bits: bitgroup size(1, 2 or 4), in: bitgroup value, out: octet array to add bits to*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addColorBits</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span> index, <span style="color: #6666ff; font-weight: bold">unsigned</span> bits, <span style="color: #6666ff; font-weight: bold">unsigned</span> in)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> m <span style="color: #333333">=</span> bits <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">7</span> <span style="color: #333333">:</span> bits <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*8 / bits - 1*/</span>
  <span style="color: #666666; font-style: italic">/*p = the partial index in the byte, e.g. with 4 palettebits it is 0 for first half or 1 for second half*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> p <span style="color: #333333">=</span> index <span style="color: #333333">&amp;</span> m;
  in <span style="color: #333333">&amp;=</span> (<span style="color: #6666ff; font-weight: bold">1u</span> <span style="color: #333333">&lt;&lt;</span> bits) <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1u</span>; <span style="color: #666666; font-style: italic">/*filter out any other bits of the input value*/</span>
  in <span style="color: #333333">=</span> in <span style="color: #333333">&lt;&lt;</span> (bits <span style="color: #333333">*</span> (m <span style="color: #333333">-</span> p));
  <span style="color: #228899; font-weight: bold">if</span>(p <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) out[index <span style="color: #333333">*</span> bits <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>] <span style="color: #333333">=</span> in;
  <span style="color: #228899; font-weight: bold">else</span> out[index <span style="color: #333333">*</span> bits <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>] <span style="color: #333333">|=</span> in;
}

<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> ColorTree ColorTree;

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">One node of a color tree</span>
<span style="color: #666666; font-style: italic">This is the data structure used to count the number of unique colors and to get a palette</span>
<span style="color: #666666; font-style: italic">index for a color. It&#39;s like an octree, but because the alpha channel is used too, each</span>
<span style="color: #666666; font-style: italic">node has 16 instead of 8 children.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">struct</span> ColorTree
{
  ColorTree<span style="color: #333333">*</span> children[<span style="color: #6666ff; font-weight: bold">16</span>]; <span style="color: #666666; font-style: italic">/*up to 16 pointers to ColorTree of next level*/</span>
  <span style="color: #6666ff; font-weight: bold">int</span> index; <span style="color: #666666; font-style: italic">/*the payload. Only has a meaningful value if this is in the last level*/</span>
};

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">color_tree_init</span>(ColorTree<span style="color: #333333">*</span> tree)
{
  <span style="color: #6666ff; font-weight: bold">int</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">16</span>; i<span style="color: #333333">++</span>) tree<span style="color: #333333">-&gt;</span>children[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  tree<span style="color: #333333">-&gt;</span>index <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">color_tree_cleanup</span>(ColorTree<span style="color: #333333">*</span> tree)
{
  <span style="color: #6666ff; font-weight: bold">int</span> i;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">16</span>; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(tree<span style="color: #333333">-&gt;</span>children[i])
    {
      color_tree_cleanup(tree<span style="color: #333333">-&gt;</span>children[i]);
      lodepng_free(tree<span style="color: #333333">-&gt;</span>children[i]);
    }
  }
}

<span style="color: #666666; font-style: italic">/*returns -1 if color not present, its index otherwise*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">int</span> <span style="color: #55eedd; font-weight: bold">color_tree_get</span>(ColorTree<span style="color: #333333">*</span> tree, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a)
{
  <span style="color: #6666ff; font-weight: bold">int</span> bit <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(bit <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; bit <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>; bit<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">*</span> ((r <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> ((g <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> ((b <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">*</span> ((a <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>children[i]) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
    <span style="color: #228899; font-weight: bold">else</span> tree <span style="color: #333333">=</span> tree<span style="color: #333333">-&gt;</span>children[i];
  }
  <span style="color: #228899; font-weight: bold">return</span> tree <span style="color: #333333">?</span> tree<span style="color: #333333">-&gt;</span>index <span style="color: #333333">:</span> <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">int</span> <span style="color: #55eedd; font-weight: bold">color_tree_has</span>(ColorTree<span style="color: #333333">*</span> tree, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a)
{
  <span style="color: #228899; font-weight: bold">return</span> color_tree_get(tree, r, g, b, a) <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*color is not allowed to already exist.</span>
<span style="color: #666666; font-style: italic">Index should be &gt;= 0 (it&#39;s signed to be compatible with using -1 for &quot;doesn&#39;t exist&quot;)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">color_tree_add</span>(ColorTree<span style="color: #333333">*</span> tree,
                           <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a, <span style="color: #6666ff; font-weight: bold">unsigned</span> index)
{
  <span style="color: #6666ff; font-weight: bold">int</span> bit;
  <span style="color: #228899; font-weight: bold">for</span>(bit <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; bit <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>; bit<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">*</span> ((r <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> ((g <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> ((b <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">*</span> ((a <span style="color: #333333">&gt;&gt;</span> bit) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>tree<span style="color: #333333">-&gt;</span>children[i])
    {
      tree<span style="color: #333333">-&gt;</span>children[i] <span style="color: #333333">=</span> (ColorTree<span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(ColorTree));
      color_tree_init(tree<span style="color: #333333">-&gt;</span>children[i]);
    }
    tree <span style="color: #333333">=</span> tree<span style="color: #333333">-&gt;</span>children[i];
  }
  tree<span style="color: #333333">-&gt;</span>index <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">int</span>)index;
}

<span style="color: #666666; font-style: italic">/*put a pixel, given its RGBA color, into image of any color type*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">rgba8ToPixel</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span> i,
                             <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode, ColorTree<span style="color: #333333">*</span> tree <span style="color: #666666; font-style: italic">/*for palette*/</span>,
                             <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a)
{
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> grey <span style="color: #333333">=</span> r; <span style="color: #666666; font-style: italic">/*((unsigned short)r + g + b) / 3*/</span>;
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>) out[i] <span style="color: #333333">=</span> grey;
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>) out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> grey;
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #666666; font-style: italic">/*take the most significant bits of grey*/</span>
      grey <span style="color: #333333">=</span> (grey <span style="color: #333333">&gt;&gt;</span> (<span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">-</span> mode<span style="color: #333333">-&gt;</span>bitdepth)) <span style="color: #333333">&amp;</span> ((<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">&lt;&lt;</span> mode<span style="color: #333333">-&gt;</span>bitdepth) <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>);
      addColorBits(out, i, mode<span style="color: #333333">-&gt;</span>bitdepth, grey);
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> r;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> g;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> b;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> r;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> g;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> b;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #6666ff; font-weight: bold">int</span> index <span style="color: #333333">=</span> color_tree_get(tree, r, g, b, a);
    <span style="color: #228899; font-weight: bold">if</span>(index <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">82</span>; <span style="color: #666666; font-style: italic">/*color not in palette*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>) out[i] <span style="color: #333333">=</span> index;
    <span style="color: #228899; font-weight: bold">else</span> addColorBits(out, i, mode<span style="color: #333333">-&gt;</span>bitdepth, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)index);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> grey <span style="color: #333333">=</span> r; <span style="color: #666666; font-style: italic">/*((unsigned short)r + g + b) / 3*/</span>;
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> grey;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> a;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> grey;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> a;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> r;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> g;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> b;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> a;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> r;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> g;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> b;
      out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">=</span> out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> a;
    }
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*no error*/</span>
}

<span style="color: #666666; font-style: italic">/*put a pixel, given its RGBA16 color, into image of any color 16-bitdepth type*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">rgba16ToPixel</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span> i,
                         <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode,
                         <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> a)
{
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> grey <span style="color: #333333">=</span> r; <span style="color: #666666; font-style: italic">/*((unsigned)r + g + b) / 3*/</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (grey <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> grey <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (r <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> r <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (g <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> g <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> (b <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> b <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> grey <span style="color: #333333">=</span> r; <span style="color: #666666; font-style: italic">/*((unsigned)r + g + b) / 3*/</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (grey <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> grey <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (a <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> a <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (r <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> r <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (g <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> g <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> (b <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> b <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">=</span> (a <span style="color: #333333">&gt;&gt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    out[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> a <span style="color: #333333">&amp;</span> <span style="color: #6666ff; font-weight: bold">255</span>;
  }
}

<span style="color: #666666; font-style: italic">/*Get RGBA8 color of pixel with index i (y * width + x) from the raw image with given color type.*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">getPixelColorRGBA8</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> g,
                               <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> a,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> i,
                               <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode)
{
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i];
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>r <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> highest <span style="color: #333333">=</span> ((<span style="color: #6666ff; font-weight: bold">1U</span> <span style="color: #333333">&lt;&lt;</span> mode<span style="color: #333333">-&gt;</span>bitdepth) <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1U</span>); <span style="color: #666666; font-style: italic">/*highest possible value for this bit depth*/</span>
      <span style="color: #6666ff; font-weight: bold">size_t</span> j <span style="color: #333333">=</span> i <span style="color: #333333">*</span> mode<span style="color: #333333">-&gt;</span>bitdepth;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> value <span style="color: #333333">=</span> readBitsFromReversedStream(<span style="color: #333333">&amp;</span>j, in, mode<span style="color: #333333">-&gt;</span>bitdepth);
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> (value <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #333333">/</span> highest;
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> value <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>]; <span style="color: #333333">*</span>g <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>]; <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>r <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>g <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">*</span>b <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_b) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>g <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>];
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r
         <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_g
         <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_b) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> index;
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>) index <span style="color: #333333">=</span> in[i];
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #6666ff; font-weight: bold">size_t</span> j <span style="color: #333333">=</span> i <span style="color: #333333">*</span> mode<span style="color: #333333">-&gt;</span>bitdepth;
      index <span style="color: #333333">=</span> readBitsFromReversedStream(<span style="color: #333333">&amp;</span>j, in, mode<span style="color: #333333">-&gt;</span>bitdepth);
    }

    <span style="color: #228899; font-weight: bold">if</span>(index <span style="color: #333333">&gt;=</span> mode<span style="color: #333333">-&gt;</span>palettesize)
    {
      <span style="color: #666666; font-style: italic">/*This is an error according to the PNG spec, but common PNG decoders make it black instead.</span>
<span style="color: #666666; font-style: italic">      Done here too, slightly faster due to no error handling needed.*/</span>
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>g <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
      <span style="color: #333333">*</span>b <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>g <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
      <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #333333">*</span>r <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
      <span style="color: #333333">*</span>g <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      <span style="color: #333333">*</span>b <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>];
      <span style="color: #333333">*</span>a <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">6</span>];
    }
  }
}

<span style="color: #666666; font-style: italic">/*Similar to getPixelColorRGBA8, but with all the for loops inside of the color</span>
<span style="color: #666666; font-style: italic">mode test cases, optimized to convert the colors much faster, when converting</span>
<span style="color: #666666; font-style: italic">to RGBA or RGB with 8 bit per cannel. buffer must be RGBA or RGB output with</span>
<span style="color: #666666; font-style: italic">enough memory, if has_alpha is true the output is RGBA. mode has the color mode</span>
<span style="color: #666666; font-style: italic">of the input buffer.*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">getPixelColorsRGBA8</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">size_t</span> numpixels,
                                <span style="color: #6666ff; font-weight: bold">unsigned</span> has_alpha, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> num_channels <span style="color: #333333">=</span> has_alpha <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">3</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> in[i] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> highest <span style="color: #333333">=</span> ((<span style="color: #6666ff; font-weight: bold">1U</span> <span style="color: #333333">&lt;&lt;</span> mode<span style="color: #333333">-&gt;</span>bitdepth) <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1U</span>); <span style="color: #666666; font-style: italic">/*highest possible value for this bit depth*/</span>
      <span style="color: #6666ff; font-weight: bold">size_t</span> j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> value <span style="color: #333333">=</span> readBitsFromReversedStream(<span style="color: #333333">&amp;</span>j, in, mode<span style="color: #333333">-&gt;</span>bitdepth);
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (value <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #333333">/</span> highest;
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> value <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r
           <span style="color: #333333">&amp;&amp;</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>]<span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">&amp;&amp;</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>key_defined
           <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r
           <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_g
           <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> index;
    <span style="color: #6666ff; font-weight: bold">size_t</span> j <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
    {
      <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>) index <span style="color: #333333">=</span> in[i];
      <span style="color: #228899; font-weight: bold">else</span> index <span style="color: #333333">=</span> readBitsFromReversedStream(<span style="color: #333333">&amp;</span>j, in, mode<span style="color: #333333">-&gt;</span>bitdepth);

      <span style="color: #228899; font-weight: bold">if</span>(index <span style="color: #333333">&gt;=</span> mode<span style="color: #333333">-&gt;</span>palettesize)
      {
        <span style="color: #666666; font-style: italic">/*This is an error according to the PNG spec, but most PNG decoders make it black instead.</span>
<span style="color: #666666; font-style: italic">        Done here too, slightly faster due to no error handling needed.*/</span>
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> mode<span style="color: #333333">-&gt;</span>palette[index <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
      }
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
      }
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>, buffer <span style="color: #333333">+=</span> num_channels)
      {
        buffer[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
        buffer[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>];
        <span style="color: #228899; font-weight: bold">if</span>(has_alpha) buffer[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">6</span>];
      }
    }
  }
}

<span style="color: #666666; font-style: italic">/*Get RGBA16 color of pixel with index i (y * width + x) from the raw image with</span>
<span style="color: #666666; font-style: italic">given color type, but the given color type must be 16-bit itself.*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">getPixelColorRGBA16</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span><span style="color: #333333">*</span> a,
                                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> i, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode)
{
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span>;
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
    <span style="color: #333333">*</span>b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>];
    <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_r
       <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_g
       <span style="color: #333333">&amp;&amp;</span> <span style="color: #6666ff; font-weight: bold">256U</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">==</span> mode<span style="color: #333333">-&gt;</span>key_b) <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">65535</span>;
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #333333">*</span>b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    <span style="color: #333333">*</span>r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    <span style="color: #333333">*</span>g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>];
    <span style="color: #333333">*</span>b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">5</span>];
    <span style="color: #333333">*</span>a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">*</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">+</span> in[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>];
  }
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_convert</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                         LodePNGColorMode<span style="color: #333333">*</span> mode_out, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode_in,
                         <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ColorTree tree;
  <span style="color: #6666ff; font-weight: bold">size_t</span> numpixels <span style="color: #333333">=</span> w <span style="color: #333333">*</span> h;

  <span style="color: #228899; font-weight: bold">if</span>(lodepng_color_mode_equal(mode_out, mode_in))
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> numbytes <span style="color: #333333">=</span> lodepng_get_raw_size(w, h, mode_in);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numbytes; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> in[i];
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  }

  <span style="color: #228899; font-weight: bold">if</span>(mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> palsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1u</span> <span style="color: #333333">&lt;&lt;</span> mode_out<span style="color: #333333">-&gt;</span>bitdepth;
    <span style="color: #228899; font-weight: bold">if</span>(mode_out<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">&lt;</span> palsize) palsize <span style="color: #333333">=</span> mode_out<span style="color: #333333">-&gt;</span>palettesize;
    color_tree_init(<span style="color: #333333">&amp;</span>tree);
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> palsize; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> p <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>mode_out<span style="color: #333333">-&gt;</span>palette[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span>];
      color_tree_add(<span style="color: #333333">&amp;</span>tree, p[<span style="color: #6666ff; font-weight: bold">0</span>], p[<span style="color: #6666ff; font-weight: bold">1</span>], p[<span style="color: #6666ff; font-weight: bold">2</span>], p[<span style="color: #6666ff; font-weight: bold">3</span>], i);
    }
  }

  <span style="color: #228899; font-weight: bold">if</span>(mode_in<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span> <span style="color: #333333">&amp;&amp;</span> mode_out<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      getPixelColorRGBA16(<span style="color: #333333">&amp;</span>r, <span style="color: #333333">&amp;</span>g, <span style="color: #333333">&amp;</span>b, <span style="color: #333333">&amp;</span>a, in, i, mode_in);
      rgba16ToPixel(out, i, mode_out, r, g, b, a);
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode_out<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">&amp;&amp;</span> mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    getPixelColorsRGBA8(out, numpixels, <span style="color: #6666ff; font-weight: bold">1</span>, in, mode_in);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(mode_out<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">&amp;&amp;</span> mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    getPixelColorsRGBA8(out, numpixels, <span style="color: #6666ff; font-weight: bold">0</span>, in, mode_in);
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>)
    {
      getPixelColorRGBA8(<span style="color: #333333">&amp;</span>r, <span style="color: #333333">&amp;</span>g, <span style="color: #333333">&amp;</span>b, <span style="color: #333333">&amp;</span>a, in, i, mode_in);
      rgba8ToPixel(out, i, mode_out, <span style="color: #333333">&amp;</span>tree, r, g, b, a);
    }
  }

  <span style="color: #228899; font-weight: bold">if</span>(mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    color_tree_cleanup(<span style="color: #333333">&amp;</span>tree);
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*no error (this function currently never has one, but maybe OOM detection added later.)*/</span>
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_profile_init</span>(LodePNGColorProfile<span style="color: #333333">*</span> profile)
{
  profile<span style="color: #333333">-&gt;</span>colored <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> profile<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  profile<span style="color: #333333">-&gt;</span>numcolors <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #666666; font-style: italic">/*function used for debug purposes with C++*/</span>
<span style="color: #666666; font-style: italic">/*void printColorProfile(LodePNGColorProfile* p)</span>
<span style="color: #666666; font-style: italic">{</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;colored: &quot; &lt;&lt; (int)p-&gt;colored &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;key: &quot; &lt;&lt; (int)p-&gt;key &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;key_r: &quot; &lt;&lt; (int)p-&gt;key_r &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;key_g: &quot; &lt;&lt; (int)p-&gt;key_g &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;key_b: &quot; &lt;&lt; (int)p-&gt;key_b &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;alpha: &quot; &lt;&lt; (int)p-&gt;alpha &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;numcolors: &quot; &lt;&lt; (int)p-&gt;numcolors &lt;&lt; &quot;, &quot;;</span>
<span style="color: #666666; font-style: italic">  std::cout &lt;&lt; &quot;bits: &quot; &lt;&lt; (int)p-&gt;bits &lt;&lt; std::endl;</span>
<span style="color: #666666; font-style: italic">}*/</span>

<span style="color: #666666; font-style: italic">/*Returns how many bits needed to represent given value (max 8 bit)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">getValueRequiredBits</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> value)
{
  <span style="color: #228899; font-weight: bold">if</span>(value <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> value <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #666666; font-style: italic">/*The scaling of 2-bit and 4-bit values uses multiples of 85 and 17*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(value <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">17</span> <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> value <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">85</span> <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">4</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">8</span>;
}

<span style="color: #666666; font-style: italic">/*profile must already have been inited with mode.</span>
<span style="color: #666666; font-style: italic">It&#39;s ok to set some parameters of profile to done already.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">get_color_profile</span>(LodePNGColorProfile<span style="color: #333333">*</span> profile,
                           <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                           <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ColorTree tree;
  <span style="color: #6666ff; font-weight: bold">size_t</span> numpixels <span style="color: #333333">=</span> w <span style="color: #333333">*</span> h;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> colored_done <span style="color: #333333">=</span> lodepng_is_greyscale_type(mode) <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> alpha_done <span style="color: #333333">=</span> lodepng_can_have_alpha(mode) <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> numcolors_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp <span style="color: #333333">=</span> lodepng_get_bpp(mode);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bits_done <span style="color: #333333">=</span> bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> maxnumcolors <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">257</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> sixteen <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">8</span>) maxnumcolors <span style="color: #333333">=</span> bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">:</span> (bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">:</span> (bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">16</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">256</span>));

  color_tree_init(<span style="color: #333333">&amp;</span>tree);

  <span style="color: #666666; font-style: italic">/*Check if the 16-bit input is truly 16-bit*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(mode<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">16</span>)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> r, g, b, a;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>)
    {
      getPixelColorRGBA16(<span style="color: #333333">&amp;</span>r, <span style="color: #333333">&amp;</span>g, <span style="color: #333333">&amp;</span>b, <span style="color: #333333">&amp;</span>a, in, i, mode);
      <span style="color: #228899; font-weight: bold">if</span>(r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">257u</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> g <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">257u</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> b <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">257u</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> a <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">257u</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #666666; font-style: italic">/*first and second byte differ*/</span>
      {
        sixteen <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
  }

  <span style="color: #228899; font-weight: bold">if</span>(sixteen)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">16</span>;
    bits_done <span style="color: #333333">=</span> numcolors_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*counting colors no longer useful, palette doesn&#39;t support 16-bit*/</span>

    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>)
    {
      getPixelColorRGBA16(<span style="color: #333333">&amp;</span>r, <span style="color: #333333">&amp;</span>g, <span style="color: #333333">&amp;</span>b, <span style="color: #333333">&amp;</span>a, in, i, mode);
      
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>colored_done <span style="color: #333333">&amp;&amp;</span> (r <span style="color: #333333">!=</span> g <span style="color: #333333">||</span> r <span style="color: #333333">!=</span> b))
      {
        profile<span style="color: #333333">-&gt;</span>colored <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        colored_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
      }

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>alpha_done)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> matchkey <span style="color: #333333">=</span> (r <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">&amp;&amp;</span> g <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">&amp;&amp;</span> b <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_b);
        <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">65535</span> <span style="color: #333333">&amp;&amp;</span> (a <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> (profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>matchkey)))
        {
          profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          alpha_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          <span style="color: #228899; font-weight: bold">if</span>(profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>; <span style="color: #666666; font-style: italic">/*PNG has no alphachannel modes with less than 8-bit per channel*/</span>
        }
        <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>profile<span style="color: #333333">-&gt;</span>key)
        {
          profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> r;
          profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> g;
          profile<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> b;
        }
        <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">65535</span> <span style="color: #333333">&amp;&amp;</span> profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">&amp;&amp;</span> matchkey)
        {
          <span style="color: #666666; font-style: italic">/* Color key cannot be used if an opaque pixel also has that RGB color. */</span>
          profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          alpha_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        }
      }

      <span style="color: #228899; font-weight: bold">if</span>(alpha_done <span style="color: #333333">&amp;&amp;</span> numcolors_done <span style="color: #333333">&amp;&amp;</span> colored_done <span style="color: #333333">&amp;&amp;</span> bits_done) <span style="color: #228899; font-weight: bold">break</span>;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/* &lt; 16-bit */</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> numpixels; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, a <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      getPixelColorRGBA8(<span style="color: #333333">&amp;</span>r, <span style="color: #333333">&amp;</span>g, <span style="color: #333333">&amp;</span>b, <span style="color: #333333">&amp;</span>a, in, i, mode);

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>bits_done <span style="color: #333333">&amp;&amp;</span> profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>)
      {
        <span style="color: #666666; font-style: italic">/*only r is checked, &lt; 8 bits is only relevant for greyscale*/</span>
        <span style="color: #6666ff; font-weight: bold">unsigned</span> bits <span style="color: #333333">=</span> getValueRequiredBits(r);
        <span style="color: #228899; font-weight: bold">if</span>(bits <span style="color: #333333">&gt;</span> profile<span style="color: #333333">-&gt;</span>bits) profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> bits;
      }
      bits_done <span style="color: #333333">=</span> (profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&gt;=</span> bpp);

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>colored_done <span style="color: #333333">&amp;&amp;</span> (r <span style="color: #333333">!=</span> g <span style="color: #333333">||</span> r <span style="color: #333333">!=</span> b))
      {
        profile<span style="color: #333333">-&gt;</span>colored <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        colored_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
        <span style="color: #228899; font-weight: bold">if</span>(profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>; <span style="color: #666666; font-style: italic">/*PNG has no colored modes with less than 8-bit per channel*/</span>
      }

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>alpha_done)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> matchkey <span style="color: #333333">=</span> (r <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">&amp;&amp;</span> g <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">&amp;&amp;</span> b <span style="color: #333333">==</span> profile<span style="color: #333333">-&gt;</span>key_b);
        <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">255</span> <span style="color: #333333">&amp;&amp;</span> (a <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> (profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>matchkey)))
        {
          profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          alpha_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          <span style="color: #228899; font-weight: bold">if</span>(profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>; <span style="color: #666666; font-style: italic">/*PNG has no alphachannel modes with less than 8-bit per channel*/</span>
        }
        <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>profile<span style="color: #333333">-&gt;</span>key)
        {
          profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> r;
          profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> g;
          profile<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> b;
        }
        <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(a <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">255</span> <span style="color: #333333">&amp;&amp;</span> profile<span style="color: #333333">-&gt;</span>key <span style="color: #333333">&amp;&amp;</span> matchkey)
        {
          <span style="color: #666666; font-style: italic">/* Color key cannot be used if an opaque pixel also has that RGB color. */</span>
          profile<span style="color: #333333">-&gt;</span>alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          alpha_done <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          <span style="color: #228899; font-weight: bold">if</span>(profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>) profile<span style="color: #333333">-&gt;</span>bits <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>; <span style="color: #666666; font-style: italic">/*PNG has no alphachannel modes with less than 8-bit per channel*/</span>
        }
      }

      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>numcolors_done)
      {
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>color_tree_has(<span style="color: #333333">&amp;</span>tree, r, g, b, a))
        {
          color_tree_add(<span style="color: #333333">&amp;</span>tree, r, g, b, a, profile<span style="color: #333333">-&gt;</span>numcolors);
          <span style="color: #228899; font-weight: bold">if</span>(profile<span style="color: #333333">-&gt;</span>numcolors <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">256</span>)
          {
            <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> p <span style="color: #333333">=</span> profile<span style="color: #333333">-&gt;</span>palette;
            <span style="color: #6666ff; font-weight: bold">unsigned</span> n <span style="color: #333333">=</span> profile<span style="color: #333333">-&gt;</span>numcolors;
            p[n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> r;
            p[n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> g;
            p[n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> b;
            p[n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> a;
          }
          profile<span style="color: #333333">-&gt;</span>numcolors<span style="color: #333333">++</span>;
          numcolors_done <span style="color: #333333">=</span> profile<span style="color: #333333">-&gt;</span>numcolors <span style="color: #333333">&gt;=</span> maxnumcolors;
        }
      }

      <span style="color: #228899; font-weight: bold">if</span>(alpha_done <span style="color: #333333">&amp;&amp;</span> numcolors_done <span style="color: #333333">&amp;&amp;</span> colored_done <span style="color: #333333">&amp;&amp;</span> bits_done) <span style="color: #228899; font-weight: bold">break</span>;
    }

    <span style="color: #666666; font-style: italic">/*make the profile&#39;s key always 16-bit for consistency - repeat each byte twice*/</span>
    profile<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">*=</span> <span style="color: #6666ff; font-weight: bold">257</span>;
    profile<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">*=</span> <span style="color: #6666ff; font-weight: bold">257</span>;
    profile<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">*=</span> <span style="color: #6666ff; font-weight: bold">257</span>;
  }

  color_tree_cleanup(<span style="color: #333333">&amp;</span>tree);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*Automatically chooses color type that gives smallest amount of bits in the</span>
<span style="color: #666666; font-style: italic">output image, e.g. grey if there are only greyscale pixels, palette if there</span>
<span style="color: #666666; font-style: italic">are less than 256 colors, ...</span>
<span style="color: #666666; font-style: italic">Updates values of mode with a potentially smaller color model. mode_out should</span>
<span style="color: #666666; font-style: italic">contain the user chosen color model, but will be overwritten with the new chosen one.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_auto_choose_color</span>(LodePNGColorMode<span style="color: #333333">*</span> mode_out,
                                   <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                                   <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode_in)
{
  LodePNGColorProfile prof;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i, n, palettebits, grey_ok, palette_ok;

  lodepng_color_profile_init(<span style="color: #333333">&amp;</span>prof);
  error <span style="color: #333333">=</span> get_color_profile(<span style="color: #333333">&amp;</span>prof, image, w, h, mode_in);
  <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">return</span> error;
  mode_out<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #228899; font-weight: bold">if</span>(prof.key <span style="color: #333333">&amp;&amp;</span> w <span style="color: #333333">*</span> h <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">16</span>) prof.alpha <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*too few pixels to justify tRNS chunk overhead*/</span>
  grey_ok <span style="color: #333333">=</span> <span style="color: #333333">!</span>prof.colored <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>prof.alpha; <span style="color: #666666; font-style: italic">/*grey without alpha, with potentially low bits*/</span>
  n <span style="color: #333333">=</span> prof.numcolors;
  palettebits <span style="color: #333333">=</span> n <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> (n <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">:</span> (n <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">16</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">8</span>));
  palette_ok <span style="color: #333333">=</span> n <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">256</span> <span style="color: #333333">&amp;&amp;</span> (n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">&lt;</span> w <span style="color: #333333">*</span> h) <span style="color: #333333">&amp;&amp;</span> prof.bits <span style="color: #333333">&lt;=</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #228899; font-weight: bold">if</span>(w <span style="color: #333333">*</span> h <span style="color: #333333">&lt;</span> n <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">2</span>) palette_ok <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*don&#39;t add palette overhead if image has only a few pixels*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(grey_ok <span style="color: #333333">&amp;&amp;</span> prof.bits <span style="color: #333333">&lt;=</span> palettebits) palette_ok <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*grey is less overhead*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(palette_ok)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> p <span style="color: #333333">=</span> prof.palette;
    lodepng_palette_clear(mode_out); <span style="color: #666666; font-style: italic">/*remove potential earlier palette*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> prof.numcolors; i<span style="color: #333333">++</span>)
    {
      error <span style="color: #333333">=</span> lodepng_palette_add(mode_out, p[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>], p[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>], p[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>], p[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>]);
      <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
    }

    mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">=</span> LCT_PALETTE;
    mode_out<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">=</span> palettebits;

    <span style="color: #228899; font-weight: bold">if</span>(mode_in<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE <span style="color: #333333">&amp;&amp;</span> mode_in<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">&gt;=</span> mode_out<span style="color: #333333">-&gt;</span>palettesize
        <span style="color: #333333">&amp;&amp;</span> mode_in<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">==</span> mode_out<span style="color: #333333">-&gt;</span>bitdepth)
    {
      <span style="color: #666666; font-style: italic">/*If input should have same palette colors, keep original to preserve its order and prevent conversion*/</span>
      lodepng_color_mode_cleanup(mode_out);
      lodepng_color_mode_copy(mode_out, mode_in);
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*8-bit or 16-bit per channel*/</span>
  {
    mode_out<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">=</span> prof.bits;
    mode_out<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">=</span> prof.alpha <span style="color: #333333">?</span> (prof.colored <span style="color: #333333">?</span> LCT_RGBA <span style="color: #333333">:</span> LCT_GREY_ALPHA)
                                     <span style="color: #333333">:</span> (prof.colored <span style="color: #333333">?</span> LCT_RGB <span style="color: #333333">:</span> LCT_GREY);

    <span style="color: #228899; font-weight: bold">if</span>(prof.key <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>prof.alpha)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> mask <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">1u</span> <span style="color: #333333">&lt;&lt;</span> mode_out<span style="color: #333333">-&gt;</span>bitdepth) <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1u</span>; <span style="color: #666666; font-style: italic">/*profile always uses 16-bit, mask converts it*/</span>
      mode_out<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> prof.key_r <span style="color: #333333">&amp;</span> mask;
      mode_out<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> prof.key_g <span style="color: #333333">&amp;</span> mask;
      mode_out<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> prof.key_b <span style="color: #333333">&amp;</span> mask;
      mode_out<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    }
  }

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/* #ifdef LODEPNG_COMPILE_ENCODER */</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Paeth predicter, used by PNG filter type 4</span>
<span style="color: #666666; font-style: italic">The parameters are of type short, but should come from unsigned chars, the shorts</span>
<span style="color: #666666; font-style: italic">are only needed to make the paeth calculation correct.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">paethPredictor</span>(<span style="color: #6666ff; font-weight: bold">short</span> a, <span style="color: #6666ff; font-weight: bold">short</span> b, <span style="color: #6666ff; font-weight: bold">short</span> c)
{
  <span style="color: #6666ff; font-weight: bold">short</span> pa <span style="color: #333333">=</span> abs(b <span style="color: #333333">-</span> c);
  <span style="color: #6666ff; font-weight: bold">short</span> pb <span style="color: #333333">=</span> abs(a <span style="color: #333333">-</span> c);
  <span style="color: #6666ff; font-weight: bold">short</span> pc <span style="color: #333333">=</span> abs(a <span style="color: #333333">+</span> b <span style="color: #333333">-</span> c <span style="color: #333333">-</span> c);

  <span style="color: #228899; font-weight: bold">if</span>(pc <span style="color: #333333">&lt;</span> pa <span style="color: #333333">&amp;&amp;</span> pc <span style="color: #333333">&lt;</span> pb) <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)c;
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(pb <span style="color: #333333">&lt;</span> pa) <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)b;
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)a;
}

<span style="color: #666666; font-style: italic">/*shared values used by multiple Adam7 related functions*/</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> ADAM7_IX[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> { <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">1</span>, <span style="color: #6666ff; font-weight: bold">0</span> }; <span style="color: #666666; font-style: italic">/*x start values*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> ADAM7_IY[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> { <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">1</span> }; <span style="color: #666666; font-style: italic">/*y start values*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> ADAM7_DX[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> { <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">1</span> }; <span style="color: #666666; font-style: italic">/*x delta values*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> ADAM7_DY[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">=</span> { <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">8</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #6666ff; font-weight: bold">2</span> }; <span style="color: #666666; font-style: italic">/*y delta values*/</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Outputs various dimensions and positions in the image related to the Adam7 reduced images.</span>
<span style="color: #666666; font-style: italic">passw: output containing the width of the 7 passes</span>
<span style="color: #666666; font-style: italic">passh: output containing the height of the 7 passes</span>
<span style="color: #666666; font-style: italic">filter_passstart: output containing the index of the start and end of each</span>
<span style="color: #666666; font-style: italic"> reduced image with filter bytes</span>
<span style="color: #666666; font-style: italic">padded_passstart output containing the index of the start and end of each</span>
<span style="color: #666666; font-style: italic"> reduced image when without filter bytes but with padded scanlines</span>
<span style="color: #666666; font-style: italic">passstart: output containing the index of the start and end of each reduced</span>
<span style="color: #666666; font-style: italic"> image without padding between scanlines, but still padding between the images</span>
<span style="color: #666666; font-style: italic">w, h: width and height of non-interlaced image</span>
<span style="color: #666666; font-style: italic">bpp: bits per pixel</span>
<span style="color: #666666; font-style: italic">&quot;padded&quot; is only relevant if bpp is less than 8 and a scanline or image does not</span>
<span style="color: #666666; font-style: italic"> end at a full byte</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">Adam7_getpassvalues</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> passw[<span style="color: #6666ff; font-weight: bold">7</span>], <span style="color: #6666ff; font-weight: bold">unsigned</span> passh[<span style="color: #6666ff; font-weight: bold">7</span>], <span style="color: #6666ff; font-weight: bold">size_t</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">8</span>],
                                <span style="color: #6666ff; font-weight: bold">size_t</span> padded_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], <span style="color: #6666ff; font-weight: bold">size_t</span> passstart[<span style="color: #6666ff; font-weight: bold">8</span>], <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp)
{
  <span style="color: #666666; font-style: italic">/*the passstart values have 8 values: the 8th one indicates the byte after the end of the 7th (= last) pass*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  <span style="color: #666666; font-style: italic">/*calculate width and height in pixels of each pass*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
  {
    passw[i] <span style="color: #333333">=</span> (w <span style="color: #333333">+</span> ADAM7_DX[i] <span style="color: #333333">-</span> ADAM7_IX[i] <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">/</span> ADAM7_DX[i];
    passh[i] <span style="color: #333333">=</span> (h <span style="color: #333333">+</span> ADAM7_DY[i] <span style="color: #333333">-</span> ADAM7_IY[i] <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">/</span> ADAM7_DY[i];
    <span style="color: #228899; font-weight: bold">if</span>(passw[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) passh[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">if</span>(passh[i] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) passw[i] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  }

  filter_passstart[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> padded_passstart[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> passstart[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
  {
    <span style="color: #666666; font-style: italic">/*if passw[i] is 0, it&#39;s 0 bytes, not 1 (no filtertype-byte)*/</span>
    filter_passstart[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> filter_passstart[i]
                            <span style="color: #333333">+</span> ((passw[i] <span style="color: #333333">&amp;&amp;</span> passh[i]) <span style="color: #333333">?</span> passh[i] <span style="color: #333333">*</span> (<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> (passw[i] <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>);
    <span style="color: #666666; font-style: italic">/*bits padded if needed to fill full byte at end of each scanline*/</span>
    padded_passstart[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> padded_passstart[i] <span style="color: #333333">+</span> passh[i] <span style="color: #333333">*</span> ((passw[i] <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>);
    <span style="color: #666666; font-style: italic">/*only padded at end of reduced image*/</span>
    passstart[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> passstart[i] <span style="color: #333333">+</span> (passh[i] <span style="color: #333333">*</span> passw[i] <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  }
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / PNG Decoder                                                            / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*read the information from the header and store it in the LodePNGInfo. return value is error*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_inspect</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, LodePNGState<span style="color: #333333">*</span> state,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  LodePNGInfo<span style="color: #333333">*</span> info <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png;
  <span style="color: #228899; font-weight: bold">if</span>(insize <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> in <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">48</span>); <span style="color: #666666; font-style: italic">/*error: the given data is empty*/</span>
  }
  <span style="color: #228899; font-weight: bold">if</span>(insize <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">29</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">27</span>); <span style="color: #666666; font-style: italic">/*error: the data length is smaller than the length of a PNG header*/</span>
  }

  <span style="color: #666666; font-style: italic">/*when decoding a new PNG image, make sure all parameters created after previous decoding are reset*/</span>
  lodepng_info_cleanup(info);
  lodepng_info_init(info);

  <span style="color: #228899; font-weight: bold">if</span>(in[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">137</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">80</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">78</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">71</span>
     <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">13</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">10</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">26</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">7</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">10</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">28</span>); <span style="color: #666666; font-style: italic">/*error: the first 8 bytes are not the correct PNG signature*/</span>
  }
  <span style="color: #228899; font-weight: bold">if</span>(in[<span style="color: #6666ff; font-weight: bold">12</span>] <span style="color: #333333">!=</span> <span style="color: #8888FF">&#39;I&#39;</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">13</span>] <span style="color: #333333">!=</span> <span style="color: #8888FF">&#39;H&#39;</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">14</span>] <span style="color: #333333">!=</span> <span style="color: #8888FF">&#39;D&#39;</span> <span style="color: #333333">||</span> in[<span style="color: #6666ff; font-weight: bold">15</span>] <span style="color: #333333">!=</span> <span style="color: #8888FF">&#39;R&#39;</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">29</span>); <span style="color: #666666; font-style: italic">/*error: it doesn&#39;t start with a IHDR chunk!*/</span>
  }

  <span style="color: #666666; font-style: italic">/*read the values given in the header*/</span>
  <span style="color: #333333">*</span>w <span style="color: #333333">=</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">16</span>]);
  <span style="color: #333333">*</span>h <span style="color: #333333">=</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">20</span>]);
  info<span style="color: #333333">-&gt;</span>color.bitdepth <span style="color: #333333">=</span> in[<span style="color: #6666ff; font-weight: bold">24</span>];
  info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">=</span> (LodePNGColorType)in[<span style="color: #6666ff; font-weight: bold">25</span>];
  info<span style="color: #333333">-&gt;</span>compression_method <span style="color: #333333">=</span> in[<span style="color: #6666ff; font-weight: bold">26</span>];
  info<span style="color: #333333">-&gt;</span>filter_method <span style="color: #333333">=</span> in[<span style="color: #6666ff; font-weight: bold">27</span>];
  info<span style="color: #333333">-&gt;</span>interlace_method <span style="color: #333333">=</span> in[<span style="color: #6666ff; font-weight: bold">28</span>];

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>decoder.ignore_crc)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> CRC <span style="color: #333333">=</span> lodepng_read32bitInt(<span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">29</span>]);
    <span style="color: #6666ff; font-weight: bold">unsigned</span> checksum <span style="color: #333333">=</span> lodepng_crc32(<span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">12</span>], <span style="color: #6666ff; font-weight: bold">17</span>);
    <span style="color: #228899; font-weight: bold">if</span>(CRC <span style="color: #333333">!=</span> checksum)
    {
      CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">57</span>); <span style="color: #666666; font-style: italic">/*invalid CRC*/</span>
    }
  }

  <span style="color: #666666; font-style: italic">/*error: only compression method 0 is allowed in the specification*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>compression_method <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">32</span>);
  <span style="color: #666666; font-style: italic">/*error: only filter method 0 is allowed in the specification*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>filter_method <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">33</span>);
  <span style="color: #666666; font-style: italic">/*error: only interlace methods 0 and 1 exist in the specification*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>interlace_method <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">1</span>) CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">34</span>);

  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> checkColorValidity(info<span style="color: #333333">-&gt;</span>color.colortype, info<span style="color: #333333">-&gt;</span>color.bitdepth);
  <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">unfilterScanline</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> recon, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> scanline, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> precon,
                                 <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> filterType, <span style="color: #6666ff; font-weight: bold">size_t</span> length)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  For PNG filter method 0</span>
<span style="color: #666666; font-style: italic">  unfilter a PNG image scanline by scanline. when the pixels are smaller than 1 byte,</span>
<span style="color: #666666; font-style: italic">  the filter works byte per byte (bytewidth = 1)</span>
<span style="color: #666666; font-style: italic">  precon is the previous unfiltered scanline, recon the result, scanline the current one</span>
<span style="color: #666666; font-style: italic">  the incoming scanlines do NOT include the filtertype byte, that one is given in the parameter filterType instead</span>
<span style="color: #666666; font-style: italic">  recon and scanline MAY be the same memory address! precon must be disjoint.</span>
<span style="color: #666666; font-style: italic">  */</span>

  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">switch</span>(filterType)
  {
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">0</span>:
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i];
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">1</span>:
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i];
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">+</span> recon[i <span style="color: #333333">-</span> bytewidth];
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">2</span>:
      <span style="color: #228899; font-weight: bold">if</span>(precon)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">+</span> precon[i];
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i];
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">3</span>:
      <span style="color: #228899; font-weight: bold">if</span>(precon)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">+</span> precon[i] <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>;
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">+</span> ((recon[i <span style="color: #333333">-</span> bytewidth] <span style="color: #333333">+</span> precon[i]) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>);
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i];
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) recon[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">+</span> recon[i <span style="color: #333333">-</span> bytewidth] <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>;
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">4</span>:
      <span style="color: #228899; font-weight: bold">if</span>(precon)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>)
        {
          recon[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">+</span> precon[i]); <span style="color: #666666; font-style: italic">/*paethPredictor(0, precon[i], 0) is always precon[i]*/</span>
        }
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>)
        {
          recon[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">+</span> paethPredictor(recon[i <span style="color: #333333">-</span> bytewidth], precon[i], precon[i <span style="color: #333333">-</span> bytewidth]));
        }
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>)
        {
          recon[i] <span style="color: #333333">=</span> scanline[i];
        }
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>)
        {
          <span style="color: #666666; font-style: italic">/*paethPredictor(recon[i - bytewidth], 0, 0) is always recon[i - bytewidth]*/</span>
          recon[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">+</span> recon[i <span style="color: #333333">-</span> bytewidth]);
        }
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #997700; font-weight: bold">default:</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">36</span>; <span style="color: #666666; font-style: italic">/*error: unexisting filter type given*/</span>
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">unfilter</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  For PNG filter method 0</span>
<span style="color: #666666; font-style: italic">  this function unfilters a single image (e.g. without interlacing this is called once, with Adam7 seven times)</span>
<span style="color: #666666; font-style: italic">  out must have enough bytes allocated already, in must have the scanlines + 1 filtertype byte per scanline</span>
<span style="color: #666666; font-style: italic">  w and h are image dimensions or dimensions of reduced image, bpp is bits per pixel</span>
<span style="color: #666666; font-style: italic">  in and out are allowed to be the same memory address (but aren&#39;t the same size since in has the extra filter bytes)</span>
<span style="color: #666666; font-style: italic">  */</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> y;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> prevline <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #666666; font-style: italic">/*bytewidth is used for filtering, is 1 when bpp &lt; 8, number of bytes per pixel otherwise*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth <span style="color: #333333">=</span> (bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> linebytes <span style="color: #333333">=</span> (w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;

  <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> outindex <span style="color: #333333">=</span> linebytes <span style="color: #333333">*</span> y;
    <span style="color: #6666ff; font-weight: bold">size_t</span> inindex <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> linebytes) <span style="color: #333333">*</span> y; <span style="color: #666666; font-style: italic">/*the extra filterbyte added to each row*/</span>
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> filterType <span style="color: #333333">=</span> in[inindex];

    CERROR_TRY_RETURN(unfilterScanline(<span style="color: #333333">&amp;</span>out[outindex], <span style="color: #333333">&amp;</span>in[inindex <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>], prevline, bytewidth, filterType, linebytes));

    prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>out[outindex];
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">in: Adam7 interlaced image, with no padding bits between scanlines, but between</span>
<span style="color: #666666; font-style: italic"> reduced images so that each reduced image starts at a byte.</span>
<span style="color: #666666; font-style: italic">out: the same pixels, but re-ordered so that they&#39;re now a non-interlaced image with size w*h</span>
<span style="color: #666666; font-style: italic">bpp: bits per pixel</span>
<span style="color: #666666; font-style: italic">out has the following size in bits: w * h * bpp.</span>
<span style="color: #666666; font-style: italic">in is possibly bigger due to padding bits between reduced images.</span>
<span style="color: #666666; font-style: italic">out must be big enough AND must be 0 everywhere if bpp &lt; 8 in the current implementation</span>
<span style="color: #666666; font-style: italic">(because that&#39;s likely a little bit faster)</span>
<span style="color: #666666; font-style: italic">NOTE: comments about padding bits are only relevant if bpp &lt; 8</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">Adam7_deinterlace</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> passw[<span style="color: #6666ff; font-weight: bold">7</span>], passh[<span style="color: #6666ff; font-weight: bold">7</span>];
  <span style="color: #6666ff; font-weight: bold">size_t</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], padded_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], passstart[<span style="color: #6666ff; font-weight: bold">8</span>];
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  Adam7_getpassvalues(passw, passh, filter_passstart, padded_passstart, passstart, w, h, bpp);

  <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">8</span>)
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> x, y, b;
      <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth <span style="color: #333333">=</span> bpp <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
      <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> passh[i]; y<span style="color: #333333">++</span>)
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> passw[i]; x<span style="color: #333333">++</span>)
      {
        <span style="color: #6666ff; font-weight: bold">size_t</span> pixelinstart <span style="color: #333333">=</span> passstart[i] <span style="color: #333333">+</span> (y <span style="color: #333333">*</span> passw[i] <span style="color: #333333">+</span> x) <span style="color: #333333">*</span> bytewidth;
        <span style="color: #6666ff; font-weight: bold">size_t</span> pixeloutstart <span style="color: #333333">=</span> ((ADAM7_IY[i] <span style="color: #333333">+</span> y <span style="color: #333333">*</span> ADAM7_DY[i]) <span style="color: #333333">*</span> w <span style="color: #333333">+</span> ADAM7_IX[i] <span style="color: #333333">+</span> x <span style="color: #333333">*</span> ADAM7_DX[i]) <span style="color: #333333">*</span> bytewidth;
        <span style="color: #228899; font-weight: bold">for</span>(b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; b <span style="color: #333333">&lt;</span> bytewidth; b<span style="color: #333333">++</span>)
        {
          out[pixeloutstart <span style="color: #333333">+</span> b] <span style="color: #333333">=</span> in[pixelinstart <span style="color: #333333">+</span> b];
        }
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*bpp &lt; 8: Adam7 with pixels &lt; 8 bit is a bit trickier: with bit pointers*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> x, y, b;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> ilinebits <span style="color: #333333">=</span> bpp <span style="color: #333333">*</span> passw[i];
      <span style="color: #6666ff; font-weight: bold">unsigned</span> olinebits <span style="color: #333333">=</span> bpp <span style="color: #333333">*</span> w;
      <span style="color: #6666ff; font-weight: bold">size_t</span> obp, ibp; <span style="color: #666666; font-style: italic">/*bit pointers (for out and in buffer)*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> passh[i]; y<span style="color: #333333">++</span>)
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> passw[i]; x<span style="color: #333333">++</span>)
      {
        ibp <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">*</span> passstart[i]) <span style="color: #333333">+</span> (y <span style="color: #333333">*</span> ilinebits <span style="color: #333333">+</span> x <span style="color: #333333">*</span> bpp);
        obp <span style="color: #333333">=</span> (ADAM7_IY[i] <span style="color: #333333">+</span> y <span style="color: #333333">*</span> ADAM7_DY[i]) <span style="color: #333333">*</span> olinebits <span style="color: #333333">+</span> (ADAM7_IX[i] <span style="color: #333333">+</span> x <span style="color: #333333">*</span> ADAM7_DX[i]) <span style="color: #333333">*</span> bpp;
        <span style="color: #228899; font-weight: bold">for</span>(b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; b <span style="color: #333333">&lt;</span> bpp; b<span style="color: #333333">++</span>)
        {
          <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit <span style="color: #333333">=</span> readBitFromReversedStream(<span style="color: #333333">&amp;</span>ibp, in);
          <span style="color: #666666; font-style: italic">/*note that this function assumes the out buffer is completely 0, use setBitOfReversedStream otherwise*/</span>
          setBitOfReversedStream0(<span style="color: #333333">&amp;</span>obp, out, bit);
        }
      }
    }
  }
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">removePaddingBits</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                              <span style="color: #6666ff; font-weight: bold">size_t</span> olinebits, <span style="color: #6666ff; font-weight: bold">size_t</span> ilinebits, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  After filtering there are still padding bits if scanlines have non multiple of 8 bit amounts. They need</span>
<span style="color: #666666; font-style: italic">  to be removed (except at last scanline of (Adam7-reduced) image) before working with pure image buffers</span>
<span style="color: #666666; font-style: italic">  for the Adam7 code, the color convert code and the output to the user.</span>
<span style="color: #666666; font-style: italic">  in and out are allowed to be the same buffer, in may also be higher but still overlapping; in must</span>
<span style="color: #666666; font-style: italic">  have &gt;= ilinebits*h bits, out must have &gt;= olinebits*h bits, olinebits must be &lt;= ilinebits</span>
<span style="color: #666666; font-style: italic">  also used to move bits after earlier such operations happened, e.g. in a sequence of reduced images from Adam7</span>
<span style="color: #666666; font-style: italic">  only useful if (ilinebits - olinebits) is a value in the range 1..7</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> y;
  <span style="color: #6666ff; font-weight: bold">size_t</span> diff <span style="color: #333333">=</span> ilinebits <span style="color: #333333">-</span> olinebits;
  <span style="color: #6666ff; font-weight: bold">size_t</span> ibp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, obp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*input and output bit pointers*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> x;
    <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> olinebits; x<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit <span style="color: #333333">=</span> readBitFromReversedStream(<span style="color: #333333">&amp;</span>ibp, in);
      setBitOfReversedStream(<span style="color: #333333">&amp;</span>obp, out, bit);
    }
    ibp <span style="color: #333333">+=</span> diff;
  }
}

<span style="color: #666666; font-style: italic">/*out must be buffer big enough to contain full image, and in must contain the full decompressed data from</span>
<span style="color: #666666; font-style: italic">the IDAT chunks (with filter index bytes and possible padding bits)</span>
<span style="color: #666666; font-style: italic">return value is error*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">postProcessScanlines</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                     <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> info_png)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  This function converts the filtered-padded-interlaced data into pure 2D image buffer with the PNG&#39;s colortype.</span>
<span style="color: #666666; font-style: italic">  Steps:</span>
<span style="color: #666666; font-style: italic">  *) if no Adam7: 1) unfilter 2) remove padding bits (= posible extra bits per scanline if bpp &lt; 8)</span>
<span style="color: #666666; font-style: italic">  *) if adam7: 1) 7x unfilter 2) 7x remove padding bits 3) Adam7_deinterlace</span>
<span style="color: #666666; font-style: italic">  NOTE: the in buffer will be overwritten with intermediate data!</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp <span style="color: #333333">=</span> lodepng_get_bpp(<span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color);
  <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">31</span>; <span style="color: #666666; font-style: italic">/*error: invalid colortype*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(info_png<span style="color: #333333">-&gt;</span>interlace_method <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">&amp;&amp;</span> w <span style="color: #333333">*</span> bpp <span style="color: #333333">!=</span> ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>)
    {
      CERROR_TRY_RETURN(unfilter(in, in, w, h, bpp));
      removePaddingBits(out, in, w <span style="color: #333333">*</span> bpp, ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>, h);
    }
    <span style="color: #666666; font-style: italic">/*we can immediatly filter into the out buffer, no other steps needed*/</span>
    <span style="color: #228899; font-weight: bold">else</span> CERROR_TRY_RETURN(unfilter(out, in, w, h, bpp));
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*interlace_method is 1 (Adam7)*/</span>
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> passw[<span style="color: #6666ff; font-weight: bold">7</span>], passh[<span style="color: #6666ff; font-weight: bold">7</span>]; <span style="color: #6666ff; font-weight: bold">size_t</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], padded_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], passstart[<span style="color: #6666ff; font-weight: bold">8</span>];
    <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

    Adam7_getpassvalues(passw, passh, filter_passstart, padded_passstart, passstart, w, h, bpp);

    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
    {
      CERROR_TRY_RETURN(unfilter(<span style="color: #333333">&amp;</span>in[padded_passstart[i]], <span style="color: #333333">&amp;</span>in[filter_passstart[i]], passw[i], passh[i], bpp));
      <span style="color: #666666; font-style: italic">/*TODO: possible efficiency improvement: if in this reduced image the bits fit nicely in 1 scanline,</span>
<span style="color: #666666; font-style: italic">      move bytes instead of bits or move not at all*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>)
      {
        <span style="color: #666666; font-style: italic">/*remove padding bits in scanlines; after this there still may be padding</span>
<span style="color: #666666; font-style: italic">        bits between the different reduced images: each reduced image still starts nicely at a byte*/</span>
        removePaddingBits(<span style="color: #333333">&amp;</span>in[passstart[i]], <span style="color: #333333">&amp;</span>in[padded_passstart[i]], passw[i] <span style="color: #333333">*</span> bpp,
                          ((passw[i] <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>, passh[i]);
      }
    }

    Adam7_deinterlace(out, in, w, h, bpp);
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_PLTE</span>(LodePNGColorMode<span style="color: #333333">*</span> color, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> pos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, i;
  <span style="color: #228899; font-weight: bold">if</span>(color<span style="color: #333333">-&gt;</span>palette) lodepng_free(color<span style="color: #333333">-&gt;</span>palette);
  color<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">=</span> chunkLength <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">3</span>;
  color<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> color<span style="color: #333333">-&gt;</span>palettesize);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>color<span style="color: #333333">-&gt;</span>palette <span style="color: #333333">&amp;&amp;</span> color<span style="color: #333333">-&gt;</span>palettesize)
  {
    color<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  }
  <span style="color: #228899; font-weight: bold">if</span>(color<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">256</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">38</span>; <span style="color: #666666; font-style: italic">/*error: palette too big*/</span>

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> color<span style="color: #333333">-&gt;</span>palettesize; i<span style="color: #333333">++</span>)
  {
    color<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> data[pos<span style="color: #333333">++</span>]; <span style="color: #666666; font-style: italic">/*R*/</span>
    color<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> data[pos<span style="color: #333333">++</span>]; <span style="color: #666666; font-style: italic">/*G*/</span>
    color<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> data[pos<span style="color: #333333">++</span>]; <span style="color: #666666; font-style: italic">/*B*/</span>
    color<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>; <span style="color: #666666; font-style: italic">/*alpha*/</span>
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/* OK */</span>
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_tRNS</span>(LodePNGColorMode<span style="color: #333333">*</span> color, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;
  <span style="color: #228899; font-weight: bold">if</span>(color<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #666666; font-style: italic">/*error: more alpha values given than there are palette entries*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">&gt;</span> color<span style="color: #333333">-&gt;</span>palettesize) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">38</span>;

    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> chunkLength; i<span style="color: #333333">++</span>) color<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> data[i];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(color<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #666666; font-style: italic">/*error: this chunk must be 2 bytes for greyscale image*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">30</span>;

    color<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    color<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> color<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> color<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">1</span>];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(color<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #666666; font-style: italic">/*error: this chunk must be 6 bytes for RGB image*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">6</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">41</span>;

    color<span style="color: #333333">-&gt;</span>key_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    color<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">1</span>];
    color<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">3</span>];
    color<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">5</span>];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">42</span>; <span style="color: #666666; font-style: italic">/*error: tRNS chunk not allowed for other color models*/</span>

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/* OK */</span>
}


<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #666666; font-style: italic">/*background color chunk (bKGD)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_bKGD</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #666666; font-style: italic">/*error: this chunk must be 1 byte for indexed color image*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">43</span>;

    info<span style="color: #333333">-&gt;</span>background_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">0</span>];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_GREY <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    <span style="color: #666666; font-style: italic">/*error: this chunk must be 2 bytes for greyscale image*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">2</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">44</span>;

    info<span style="color: #333333">-&gt;</span>background_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">1</span>];
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_RGB <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    <span style="color: #666666; font-style: italic">/*error: this chunk must be 6 bytes for greyscale image*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">6</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">45</span>;

    info<span style="color: #333333">-&gt;</span>background_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">1</span>];
    info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">3</span>];
    info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">5</span>];
  }

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/* OK */</span>
}

<span style="color: #666666; font-style: italic">/*text chunk (tEXt)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_tEXt</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #333333">*</span>str <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error) <span style="color: #666666; font-style: italic">/*not really a while loop, only used to break on error*/</span>
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> length, string2_begin;

    length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">while</span>(length <span style="color: #333333">&lt;</span> chunkLength <span style="color: #333333">&amp;&amp;</span> data[length] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) length<span style="color: #333333">++</span>;
    <span style="color: #666666; font-style: italic">/*even though it&#39;s not allowed by the standard, no error is thrown if</span>
<span style="color: #666666; font-style: italic">    there&#39;s no null termination char, if the text is empty*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> length <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">89</span>); <span style="color: #666666; font-style: italic">/*keyword too short or long*/</span>

    key <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>key) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    key[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) key[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[i];

    string2_begin <span style="color: #333333">=</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*skip keyword null terminator*/</span>

    length <span style="color: #333333">=</span> chunkLength <span style="color: #333333">&lt;</span> string2_begin <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> chunkLength <span style="color: #333333">-</span> string2_begin;
    str <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>str) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    str[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) str[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[string2_begin <span style="color: #333333">+</span> i];

    error <span style="color: #333333">=</span> lodepng_add_text(info, key, str);

    <span style="color: #228899; font-weight: bold">break</span>;
  }

  lodepng_free(key);
  lodepng_free(str);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*compressed text chunk (zTXt)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_zTXt</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> zlibsettings,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> length, string2_begin;
  <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector decoded;

  ucvector_init(<span style="color: #333333">&amp;</span>decoded);

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error) <span style="color: #666666; font-style: italic">/*not really a while loop, only used to break on error*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; length <span style="color: #333333">&lt;</span> chunkLength <span style="color: #333333">&amp;&amp;</span> data[length] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; length<span style="color: #333333">++</span>) ;
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">&gt;=</span> chunkLength) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">75</span>); <span style="color: #666666; font-style: italic">/*no null termination, corrupt?*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> length <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">89</span>); <span style="color: #666666; font-style: italic">/*keyword too short or long*/</span>

    key <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>key) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    key[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) key[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[i];

    <span style="color: #228899; font-weight: bold">if</span>(data[length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">72</span>); <span style="color: #666666; font-style: italic">/*the 0 byte indicating compression must be 0*/</span>

    string2_begin <span style="color: #333333">=</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>;
    <span style="color: #228899; font-weight: bold">if</span>(string2_begin <span style="color: #333333">&gt;</span> chunkLength) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">75</span>); <span style="color: #666666; font-style: italic">/*no null termination, corrupt?*/</span>

    length <span style="color: #333333">=</span> chunkLength <span style="color: #333333">-</span> string2_begin;
    <span style="color: #666666; font-style: italic">/*will fail if zlib error, e.g. if length is too small*/</span>
    error <span style="color: #333333">=</span> zlib_decompress(<span style="color: #333333">&amp;</span>decoded.data, <span style="color: #333333">&amp;</span>decoded.size,
                            (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)(<span style="color: #333333">&amp;</span>data[string2_begin]),
                            length, zlibsettings);
    <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
    ucvector_push_back(<span style="color: #333333">&amp;</span>decoded, <span style="color: #6666ff; font-weight: bold">0</span>);

    error <span style="color: #333333">=</span> lodepng_add_text(info, key, (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)decoded.data);

    <span style="color: #228899; font-weight: bold">break</span>;
  }

  lodepng_free(key);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>decoded);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*international text chunk (iTXt)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_iTXt</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> zlibsettings,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  <span style="color: #6666ff; font-weight: bold">unsigned</span> length, begin, compressed;
  <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #333333">*</span>langtag <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #333333">*</span>transkey <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector decoded;
  ucvector_init(<span style="color: #333333">&amp;</span>decoded);

  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>error) <span style="color: #666666; font-style: italic">/*not really a while loop, only used to break on error*/</span>
  {
    <span style="color: #666666; font-style: italic">/*Quick check if the chunk length isn&#39;t too small. Even without check</span>
<span style="color: #666666; font-style: italic">    it&#39;d still fail with other error checks below if it&#39;s too short. This just gives a different error code.*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">30</span>); <span style="color: #666666; font-style: italic">/*iTXt chunk too short*/</span>

    <span style="color: #666666; font-style: italic">/*read the key*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; length <span style="color: #333333">&lt;</span> chunkLength <span style="color: #333333">&amp;&amp;</span> data[length] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; length<span style="color: #333333">++</span>) ;
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">&gt;=</span> chunkLength) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">75</span>); <span style="color: #666666; font-style: italic">/*no null termination char, corrupt?*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(length <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> length <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">89</span>); <span style="color: #666666; font-style: italic">/*keyword too short or long*/</span>

    key <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>key) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    key[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) key[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[i];

    <span style="color: #666666; font-style: italic">/*read the compression method*/</span>
    compressed <span style="color: #333333">=</span> data[length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>];
    <span style="color: #228899; font-weight: bold">if</span>(data[length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">72</span>); <span style="color: #666666; font-style: italic">/*the 0 byte indicating compression must be 0*/</span>

    <span style="color: #666666; font-style: italic">/*even though it&#39;s not allowed by the standard, no error is thrown if</span>
<span style="color: #666666; font-style: italic">    there&#39;s no null termination char, if the text is empty for the next 3 texts*/</span>

    <span style="color: #666666; font-style: italic">/*read the langtag*/</span>
    begin <span style="color: #333333">=</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>;
    length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> begin; i <span style="color: #333333">&lt;</span> chunkLength <span style="color: #333333">&amp;&amp;</span> data[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) length<span style="color: #333333">++</span>;

    langtag <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>langtag) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    langtag[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) langtag[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[begin <span style="color: #333333">+</span> i];

    <span style="color: #666666; font-style: italic">/*read the transkey*/</span>
    begin <span style="color: #333333">+=</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    length <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> begin; i <span style="color: #333333">&lt;</span> chunkLength <span style="color: #333333">&amp;&amp;</span> data[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) length<span style="color: #333333">++</span>;

    transkey <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>transkey) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    transkey[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) transkey[i] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">char</span>)data[begin <span style="color: #333333">+</span> i];

    <span style="color: #666666; font-style: italic">/*read the actual text*/</span>
    begin <span style="color: #333333">+=</span> length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>;

    length <span style="color: #333333">=</span> chunkLength <span style="color: #333333">&lt;</span> begin <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> chunkLength <span style="color: #333333">-</span> begin;

    <span style="color: #228899; font-weight: bold">if</span>(compressed)
    {
      <span style="color: #666666; font-style: italic">/*will fail if zlib error, e.g. if length is too small*/</span>
      error <span style="color: #333333">=</span> zlib_decompress(<span style="color: #333333">&amp;</span>decoded.data, <span style="color: #333333">&amp;</span>decoded.size,
                              (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)(<span style="color: #333333">&amp;</span>data[begin]),
                              length, zlibsettings);
      <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
      <span style="color: #228899; font-weight: bold">if</span>(decoded.allocsize <span style="color: #333333">&lt;</span> decoded.size) decoded.allocsize <span style="color: #333333">=</span> decoded.size;
      ucvector_push_back(<span style="color: #333333">&amp;</span>decoded, <span style="color: #6666ff; font-weight: bold">0</span>);
    }
    <span style="color: #228899; font-weight: bold">else</span>
    {
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(<span style="color: #333333">&amp;</span>decoded, length <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)) CERROR_BREAK(error, <span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);

      decoded.data[length] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) decoded.data[i] <span style="color: #333333">=</span> data[begin <span style="color: #333333">+</span> i];
    }

    error <span style="color: #333333">=</span> lodepng_add_itext(info, key, langtag, transkey, (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)decoded.data);

    <span style="color: #228899; font-weight: bold">break</span>;
  }

  lodepng_free(key);
  lodepng_free(langtag);
  lodepng_free(transkey);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>decoded);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_tIME</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">73</span>; <span style="color: #666666; font-style: italic">/*invalid tIME chunk size*/</span>

  info<span style="color: #333333">-&gt;</span>time_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  info<span style="color: #333333">-&gt;</span>time.year <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">1</span>];
  info<span style="color: #333333">-&gt;</span>time.month <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">2</span>];
  info<span style="color: #333333">-&gt;</span>time.day <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">3</span>];
  info<span style="color: #333333">-&gt;</span>time.hour <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">4</span>];
  info<span style="color: #333333">-&gt;</span>time.minute <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">5</span>];
  info<span style="color: #333333">-&gt;</span>time.second <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">6</span>];

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/* OK */</span>
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">readChunk_pHYs</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> chunkLength)
{
  <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">9</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">74</span>; <span style="color: #666666; font-style: italic">/*invalid pHYs chunk size*/</span>

  info<span style="color: #333333">-&gt;</span>phys_defined <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  info<span style="color: #333333">-&gt;</span>phys_x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">16777216u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">65536u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">3</span>];
  info<span style="color: #333333">-&gt;</span>phys_y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">16777216u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">65536u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">256u</span> <span style="color: #333333">*</span> data[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">+</span> data[<span style="color: #6666ff; font-weight: bold">7</span>];
  info<span style="color: #333333">-&gt;</span>phys_unit <span style="color: #333333">=</span> data[<span style="color: #6666ff; font-weight: bold">8</span>];

  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/* OK */</span>
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*read a PNG, the result will be in the same color type as the PNG (hence &quot;generic&quot;)*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">decodeGeneric</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                          LodePNGState<span style="color: #333333">*</span> state,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> IEND <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ucvector idat; <span style="color: #666666; font-style: italic">/*the data from idat chunks*/</span>
  ucvector scanlines;
  <span style="color: #6666ff; font-weight: bold">size_t</span> predict;

  <span style="color: #666666; font-style: italic">/*for unknown chunk order*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> unknown <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> critical_pos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>; <span style="color: #666666; font-style: italic">/*1 = after IHDR, 2 = after PLTE, 3 = after IDAT*/</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

  <span style="color: #666666; font-style: italic">/*provide some proper output values if error will happen*/</span>
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_inspect(w, h, state, in, insize); <span style="color: #666666; font-style: italic">/*reads header and resets other parameters in state-&gt;info_png*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span>;

  ucvector_init(<span style="color: #333333">&amp;</span>idat);
  chunk <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">33</span>]; <span style="color: #666666; font-style: italic">/*first byte of the first chunk after the header*/</span>

  <span style="color: #666666; font-style: italic">/*loop through the chunks, ignoring unknown chunks and stopping at IEND chunk.</span>
<span style="color: #666666; font-style: italic">  IDAT data is put at the start of the in buffer*/</span>
  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>IEND <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error)
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> chunkLength;
    <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data; <span style="color: #666666; font-style: italic">/*the data in the chunk*/</span>

    <span style="color: #666666; font-style: italic">/*error: size of the in buffer too small to contain next chunk*/</span>
    <span style="color: #228899; font-weight: bold">if</span>((<span style="color: #6666ff; font-weight: bold">size_t</span>)((chunk <span style="color: #333333">-</span> in) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>) <span style="color: #333333">&gt;</span> insize <span style="color: #333333">||</span> chunk <span style="color: #333333">&lt;</span> in) CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">30</span>);

    <span style="color: #666666; font-style: italic">/*length of the data of the chunk, excluding the length bytes, chunk type and CRC bytes*/</span>
    chunkLength <span style="color: #333333">=</span> lodepng_chunk_length(chunk);
    <span style="color: #666666; font-style: italic">/*error: chunk length larger than the max PNG chunk size*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(chunkLength <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">2147483647</span>) CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">63</span>);

    <span style="color: #228899; font-weight: bold">if</span>((<span style="color: #6666ff; font-weight: bold">size_t</span>)((chunk <span style="color: #333333">-</span> in) <span style="color: #333333">+</span> chunkLength <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>) <span style="color: #333333">&gt;</span> insize <span style="color: #333333">||</span> (chunk <span style="color: #333333">+</span> chunkLength <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">12</span>) <span style="color: #333333">&lt;</span> in)
    {
      CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">64</span>); <span style="color: #666666; font-style: italic">/*error: size of the in buffer too small to contain next chunk*/</span>
    }

    data <span style="color: #333333">=</span> lodepng_chunk_data_const(chunk);

    <span style="color: #666666; font-style: italic">/*IDAT chunk, containing compressed image data*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;IDAT&quot;</span>))
    {
      <span style="color: #6666ff; font-weight: bold">size_t</span> oldsize <span style="color: #333333">=</span> idat.size;
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(<span style="color: #333333">&amp;</span>idat, oldsize <span style="color: #333333">+</span> chunkLength)) CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">83</span> <span style="color: #666666; font-style: italic">/*alloc fail*/</span>);
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> chunkLength; i<span style="color: #333333">++</span>) idat.data[oldsize <span style="color: #333333">+</span> i] <span style="color: #333333">=</span> data[i];
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
      critical_pos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">3</span>;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    }
    <span style="color: #666666; font-style: italic">/*IEND chunk*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;IEND&quot;</span>))
    {
      IEND <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    }
    <span style="color: #666666; font-style: italic">/*palette chunk (PLTE)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;PLTE&quot;</span>))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_PLTE(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color, data, chunkLength);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
      critical_pos <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">2</span>;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    }
    <span style="color: #666666; font-style: italic">/*palette transparency chunk (tRNS)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;tRNS&quot;</span>))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_tRNS(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color, data, chunkLength);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
    <span style="color: #666666; font-style: italic">/*background color chunk (bKGD)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;bKGD&quot;</span>))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_bKGD(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, data, chunkLength);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #666666; font-style: italic">/*text chunk (tEXt)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;tEXt&quot;</span>))
    {
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>decoder.read_text_chunks)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_tEXt(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, data, chunkLength);
        <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
    <span style="color: #666666; font-style: italic">/*compressed text chunk (zTXt)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;zTXt&quot;</span>))
    {
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>decoder.read_text_chunks)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_zTXt(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>decoder.zlibsettings, data, chunkLength);
        <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
    <span style="color: #666666; font-style: italic">/*international text chunk (iTXt)*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;iTXt&quot;</span>))
    {
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>decoder.read_text_chunks)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_iTXt(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>decoder.zlibsettings, data, chunkLength);
        <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
      }
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;tIME&quot;</span>))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_tIME(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, data, chunkLength);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_type_equals(chunk, <span style="background-color: #e0e0ff">&quot;pHYs&quot;</span>))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> readChunk_pHYs(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png, data, chunkLength);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*it&#39;s not an implemented chunk type, so ignore it: skip over the data*/</span>
    {
      <span style="color: #666666; font-style: italic">/*error: unknown critical chunk (5th bit of first byte of chunk type is 0)*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>lodepng_chunk_ancillary(chunk)) CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">69</span>);

      unknown <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>decoder.remember_unknown_chunks)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_chunk_append(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.unknown_chunks_data[critical_pos <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>],
                                            <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.unknown_chunks_size[critical_pos <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>], chunk);
        <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
      }
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    }

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>decoder.ignore_crc <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>unknown) <span style="color: #666666; font-style: italic">/*check CRC if wanted, only on known chunk types*/</span>
    {
      <span style="color: #228899; font-weight: bold">if</span>(lodepng_chunk_check_crc(chunk)) CERROR_BREAK(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">57</span>); <span style="color: #666666; font-style: italic">/*invalid CRC*/</span>
    }

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>IEND) chunk <span style="color: #333333">=</span> lodepng_chunk_next_const(chunk);
  }

  ucvector_init(<span style="color: #333333">&amp;</span>scanlines);
  <span style="color: #666666; font-style: italic">/*predict output size, to allocate exact size for output buffer to avoid more dynamic allocation.</span>
<span style="color: #666666; font-style: italic">  The prediction is currently not correct for interlaced PNG images.*/</span>
  predict <span style="color: #333333">=</span> lodepng_get_raw_size_idat(<span style="color: #333333">*</span>w, <span style="color: #333333">*</span>h, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color) <span style="color: #333333">+</span> <span style="color: #333333">*</span>h;
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>ucvector_reserve(<span style="color: #333333">&amp;</span>scanlines, predict)) state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error)
  {
    state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> zlib_decompress(<span style="color: #333333">&amp;</span>scanlines.data, <span style="color: #333333">&amp;</span>scanlines.size, idat.data,
                                   idat.size, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>decoder.zlibsettings);
  }
  ucvector_cleanup(<span style="color: #333333">&amp;</span>idat);

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error)
  {
    ucvector outv;
    ucvector_init(<span style="color: #333333">&amp;</span>outv);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resizev(<span style="color: #333333">&amp;</span>outv,
        lodepng_get_raw_size(<span style="color: #333333">*</span>w, <span style="color: #333333">*</span>h, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color), <span style="color: #6666ff; font-weight: bold">0</span>)) state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error) state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> postProcessScanlines(outv.data, scanlines.data, <span style="color: #333333">*</span>w, <span style="color: #333333">*</span>h, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png);
    <span style="color: #333333">*</span>out <span style="color: #333333">=</span> outv.data;
  }
  ucvector_cleanup(<span style="color: #333333">&amp;</span>scanlines);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                        LodePNGState<span style="color: #333333">*</span> state,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  decodeGeneric(out, w, h, state, in, insize);
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>decoder.color_convert <span style="color: #333333">||</span> lodepng_color_mode_equal(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color))
  {
    <span style="color: #666666; font-style: italic">/*same color type, no copying or converting of data needed*/</span>
    <span style="color: #666666; font-style: italic">/*store the info_png color settings on the info_raw so that the info_raw still reflects what colortype</span>
<span style="color: #666666; font-style: italic">    the raw image has to the end user*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>decoder.color_convert)
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_color_mode_copy(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
    }
  }
  <span style="color: #228899; font-weight: bold">else</span>
  {
    <span style="color: #666666; font-style: italic">/*color conversion needed; sort of copy of the data*/</span>
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> <span style="color: #333333">*</span>out;
    <span style="color: #6666ff; font-weight: bold">size_t</span> outsize;

    <span style="color: #666666; font-style: italic">/*TODO: check if this works according to the statement in the documentation: &quot;The converter can convert</span>
<span style="color: #666666; font-style: italic">    from greyscale input color type, to 8-bit greyscale or greyscale with alpha&quot;*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(state<span style="color: #333333">-&gt;</span>info_raw.colortype <span style="color: #333333">==</span> LCT_RGB <span style="color: #333333">||</span> state<span style="color: #333333">-&gt;</span>info_raw.colortype <span style="color: #333333">==</span> LCT_RGBA)
       <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>(state<span style="color: #333333">-&gt;</span>info_raw.bitdepth <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">8</span>))
    {
      <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">56</span>; <span style="color: #666666; font-style: italic">/*unsupported color mode conversion*/</span>
    }

    outsize <span style="color: #333333">=</span> lodepng_get_raw_size(<span style="color: #333333">*</span>w, <span style="color: #333333">*</span>h, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw);
    <span style="color: #333333">*</span>out <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(outsize);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(<span style="color: #333333">*</span>out))
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    }
    <span style="color: #228899; font-weight: bold">else</span> state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_convert(<span style="color: #333333">*</span>out, data, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw,
                                        <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png.color, <span style="color: #333333">*</span>w, <span style="color: #333333">*</span>h);
    lodepng_free(data);
  }
  <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode_memory</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                               <span style="color: #6666ff; font-weight: bold">size_t</span> insize, LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  LodePNGState state;
  lodepng_state_init(<span style="color: #333333">&amp;</span>state);
  state.info_raw.colortype <span style="color: #333333">=</span> colortype;
  state.info_raw.bitdepth <span style="color: #333333">=</span> bitdepth;
  error <span style="color: #333333">=</span> lodepng_decode(out, w, h, <span style="color: #333333">&amp;</span>state, in, insize);
  lodepng_state_cleanup(<span style="color: #333333">&amp;</span>state);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode32</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_decode_memory(out, w, h, in, insize, LCT_RGBA, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode24</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_decode_memory(out, w, h, in, insize, LCT_RGB, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename,
                             LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  error <span style="color: #333333">=</span> lodepng_load_file(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, filename);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) error <span style="color: #333333">=</span> lodepng_decode_memory(out, w, h, buffer, buffersize, colortype, bitdepth);
  lodepng_free(buffer);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode32_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_decode_file(out, w, h, filename, LCT_RGBA, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode24_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_decode_file(out, w, h, filename, LCT_RGB, <span style="color: #6666ff; font-weight: bold">8</span>);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_decoder_settings_init</span>(LodePNGDecoderSettings<span style="color: #333333">*</span> settings)
{
  settings<span style="color: #333333">-&gt;</span>color_convert <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  settings<span style="color: #333333">-&gt;</span>read_text_chunks <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  settings<span style="color: #333333">-&gt;</span>remember_unknown_chunks <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
  settings<span style="color: #333333">-&gt;</span>ignore_crc <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  lodepng_decompress_settings_init(<span style="color: #333333">&amp;</span>settings<span style="color: #333333">-&gt;</span>zlibsettings);
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#if defined(LODEPNG_COMPILE_DECODER) || defined(LODEPNG_COMPILE_ENCODER)</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_init</span>(LodePNGState<span style="color: #333333">*</span> state)
{
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
  lodepng_decoder_settings_init(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>decoder);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
  lodepng_encoder_settings_init(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>
  lodepng_color_mode_init(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw);
  lodepng_info_init(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png);
  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_cleanup</span>(LodePNGState<span style="color: #333333">*</span> state)
{
  lodepng_color_mode_cleanup(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw);
  lodepng_info_cleanup(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png);
}

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_copy</span>(LodePNGState<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGState<span style="color: #333333">*</span> source)
{
  lodepng_state_cleanup(dest);
  <span style="color: #333333">*</span>dest <span style="color: #333333">=</span> <span style="color: #333333">*</span>source;
  lodepng_color_mode_init(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>info_raw);
  lodepng_info_init(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>info_png);
  dest<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_color_mode_copy(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>info_raw, <span style="color: #333333">&amp;</span>source<span style="color: #333333">-&gt;</span>info_raw); <span style="color: #228899; font-weight: bold">if</span>(dest<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span>;
  dest<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_info_copy(<span style="color: #333333">&amp;</span>dest<span style="color: #333333">-&gt;</span>info_png, <span style="color: #333333">&amp;</span>source<span style="color: #333333">-&gt;</span>info_png); <span style="color: #228899; font-weight: bold">if</span>(dest<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span>;
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/* defined(LODEPNG_COMPILE_DECODER) || defined(LODEPNG_COMPILE_ENCODER) */</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* / PNG Encoder                                                            / */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #666666; font-style: italic">/*chunkName must be string of 4 characters*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunkName, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> length)
{
  CERROR_TRY_RETURN(lodepng_chunk_create(<span style="color: #333333">&amp;</span>out<span style="color: #333333">-&gt;</span>data, <span style="color: #333333">&amp;</span>out<span style="color: #333333">-&gt;</span>size, (<span style="color: #6666ff; font-weight: bold">unsigned</span>)length, chunkName, data));
  out<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> out<span style="color: #333333">-&gt;</span>size; <span style="color: #666666; font-style: italic">/*fix the allocsize again*/</span>
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">writeSignature</span>(ucvector<span style="color: #333333">*</span> out)
{
  <span style="color: #666666; font-style: italic">/*8 bytes PNG signature, aka the magic bytes*/</span>
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">137</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">80</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">78</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">71</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">13</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">10</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">26</span>);
  ucvector_push_back(out, <span style="color: #6666ff; font-weight: bold">10</span>);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_IHDR</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                              LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth, <span style="color: #6666ff; font-weight: bold">unsigned</span> interlace_method)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector header;
  ucvector_init(<span style="color: #333333">&amp;</span>header);

  lodepng_add32bitInt(<span style="color: #333333">&amp;</span>header, w); <span style="color: #666666; font-style: italic">/*width*/</span>
  lodepng_add32bitInt(<span style="color: #333333">&amp;</span>header, h); <span style="color: #666666; font-style: italic">/*height*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>header, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)bitdepth); <span style="color: #666666; font-style: italic">/*bit depth*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>header, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)colortype); <span style="color: #666666; font-style: italic">/*color type*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>header, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*compression method*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>header, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*filter method*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>header, interlace_method); <span style="color: #666666; font-style: italic">/*interlace method*/</span>

  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;IHDR&quot;</span>, header.data, header.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>header);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_PLTE</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ucvector PLTE;
  ucvector_init(<span style="color: #333333">&amp;</span>PLTE);
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info<span style="color: #333333">-&gt;</span>palettesize <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span>; i<span style="color: #333333">++</span>)
  {
    <span style="color: #666666; font-style: italic">/*add all channels except alpha channel*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">3</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>PLTE, info<span style="color: #333333">-&gt;</span>palette[i]);
  }
  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;PLTE&quot;</span>, PLTE.data, PLTE.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>PLTE);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_tRNS</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ucvector tRNS;
  ucvector_init(<span style="color: #333333">&amp;</span>tRNS);
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> amount <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>palettesize;
    <span style="color: #666666; font-style: italic">/*the tail of palette values that all have 255 as alpha, does not have to be encoded*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> info<span style="color: #333333">-&gt;</span>palettesize; i <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">--</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> (i <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">255</span>) amount<span style="color: #333333">--</span>;
      <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">break</span>;
    }
    <span style="color: #666666; font-style: italic">/*add only alpha channel*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> amount; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, info<span style="color: #333333">-&gt;</span>palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>]);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_GREY)
  {
    <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>key_defined)
    {
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_RGB)
  {
    <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>key_defined)
    {
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_g <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
      ucvector_push_back(<span style="color: #333333">&amp;</span>tRNS, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>key_b <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    }
  }

  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;tRNS&quot;</span>, tRNS.data, tRNS.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>tRNS);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_IDAT</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> datasize,
                              LodePNGCompressSettings<span style="color: #333333">*</span> zlibsettings)
{
  ucvector zlibdata;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #666666; font-style: italic">/*compress with the Zlib compressor*/</span>
  ucvector_init(<span style="color: #333333">&amp;</span>zlibdata);
  error <span style="color: #333333">=</span> zlib_compress(<span style="color: #333333">&amp;</span>zlibdata.data, <span style="color: #333333">&amp;</span>zlibdata.size, data, datasize, zlibsettings);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;IDAT&quot;</span>, zlibdata.data, zlibdata.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>zlibdata);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_IEND</span>(ucvector<span style="color: #333333">*</span> out)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;IEND&quot;</span>, <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #6666ff; font-weight: bold">0</span>);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_tEXt</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> keyword, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> textstring)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  ucvector text;
  ucvector_init(<span style="color: #333333">&amp;</span>text);
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; keyword[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>text, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)keyword[i]);
  <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> i <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">89</span>; <span style="color: #666666; font-style: italic">/*error: invalid keyword size*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>text, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*0 termination char*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; textstring[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>text, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)textstring[i]);
  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;tEXt&quot;</span>, text.data, text.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>text);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_zTXt</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> keyword, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> textstring,
                              LodePNGCompressSettings<span style="color: #333333">*</span> zlibsettings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector data, compressed;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i, textsize <span style="color: #333333">=</span> strlen(textstring);

  ucvector_init(<span style="color: #333333">&amp;</span>data);
  ucvector_init(<span style="color: #333333">&amp;</span>compressed);
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; keyword[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)keyword[i]);
  <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> i <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">89</span>; <span style="color: #666666; font-style: italic">/*error: invalid keyword size*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*0 termination char*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*compression method: 0*/</span>

  error <span style="color: #333333">=</span> zlib_compress(<span style="color: #333333">&amp;</span>compressed.data, <span style="color: #333333">&amp;</span>compressed.size,
                        (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)textstring, textsize, zlibsettings);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> compressed.size; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, compressed.data[i]);
    error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;zTXt&quot;</span>, data.data, data.size);
  }

  ucvector_cleanup(<span style="color: #333333">&amp;</span>compressed);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>data);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_iTXt</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span> compressed, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> keyword, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> langtag,
                              <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> transkey, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> textstring, LodePNGCompressSettings<span style="color: #333333">*</span> zlibsettings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector data;
  <span style="color: #6666ff; font-weight: bold">size_t</span> i, textsize <span style="color: #333333">=</span> strlen(textstring);

  ucvector_init(<span style="color: #333333">&amp;</span>data);

  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; keyword[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)keyword[i]);
  <span style="color: #228899; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">||</span> i <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">89</span>; <span style="color: #666666; font-style: italic">/*error: invalid keyword size*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*null termination char*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, compressed <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">:</span> <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*compression flag*/</span>
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*compression method*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; langtag[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)langtag[i]);
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*null termination char*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; transkey[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)transkey[i]);
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, <span style="color: #6666ff; font-weight: bold">0</span>); <span style="color: #666666; font-style: italic">/*null termination char*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(compressed)
  {
    ucvector compressed_data;
    ucvector_init(<span style="color: #333333">&amp;</span>compressed_data);
    error <span style="color: #333333">=</span> zlib_compress(<span style="color: #333333">&amp;</span>compressed_data.data, <span style="color: #333333">&amp;</span>compressed_data.size,
                          (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)textstring, textsize, zlibsettings);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> compressed_data.size; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, compressed_data.data[i]);
    }
    ucvector_cleanup(<span style="color: #333333">&amp;</span>compressed_data);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*not compressed*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; textstring[i] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i<span style="color: #333333">++</span>) ucvector_push_back(<span style="color: #333333">&amp;</span>data, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)textstring[i]);
  }

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;iTXt&quot;</span>, data.data, data.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>data);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_bKGD</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector bKGD;
  ucvector_init(<span style="color: #333333">&amp;</span>bKGD);
  <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_GREY <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_GREY_ALPHA)
  {
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_RGB <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_RGBA)
  {
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_g <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>));
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_b <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>));
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(info<span style="color: #333333">-&gt;</span>color.colortype <span style="color: #333333">==</span> LCT_PALETTE)
  {
    ucvector_push_back(<span style="color: #333333">&amp;</span>bKGD, (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(info<span style="color: #333333">-&gt;</span>background_r <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>)); <span style="color: #666666; font-style: italic">/*palette index*/</span>
  }

  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;bKGD&quot;</span>, bKGD.data, bKGD.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>bKGD);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_tIME</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> LodePNGTime<span style="color: #333333">*</span> time)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #6666ff; font-weight: bold">7</span>);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>data) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
  data[<span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(time<span style="color: #333333">-&gt;</span>year <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">256</span>);
  data[<span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(time<span style="color: #333333">-&gt;</span>year <span style="color: #333333">%</span> <span style="color: #6666ff; font-weight: bold">256</span>);
  data[<span style="color: #6666ff; font-weight: bold">2</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)time<span style="color: #333333">-&gt;</span>month;
  data[<span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)time<span style="color: #333333">-&gt;</span>day;
  data[<span style="color: #6666ff; font-weight: bold">4</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)time<span style="color: #333333">-&gt;</span>hour;
  data[<span style="color: #6666ff; font-weight: bold">5</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)time<span style="color: #333333">-&gt;</span>minute;
  data[<span style="color: #6666ff; font-weight: bold">6</span>] <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)time<span style="color: #333333">-&gt;</span>second;
  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;tIME&quot;</span>, data, <span style="color: #6666ff; font-weight: bold">7</span>);
  lodepng_free(data);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addChunk_pHYs</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> info)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  ucvector data;
  ucvector_init(<span style="color: #333333">&amp;</span>data);

  lodepng_add32bitInt(<span style="color: #333333">&amp;</span>data, info<span style="color: #333333">-&gt;</span>phys_x);
  lodepng_add32bitInt(<span style="color: #333333">&amp;</span>data, info<span style="color: #333333">-&gt;</span>phys_y);
  ucvector_push_back(<span style="color: #333333">&amp;</span>data, info<span style="color: #333333">-&gt;</span>phys_unit);

  error <span style="color: #333333">=</span> addChunk(out, <span style="background-color: #e0e0ff">&quot;pHYs&quot;</span>, data.data, data.size);
  ucvector_cleanup(<span style="color: #333333">&amp;</span>data);

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">filterScanline</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> scanline, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> prevline,
                           <span style="color: #6666ff; font-weight: bold">size_t</span> length, <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> filterType)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #228899; font-weight: bold">switch</span>(filterType)
  {
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">0</span>: <span style="color: #666666; font-style: italic">/*None*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">1</span>: <span style="color: #666666; font-style: italic">/*Sub*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(prevline)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> scanline[i <span style="color: #333333">-</span> bytewidth];
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> scanline[i <span style="color: #333333">-</span> bytewidth];
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">2</span>: <span style="color: #666666; font-style: italic">/*Up*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(prevline)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> prevline[i];
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">3</span>: <span style="color: #666666; font-style: italic">/*Average*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(prevline)
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> prevline[i] <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>;
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> ((scanline[i <span style="color: #333333">-</span> bytewidth] <span style="color: #333333">+</span> prevline[i]) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>);
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i] <span style="color: #333333">-</span> scanline[i <span style="color: #333333">-</span> bytewidth] <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span>;
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">4</span>: <span style="color: #666666; font-style: italic">/*Paeth*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(prevline)
      {
        <span style="color: #666666; font-style: italic">/*paethPredictor(0, prevline[i], 0) is always prevline[i]*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">-</span> prevline[i]);
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>)
        {
          out[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">-</span> paethPredictor(scanline[i <span style="color: #333333">-</span> bytewidth], prevline[i], prevline[i <span style="color: #333333">-</span> bytewidth]));
        }
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> bytewidth; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> scanline[i];
        <span style="color: #666666; font-style: italic">/*paethPredictor(scanline[i - bytewidth], 0, 0) is always scanline[i - bytewidth]*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> bytewidth; i <span style="color: #333333">&lt;</span> length; i<span style="color: #333333">++</span>) out[i] <span style="color: #333333">=</span> (scanline[i] <span style="color: #333333">-</span> scanline[i <span style="color: #333333">-</span> bytewidth]);
      }
      <span style="color: #228899; font-weight: bold">break</span>;
    <span style="color: #997700; font-weight: bold">default:</span> <span style="color: #228899; font-weight: bold">return</span>; <span style="color: #666666; font-style: italic">/*unexisting filter type given*/</span>
  }
}

<span style="color: #666666; font-style: italic">/* log2 approximation. A slight bit faster than std::log. */</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">float</span> <span style="color: #55eedd; font-weight: bold">flog2</span>(<span style="color: #6666ff; font-weight: bold">float</span> f)
{
  <span style="color: #6666ff; font-weight: bold">float</span> result <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">while</span>(f <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">32</span>) { result <span style="color: #333333">+=</span> <span style="color: #6666ff; font-weight: bold">4</span>; f <span style="color: #333333">/=</span> <span style="color: #6666ff; font-weight: bold">16</span>; }
  <span style="color: #228899; font-weight: bold">while</span>(f <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">2</span>) { result<span style="color: #333333">++</span>; f <span style="color: #333333">/=</span> <span style="color: #6666ff; font-weight: bold">2</span>; }
  <span style="color: #228899; font-weight: bold">return</span> result <span style="color: #333333">+</span> <span style="color: #6600EE; font-weight: bold">1.442695f</span> <span style="color: #333333">*</span> (f <span style="color: #333333">*</span> f <span style="color: #333333">*</span> f <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">*</span> f <span style="color: #333333">*</span> f <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span> <span style="color: #333333">*</span> f <span style="color: #333333">-</span> <span style="color: #6600EE; font-weight: bold">1.83333f</span>);
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">filter</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                       <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> LodePNGEncoderSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  For PNG filter method 0</span>
<span style="color: #666666; font-style: italic">  out must be a buffer with as size: h + (w * h * bpp + 7) / 8, because there are</span>
<span style="color: #666666; font-style: italic">  the scanlines with 1 extra byte per scanline</span>
<span style="color: #666666; font-style: italic">  */</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp <span style="color: #333333">=</span> lodepng_get_bpp(info);
  <span style="color: #666666; font-style: italic">/*the width of a scanline in bytes, not including the filter type*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> linebytes <span style="color: #333333">=</span> (w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #666666; font-style: italic">/*bytewidth is used for filtering, is 1 when bpp &lt; 8, number of bytes per pixel otherwise*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth <span style="color: #333333">=</span> (bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> prevline <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> x, y;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  LodePNGFilterStrategy strategy <span style="color: #333333">=</span> settings<span style="color: #333333">-&gt;</span>filter_strategy;

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  There is a heuristic called the minimum sum of absolute differences heuristic, suggested by the PNG standard:</span>
<span style="color: #666666; font-style: italic">   *  If the image type is Palette, or the bit depth is smaller than 8, then do not filter the image (i.e.</span>
<span style="color: #666666; font-style: italic">      use fixed filtering, with the filter None).</span>
<span style="color: #666666; font-style: italic">   * (The other case) If the image type is Grayscale or RGB (with or without Alpha), and the bit depth is</span>
<span style="color: #666666; font-style: italic">     not smaller than 8, then use adaptive filtering heuristic as follows: independently for each row, apply</span>
<span style="color: #666666; font-style: italic">     all five filters and select the filter that produces the smallest sum of absolute values per row.</span>
<span style="color: #666666; font-style: italic">  This heuristic is used if filter strategy is LFS_MINSUM and filter_palette_zero is true.</span>

<span style="color: #666666; font-style: italic">  If filter_palette_zero is true and filter_strategy is not LFS_MINSUM, the above heuristic is followed,</span>
<span style="color: #666666; font-style: italic">  but for &quot;the other case&quot;, whatever strategy filter_strategy is set to instead of the minimum sum</span>
<span style="color: #666666; font-style: italic">  heuristic is used.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #228899; font-weight: bold">if</span>(settings<span style="color: #333333">-&gt;</span>filter_palette_zero <span style="color: #333333">&amp;&amp;</span>
     (info<span style="color: #333333">-&gt;</span>colortype <span style="color: #333333">==</span> LCT_PALETTE <span style="color: #333333">||</span> info<span style="color: #333333">-&gt;</span>bitdepth <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>)) strategy <span style="color: #333333">=</span> LFS_ZERO;

  <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">31</span>; <span style="color: #666666; font-style: italic">/*error: invalid color type*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(strategy <span style="color: #333333">==</span> LFS_ZERO)
  {
    <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">size_t</span> outindex <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> linebytes) <span style="color: #333333">*</span> y; <span style="color: #666666; font-style: italic">/*the extra filterbyte added to each row*/</span>
      <span style="color: #6666ff; font-weight: bold">size_t</span> inindex <span style="color: #333333">=</span> linebytes <span style="color: #333333">*</span> y;
      out[outindex] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*filter type byte*/</span>
      filterScanline(<span style="color: #333333">&amp;</span>out[outindex <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>], <span style="color: #333333">&amp;</span>in[inindex], prevline, linebytes, bytewidth, <span style="color: #6666ff; font-weight: bold">0</span>);
      prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[inindex];
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(strategy <span style="color: #333333">==</span> LFS_MINSUM)
  {
    <span style="color: #666666; font-style: italic">/*adaptive filtering*/</span>
    <span style="color: #6666ff; font-weight: bold">size_t</span> sum[<span style="color: #6666ff; font-weight: bold">5</span>];
    ucvector attempt[<span style="color: #6666ff; font-weight: bold">5</span>]; <span style="color: #666666; font-style: italic">/*five filtering attempts, one for each filter type*/</span>
    <span style="color: #6666ff; font-weight: bold">size_t</span> smallest <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> type, bestType <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
    {
      ucvector_init(<span style="color: #333333">&amp;</span>attempt[type]);
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(<span style="color: #333333">&amp;</span>attempt[type], linebytes)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    }

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
      {
        <span style="color: #666666; font-style: italic">/*try the 5 filter types*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
        {
          filterScanline(attempt[type].data, <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes], prevline, linebytes, bytewidth, type);

          <span style="color: #666666; font-style: italic">/*calculate the sum of the result*/</span>
          sum[type] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
          <span style="color: #228899; font-weight: bold">if</span>(type <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
          {
            <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>) sum[type] <span style="color: #333333">+=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)(attempt[type].data[x]);
          }
          <span style="color: #228899; font-weight: bold">else</span>
          {
            <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>)
            {
              <span style="color: #666666; font-style: italic">/*For differences, each byte should be treated as signed, values above 127 are negative</span>
<span style="color: #666666; font-style: italic">              (converted to signed char). Filtertype 0 isn&#39;t a difference though, so use unsigned there.</span>
<span style="color: #666666; font-style: italic">              This means filtertype 0 is almost never chosen, but that is justified.*/</span>
              <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> s <span style="color: #333333">=</span> attempt[type].data[x];
              sum[type] <span style="color: #333333">+=</span> s <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">128</span> <span style="color: #333333">?</span> s <span style="color: #333333">:</span> (<span style="color: #6666ff; font-weight: bold">255U</span> <span style="color: #333333">-</span> s);
            }
          }

          <span style="color: #666666; font-style: italic">/*check if this is smallest sum (or if type == 0 it&#39;s the first case so always store the values)*/</span>
          <span style="color: #228899; font-weight: bold">if</span>(type <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> sum[type] <span style="color: #333333">&lt;</span> smallest)
          {
            bestType <span style="color: #333333">=</span> type;
            smallest <span style="color: #333333">=</span> sum[type];
          }
        }

        prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes];

        <span style="color: #666666; font-style: italic">/*now fill the out values*/</span>
        out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)] <span style="color: #333333">=</span> bestType; <span style="color: #666666; font-style: italic">/*the first byte of a scanline will be the filter type*/</span>
        <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>) out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> attempt[bestType].data[x];
      }
    }

    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>) ucvector_cleanup(<span style="color: #333333">&amp;</span>attempt[type]);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(strategy <span style="color: #333333">==</span> LFS_ENTROPY)
  {
    <span style="color: #6666ff; font-weight: bold">float</span> sum[<span style="color: #6666ff; font-weight: bold">5</span>];
    ucvector attempt[<span style="color: #6666ff; font-weight: bold">5</span>]; <span style="color: #666666; font-style: italic">/*five filtering attempts, one for each filter type*/</span>
    <span style="color: #6666ff; font-weight: bold">float</span> smallest <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> type, bestType <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> count[<span style="color: #6666ff; font-weight: bold">256</span>];

    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
    {
      ucvector_init(<span style="color: #333333">&amp;</span>attempt[type]);
      <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>ucvector_resize(<span style="color: #333333">&amp;</span>attempt[type], linebytes)) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    }

    <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
    {
      <span style="color: #666666; font-style: italic">/*try the 5 filter types*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
      {
        filterScanline(attempt[type].data, <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes], prevline, linebytes, bytewidth, type);
        <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">256</span>; x<span style="color: #333333">++</span>) count[x] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>) count[attempt[type].data[x]]<span style="color: #333333">++</span>;
        count[type]<span style="color: #333333">++</span>; <span style="color: #666666; font-style: italic">/*the filter type itself is part of the scanline*/</span>
        sum[type] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">256</span>; x<span style="color: #333333">++</span>)
        {
          <span style="color: #6666ff; font-weight: bold">float</span> p <span style="color: #333333">=</span> count[x] <span style="color: #333333">/</span> (<span style="color: #6666ff; font-weight: bold">float</span>)(linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>);
          sum[type] <span style="color: #333333">+=</span> count[x] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> flog2(<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">/</span> p) <span style="color: #333333">*</span> p;
        }
        <span style="color: #666666; font-style: italic">/*check if this is smallest sum (or if type == 0 it&#39;s the first case so always store the values)*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(type <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> sum[type] <span style="color: #333333">&lt;</span> smallest)
        {
          bestType <span style="color: #333333">=</span> type;
          smallest <span style="color: #333333">=</span> sum[type];
        }
      }

      prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes];

      <span style="color: #666666; font-style: italic">/*now fill the out values*/</span>
      out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)] <span style="color: #333333">=</span> bestType; <span style="color: #666666; font-style: italic">/*the first byte of a scanline will be the filter type*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>) out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> attempt[bestType].data[x];
    }

    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>) ucvector_cleanup(<span style="color: #333333">&amp;</span>attempt[type]);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(strategy <span style="color: #333333">==</span> LFS_PREDEFINED)
  {
    <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">size_t</span> outindex <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> linebytes) <span style="color: #333333">*</span> y; <span style="color: #666666; font-style: italic">/*the extra filterbyte added to each row*/</span>
      <span style="color: #6666ff; font-weight: bold">size_t</span> inindex <span style="color: #333333">=</span> linebytes <span style="color: #333333">*</span> y;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> type <span style="color: #333333">=</span> settings<span style="color: #333333">-&gt;</span>predefined_filters[y];
      out[outindex] <span style="color: #333333">=</span> type; <span style="color: #666666; font-style: italic">/*filter type byte*/</span>
      filterScanline(<span style="color: #333333">&amp;</span>out[outindex <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>], <span style="color: #333333">&amp;</span>in[inindex], prevline, linebytes, bytewidth, type);
      prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[inindex];
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(strategy <span style="color: #333333">==</span> LFS_BRUTE_FORCE)
  {
    <span style="color: #666666; font-style: italic">/*brute force filter chooser.</span>
<span style="color: #666666; font-style: italic">    deflate the scanline after every filter attempt to see which one deflates best.</span>
<span style="color: #666666; font-style: italic">    This is very slow and gives only slightly smaller, sometimes even larger, result*/</span>
    <span style="color: #6666ff; font-weight: bold">size_t</span> size[<span style="color: #6666ff; font-weight: bold">5</span>];
    ucvector attempt[<span style="color: #6666ff; font-weight: bold">5</span>]; <span style="color: #666666; font-style: italic">/*five filtering attempts, one for each filter type*/</span>
    <span style="color: #6666ff; font-weight: bold">size_t</span> smallest <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, bestType <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> dummy;
    LodePNGCompressSettings zlibsettings <span style="color: #333333">=</span> settings<span style="color: #333333">-&gt;</span>zlibsettings;
    <span style="color: #666666; font-style: italic">/*use fixed tree on the attempts so that the tree is not adapted to the filtertype on purpose,</span>
<span style="color: #666666; font-style: italic">    to simulate the true case where the tree is the same for the whole image. Sometimes it gives</span>
<span style="color: #666666; font-style: italic">    better result with dynamic tree anyway. Using the fixed tree sometimes gives worse, but in rare</span>
<span style="color: #666666; font-style: italic">    cases better compression. It does make this a bit less slow, so it&#39;s worth doing this.*/</span>
    zlibsettings.btype <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
    <span style="color: #666666; font-style: italic">/*a custom encoder likely doesn&#39;t read the btype setting and is optimized for complete PNG</span>
<span style="color: #666666; font-style: italic">    images only, so disable it*/</span>
    zlibsettings.custom_zlib <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    zlibsettings.custom_deflate <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
    {
      ucvector_init(<span style="color: #333333">&amp;</span>attempt[type]);
      ucvector_resize(<span style="color: #333333">&amp;</span>attempt[type], linebytes); <span style="color: #666666; font-style: italic">/*todo: give error if resize failed*/</span>
    }
    <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>) <span style="color: #666666; font-style: italic">/*try the 5 filter types*/</span>
    {
      <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> testsize <span style="color: #333333">=</span> attempt[type].size;
        <span style="color: #666666; font-style: italic">/*if(testsize &gt; 8) testsize /= 8;*/</span> <span style="color: #666666; font-style: italic">/*it already works good enough by testing a part of the row*/</span>

        filterScanline(attempt[type].data, <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes], prevline, linebytes, bytewidth, type);
        size[type] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        dummy <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
        zlib_compress(<span style="color: #333333">&amp;</span>dummy, <span style="color: #333333">&amp;</span>size[type], attempt[type].data, testsize, <span style="color: #333333">&amp;</span>zlibsettings);
        lodepng_free(dummy);
        <span style="color: #666666; font-style: italic">/*check if this is smallest size (or if type == 0 it&#39;s the first case so always store the values)*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(type <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> size[type] <span style="color: #333333">&lt;</span> smallest)
        {
          bestType <span style="color: #333333">=</span> type;
          smallest <span style="color: #333333">=</span> size[type];
        }
      }
      prevline <span style="color: #333333">=</span> <span style="color: #333333">&amp;</span>in[y <span style="color: #333333">*</span> linebytes];
      out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>)] <span style="color: #333333">=</span> bestType; <span style="color: #666666; font-style: italic">/*the first byte of a scanline will be the filter type*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> linebytes; x<span style="color: #333333">++</span>) out[y <span style="color: #333333">*</span> (linebytes <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> attempt[bestType].data[x];
    }
    <span style="color: #228899; font-weight: bold">for</span>(type <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; type <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">5</span>; type<span style="color: #333333">++</span>) ucvector_cleanup(<span style="color: #333333">&amp;</span>attempt[type]);
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">88</span>; <span style="color: #666666; font-style: italic">/* unknown filter strategy */</span>

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">addPaddingBits</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                           <span style="color: #6666ff; font-weight: bold">size_t</span> olinebits, <span style="color: #6666ff; font-weight: bold">size_t</span> ilinebits, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #666666; font-style: italic">/*The opposite of the removePaddingBits function</span>
<span style="color: #666666; font-style: italic">  olinebits must be &gt;= ilinebits*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> y;
  <span style="color: #6666ff; font-weight: bold">size_t</span> diff <span style="color: #333333">=</span> olinebits <span style="color: #333333">-</span> ilinebits;
  <span style="color: #6666ff; font-weight: bold">size_t</span> obp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, ibp <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*bit pointers*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> h; y<span style="color: #333333">++</span>)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> x;
    <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> ilinebits; x<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit <span style="color: #333333">=</span> readBitFromReversedStream(<span style="color: #333333">&amp;</span>ibp, in);
      setBitOfReversedStream(<span style="color: #333333">&amp;</span>obp, out, bit);
    }
    <span style="color: #666666; font-style: italic">/*obp += diff; --&gt; no, fill in some value in the padding bits too, to avoid</span>
<span style="color: #666666; font-style: italic">    &quot;Use of uninitialised value of size ###&quot; warning from valgrind*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> diff; x<span style="color: #333333">++</span>) setBitOfReversedStream(<span style="color: #333333">&amp;</span>obp, out, <span style="color: #6666ff; font-weight: bold">0</span>);
  }
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">in: non-interlaced image with size w*h</span>
<span style="color: #666666; font-style: italic">out: the same pixels, but re-ordered according to PNG&#39;s Adam7 interlacing, with</span>
<span style="color: #666666; font-style: italic"> no padding bits between scanlines, but between reduced images so that each</span>
<span style="color: #666666; font-style: italic"> reduced image starts at a byte.</span>
<span style="color: #666666; font-style: italic">bpp: bits per pixel</span>
<span style="color: #666666; font-style: italic">there are no padding bits, not between scanlines, not between reduced images</span>
<span style="color: #666666; font-style: italic">in has the following size in bits: w * h * bpp.</span>
<span style="color: #666666; font-style: italic">out is possibly bigger due to padding bits between reduced images</span>
<span style="color: #666666; font-style: italic">NOTE: comments about padding bits are only relevant if bpp &lt; 8</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">Adam7_interlace</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> passw[<span style="color: #6666ff; font-weight: bold">7</span>], passh[<span style="color: #6666ff; font-weight: bold">7</span>];
  <span style="color: #6666ff; font-weight: bold">size_t</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], padded_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], passstart[<span style="color: #6666ff; font-weight: bold">8</span>];
  <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

  Adam7_getpassvalues(passw, passh, filter_passstart, padded_passstart, passstart, w, h, bpp);

  <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">8</span>)
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> x, y, b;
      <span style="color: #6666ff; font-weight: bold">size_t</span> bytewidth <span style="color: #333333">=</span> bpp <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;
      <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> passh[i]; y<span style="color: #333333">++</span>)
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> passw[i]; x<span style="color: #333333">++</span>)
      {
        <span style="color: #6666ff; font-weight: bold">size_t</span> pixelinstart <span style="color: #333333">=</span> ((ADAM7_IY[i] <span style="color: #333333">+</span> y <span style="color: #333333">*</span> ADAM7_DY[i]) <span style="color: #333333">*</span> w <span style="color: #333333">+</span> ADAM7_IX[i] <span style="color: #333333">+</span> x <span style="color: #333333">*</span> ADAM7_DX[i]) <span style="color: #333333">*</span> bytewidth;
        <span style="color: #6666ff; font-weight: bold">size_t</span> pixeloutstart <span style="color: #333333">=</span> passstart[i] <span style="color: #333333">+</span> (y <span style="color: #333333">*</span> passw[i] <span style="color: #333333">+</span> x) <span style="color: #333333">*</span> bytewidth;
        <span style="color: #228899; font-weight: bold">for</span>(b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; b <span style="color: #333333">&lt;</span> bytewidth; b<span style="color: #333333">++</span>)
        {
          out[pixeloutstart <span style="color: #333333">+</span> b] <span style="color: #333333">=</span> in[pixelinstart <span style="color: #333333">+</span> b];
        }
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*bpp &lt; 8: Adam7 with pixels &lt; 8 bit is a bit trickier: with bit pointers*/</span>
  {
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> x, y, b;
      <span style="color: #6666ff; font-weight: bold">unsigned</span> ilinebits <span style="color: #333333">=</span> bpp <span style="color: #333333">*</span> passw[i];
      <span style="color: #6666ff; font-weight: bold">unsigned</span> olinebits <span style="color: #333333">=</span> bpp <span style="color: #333333">*</span> w;
      <span style="color: #6666ff; font-weight: bold">size_t</span> obp, ibp; <span style="color: #666666; font-style: italic">/*bit pointers (for out and in buffer)*/</span>
      <span style="color: #228899; font-weight: bold">for</span>(y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> passh[i]; y<span style="color: #333333">++</span>)
      <span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> passw[i]; x<span style="color: #333333">++</span>)
      {
        ibp <span style="color: #333333">=</span> (ADAM7_IY[i] <span style="color: #333333">+</span> y <span style="color: #333333">*</span> ADAM7_DY[i]) <span style="color: #333333">*</span> olinebits <span style="color: #333333">+</span> (ADAM7_IX[i] <span style="color: #333333">+</span> x <span style="color: #333333">*</span> ADAM7_DX[i]) <span style="color: #333333">*</span> bpp;
        obp <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">*</span> passstart[i]) <span style="color: #333333">+</span> (y <span style="color: #333333">*</span> ilinebits <span style="color: #333333">+</span> x <span style="color: #333333">*</span> bpp);
        <span style="color: #228899; font-weight: bold">for</span>(b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; b <span style="color: #333333">&lt;</span> bpp; b<span style="color: #333333">++</span>)
        {
          <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> bit <span style="color: #333333">=</span> readBitFromReversedStream(<span style="color: #333333">&amp;</span>ibp, in);
          setBitOfReversedStream(<span style="color: #333333">&amp;</span>obp, out, bit);
        }
      }
    }
  }
}

<span style="color: #666666; font-style: italic">/*out must be buffer big enough to contain uncompressed IDAT chunk data, and in must contain the full image.</span>
<span style="color: #666666; font-style: italic">return value is error**/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">preProcessScanlines</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                                    <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                                    <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> info_png, <span style="color: #228899; font-weight: bold">const</span> LodePNGEncoderSettings<span style="color: #333333">*</span> settings)
{
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  This function converts the pure 2D image with the PNG&#39;s colortype, into filtered-padded-interlaced data. Steps:</span>
<span style="color: #666666; font-style: italic">  *) if no Adam7: 1) add padding bits (= posible extra bits per scanline if bpp &lt; 8) 2) filter</span>
<span style="color: #666666; font-style: italic">  *) if adam7: 1) Adam7_interlace 2) 7x add padding bits 3) 7x filter</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bpp <span style="color: #333333">=</span> lodepng_get_bpp(<span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color);
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #228899; font-weight: bold">if</span>(info_png<span style="color: #333333">-&gt;</span>interlace_method <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
  {
    <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> h <span style="color: #333333">+</span> (h <span style="color: #333333">*</span> ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>)); <span style="color: #666666; font-style: italic">/*image size plus an extra byte per scanline + possible padding bits*/</span>
    <span style="color: #333333">*</span>out <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #333333">*</span>outsize);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(<span style="color: #333333">*</span>out) <span style="color: #333333">&amp;&amp;</span> (<span style="color: #333333">*</span>outsize)) error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #666666; font-style: italic">/*non multiple of 8 bits per scanline, padding bits needed per scanline*/</span>
      <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span> <span style="color: #333333">&amp;&amp;</span> w <span style="color: #333333">*</span> bpp <span style="color: #333333">!=</span> ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>)
      {
        <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> padded <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(h <span style="color: #333333">*</span> ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>));
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>padded) error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
        {
          addPaddingBits(padded, in, ((w <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>, w <span style="color: #333333">*</span> bpp, h);
          error <span style="color: #333333">=</span> filter(<span style="color: #333333">*</span>out, padded, w, h, <span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color, settings);
        }
        lodepng_free(padded);
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        <span style="color: #666666; font-style: italic">/*we can immediatly filter into the out buffer, no other steps needed*/</span>
        error <span style="color: #333333">=</span> filter(<span style="color: #333333">*</span>out, in, w, h, <span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color, settings);
      }
    }
  }
  <span style="color: #228899; font-weight: bold">else</span> <span style="color: #666666; font-style: italic">/*interlace_method is 1 (Adam7)*/</span>
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> passw[<span style="color: #6666ff; font-weight: bold">7</span>], passh[<span style="color: #6666ff; font-weight: bold">7</span>];
    <span style="color: #6666ff; font-weight: bold">size_t</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], padded_passstart[<span style="color: #6666ff; font-weight: bold">8</span>], passstart[<span style="color: #6666ff; font-weight: bold">8</span>];
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> adam7;

    Adam7_getpassvalues(passw, passh, filter_passstart, padded_passstart, passstart, w, h, bpp);

    <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> filter_passstart[<span style="color: #6666ff; font-weight: bold">7</span>]; <span style="color: #666666; font-style: italic">/*image size plus an extra byte per scanline + possible padding bits*/</span>
    <span style="color: #333333">*</span>out <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(<span style="color: #333333">*</span>outsize);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>(<span style="color: #333333">*</span>out)) error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    adam7 <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(passstart[<span style="color: #6666ff; font-weight: bold">7</span>]);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>adam7 <span style="color: #333333">&amp;&amp;</span> passstart[<span style="color: #6666ff; font-weight: bold">7</span>]) error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>

    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> i;

      Adam7_interlace(adam7, in, w, h, bpp);
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">7</span>; i<span style="color: #333333">++</span>)
      {
        <span style="color: #228899; font-weight: bold">if</span>(bpp <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">8</span>)
        {
          <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> padded <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(padded_passstart[i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">-</span> padded_passstart[i]);
          <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>padded) ERROR_BREAK(<span style="color: #6666ff; font-weight: bold">83</span>); <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
          addPaddingBits(padded, <span style="color: #333333">&amp;</span>adam7[passstart[i]],
                         ((passw[i] <span style="color: #333333">*</span> bpp <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>) <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">8</span>, passw[i] <span style="color: #333333">*</span> bpp, passh[i]);
          error <span style="color: #333333">=</span> filter(<span style="color: #333333">&amp;</span>(<span style="color: #333333">*</span>out)[filter_passstart[i]], padded,
                         passw[i], passh[i], <span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color, settings);
          lodepng_free(padded);
        }
        <span style="color: #228899; font-weight: bold">else</span>
        {
          error <span style="color: #333333">=</span> filter(<span style="color: #333333">&amp;</span>(<span style="color: #333333">*</span>out)[filter_passstart[i]], <span style="color: #333333">&amp;</span>adam7[padded_passstart[i]],
                         passw[i], passh[i], <span style="color: #333333">&amp;</span>info_png<span style="color: #333333">-&gt;</span>color, settings);
        }

        <span style="color: #228899; font-weight: bold">if</span>(error) <span style="color: #228899; font-weight: bold">break</span>;
      }
    }

    lodepng_free(adam7);
  }

  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">palette must have 4 * palettesize bytes allocated, and given in format RGBARGBARGBARGBA...</span>
<span style="color: #666666; font-style: italic">returns 0 if the palette is opaque,</span>
<span style="color: #666666; font-style: italic">returns 1 if the palette has a single color with alpha 0 ==&gt; color key</span>
<span style="color: #666666; font-style: italic">returns 2 if the palette is semi-translucent.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">getPaletteTranslucency</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> palette, <span style="color: #6666ff; font-weight: bold">size_t</span> palettesize)
{
  <span style="color: #6666ff; font-weight: bold">size_t</span> i;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> r <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, g <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, b <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*the value of the color with alpha 0, so long as color keying is possible*/</span>
  <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> palettesize; i<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>key <span style="color: #333333">&amp;&amp;</span> palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
    {
      r <span style="color: #333333">=</span> palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>]; g <span style="color: #333333">=</span> palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>]; b <span style="color: #333333">=</span> palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>];
      key <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
      i <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">size_t</span>)(<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>); <span style="color: #666666; font-style: italic">/*restart from beginning, to detect earlier opaque colors with key&#39;s value*/</span>
    }
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(palette[<span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">*</span> i <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">3</span>] <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">255</span>) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">2</span>;
    <span style="color: #666666; font-style: italic">/*when key, no opaque RGB may have key&#39;s RGB*/</span>
    <span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span>(key <span style="color: #333333">&amp;&amp;</span> r <span style="color: #333333">==</span> palette[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">0</span>] <span style="color: #333333">&amp;&amp;</span> g <span style="color: #333333">==</span> palette[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>] <span style="color: #333333">&amp;&amp;</span> b <span style="color: #333333">==</span> palette[i <span style="color: #333333">*</span> <span style="color: #6666ff; font-weight: bold">4</span> <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">2</span>]) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">2</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> key;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #228899; font-weight: bold">static</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">addUnknownChunks</span>(ucvector<span style="color: #333333">*</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data, <span style="color: #6666ff; font-weight: bold">size_t</span> datasize)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> inchunk <span style="color: #333333">=</span> data;
  <span style="color: #228899; font-weight: bold">while</span>((<span style="color: #6666ff; font-weight: bold">size_t</span>)(inchunk <span style="color: #333333">-</span> data) <span style="color: #333333">&lt;</span> datasize)
  {
    CERROR_TRY_RETURN(lodepng_chunk_append(<span style="color: #333333">&amp;</span>out<span style="color: #333333">-&gt;</span>data, <span style="color: #333333">&amp;</span>out<span style="color: #333333">-&gt;</span>size, inchunk));
    out<span style="color: #333333">-&gt;</span>allocsize <span style="color: #333333">=</span> out<span style="color: #333333">-&gt;</span>size; <span style="color: #666666; font-style: italic">/*fix the allocsize again*/</span>
    inchunk <span style="color: #333333">=</span> lodepng_chunk_next(inchunk);
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">0</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                        LodePNGState<span style="color: #333333">*</span> state)
{
  LodePNGInfo info;
  ucvector outv;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; <span style="color: #666666; font-style: italic">/*uncompressed version of the IDAT chunk data*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> datasize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  <span style="color: #666666; font-style: italic">/*provide some proper output values if error will happen*/</span>
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

  lodepng_info_init(<span style="color: #333333">&amp;</span>info);
  lodepng_info_copy(<span style="color: #333333">&amp;</span>info, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_png);

  <span style="color: #228899; font-weight: bold">if</span>((info.color.colortype <span style="color: #333333">==</span> LCT_PALETTE <span style="color: #333333">||</span> state<span style="color: #333333">-&gt;</span>encoder.force_palette)
      <span style="color: #333333">&amp;&amp;</span> (info.color.palettesize <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> info.color.palettesize <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">256</span>))
  {
    state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">68</span>; <span style="color: #666666; font-style: italic">/*invalid palette size, it is only allowed to be 1-256*/</span>
    <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
  }

  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>encoder.auto_convert)
  {
    state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_auto_choose_color(<span style="color: #333333">&amp;</span>info.color, image, w, h, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw);
  }
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;

  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>encoder.zlibsettings.btype <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">2</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">61</span>); <span style="color: #666666; font-style: italic">/*error: unexisting btype*/</span>
  }
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>info_png.interlace_method <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">1</span>)
  {
    CERROR_RETURN_ERROR(state<span style="color: #333333">-&gt;</span>error, <span style="color: #6666ff; font-weight: bold">71</span>); <span style="color: #666666; font-style: italic">/*error: unexisting interlace mode*/</span>
  }

  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> checkColorValidity(info.color.colortype, info.color.bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error; <span style="color: #666666; font-style: italic">/*error: unexisting color type given*/</span>
  state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> checkColorValidity(state<span style="color: #333333">-&gt;</span>info_raw.colortype, state<span style="color: #333333">-&gt;</span>info_raw.bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error; <span style="color: #666666; font-style: italic">/*error: unexisting color type given*/</span>

  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>lodepng_color_mode_equal(<span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw, <span style="color: #333333">&amp;</span>info.color))
  {
    <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> converted;
    <span style="color: #6666ff; font-weight: bold">size_t</span> size <span style="color: #333333">=</span> (w <span style="color: #333333">*</span> h <span style="color: #333333">*</span> lodepng_get_bpp(<span style="color: #333333">&amp;</span>info.color) <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">7</span>) <span style="color: #333333">/</span> <span style="color: #6666ff; font-weight: bold">8</span>;

    converted <span style="color: #333333">=</span> (<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)lodepng_malloc(size);
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>converted <span style="color: #333333">&amp;&amp;</span> size) state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">83</span>; <span style="color: #666666; font-style: italic">/*alloc fail*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error)
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> lodepng_convert(converted, image, <span style="color: #333333">&amp;</span>info.color, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>info_raw, w, h);
    }
    <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error) preProcessScanlines(<span style="color: #333333">&amp;</span>data, <span style="color: #333333">&amp;</span>datasize, converted, w, h, <span style="color: #333333">&amp;</span>info, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder);
    lodepng_free(converted);
  }
  <span style="color: #228899; font-weight: bold">else</span> preProcessScanlines(<span style="color: #333333">&amp;</span>data, <span style="color: #333333">&amp;</span>datasize, image, w, h, <span style="color: #333333">&amp;</span>info, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder);

  ucvector_init(<span style="color: #333333">&amp;</span>outv);
  <span style="color: #228899; font-weight: bold">while</span>(<span style="color: #333333">!</span>state<span style="color: #333333">-&gt;</span>error) <span style="color: #666666; font-style: italic">/*while only executed once, to break on error*/</span>
  {
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
    <span style="color: #6666ff; font-weight: bold">size_t</span> i;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    <span style="color: #666666; font-style: italic">/*write signature and chunks*/</span>
    writeSignature(<span style="color: #333333">&amp;</span>outv);
    <span style="color: #666666; font-style: italic">/*IHDR*/</span>
    addChunk_IHDR(<span style="color: #333333">&amp;</span>outv, w, h, info.color.colortype, info.color.bitdepth, info.interlace_method);
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
    <span style="color: #666666; font-style: italic">/*unknown chunks between IHDR and PLTE*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">0</span>])
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> addUnknownChunks(<span style="color: #333333">&amp;</span>outv, info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">0</span>], info.unknown_chunks_size[<span style="color: #6666ff; font-weight: bold">0</span>]);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    <span style="color: #666666; font-style: italic">/*PLTE*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.color.colortype <span style="color: #333333">==</span> LCT_PALETTE)
    {
      addChunk_PLTE(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info.color);
    }
    <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>encoder.force_palette <span style="color: #333333">&amp;&amp;</span> (info.color.colortype <span style="color: #333333">==</span> LCT_RGB <span style="color: #333333">||</span> info.color.colortype <span style="color: #333333">==</span> LCT_RGBA))
    {
      addChunk_PLTE(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info.color);
    }
    <span style="color: #666666; font-style: italic">/*tRNS*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.color.colortype <span style="color: #333333">==</span> LCT_PALETTE <span style="color: #333333">&amp;&amp;</span> getPaletteTranslucency(info.color.palette, info.color.palettesize) <span style="color: #333333">!=</span> <span style="color: #6666ff; font-weight: bold">0</span>)
    {
      addChunk_tRNS(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info.color);
    }
    <span style="color: #228899; font-weight: bold">if</span>((info.color.colortype <span style="color: #333333">==</span> LCT_GREY <span style="color: #333333">||</span> info.color.colortype <span style="color: #333333">==</span> LCT_RGB) <span style="color: #333333">&amp;&amp;</span> info.color.key_defined)
    {
      addChunk_tRNS(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info.color);
    }
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
    <span style="color: #666666; font-style: italic">/*bKGD (must come between PLTE and the IDAt chunks*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.background_defined) addChunk_bKGD(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info);
    <span style="color: #666666; font-style: italic">/*pHYs (must come before the IDAT chunks)*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.phys_defined) addChunk_pHYs(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info);

    <span style="color: #666666; font-style: italic">/*unknown chunks between PLTE and IDAT*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">1</span>])
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> addUnknownChunks(<span style="color: #333333">&amp;</span>outv, info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">1</span>], info.unknown_chunks_size[<span style="color: #6666ff; font-weight: bold">1</span>]);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    <span style="color: #666666; font-style: italic">/*IDAT (multiple IDAT chunks must be consecutive)*/</span>
    state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> addChunk_IDAT(<span style="color: #333333">&amp;</span>outv, data, datasize, <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder.zlibsettings);
    <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
    <span style="color: #666666; font-style: italic">/*tIME*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.time_defined) addChunk_tIME(<span style="color: #333333">&amp;</span>outv, <span style="color: #333333">&amp;</span>info.time);
    <span style="color: #666666; font-style: italic">/*tEXt and/or zTXt*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info.text_num; i<span style="color: #333333">++</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(strlen(info.text_keys[i]) <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">66</span>; <span style="color: #666666; font-style: italic">/*text chunk too large*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
      <span style="color: #228899; font-weight: bold">if</span>(strlen(info.text_keys[i]) <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">67</span>; <span style="color: #666666; font-style: italic">/*text chunk too small*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>encoder.text_compression)
      {
        addChunk_zTXt(<span style="color: #333333">&amp;</span>outv, info.text_keys[i], info.text_strings[i], <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder.zlibsettings);
      }
      <span style="color: #228899; font-weight: bold">else</span>
      {
        addChunk_tEXt(<span style="color: #333333">&amp;</span>outv, info.text_keys[i], info.text_strings[i]);
      }
    }
    <span style="color: #666666; font-style: italic">/*LodePNG version id in text chunk*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>encoder.add_id)
    {
      <span style="color: #6666ff; font-weight: bold">unsigned</span> alread_added_id_text <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
      <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info.text_num; i<span style="color: #333333">++</span>)
      {
        <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>strcmp(info.text_keys[i], <span style="background-color: #e0e0ff">&quot;LodePNG&quot;</span>))
        {
          alread_added_id_text <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
          <span style="color: #228899; font-weight: bold">break</span>;
        }
      }
      <span style="color: #228899; font-weight: bold">if</span>(alread_added_id_text <span style="color: #333333">==</span> <span style="color: #6666ff; font-weight: bold">0</span>)
      {
        addChunk_tEXt(<span style="color: #333333">&amp;</span>outv, <span style="background-color: #e0e0ff">&quot;LodePNG&quot;</span>, VERSION_STRING); <span style="color: #666666; font-style: italic">/*it&#39;s shorter as tEXt than as zTXt chunk*/</span>
      }
    }
    <span style="color: #666666; font-style: italic">/*iTXt*/</span>
    <span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; i <span style="color: #333333">&lt;</span> info.itext_num; i<span style="color: #333333">++</span>)
    {
      <span style="color: #228899; font-weight: bold">if</span>(strlen(info.itext_keys[i]) <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">79</span>)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">66</span>; <span style="color: #666666; font-style: italic">/*text chunk too large*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
      <span style="color: #228899; font-weight: bold">if</span>(strlen(info.itext_keys[i]) <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>)
      {
        state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">67</span>; <span style="color: #666666; font-style: italic">/*text chunk too small*/</span>
        <span style="color: #228899; font-weight: bold">break</span>;
      }
      addChunk_iTXt(<span style="color: #333333">&amp;</span>outv, state<span style="color: #333333">-&gt;</span>encoder.text_compression,
                    info.itext_keys[i], info.itext_langtags[i], info.itext_transkeys[i], info.itext_strings[i],
                    <span style="color: #333333">&amp;</span>state<span style="color: #333333">-&gt;</span>encoder.zlibsettings);
    }

    <span style="color: #666666; font-style: italic">/*unknown chunks between IDAT and IEND*/</span>
    <span style="color: #228899; font-weight: bold">if</span>(info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">2</span>])
    {
      state<span style="color: #333333">-&gt;</span>error <span style="color: #333333">=</span> addUnknownChunks(<span style="color: #333333">&amp;</span>outv, info.unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">2</span>], info.unknown_chunks_size[<span style="color: #6666ff; font-weight: bold">2</span>]);
      <span style="color: #228899; font-weight: bold">if</span>(state<span style="color: #333333">-&gt;</span>error) <span style="color: #228899; font-weight: bold">break</span>;
    }
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
    addChunk_IEND(<span style="color: #333333">&amp;</span>outv);

    <span style="color: #228899; font-weight: bold">break</span>; <span style="color: #666666; font-style: italic">/*this isn&#39;t really a while loop; no error happened so break out now!*/</span>
  }

  lodepng_info_cleanup(<span style="color: #333333">&amp;</span>info);
  lodepng_free(data);
  <span style="color: #666666; font-style: italic">/*instead of cleaning the vector up, give it to the output*/</span>
  <span style="color: #333333">*</span>out <span style="color: #333333">=</span> outv.data;
  <span style="color: #333333">*</span>outsize <span style="color: #333333">=</span> outv.size;

  <span style="color: #228899; font-weight: bold">return</span> state<span style="color: #333333">-&gt;</span>error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode_memory</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image,
                               <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
  LodePNGState state;
  lodepng_state_init(<span style="color: #333333">&amp;</span>state);
  state.info_raw.colortype <span style="color: #333333">=</span> colortype;
  state.info_raw.bitdepth <span style="color: #333333">=</span> bitdepth;
  state.info_png.color.colortype <span style="color: #333333">=</span> colortype;
  state.info_png.color.bitdepth <span style="color: #333333">=</span> bitdepth;
  lodepng_encode(out, outsize, image, w, h, <span style="color: #333333">&amp;</span>state);
  error <span style="color: #333333">=</span> state.error;
  lodepng_state_cleanup(<span style="color: #333333">&amp;</span>state);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode32</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_encode_memory(out, outsize, image, w, h, LCT_RGBA, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode24</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_encode_memory(out, outsize, image, w, h, LCT_RGB, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                             LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> lodepng_encode_memory(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, image, w, h, colortype, bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) error <span style="color: #333333">=</span> lodepng_save_file(buffer, buffersize, filename);
  lodepng_free(buffer);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode32_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_encode_file(filename, image, w, h, LCT_RGBA, <span style="color: #6666ff; font-weight: bold">8</span>);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode24_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h)
{
  <span style="color: #228899; font-weight: bold">return</span> lodepng_encode_file(filename, image, w, h, LCT_RGB, <span style="color: #6666ff; font-weight: bold">8</span>);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_encoder_settings_init</span>(LodePNGEncoderSettings<span style="color: #333333">*</span> settings)
{
  lodepng_compress_settings_init(<span style="color: #333333">&amp;</span>settings<span style="color: #333333">-&gt;</span>zlibsettings);
  settings<span style="color: #333333">-&gt;</span>filter_palette_zero <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  settings<span style="color: #333333">-&gt;</span>filter_strategy <span style="color: #333333">=</span> LFS_MINSUM;
  settings<span style="color: #333333">-&gt;</span>auto_convert <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
  settings<span style="color: #333333">-&gt;</span>force_palette <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>predefined_filters <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  settings<span style="color: #333333">-&gt;</span>add_id <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  settings<span style="color: #333333">-&gt;</span>text_compression <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">1</span>;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
}

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ERROR_TEXT</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">This returns the description of a numerical error code in English. This is also</span>
<span style="color: #666666; font-style: italic">the documentation of all the error codes.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_error_text</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> code)
{
  <span style="color: #228899; font-weight: bold">switch</span>(code)
  {
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">0</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;no error, everything went ok&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">1</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;nothing done yet&quot;</span>; <span style="color: #666666; font-style: italic">/*the Encoder/Decoder has done nothing yet, error checking makes no sense yet*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">10</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;end of input memory reached without huffman end code&quot;</span>; <span style="color: #666666; font-style: italic">/*while huffman decoding*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">11</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;error in code tree made it jump outside of huffman tree&quot;</span>; <span style="color: #666666; font-style: italic">/*while huffman decoding*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">13</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;problem while processing dynamic deflate block&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">14</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;problem while processing dynamic deflate block&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">15</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;problem while processing dynamic deflate block&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">16</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;unexisting code while processing dynamic deflate block&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">17</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;end of out buffer memory reached while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">18</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid distance code while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">19</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;end of out buffer memory reached while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">20</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid deflate block BTYPE encountered while decoding&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">21</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;NLEN is not ones complement of LEN in a deflate block&quot;</span>;
     <span style="color: #666666; font-style: italic">/*end of out buffer memory reached while inflating:</span>
<span style="color: #666666; font-style: italic">     This can happen if the inflated deflate data is longer than the amount of bytes required to fill up</span>
<span style="color: #666666; font-style: italic">     all the pixels of the image, given the color depth and image dimensions. Something that doesn&#39;t</span>
<span style="color: #666666; font-style: italic">     happen in a normal, well encoded, PNG image.*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">22</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;end of out buffer memory reached while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">23</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;end of in buffer memory reached while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">24</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid FCHECK in zlib header&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">25</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid compression method in zlib header&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">26</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;FDICT encountered in zlib header while it&#39;s not used for PNG&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">27</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;PNG file is smaller than a PNG header&quot;</span>;
    <span style="color: #666666; font-style: italic">/*Checks the magic file header, the first 8 bytes of the PNG file*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">28</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;incorrect PNG signature, it&#39;s no PNG or corrupted&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">29</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;first chunk is not the header chunk&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">30</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;chunk length too large, chunk broken off at end of file&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">31</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal PNG color type or bpp&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">32</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal PNG compression method&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">33</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal PNG filter method&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">34</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal PNG interlace method&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">35</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;chunk length of a chunk is too large or the chunk too small&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">36</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal PNG filter type encountered&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">37</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;illegal bit depth for this color type given&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">38</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;the palette is too big&quot;</span>; <span style="color: #666666; font-style: italic">/*more than 256 colors*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">39</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;more palette alpha values given in tRNS chunk than there are colors in the palette&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">40</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;tRNS chunk has wrong size for greyscale image&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">41</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;tRNS chunk has wrong size for RGB image&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">42</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;tRNS chunk appeared while it was not allowed for this color type&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">43</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;bKGD chunk has wrong size for palette image&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">44</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;bKGD chunk has wrong size for greyscale image&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">45</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;bKGD chunk has wrong size for RGB image&quot;</span>;
    <span style="color: #666666; font-style: italic">/*the input data is empty, maybe a PNG file doesn&#39;t exist or is in the wrong path*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">48</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;empty input or file doesn&#39;t exist&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">49</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;jumped past memory while generating dynamic huffman tree&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">50</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;jumped past memory while generating dynamic huffman tree&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">51</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;jumped past memory while inflating huffman block&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">52</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;jumped past memory while inflating&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">53</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;size of zlib data too small&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">54</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;repeat symbol in tree while there was no value symbol yet&quot;</span>;
    <span style="color: #666666; font-style: italic">/*jumped past tree while generating huffman tree, this could be when the</span>
<span style="color: #666666; font-style: italic">    tree will have more leaves than symbols after generating it out of the</span>
<span style="color: #666666; font-style: italic">    given lenghts. They call this an oversubscribed dynamic bit lengths tree in zlib.*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">55</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;jumped past tree while generating huffman tree&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">56</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;given output image colortype or bitdepth not supported for color conversion&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">57</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid CRC encountered (checking CRC can be disabled)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">58</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid ADLER32 encountered (checking ADLER32 can be disabled)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">59</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;requested color conversion not supported&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">60</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid window size given in the settings of the encoder (must be 0-32768)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">61</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid BTYPE given in the settings of the encoder (only 0, 1 and 2 are allowed)&quot;</span>;
    <span style="color: #666666; font-style: italic">/*LodePNG leaves the choice of RGB to greyscale conversion formula to the user.*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">62</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;conversion from color to greyscale not supported&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">63</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;length of a chunk too long, max allowed for PNG is 2147483647 bytes per chunk&quot;</span>; <span style="color: #666666; font-style: italic">/*(2^31-1)*/</span>
    <span style="color: #666666; font-style: italic">/*this would result in the inability of a deflated block to ever contain an end code. It must be at least 1.*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">64</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;the length of the END symbol 256 in the Huffman tree is 0&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">66</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;the length of a text chunk keyword given to the encoder is longer than the maximum of 79 bytes&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">67</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;the length of a text chunk keyword given to the encoder is smaller than the minimum of 1 byte&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">68</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;tried to encode a PLTE chunk with a palette that has less than 1 or more than 256 colors&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">69</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;unknown chunk type with &#39;critical&#39; flag encountered by the decoder&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">71</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;unexisting interlace mode given to encoder (must be 0 or 1)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">72</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;while decoding, unexisting compression method encountering in zTXt or iTXt chunk (it must be 0)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">73</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid tIME chunk size&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">74</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid pHYs chunk size&quot;</span>;
    <span style="color: #666666; font-style: italic">/*length could be wrong, or data chopped off*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">75</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;no null termination char found while decoding text chunk&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">76</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;iTXt chunk too short to contain required bytes&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">77</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;integer overflow in buffer size&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">78</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;failed to open file for reading&quot;</span>; <span style="color: #666666; font-style: italic">/*file doesn&#39;t exist or couldn&#39;t be opened for reading*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">79</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;failed to open file for writing&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">80</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;tried creating a tree of 0 symbols&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">81</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;lazy matching at pos 0 is impossible&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">82</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;color conversion to palette requested while a color isn&#39;t in palette&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">83</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;memory allocation failed&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">84</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;given image too small to contain all pixels to be encoded&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">86</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;impossible offset in lz77 encoding (internal bug)&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">87</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;must provide custom zlib function pointer if LODEPNG_COMPILE_ZLIB is not defined&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">88</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;invalid filter strategy given for LodePNGEncoderSettings.filter_strategy&quot;</span>;
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">89</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;text chunk keyword too short or long: must have size 1-79&quot;</span>;
    <span style="color: #666666; font-style: italic">/*the windowsize in the LodePNGCompressSettings. Requiring POT(==&gt; &amp; instead of %) makes encoding 12% faster.*/</span>
    <span style="color: #228899; font-weight: bold">case</span> <span style="color: #6666ff; font-weight: bold">90</span>: <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;windowsize must be a power of two&quot;</span>;
  }
  <span style="color: #228899; font-weight: bold">return</span> <span style="background-color: #e0e0ff">&quot;unknown error code&quot;</span>;
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ERROR_TEXT*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* // C++ Wrapper                                                          // */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>
<span style="color: #666666; font-style: italic">/* ////////////////////////////////////////////////////////////////////////// */</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_CPP</span>
namespace lodepng
{

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #6666ff; font-weight: bold">void</span> load_file(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> buffer, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename)
{
  std<span style="color: #333333">::</span>ifstream file(filename.c_str(), std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>in<span style="color: #333333">|</span>std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>binary<span style="color: #333333">|</span>std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>ate);

  <span style="color: #666666; font-style: italic">/*get filesize*/</span>
  std<span style="color: #333333">::</span>streamsize size <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #228899; font-weight: bold">if</span>(file.seekg(<span style="color: #6666ff; font-weight: bold">0</span>, std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>end).good()) size <span style="color: #333333">=</span> file.tellg();
  <span style="color: #228899; font-weight: bold">if</span>(file.seekg(<span style="color: #6666ff; font-weight: bold">0</span>, std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>beg).good()) size <span style="color: #333333">-=</span> file.tellg();

  <span style="color: #666666; font-style: italic">/*read contents of the file into the vector*/</span>
  buffer.resize(<span style="color: #6666ff; font-weight: bold">size_t</span>(size));
  <span style="color: #228899; font-weight: bold">if</span>(size <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">0</span>) file.read((<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)(<span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>]), size);
}

<span style="color: #666666; font-style: italic">/*write given buffer to the file, overwriting the file, it doesn&#39;t append to it.*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> save_file(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> buffer, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename)
{
  std<span style="color: #333333">::</span>ofstream file(filename.c_str(), std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>out<span style="color: #333333">|</span>std<span style="color: #333333">::</span>ios<span style="color: #333333">::</span>binary);
  file.write(buffer.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> (<span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)<span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], std<span style="color: #333333">::</span>streamsize(buffer.size()));
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> decompress(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                    <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">&amp;</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> zlib_decompress(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, in, insize, <span style="color: #333333">&amp;</span>settings);
  <span style="color: #228899; font-weight: bold">if</span>(buffer)
  {
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
    lodepng_free(buffer);
  }
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> decompress(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in,
                    <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">&amp;</span> settings)
{
  <span style="color: #228899; font-weight: bold">return</span> decompress(out, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], in.size(), settings);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DECODER</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> compress(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                  <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">&amp;</span> settings)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> zlib_compress(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, in, insize, <span style="color: #333333">&amp;</span>settings);
  <span style="color: #228899; font-weight: bold">if</span>(buffer)
  {
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
    lodepng_free(buffer);
  }
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> compress(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in,
                  <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">&amp;</span> settings)
{
  <span style="color: #228899; font-weight: bold">return</span> compress(out, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], in.size(), settings);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ENCODER</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ZLIB</span>


<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>

State<span style="color: #333333">::</span>State()
{
  lodepng_state_init(this);
}

State<span style="color: #333333">::</span>State(<span style="color: #228899; font-weight: bold">const</span> State<span style="color: #333333">&amp;</span> other)
{
  lodepng_state_init(this);
  lodepng_state_copy(this, <span style="color: #333333">&amp;</span>other);
}

State<span style="color: #333333">::~</span>State()
{
  lodepng_state_cleanup(this);
}

State<span style="color: #333333">&amp;</span> State<span style="color: #333333">::</span>operator<span style="color: #333333">=</span>(<span style="color: #228899; font-weight: bold">const</span> State<span style="color: #333333">&amp;</span> other)
{
  lodepng_state_copy(this, <span style="color: #333333">&amp;</span>other);
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #333333">*</span>this;
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>

<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                <span style="color: #6666ff; font-weight: bold">size_t</span> insize, LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> lodepng_decode_memory(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>w, <span style="color: #333333">&amp;</span>h, in, insize, colortype, bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(buffer <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>error)
  {
    State state;
    state.info_raw.colortype <span style="color: #333333">=</span> colortype;
    state.info_raw.bitdepth <span style="color: #333333">=</span> bitdepth;
    <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize <span style="color: #333333">=</span> lodepng_get_raw_size(w, h, <span style="color: #333333">&amp;</span>state.info_raw);
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
    lodepng_free(buffer);
  }
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #228899; font-weight: bold">return</span> decode(out, w, h, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], (<span style="color: #6666ff; font-weight: bold">unsigned</span>)in.size(), colortype, bitdepth);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                State<span style="color: #333333">&amp;</span> state,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer <span style="color: #333333">=</span> <span style="color: #007722">NULL</span>;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> lodepng_decode(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>w, <span style="color: #333333">&amp;</span>h, <span style="color: #333333">&amp;</span>state, in, insize);
  <span style="color: #228899; font-weight: bold">if</span>(buffer <span style="color: #333333">&amp;&amp;</span> <span style="color: #333333">!</span>error)
  {
    <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize <span style="color: #333333">=</span> lodepng_get_raw_size(w, h, <span style="color: #333333">&amp;</span>state.info_raw);
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
  }
  lodepng_free(buffer);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                State<span style="color: #333333">&amp;</span> state,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in)
{
  <span style="color: #228899; font-weight: bold">return</span> decode(out, w, h, state, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], in.size());
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;</span> buffer;
  load_file(buffer, filename);
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #55eedd; font-weight: bold">decode</span>(out, w, h, buffer, colortype, bitdepth);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DECODER</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> lodepng_encode_memory(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, in, w, h, colortype, bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(buffer)
  {
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
    lodepng_free(buffer);
  }
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #228899; font-weight: bold">if</span>(lodepng_get_raw_size_lct(w, h, colortype, bitdepth) <span style="color: #333333">&gt;</span> in.size()) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">84</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #55eedd; font-weight: bold">encode</span>(out, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], w, h, colortype, bitdepth);
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                State<span style="color: #333333">&amp;</span> state)
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer;
  <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> lodepng_encode(<span style="color: #333333">&amp;</span>buffer, <span style="color: #333333">&amp;</span>buffersize, in, w, h, <span style="color: #333333">&amp;</span>state);
  <span style="color: #228899; font-weight: bold">if</span>(buffer)
  {
    out.insert(out.end(), <span style="color: #333333">&amp;</span>buffer[<span style="color: #6666ff; font-weight: bold">0</span>], <span style="color: #333333">&amp;</span>buffer[buffersize]);
    lodepng_free(buffer);
  }
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                State<span style="color: #333333">&amp;</span> state)
{
  <span style="color: #228899; font-weight: bold">if</span>(lodepng_get_raw_size(w, h, <span style="color: #333333">&amp;</span>state.info_raw) <span style="color: #333333">&gt;</span> in.size()) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">84</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #55eedd; font-weight: bold">encode</span>(out, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], w, h, state);
}

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;</span> buffer;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error <span style="color: #333333">=</span> encode(buffer, in, w, h, colortype, bitdepth);
  <span style="color: #228899; font-weight: bold">if</span>(<span style="color: #333333">!</span>error) save_file(buffer, filename);
  <span style="color: #228899; font-weight: bold">return</span> error;
}

<span style="color: #6666ff; font-weight: bold">unsigned</span> encode(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth)
{
  <span style="color: #228899; font-weight: bold">if</span>(lodepng_get_raw_size_lct(w, h, colortype, bitdepth) <span style="color: #333333">&gt;</span> in.size()) <span style="color: #228899; font-weight: bold">return</span> <span style="color: #6666ff; font-weight: bold">84</span>;
  <span style="color: #228899; font-weight: bold">return</span> <span style="color: #55eedd; font-weight: bold">encode</span>(filename, in.empty() <span style="color: #333333">?</span> <span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">:</span> <span style="color: #333333">&amp;</span>in[<span style="color: #6666ff; font-weight: bold">0</span>], w, h, colortype, bitdepth);
}
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ENCODER</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_PNG</span>
} <span style="color: #666666; font-style: italic">//namespace lodepng</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_CPP*/</span><span style="color: #557799"></span>
</pre></div>
<p></p>

                            </section>
                            
                            
        
        
        
        
        
        
                            <!--lodepng.h-->
                            <section>
                                <hnew id="lodepng.h">lodepng.h</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">LodePNG version 20140823</span>

<span style="color: #666666; font-style: italic">Copyright (c) 2005-2014 Lode Vandevenne</span>

<span style="color: #666666; font-style: italic">This software is provided &#39;as-is&#39;, without any express or implied</span>
<span style="color: #666666; font-style: italic">warranty. In no event will the authors be held liable for any damages</span>
<span style="color: #666666; font-style: italic">arising from the use of this software.</span>

<span style="color: #666666; font-style: italic">Permission is granted to anyone to use this software for any purpose,</span>
<span style="color: #666666; font-style: italic">including commercial applications, and to alter it and redistribute it</span>
<span style="color: #666666; font-style: italic">freely, subject to the following restrictions:</span>

<span style="color: #666666; font-style: italic">    1. The origin of this software must not be misrepresented; you must not</span>
<span style="color: #666666; font-style: italic">    claim that you wrote the original software. If you use this software</span>
<span style="color: #666666; font-style: italic">    in a product, an acknowledgment in the product documentation would be</span>
<span style="color: #666666; font-style: italic">    appreciated but is not required.</span>

<span style="color: #666666; font-style: italic">    2. Altered source versions must be plainly marked as such, and must not be</span>
<span style="color: #666666; font-style: italic">    misrepresented as being the original software.</span>

<span style="color: #666666; font-style: italic">    3. This notice may not be removed or altered from any source</span>
<span style="color: #666666; font-style: italic">    distribution.</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #557799">#ifndef LODEPNG_H</span>
<span style="color: #557799">#define LODEPNG_H</span>

<span style="color: #557799">#include &lt;string.h&gt; </span><span style="color: #666666; font-style: italic">/*for size_t*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef __cplusplus</span>
<span style="color: #557799">#include &lt;vector&gt;</span>
<span style="color: #557799">#include &lt;string&gt;</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*__cplusplus*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">The following #defines are used to create code sections. They can be disabled</span>
<span style="color: #666666; font-style: italic">to disable code sections, which can give faster compile time and smaller binary.</span>
<span style="color: #666666; font-style: italic">The &quot;NO_COMPILE&quot; defines are designed to be used to pass as defines to the</span>
<span style="color: #666666; font-style: italic">compiler command to disable them without modifying this header, e.g.</span>
<span style="color: #666666; font-style: italic">-DLODEPNG_NO_COMPILE_ZLIB for gcc.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #666666; font-style: italic">/*deflate &amp; zlib. If disabled, you must specify alternative zlib functions in</span>
<span style="color: #666666; font-style: italic">the custom_zlib field of the compress and decompress settings*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_ZLIB</span>
<span style="color: #557799">#define LODEPNG_COMPILE_ZLIB</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*png encoder and png decoder*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_PNG</span>
<span style="color: #557799">#define LODEPNG_COMPILE_PNG</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*deflate&amp;zlib decoder and png decoder*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_DECODER</span>
<span style="color: #557799">#define LODEPNG_COMPILE_DECODER</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*deflate&amp;zlib encoder and png encoder*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_ENCODER</span>
<span style="color: #557799">#define LODEPNG_COMPILE_ENCODER</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*the optional built in harddisk file loading and saving functions*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_DISK</span>
<span style="color: #557799">#define LODEPNG_COMPILE_DISK</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*support for chunks other than IHDR, IDAT, PLTE, tRNS, IEND: ancillary and unknown chunks*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #557799">#define LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*ability to convert error numerical codes to English text string*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_ERROR_TEXT</span>
<span style="color: #557799">#define LODEPNG_COMPILE_ERROR_TEXT</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*Compile the default allocators (C&#39;s free, malloc and realloc). If you disable this,</span>
<span style="color: #666666; font-style: italic">you can define the functions lodepng_free, lodepng_malloc and lodepng_realloc in your</span>
<span style="color: #666666; font-style: italic">source files with custom allocators.*/</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_ALLOCATORS</span>
<span style="color: #557799">#define LODEPNG_COMPILE_ALLOCATORS</span>
<span style="color: #557799">#endif</span>
<span style="color: #666666; font-style: italic">/*compile the C++ version (you can disable the C++ wrapper here even when compiling for C++)*/</span>
<span style="color: #557799">#ifdef __cplusplus</span>
<span style="color: #557799">#ifndef LODEPNG_NO_COMPILE_CPP</span>
<span style="color: #557799">#define LODEPNG_COMPILE_CPP</span>
<span style="color: #557799">#endif</span>
<span style="color: #557799">#endif</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>
<span style="color: #666666; font-style: italic">/*The PNG color types (also used for raw).*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">enum</span> LodePNGColorType
{
  LCT_GREY <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>, <span style="color: #666666; font-style: italic">/*greyscale: 1,2,4,8,16 bit*/</span>
  LCT_RGB <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">2</span>, <span style="color: #666666; font-style: italic">/*RGB: 8,16 bit*/</span>
  LCT_PALETTE <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">3</span>, <span style="color: #666666; font-style: italic">/*palette: 1,2,4,8 bit*/</span>
  LCT_GREY_ALPHA <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">4</span>, <span style="color: #666666; font-style: italic">/*greyscale with alpha: 8,16 bit*/</span>
  LCT_RGBA <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">6</span> <span style="color: #666666; font-style: italic">/*RGB with alpha: 8,16 bit*/</span>
} LodePNGColorType;

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts PNG data in memory to raw pixel data.</span>
<span style="color: #666666; font-style: italic">out: Output parameter. Pointer to buffer that will contain the raw pixel data.</span>
<span style="color: #666666; font-style: italic">     After decoding, its size is w * h * (bytes per pixel) bytes larger than</span>
<span style="color: #666666; font-style: italic">     initially. Bytes per pixel depends on colortype and bitdepth.</span>
<span style="color: #666666; font-style: italic">     Must be freed after usage with free(*out).</span>
<span style="color: #666666; font-style: italic">     Note: for 16-bit per channel colors, uses big endian format like PNG does.</span>
<span style="color: #666666; font-style: italic">w: Output parameter. Pointer to width of pixel data.</span>
<span style="color: #666666; font-style: italic">h: Output parameter. Pointer to height of pixel data.</span>
<span style="color: #666666; font-style: italic">in: Memory buffer with the PNG file.</span>
<span style="color: #666666; font-style: italic">insize: size of the in buffer.</span>
<span style="color: #666666; font-style: italic">colortype: the desired color type for the raw output image. See explanation on PNG color types.</span>
<span style="color: #666666; font-style: italic">bitdepth: the desired bit depth for the raw output image. See explanation on PNG color types.</span>
<span style="color: #666666; font-style: italic">Return value: LodePNG error code (0 means no error).</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode_memory</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                               LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth);

<span style="color: #666666; font-style: italic">/*Same as lodepng_decode_memory, but always decodes to 32-bit RGBA raw image*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode32</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize);

<span style="color: #666666; font-style: italic">/*Same as lodepng_decode_memory, but always decodes to 24-bit RGB raw image*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode24</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize);

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Load PNG from disk, from file with given name.</span>
<span style="color: #666666; font-style: italic">Same as the other decode functions, but instead takes a filename as input.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                             <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename,
                             LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth);

<span style="color: #666666; font-style: italic">/*Same as lodepng_decode_file, but always decodes to 32-bit RGBA raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode32_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename);

<span style="color: #666666; font-style: italic">/*Same as lodepng_decode_file, but always decodes to 24-bit RGB raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode24_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>


<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts raw pixel data into a PNG image in memory. The colortype and bitdepth</span>
<span style="color: #666666; font-style: italic">  of the output PNG image cannot be chosen, they are automatically determined</span>
<span style="color: #666666; font-style: italic">  by the colortype, bitdepth and content of the input pixel data.</span>
<span style="color: #666666; font-style: italic">  Note: for 16-bit per channel colors, needs big endian format like PNG does.</span>
<span style="color: #666666; font-style: italic">out: Output parameter. Pointer to buffer that will contain the PNG image data.</span>
<span style="color: #666666; font-style: italic">     Must be freed after usage with free(*out).</span>
<span style="color: #666666; font-style: italic">outsize: Output parameter. Pointer to the size in bytes of the out buffer.</span>
<span style="color: #666666; font-style: italic">image: The raw pixel data to encode. The size of this buffer should be</span>
<span style="color: #666666; font-style: italic">       w * h * (bytes per pixel), bytes per pixel depends on colortype and bitdepth.</span>
<span style="color: #666666; font-style: italic">w: width of the raw pixel data in pixels.</span>
<span style="color: #666666; font-style: italic">h: height of the raw pixel data in pixels.</span>
<span style="color: #666666; font-style: italic">colortype: the color type of the raw input image. See explanation on PNG color types.</span>
<span style="color: #666666; font-style: italic">bitdepth: the bit depth of the raw input image. See explanation on PNG color types.</span>
<span style="color: #666666; font-style: italic">Return value: LodePNG error code (0 means no error).</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode_memory</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                               LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth);

<span style="color: #666666; font-style: italic">/*Same as lodepng_encode_memory, but always encodes from 32-bit RGBA raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode32</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h);

<span style="color: #666666; font-style: italic">/*Same as lodepng_encode_memory, but always encodes from 24-bit RGB raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode24</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h);

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts raw pixel data into a PNG file on disk.</span>
<span style="color: #666666; font-style: italic">Same as the other encode functions, but instead takes a filename as output.</span>
<span style="color: #666666; font-style: italic">NOTE: This overwrites existing files without warning!</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename,
                             <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                             LodePNGColorType colortype, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth);

<span style="color: #666666; font-style: italic">/*Same as lodepng_encode_file, but always encodes from 32-bit RGBA raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode32_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h);

<span style="color: #666666; font-style: italic">/*Same as lodepng_encode_file, but always encodes from 24-bit RGB raw image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode24_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>


<span style="color: #557799">#ifdef LODEPNG_COMPILE_CPP</span>
namespace lodepng
{
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*Same as lodepng_decode_memory, but decodes to an std::vector. The colortype</span>
<span style="color: #666666; font-style: italic">is the format to output the pixels to. Default is RGBA 8-bit per channel.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> decode(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts PNG file from disk to raw pixel data in memory.</span>
<span style="color: #666666; font-style: italic">Same as the other decode functions, but instead takes a filename as input.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DECODER</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*Same as lodepng_encode_memory, but encodes to an std::vector. colortype</span>
<span style="color: #666666; font-style: italic">is that of the raw input data. The output PNG color type will be auto chosen.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts 32-bit RGBA raw pixel data into a PNG file on disk.</span>
<span style="color: #666666; font-style: italic">Same as the other encode functions, but instead takes a filename as output.</span>
<span style="color: #666666; font-style: italic">NOTE: This overwrites existing files without warning!</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                LodePNGColorType colortype <span style="color: #333333">=</span> LCT_RGBA, <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">8</span>);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ENCODER</span>
} <span style="color: #666666; font-style: italic">//namespace lodepng</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_CPP*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ERROR_TEXT</span>
<span style="color: #666666; font-style: italic">/*Returns an English description of the numerical error code.*/</span>
<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> lodepng_error_text(<span style="color: #6666ff; font-weight: bold">unsigned</span> code);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ERROR_TEXT*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*Settings for zlib decompression*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGDecompressSettings LodePNGDecompressSettings;
<span style="color: #228899; font-weight: bold">struct</span> LodePNGDecompressSettings
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> ignore_adler32; <span style="color: #666666; font-style: italic">/*if 1, continue and don&#39;t give an error message if the Adler32 checksum is corrupted*/</span>

  <span style="color: #666666; font-style: italic">/*use custom zlib decoder instead of built in one (default: null)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> (<span style="color: #333333">*</span>custom_zlib)(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span>,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>, <span style="color: #6666ff; font-weight: bold">size_t</span>,
                          <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span>);
  <span style="color: #666666; font-style: italic">/*use custom deflate decoder instead of built in one (default: null)</span>
<span style="color: #666666; font-style: italic">  if custom_zlib is used, custom_deflate is ignored since only the built in</span>
<span style="color: #666666; font-style: italic">  zlib function will call custom_deflate*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> (<span style="color: #333333">*</span>custom_inflate)(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span>,
                             <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>, <span style="color: #6666ff; font-weight: bold">size_t</span>,
                             <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span>);

  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> custom_context; <span style="color: #666666; font-style: italic">/*optional custom settings for custom functions*/</span>
};

<span style="color: #228899; font-weight: bold">extern</span> <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings lodepng_default_decompress_settings;
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_decompress_settings_init</span>(LodePNGDecompressSettings<span style="color: #333333">*</span> settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Settings for zlib compression. Tweaking these settings tweaks the balance</span>
<span style="color: #666666; font-style: italic">between speed and compression ratio.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGCompressSettings LodePNGCompressSettings;
<span style="color: #228899; font-weight: bold">struct</span> LodePNGCompressSettings <span style="color: #666666; font-style: italic">/*deflate = compress*/</span>
{
  <span style="color: #666666; font-style: italic">/*LZ77 related settings*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> btype; <span style="color: #666666; font-style: italic">/*the block type for LZ (0, 1, 2 or 3, see zlib standard). Should be 2 for proper compression.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> use_lz77; <span style="color: #666666; font-style: italic">/*whether or not to use LZ77. Should be 1 for proper compression.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> windowsize; <span style="color: #666666; font-style: italic">/*must be a power of two &lt;= 32768. higher compresses more but is slower. Default value: 2048.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> minmatch; <span style="color: #666666; font-style: italic">/*mininum lz77 length. 3 is normally best, 6 can be better for some PNGs. Default: 0*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> nicematch; <span style="color: #666666; font-style: italic">/*stop searching if &gt;= this length found. Set to 258 for best compression. Default: 128*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> lazymatching; <span style="color: #666666; font-style: italic">/*use lazy matching: better compression but a bit slower. Default: true*/</span>

  <span style="color: #666666; font-style: italic">/*use custom zlib encoder instead of built in one (default: null)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> (<span style="color: #333333">*</span>custom_zlib)(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span>,
                          <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>, <span style="color: #6666ff; font-weight: bold">size_t</span>,
                          <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span>);
  <span style="color: #666666; font-style: italic">/*use custom deflate encoder instead of built in one (default: null)</span>
<span style="color: #666666; font-style: italic">  if custom_zlib is used, custom_deflate is ignored since only the built in</span>
<span style="color: #666666; font-style: italic">  zlib function will call custom_deflate*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> (<span style="color: #333333">*</span>custom_deflate)(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span>, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span>,
                             <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>, <span style="color: #6666ff; font-weight: bold">size_t</span>,
                             <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span>);

  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">void</span><span style="color: #333333">*</span> custom_context; <span style="color: #666666; font-style: italic">/*optional custom settings for custom functions*/</span>
};

<span style="color: #228899; font-weight: bold">extern</span> <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings lodepng_default_compress_settings;
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_compress_settings_init</span>(LodePNGCompressSettings<span style="color: #333333">*</span> settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Color mode of an image. Contains all information required to decode the pixel</span>
<span style="color: #666666; font-style: italic">bits to RGBA colors. This information is the same as used in the PNG file</span>
<span style="color: #666666; font-style: italic">format, and is used both for PNG and raw image data in LodePNG.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGColorMode
{
  <span style="color: #666666; font-style: italic">/*header (IHDR)*/</span>
  LodePNGColorType colortype; <span style="color: #666666; font-style: italic">/*color type, see PNG standard or documentation further in this header file*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bitdepth;  <span style="color: #666666; font-style: italic">/*bits per sample, see PNG standard or documentation further in this header file*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  palette (PLTE and tRNS)</span>

<span style="color: #666666; font-style: italic">  Dynamically allocated with the colors of the palette, including alpha.</span>
<span style="color: #666666; font-style: italic">  When encoding a PNG, to store your colors in the palette of the LodePNGColorMode, first use</span>
<span style="color: #666666; font-style: italic">  lodepng_palette_clear, then for each color use lodepng_palette_add.</span>
<span style="color: #666666; font-style: italic">  If you encode an image without alpha with palette, don&#39;t forget to put value 255 in each A byte of the palette.</span>

<span style="color: #666666; font-style: italic">  When decoding, by default you can ignore this palette, since LodePNG already</span>
<span style="color: #666666; font-style: italic">  fills the palette colors in the pixels of the raw RGBA output.</span>

<span style="color: #666666; font-style: italic">  The palette is only supported for color type 3.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> palette; <span style="color: #666666; font-style: italic">/*palette in RGBARGBA... order. When allocated, must be either 0, or have size 1024*/</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> palettesize; <span style="color: #666666; font-style: italic">/*palette size in number of colors (amount of bytes is 4 * palettesize)*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  transparent color key (tRNS)</span>

<span style="color: #666666; font-style: italic">  This color uses the same bit depth as the bitdepth value in this struct, which can be 1-bit to 16-bit.</span>
<span style="color: #666666; font-style: italic">  For greyscale PNGs, r, g and b will all 3 be set to the same.</span>

<span style="color: #666666; font-style: italic">  When decoding, by default you can ignore this information, since LodePNG sets</span>
<span style="color: #666666; font-style: italic">  pixels with this key to transparent already in the raw RGBA output.</span>

<span style="color: #666666; font-style: italic">  The color key is only supported for color types 0 and 2.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key_defined; <span style="color: #666666; font-style: italic">/*is a transparent color key given? 0 = false, 1 = true*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key_r;       <span style="color: #666666; font-style: italic">/*red/greyscale component of color key*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key_g;       <span style="color: #666666; font-style: italic">/*green component of color key*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key_b;       <span style="color: #666666; font-style: italic">/*blue component of color key*/</span>
} LodePNGColorMode;

<span style="color: #666666; font-style: italic">/*init, cleanup and copy functions to use with this struct*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_init</span>(LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_cleanup</span>(LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*return value is error code (0 means no error)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_mode_copy</span>(LodePNGColorMode<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> source);

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_palette_clear</span>(LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*add 1 color to the palette*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_palette_add</span>(LodePNGColorMode<span style="color: #333333">*</span> info,
                             <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> r, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> g, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> b, <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> a);

<span style="color: #666666; font-style: italic">/*get the total amount of bits per pixel, based on colortype and bitdepth in the struct*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_bpp</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*get the amount of color channels used, based on colortype in the struct.</span>
<span style="color: #666666; font-style: italic">If a palette is used, it counts as 1 channel.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_channels</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*is it a greyscale type? (only colortype 0 or 4)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_greyscale_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*has it got an alpha channel? (only colortype 2 or 6)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_alpha_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*has it got a palette? (only colortype 3)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_is_palette_type</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*only returns true if there is a palette and there is a value in the palette with alpha &lt; 255.</span>
<span style="color: #666666; font-style: italic">Loops through the palette to check this.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_has_palette_alpha</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Check if the given color info indicates the possibility of having non-opaque pixels in the PNG image.</span>
<span style="color: #666666; font-style: italic">Returns true if the image can have translucent or invisible pixels (it still be opaque if it doesn&#39;t use such pixels).</span>
<span style="color: #666666; font-style: italic">Returns false if the image can only have opaque pixels.</span>
<span style="color: #666666; font-style: italic">In detail, it returns true only if it&#39;s a color type with alpha, or has a palette with non-opaque values,</span>
<span style="color: #666666; font-style: italic">or if &quot;key_defined&quot; is true.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_can_have_alpha</span>(<span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*Returns the byte size of a raw image buffer with given width, height and color mode*/</span>
<span style="color: #6666ff; font-weight: bold">size_t</span> <span style="color: #55eedd; font-weight: bold">lodepng_get_raw_size</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> color);

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #666666; font-style: italic">/*The information of a Time chunk in PNG.*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGTime
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> year;    <span style="color: #666666; font-style: italic">/*2 bytes used (0-65535)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> month;   <span style="color: #666666; font-style: italic">/*1-12*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> day;     <span style="color: #666666; font-style: italic">/*1-31*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> hour;    <span style="color: #666666; font-style: italic">/*0-23*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> minute;  <span style="color: #666666; font-style: italic">/*0-59*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> second;  <span style="color: #666666; font-style: italic">/*0-60 (to allow for leap seconds)*/</span>
} LodePNGTime;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*Information about the PNG image, except pixels, width and height.*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGInfo
{
  <span style="color: #666666; font-style: italic">/*header (IHDR), palette (PLTE) and transparency (tRNS) chunks*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> compression_method;<span style="color: #666666; font-style: italic">/*compression method of the original file. Always 0.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> filter_method;     <span style="color: #666666; font-style: italic">/*filter method of the original file*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> interlace_method;  <span style="color: #666666; font-style: italic">/*interlace method of the original file*/</span>
  LodePNGColorMode color;     <span style="color: #666666; font-style: italic">/*color type and bits, palette and transparency of the PNG file*/</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  suggested background color chunk (bKGD)</span>
<span style="color: #666666; font-style: italic">  This color uses the same color mode as the PNG (except alpha channel), which can be 1-bit to 16-bit.</span>

<span style="color: #666666; font-style: italic">  For greyscale PNGs, r, g and b will all 3 be set to the same. When encoding</span>
<span style="color: #666666; font-style: italic">  the encoder writes the red one. For palette PNGs: When decoding, the RGB value</span>
<span style="color: #666666; font-style: italic">  will be stored, not a palette index. But when encoding, specify the index of</span>
<span style="color: #666666; font-style: italic">  the palette in background_r, the other two are then ignored.</span>

<span style="color: #666666; font-style: italic">  The decoder does not use this background color to edit the color of pixels.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> background_defined; <span style="color: #666666; font-style: italic">/*is a suggested background color given?*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> background_r;       <span style="color: #666666; font-style: italic">/*red component of suggested background color*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> background_g;       <span style="color: #666666; font-style: italic">/*green component of suggested background color*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> background_b;       <span style="color: #666666; font-style: italic">/*blue component of suggested background color*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  non-international text chunks (tEXt and zTXt)</span>

<span style="color: #666666; font-style: italic">  The char** arrays each contain num strings. The actual messages are in</span>
<span style="color: #666666; font-style: italic">  text_strings, while text_keys are keywords that give a short description what</span>
<span style="color: #666666; font-style: italic">  the actual text represents, e.g. Title, Author, Description, or anything else.</span>

<span style="color: #666666; font-style: italic">  A keyword is minimum 1 character and maximum 79 characters long. It&#39;s</span>
<span style="color: #666666; font-style: italic">  discouraged to use a single line length longer than 79 characters for texts.</span>

<span style="color: #666666; font-style: italic">  Don&#39;t allocate these text buffers yourself. Use the init/cleanup functions</span>
<span style="color: #666666; font-style: italic">  correctly and use lodepng_add_text and lodepng_clear_text.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> text_num; <span style="color: #666666; font-style: italic">/*the amount of texts in these char** buffers (there may be more texts in itext)*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> text_keys; <span style="color: #666666; font-style: italic">/*the keyword of a text chunk (e.g. &quot;Comment&quot;)*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> text_strings; <span style="color: #666666; font-style: italic">/*the actual text*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  international text chunks (iTXt)</span>
<span style="color: #666666; font-style: italic">  Similar to the non-international text chunks, but with additional strings</span>
<span style="color: #666666; font-style: italic">  &quot;langtags&quot; and &quot;transkeys&quot;.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">size_t</span> itext_num; <span style="color: #666666; font-style: italic">/*the amount of international texts in this PNG*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> itext_keys; <span style="color: #666666; font-style: italic">/*the English keyword of the text chunk (e.g. &quot;Comment&quot;)*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> itext_langtags; <span style="color: #666666; font-style: italic">/*language tag for this text&#39;s language, ISO/IEC 646 string, e.g. ISO 639 language tag*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> itext_transkeys; <span style="color: #666666; font-style: italic">/*keyword translated to the international language - UTF-8 string*/</span>
  <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> itext_strings; <span style="color: #666666; font-style: italic">/*the actual international text - UTF-8 string*/</span>

  <span style="color: #666666; font-style: italic">/*time chunk (tIME)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> time_defined; <span style="color: #666666; font-style: italic">/*set to 1 to make the encoder generate a tIME chunk*/</span>
  LodePNGTime time;

  <span style="color: #666666; font-style: italic">/*phys chunk (pHYs)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> phys_defined; <span style="color: #666666; font-style: italic">/*if 0, there is no pHYs chunk and the values below are undefined, if 1 else there is one*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> phys_x; <span style="color: #666666; font-style: italic">/*pixels per unit in x direction*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> phys_y; <span style="color: #666666; font-style: italic">/*pixels per unit in y direction*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> phys_unit; <span style="color: #666666; font-style: italic">/*may be 0 (unknown unit) or 1 (metre)*/</span>

  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  unknown chunks</span>
<span style="color: #666666; font-style: italic">  There are 3 buffers, one for each position in the PNG where unknown chunks can appear</span>
<span style="color: #666666; font-style: italic">  each buffer contains all unknown chunks for that position consecutively</span>
<span style="color: #666666; font-style: italic">  The 3 buffers are the unknown chunks between certain critical chunks:</span>
<span style="color: #666666; font-style: italic">  0: IHDR-PLTE, 1: PLTE-IDAT, 2: IDAT-IEND</span>
<span style="color: #666666; font-style: italic">  Do not allocate or traverse this data yourself. Use the chunk traversing functions declared</span>
<span style="color: #666666; font-style: italic">  later, such as lodepng_chunk_next and lodepng_chunk_append, to read/write this struct.</span>
<span style="color: #666666; font-style: italic">  */</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> unknown_chunks_data[<span style="color: #6666ff; font-weight: bold">3</span>];
  <span style="color: #6666ff; font-weight: bold">size_t</span> unknown_chunks_size[<span style="color: #6666ff; font-weight: bold">3</span>]; <span style="color: #666666; font-style: italic">/*size in bytes of the unknown chunks, given for protection*/</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
} LodePNGInfo;

<span style="color: #666666; font-style: italic">/*init, cleanup and copy functions to use with this struct*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_init</span>(LodePNGInfo<span style="color: #333333">*</span> info);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_cleanup</span>(LodePNGInfo<span style="color: #333333">*</span> info);
<span style="color: #666666; font-style: italic">/*return value is error code (0 means no error)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_info_copy</span>(LodePNGInfo<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGInfo<span style="color: #333333">*</span> source);

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_clear_text</span>(LodePNGInfo<span style="color: #333333">*</span> info); <span style="color: #666666; font-style: italic">/*use this to clear the texts again after you filled them in*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_add_text</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> key, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> str); <span style="color: #666666; font-style: italic">/*push back both texts at once*/</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_clear_itext</span>(LodePNGInfo<span style="color: #333333">*</span> info); <span style="color: #666666; font-style: italic">/*use this to clear the itexts again after you filled them in*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_add_itext</span>(LodePNGInfo<span style="color: #333333">*</span> info, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> key, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> langtag,
                           <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> transkey, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> str); <span style="color: #666666; font-style: italic">/*push back the 4 texts of 1 chunk at once*/</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Converts raw buffer from one color type to another color type, based on</span>
<span style="color: #666666; font-style: italic">LodePNGColorMode structs to describe the input and output color type.</span>
<span style="color: #666666; font-style: italic">See the reference manual at the end of this header file to see which color conversions are supported.</span>
<span style="color: #666666; font-style: italic">return value = LodePNG error code (0 if all went ok, an error if the conversion isn&#39;t supported)</span>
<span style="color: #666666; font-style: italic">The out buffer must have size (w * h * bpp + 7) / 8, where bpp is the bits per pixel</span>
<span style="color: #666666; font-style: italic">of the output color type (lodepng_get_bpp).</span>
<span style="color: #666666; font-style: italic">For &lt; 8 bpp images, there should not be padding bits at the end of scanlines.</span>
<span style="color: #666666; font-style: italic">For 16-bit per channel colors, uses big endian format like PNG does.</span>
<span style="color: #666666; font-style: italic">Return value is LodePNG error code</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_convert</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in,
                         LodePNGColorMode<span style="color: #333333">*</span> mode_out, <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode_in,
                         <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h);

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Settings for the decoder. This contains settings for the PNG and the Zlib</span>
<span style="color: #666666; font-style: italic">decoder, but not the Info settings from the Info structs.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGDecoderSettings
{
  LodePNGDecompressSettings zlibsettings; <span style="color: #666666; font-style: italic">/*in here is the setting to ignore Adler32 checksums*/</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> ignore_crc; <span style="color: #666666; font-style: italic">/*ignore CRC checksums*/</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> color_convert; <span style="color: #666666; font-style: italic">/*whether to convert the PNG to the color type you want. Default: yes*/</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> read_text_chunks; <span style="color: #666666; font-style: italic">/*if false but remember_unknown_chunks is true, they&#39;re stored in the unknown chunks*/</span>
  <span style="color: #666666; font-style: italic">/*store all bytes from unknown chunks in the LodePNGInfo (off by default, useful for a png editor)*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> remember_unknown_chunks;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
} LodePNGDecoderSettings;

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_decoder_settings_init</span>(LodePNGDecoderSettings<span style="color: #333333">*</span> settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*automatically use color type with less bits per pixel if losslessly possible. Default: AUTO*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">enum</span> LodePNGFilterStrategy
{
  <span style="color: #666666; font-style: italic">/*every filter at zero*/</span>
  LFS_ZERO,
  <span style="color: #666666; font-style: italic">/*Use filter that gives minumum sum, as described in the official PNG filter heuristic.*/</span>
  LFS_MINSUM,
  <span style="color: #666666; font-style: italic">/*Use the filter type that gives smallest Shannon entropy for this scanline. Depending</span>
<span style="color: #666666; font-style: italic">  on the image, this is better or worse than minsum.*/</span>
  LFS_ENTROPY,
  <span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">  Brute-force-search PNG filters by compressing each filter for each scanline.</span>
<span style="color: #666666; font-style: italic">  Experimental, very slow, and only rarely gives better compression than MINSUM.</span>
<span style="color: #666666; font-style: italic">  */</span>
  LFS_BRUTE_FORCE,
  <span style="color: #666666; font-style: italic">/*use predefined_filters buffer: you specify the filter type for each scanline*/</span>
  LFS_PREDEFINED
} LodePNGFilterStrategy;

<span style="color: #666666; font-style: italic">/*Gives characteristics about the colors of the image, which helps decide which color model to use for encoding.</span>
<span style="color: #666666; font-style: italic">Used internally by default if &quot;auto_convert&quot; is enabled. Public because it&#39;s useful for custom algorithms.*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGColorProfile
{
  <span style="color: #6666ff; font-weight: bold">unsigned</span> colored; <span style="color: #666666; font-style: italic">/*not greyscale*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> key; <span style="color: #666666; font-style: italic">/*if true, image is not opaque. Only if true and alpha is false, color key is possible.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> key_r; <span style="color: #666666; font-style: italic">/*these values are always in 16-bit bitdepth in the profile*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> key_g;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">short</span> key_b;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> alpha; <span style="color: #666666; font-style: italic">/*alpha channel or alpha palette required*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> numcolors; <span style="color: #666666; font-style: italic">/*amount of colors, up to 257. Not valid if bits == 16.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> palette[<span style="color: #6666ff; font-weight: bold">1024</span>]; <span style="color: #666666; font-style: italic">/*Remembers up to the first 256 RGBA colors, in no particular order*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> bits; <span style="color: #666666; font-style: italic">/*bits per channel (not for palette). 1,2 or 4 for greyscale only. 16 if 16-bit per channel required.*/</span>
} LodePNGColorProfile;

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_color_profile_init</span>(LodePNGColorProfile<span style="color: #333333">*</span> profile);

<span style="color: #666666; font-style: italic">/*Get a LodePNGColorProfile of the image.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">get_color_profile</span>(LodePNGColorProfile<span style="color: #333333">*</span> profile,
                           <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                           <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode_in);
<span style="color: #666666; font-style: italic">/*The function LodePNG uses internally to decide the PNG color with auto_convert.</span>
<span style="color: #666666; font-style: italic">Chooses an optimal color model, e.g. grey if only grey pixels, palette if &lt; 256 colors, ...*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_auto_choose_color</span>(LodePNGColorMode<span style="color: #333333">*</span> mode_out,
                                   <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                                   <span style="color: #228899; font-weight: bold">const</span> LodePNGColorMode<span style="color: #333333">*</span> mode_in);

<span style="color: #666666; font-style: italic">/*Settings for the encoder.*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGEncoderSettings
{
  LodePNGCompressSettings zlibsettings; <span style="color: #666666; font-style: italic">/*settings for the zlib encoder, such as window size, ...*/</span>

  <span style="color: #6666ff; font-weight: bold">unsigned</span> auto_convert; <span style="color: #666666; font-style: italic">/*automatically choose output PNG color type. Default: true*/</span>

  <span style="color: #666666; font-style: italic">/*If true, follows the official PNG heuristic: if the PNG uses a palette or lower than</span>
<span style="color: #666666; font-style: italic">  8 bit depth, set all filters to zero. Otherwise use the filter_strategy. Note that to</span>
<span style="color: #666666; font-style: italic">  completely follow the official PNG heuristic, filter_palette_zero must be true and</span>
<span style="color: #666666; font-style: italic">  filter_strategy must be LFS_MINSUM*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> filter_palette_zero;
  <span style="color: #666666; font-style: italic">/*Which filter strategy to use when not using zeroes due to filter_palette_zero.</span>
<span style="color: #666666; font-style: italic">  Set filter_palette_zero to 0 to ensure always using your chosen strategy. Default: LFS_MINSUM*/</span>
  LodePNGFilterStrategy filter_strategy;
  <span style="color: #666666; font-style: italic">/*used if filter_strategy is LFS_PREDEFINED. In that case, this must point to a buffer with</span>
<span style="color: #666666; font-style: italic">  the same length as the amount of scanlines in the image, and each value must &lt;= 5. You</span>
<span style="color: #666666; font-style: italic">  have to cleanup this buffer, LodePNG will never free it. Don&#39;t forget that filter_palette_zero</span>
<span style="color: #666666; font-style: italic">  must be set to 0 to ensure this is also used on palette or low bitdepth images.*/</span>
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> predefined_filters;

  <span style="color: #666666; font-style: italic">/*force creating a PLTE chunk if colortype is 2 or 6 (= a suggested palette).</span>
<span style="color: #666666; font-style: italic">  If colortype is 3, PLTE is _always_ created.*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> force_palette;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ANCILLARY_CHUNKS</span>
  <span style="color: #666666; font-style: italic">/*add LodePNG identifier and version as a text chunk, for debugging*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> add_id;
  <span style="color: #666666; font-style: italic">/*encode text chunks as zTXt chunks instead of tEXt chunks, and use compression in iTXt chunks*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> text_compression;
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ANCILLARY_CHUNKS*/</span><span style="color: #557799"></span>
} LodePNGEncoderSettings;

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_encoder_settings_init</span>(LodePNGEncoderSettings<span style="color: #333333">*</span> settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>


<span style="color: #557799">#if defined(LODEPNG_COMPILE_DECODER) || defined(LODEPNG_COMPILE_ENCODER)</span>
<span style="color: #666666; font-style: italic">/*The settings, state and information for extended encoding and decoding.*/</span>
<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span> LodePNGState
{
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
  LodePNGDecoderSettings decoder; <span style="color: #666666; font-style: italic">/*the decoding settings*/</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
  LodePNGEncoderSettings encoder; <span style="color: #666666; font-style: italic">/*the encoding settings*/</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>
  LodePNGColorMode info_raw; <span style="color: #666666; font-style: italic">/*specifies the format in which you would like to get the raw pixel buffer*/</span>
  LodePNGInfo info_png; <span style="color: #666666; font-style: italic">/*info of the PNG image obtained after decoding*/</span>
  <span style="color: #6666ff; font-weight: bold">unsigned</span> error;
<span style="color: #557799">#ifdef LODEPNG_COMPILE_CPP</span>
  <span style="color: #666666; font-style: italic">//For the lodepng::State subclass.</span>
  virtual <span style="color: #333333">~</span>LodePNGState(){}
<span style="color: #557799">#endif</span>
} LodePNGState;

<span style="color: #666666; font-style: italic">/*init, cleanup and copy functions to use with this struct*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_init</span>(LodePNGState<span style="color: #333333">*</span> state);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_cleanup</span>(LodePNGState<span style="color: #333333">*</span> state);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_state_copy</span>(LodePNGState<span style="color: #333333">*</span> dest, <span style="color: #228899; font-weight: bold">const</span> LodePNGState<span style="color: #333333">*</span> source);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/* defined(LODEPNG_COMPILE_DECODER) || defined(LODEPNG_COMPILE_ENCODER) */</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Same as lodepng_decode_memory, but uses a LodePNGState to allow custom settings and</span>
<span style="color: #666666; font-style: italic">getting much more information about the PNG image and color mode.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_decode</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                        LodePNGState<span style="color: #333333">*</span> state,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Read the PNG header, but not the actual data. This returns only the information</span>
<span style="color: #666666; font-style: italic">that is in the header chunk of the PNG, such as width, height and color type. The</span>
<span style="color: #666666; font-style: italic">information is placed in the info_png field of the LodePNGState.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_inspect</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> h,
                         LodePNGState<span style="color: #333333">*</span> state,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>


<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*This function allocates the out buffer with standard malloc and stores the size in *outsize.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_encode</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                        <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> image, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                        LodePNGState<span style="color: #333333">*</span> state);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">The lodepng_chunk functions are normally not needed, except to traverse the</span>
<span style="color: #666666; font-style: italic">unknown chunks stored in the LodePNGInfo struct, or add new ones to it.</span>
<span style="color: #666666; font-style: italic">It also allows traversing the chunks of an encoded PNG file yourself.</span>

<span style="color: #666666; font-style: italic">PNG standard chunk naming conventions:</span>
<span style="color: #666666; font-style: italic">First byte: uppercase = critical, lowercase = ancillary</span>
<span style="color: #666666; font-style: italic">Second byte: uppercase = public, lowercase = private</span>
<span style="color: #666666; font-style: italic">Third byte: must be uppercase</span>
<span style="color: #666666; font-style: italic">Fourth byte: uppercase = unsafe to copy, lowercase = safe to copy</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #666666; font-style: italic">/*get the length of the data of the chunk. Total chunk length has 12 bytes more.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_length</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*puts the 4-byte type in null terminated string*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_type</span>(<span style="color: #6666ff; font-weight: bold">char</span> type[<span style="color: #6666ff; font-weight: bold">5</span>], <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*check if the type is the given type*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_type_equals</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> type);

<span style="color: #666666; font-style: italic">/*0: it&#39;s one of the critical chunk types, 1: it&#39;s an ancillary chunk (see PNG standard)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_ancillary</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*0: public, 1: private (see PNG standard)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_private</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*0: the chunk is unsafe to copy, 1: the chunk is safe to copy (see PNG standard)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_safetocopy</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*get pointer to the data of the chunk, where the input points to the header of the chunk*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_data</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);
<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_data_const</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*returns 0 if the crc is correct, 1 if it&#39;s incorrect (0 for OK as usual!)*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_check_crc</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*generates the correct CRC from the data and puts it in the last 4 bytes of the chunk*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_generate_crc</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*iterate to next chunks. don&#39;t use on IEND chunk, as there is no next chunk then*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_next</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);
<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_next_const</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Appends chunk to the data in out. The given chunk should already have its chunk header.</span>
<span style="color: #666666; font-style: italic">The out variable and outlength are updated to reflect the new reallocated buffer.</span>
<span style="color: #666666; font-style: italic">Returns error code (0 if it went ok)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_append</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outlength, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> chunk);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Appends new chunk to out. The chunk to append is given by giving its length, type</span>
<span style="color: #666666; font-style: italic">and data separately. The type is a 4-letter string.</span>
<span style="color: #666666; font-style: italic">The out variable and outlength are updated to reflect the new reallocated buffer.</span>
<span style="color: #666666; font-style: italic">Returne error code (0 if it went ok)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_chunk_create</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outlength, <span style="color: #6666ff; font-weight: bold">unsigned</span> length,
                              <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> type, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> data);


<span style="color: #666666; font-style: italic">/*Calculate CRC32 of buffer*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_crc32</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buf, <span style="color: #6666ff; font-weight: bold">size_t</span> len);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_PNG*/</span><span style="color: #557799"></span>


<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">This zlib part can be used independently to zlib compress and decompress a</span>
<span style="color: #666666; font-style: italic">buffer. It cannot be used to create gzip files however, and it only supports the</span>
<span style="color: #666666; font-style: italic">part of zlib that is required for PNG, it does not support dictionaries.</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">/*Inflate a buffer. Inflate is the decompression step of deflate. Out buffer must be freed after use.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_inflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                         <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Decompresses Zlib data. Reallocates the out buffer and appends the data. The</span>
<span style="color: #666666; font-style: italic">data must be according to the zlib specification.</span>
<span style="color: #666666; font-style: italic">Either, *out must be NULL and *outsize must be 0, or, *out must be a valid</span>
<span style="color: #666666; font-style: italic">buffer and *outsize its size in bytes. out must be freed by user after usage.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_zlib_decompress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                                 <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                                 <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">*</span> settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Compresses data with Zlib. Reallocates the out buffer and appends the data.</span>
<span style="color: #666666; font-style: italic">Zlib adds a small header and trailer around the deflate data.</span>
<span style="color: #666666; font-style: italic">The data is output in the format of the zlib specification.</span>
<span style="color: #666666; font-style: italic">Either, *out must be NULL and *outsize must be 0, or, *out must be a valid</span>
<span style="color: #666666; font-style: italic">buffer and *outsize its size in bytes. out must be freed by user after usage.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_zlib_compress</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                               <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                               <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Find length-limited Huffman code for given frequencies. This function is in the</span>
<span style="color: #666666; font-style: italic">public interface only for tests, it&#39;s used internally by lodepng_deflate.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_huffman_code_lengths</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> lengths, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">*</span> frequencies,
                                      <span style="color: #6666ff; font-weight: bold">size_t</span> numcodes, <span style="color: #6666ff; font-weight: bold">unsigned</span> maxbitlen);

<span style="color: #666666; font-style: italic">/*Compress a buffer with deflate. See RFC 1951. Out buffer must be freed after use.*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_deflate</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize,
                         <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                         <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">*</span> settings);

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ZLIB*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Load a file from disk into buffer. The function allocates the out buffer, and</span>
<span style="color: #666666; font-style: italic">after usage you should free it.</span>
<span style="color: #666666; font-style: italic">out: output parameter, contains pointer to loaded buffer.</span>
<span style="color: #666666; font-style: italic">outsize: output parameter, size of the allocated out buffer</span>
<span style="color: #666666; font-style: italic">filename: the path to the file to load</span>
<span style="color: #666666; font-style: italic">return value: error code (0 means ok)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_load_file</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">**</span> out, <span style="color: #6666ff; font-weight: bold">size_t</span><span style="color: #333333">*</span> outsize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Save a file from buffer to disk. Warning, if it exists, this function overwrites</span>
<span style="color: #666666; font-style: italic">the file without warning!</span>
<span style="color: #666666; font-style: italic">buffer: the buffer to write</span>
<span style="color: #666666; font-style: italic">buffersize: size of the buffer to write</span>
<span style="color: #666666; font-style: italic">filename: the path to the file to save to</span>
<span style="color: #666666; font-style: italic">return value: error code (0 means ok)</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">lodepng_save_file</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> buffer, <span style="color: #6666ff; font-weight: bold">size_t</span> buffersize, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> filename);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DISK*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_CPP</span>
<span style="color: #666666; font-style: italic">//The LodePNG C++ wrapper uses std::vectors instead of manually allocated memory buffers.</span>
namespace lodepng
{
<span style="color: #557799">#ifdef LODEPNG_COMPILE_PNG</span>
class State <span style="color: #333333">:</span> public LodePNGState
{
  <span style="color: #997700; font-weight: bold">public:</span>
    State();
    State(<span style="color: #228899; font-weight: bold">const</span> State<span style="color: #333333">&amp;</span> other);
    virtual <span style="color: #333333">~</span>State();
    State<span style="color: #333333">&amp;</span> operator<span style="color: #333333">=</span>(<span style="color: #228899; font-weight: bold">const</span> State<span style="color: #333333">&amp;</span> other);
};

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">//Same as other lodepng::decode, but using a State for more settings and information.</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                State<span style="color: #333333">&amp;</span> state,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize);
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span><span style="color: #333333">&amp;</span> h,
                State<span style="color: #333333">&amp;</span> state,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_DECODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">//Same as other lodepng::encode, but using a State for more settings and information.</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                State<span style="color: #333333">&amp;</span> state);
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">encode</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out,
                <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in, <span style="color: #6666ff; font-weight: bold">unsigned</span> w, <span style="color: #6666ff; font-weight: bold">unsigned</span> h,
                State<span style="color: #333333">&amp;</span> state);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_ENCODER*/</span><span style="color: #557799"></span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_DISK</span>
<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Load a file from disk into an std::vector. If the vector is empty, then either</span>
<span style="color: #666666; font-style: italic">the file doesn&#39;t exist or is an empty file.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">load_file</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> buffer, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename);

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">Save the binary data in an std::vector to a file on disk. The file is overwritten</span>
<span style="color: #666666; font-style: italic">without warning.</span>
<span style="color: #666666; font-style: italic">*/</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">save_file</span>(<span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> buffer, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>string<span style="color: #333333">&amp;</span> filename);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DISK</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_PNG</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ZLIB</span>
<span style="color: #557799">#ifdef LODEPNG_COMPILE_DECODER</span>
<span style="color: #666666; font-style: italic">//Zlib-decompress an unsigned char buffer</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decompress</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                    <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">&amp;</span> settings <span style="color: #333333">=</span> lodepng_default_decompress_settings);

<span style="color: #666666; font-style: italic">//Zlib-decompress an std::vector</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">decompress</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in,
                    <span style="color: #228899; font-weight: bold">const</span> LodePNGDecompressSettings<span style="color: #333333">&amp;</span> settings <span style="color: #333333">=</span> lodepng_default_decompress_settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_DECODER</span>

<span style="color: #557799">#ifdef LODEPNG_COMPILE_ENCODER</span>
<span style="color: #666666; font-style: italic">//Zlib-compress an unsigned char buffer</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">compress</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span> in, <span style="color: #6666ff; font-weight: bold">size_t</span> insize,
                  <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">&amp;</span> settings <span style="color: #333333">=</span> lodepng_default_compress_settings);

<span style="color: #666666; font-style: italic">//Zlib-compress an std::vector</span>
<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #55eedd; font-weight: bold">compress</span>(std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> out, <span style="color: #228899; font-weight: bold">const</span> std<span style="color: #333333">::</span>vector<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">&gt;&amp;</span> in,
                  <span style="color: #228899; font-weight: bold">const</span> LodePNGCompressSettings<span style="color: #333333">&amp;</span> settings <span style="color: #333333">=</span> lodepng_default_compress_settings);
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ENCODER</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">//LODEPNG_COMPILE_ZLIB</span>
} <span style="color: #666666; font-style: italic">//namespace lodepng</span>
<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_COMPILE_CPP*/</span><span style="color: #557799"></span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">TODO:</span>
<span style="color: #666666; font-style: italic">[.] test if there are no memory leaks or security exploits - done a lot but needs to be checked often</span>
<span style="color: #666666; font-style: italic">[.] check compatibility with vareous compilers  - done but needs to be redone for every newer version</span>
<span style="color: #666666; font-style: italic">[X] converting color to 16-bit per channel types</span>
<span style="color: #666666; font-style: italic">[ ] read all public PNG chunk types (but never let the color profile and gamma ones touch RGB values)</span>
<span style="color: #666666; font-style: italic">[ ] make sure encoder generates no chunks with size &gt; (2^31)-1</span>
<span style="color: #666666; font-style: italic">[ ] partial decoding (stream processing)</span>
<span style="color: #666666; font-style: italic">[X] let the &quot;isFullyOpaque&quot; function check color keys and transparent palettes too</span>
<span style="color: #666666; font-style: italic">[X] better name for the variables &quot;codes&quot;, &quot;codesD&quot;, &quot;codelengthcodes&quot;, &quot;clcl&quot; and &quot;lldl&quot;</span>
<span style="color: #666666; font-style: italic">[ ] don&#39;t stop decoding on errors like 69, 57, 58 (make warnings)</span>
<span style="color: #666666; font-style: italic">[ ] make option to choose if the raw image with non multiple of 8 bits per scanline should have padding bits or not</span>
<span style="color: #666666; font-style: italic">[ ] let the C++ wrapper catch exceptions coming from the standard library and return LodePNG error codes</span>
<span style="color: #666666; font-style: italic">*/</span>

<span style="color: #557799">#endif </span><span style="color: #666666; font-style: italic">/*LODEPNG_H inclusion guard*/</span><span style="color: #557799"></span>
</pre></div>
<p></p>                                

                            </section>
                            
        
        
        
        
        
        
                            <!--imageData.c-->
                            <section>
                                <hnew id="imageData.c">imageData.c</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &quot;lodepng.h&quot;</span>
<span style="color: #557799">#include &quot;imageData.h&quot;</span>
<span style="color: #557799">#include &quot;functions.h&quot;</span>

<span style="color: #666666; font-style: italic">//defining all the filters</span>
<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> median_blur[<span style="color: #6666ff; font-weight: bold">25</span>]<span style="color: #333333">=</span>
{
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">13.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>
};

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> motion_blur[<span style="color: #6666ff; font-weight: bold">81</span>]<span style="color: #333333">=</span>
{
  <span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">9.0</span>
};

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> sharpen_less[<span style="color: #6666ff; font-weight: bold">25</span>]<span style="color: #333333">=</span>
{
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">8.0</span>,
};

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> sharpen_more[<span style="color: #6666ff; font-weight: bold">9</span>]<span style="color: #333333">=</span>
{
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">9</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>
};

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> edge_detect[<span style="color: #6666ff; font-weight: bold">9</span>]<span style="color: #333333">=</span>
{
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">8</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>
};

<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> emboss[<span style="color: #6666ff; font-weight: bold">9</span>]<span style="color: #333333">=</span>
{
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">2</span>,<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">0</span>,
  <span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">1</span>,
  <span style="color: #6666ff; font-weight: bold">0</span>,<span style="color: #6666ff; font-weight: bold">1</span>,<span style="color: #6666ff; font-weight: bold">2</span>,
};

<span style="color: #666666; font-style: italic">//Function print_pixel prints the value of a specified pixel for you</span>
<span style="color: #666666; font-style: italic">//Can be used to print to the command line for debugging purposes</span>
<span style="color: #666666; font-style: italic">//Specified row and col must be valid (between 0 and height-1, 0 and width-1). </span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">print_pixel</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height, <span style="color: #6666ff; font-weight: bold">int</span> col, <span style="color: #6666ff; font-weight: bold">int</span> row){
	<span style="color: #228899; font-weight: bold">if</span>(row<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> row<span style="color: #333333">&gt;</span>(height<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">||</span> col<span style="color: #333333">&lt;</span><span style="color: #6666ff; font-weight: bold">0</span> <span style="color: #333333">||</span> col<span style="color: #333333">&gt;</span>(width<span style="color: #333333">-</span><span style="color: #6666ff; font-weight: bold">1</span>)){
		printf(<span style="background-color: #e0e0ff">&quot;Invalid Pixel Col:%d Row:%d</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,col,row);
	}<span style="color: #228899; font-weight: bold">else</span>{
		<span style="color: #6666ff; font-weight: bold">int</span> index <span style="color: #333333">=</span> row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col;	
		printf(<span style="background-color: #e0e0ff">&quot;Pixel Values of Col:%d Row:%d</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,col,row);
		printf(<span style="background-color: #e0e0ff">&quot;Red:%d Blue:%d Green:%d Alpha:%d</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,in_red[index],in_blue[index],in_green[index],in_alpha[index]);
	}	
}

<span style="color: #666666; font-style: italic">//function for encoding a PNG</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">encode</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>filename,Image <span style="color: #333333">*</span>encode_image)
{
  <span style="color: #6666ff; font-weight: bold">int</span> width<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>width;
  <span style="color: #6666ff; font-weight: bold">int</span> height<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>height;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>image<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span>)<span style="color: #333333">*</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>height<span style="color: #333333">*</span>width);
  
  <span style="color: #6666ff; font-weight: bold">int</span> row,col;
  <span style="color: #6666ff; font-weight: bold">int</span> image_width<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>width;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>red_channel<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>red_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>green_channel<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>green_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>blue_channel<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>blue_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>alpha_channel<span style="color: #333333">=</span>encode_image<span style="color: #333333">-&gt;</span>alpha_channel;

  <span style="color: #228899; font-weight: bold">for</span>(row<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">0</span>;row<span style="color: #333333">&lt;</span>height;row<span style="color: #333333">++</span>)
    <span style="color: #228899; font-weight: bold">for</span>(col<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">0</span>;col<span style="color: #333333">&lt;</span>width;col<span style="color: #333333">++</span>)
    {
      image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">0</span>]<span style="color: #333333">=</span>red_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col];
      image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">1</span>]<span style="color: #333333">=</span>green_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col];
      image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">2</span>]<span style="color: #333333">=</span>blue_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col];
      image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">3</span>]<span style="color: #333333">=</span>alpha_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col];
    }

  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">int</span> error<span style="color: #333333">=</span>lodepng_encode32_file(filename,image,width,height);
  <span style="color: #228899; font-weight: bold">if</span>(error)
    printf(<span style="background-color: #e0e0ff">&quot;error %u:%s</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,error,lodepng_error_text(error));

  free(image);
}

<span style="color: #666666; font-style: italic">//function for decoding a PNG</span>
Image <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">decode</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>filename)
{
  Image <span style="color: #333333">*</span>input_image<span style="color: #333333">=</span>(Image<span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(Image));
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">int</span> error;
  <span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>image;

  <span style="color: #666666; font-style: italic">//FIX: fix this part here</span>
  error<span style="color: #333333">=</span>lodepng_decode32_file(<span style="color: #333333">&amp;</span>image,(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span>)<span style="color: #333333">&amp;</span>(input_image<span style="color: #333333">-&gt;</span>width),(<span style="color: #6666ff; font-weight: bold">unsigned</span> <span style="color: #6666ff; font-weight: bold">int</span><span style="color: #333333">*</span>)<span style="color: #333333">&amp;</span>(input_image<span style="color: #333333">-&gt;</span>height),filename);
  <span style="color: #228899; font-weight: bold">if</span>(error)
    printf(<span style="background-color: #e0e0ff">&quot;error %u: %s</span><span style="color: #666666; font-weight: bold; background-color: #e0e0ff">\n</span><span style="background-color: #e0e0ff">&quot;</span>,error,lodepng_error_text(error));

  <span style="color: #6666ff; font-weight: bold">int</span> width<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>width;
  <span style="color: #6666ff; font-weight: bold">int</span> height<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>height;
  input_image<span style="color: #333333">-&gt;</span>red_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  input_image<span style="color: #333333">-&gt;</span>green_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  input_image<span style="color: #333333">-&gt;</span>blue_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  input_image<span style="color: #333333">-&gt;</span>alpha_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);

  <span style="color: #6666ff; font-weight: bold">int</span> row,col;
  <span style="color: #6666ff; font-weight: bold">int</span> image_width<span style="color: #333333">=</span>width<span style="color: #333333">*</span><span style="color: #6666ff; font-weight: bold">4</span>;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>red_channel<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>red_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>green_channel<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>green_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>blue_channel<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>blue_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>alpha_channel<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>alpha_channel;

  <span style="color: #228899; font-weight: bold">for</span>(row<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">0</span>;row<span style="color: #333333">&lt;</span>height;row<span style="color: #333333">++</span>)
  {
    <span style="color: #228899; font-weight: bold">for</span>(col<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">0</span>;col<span style="color: #333333">&lt;</span>width;col<span style="color: #333333">++</span>)
    {
      red_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col]<span style="color: #333333">=</span>image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">0</span>];
      green_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col]<span style="color: #333333">=</span>image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">1</span>];
      blue_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col]<span style="color: #333333">=</span>image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">2</span>];
      alpha_channel[row<span style="color: #333333">*</span>width<span style="color: #333333">+</span>col]<span style="color: #333333">=</span>image[image_width<span style="color: #333333">*</span>row<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">4</span><span style="color: #333333">*</span>col<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">3</span>];
    }
  }

  free(image);
  <span style="color: #228899; font-weight: bold">return</span> input_image;
}

Image <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">generate_output</span>(Image <span style="color: #333333">*</span>input_image)
{
  Image <span style="color: #333333">*</span>output_image<span style="color: #333333">=</span>(Image<span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(Image));
  <span style="color: #6666ff; font-weight: bold">int</span> width<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>width;
  <span style="color: #6666ff; font-weight: bold">int</span> height<span style="color: #333333">=</span>input_image<span style="color: #333333">-&gt;</span>height;
  output_image<span style="color: #333333">-&gt;</span>width<span style="color: #333333">=</span>width;
  output_image<span style="color: #333333">-&gt;</span>height<span style="color: #333333">=</span>height;
  output_image<span style="color: #333333">-&gt;</span>red_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  output_image<span style="color: #333333">-&gt;</span>green_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  output_image<span style="color: #333333">-&gt;</span>blue_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  output_image<span style="color: #333333">-&gt;</span>alpha_channel<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span>)<span style="color: #333333">*</span>width<span style="color: #333333">*</span>height);
  <span style="color: #228899; font-weight: bold">return</span> output_image;
}

Filter <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">initialize_filters</span>(<span style="color: #6666ff; font-weight: bold">int</span> radius)
{
  <span style="color: #6666ff; font-weight: bold">int</span> filter_size<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">*</span>radius<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">1</span>)<span style="color: #333333">*</span>(<span style="color: #6666ff; font-weight: bold">2</span><span style="color: #333333">*</span>radius<span style="color: #333333">+</span><span style="color: #6666ff; font-weight: bold">1</span>);
  <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>cos_blur<span style="color: #333333">=</span>(<span style="color: #6666ff; font-weight: bold">double</span><span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(<span style="color: #6666ff; font-weight: bold">double</span>)<span style="color: #333333">*</span>filter_size);
  calculate_cosine_filter(cos_blur,radius);

  Filter <span style="color: #333333">*</span>filters<span style="color: #333333">=</span>(Filter<span style="color: #333333">*</span>)malloc(<span style="color: #228899; font-weight: bold">sizeof</span>(Filter)<span style="color: #333333">*</span>NUM_FILTERS);

  filters[<span style="color: #6666ff; font-weight: bold">0</span>].radius<span style="color: #333333">=</span>radius;
  filters[<span style="color: #6666ff; font-weight: bold">0</span>].filter<span style="color: #333333">=</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span><span style="color: #333333">*</span>)cos_blur;

  filters[<span style="color: #6666ff; font-weight: bold">1</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">2</span>;
  filters[<span style="color: #6666ff; font-weight: bold">1</span>].filter<span style="color: #333333">=</span>median_blur;

  filters[<span style="color: #6666ff; font-weight: bold">2</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">4</span>;
  filters[<span style="color: #6666ff; font-weight: bold">2</span>].filter<span style="color: #333333">=</span>motion_blur;

  filters[<span style="color: #6666ff; font-weight: bold">3</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">2</span>;
  filters[<span style="color: #6666ff; font-weight: bold">3</span>].filter<span style="color: #333333">=</span>sharpen_less;

  filters[<span style="color: #6666ff; font-weight: bold">4</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">1</span>;
  filters[<span style="color: #6666ff; font-weight: bold">4</span>].filter<span style="color: #333333">=</span>sharpen_more;

  filters[<span style="color: #6666ff; font-weight: bold">5</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">1</span>;
  filters[<span style="color: #6666ff; font-weight: bold">5</span>].filter<span style="color: #333333">=</span>edge_detect;

  filters[<span style="color: #6666ff; font-weight: bold">6</span>].radius<span style="color: #333333">=</span><span style="color: #6666ff; font-weight: bold">1</span>;
  filters[<span style="color: #6666ff; font-weight: bold">6</span>].filter<span style="color: #333333">=</span>emboss;

  <span style="color: #228899; font-weight: bold">return</span> filters;
}
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">free_image</span>(Image <span style="color: #333333">*</span>input_image)
{
  free(input_image<span style="color: #333333">-&gt;</span>red_channel);
  free(input_image<span style="color: #333333">-&gt;</span>green_channel);
  free(input_image<span style="color: #333333">-&gt;</span>blue_channel);
  free(input_image<span style="color: #333333">-&gt;</span>alpha_channel);
  free(input_image);
}
</pre></div>
<p></p>
                            </section>
                            
        
        
        
        
        
                            <!--imageData.h-->
                            <section>
                                <hnew id="imageData.h">imageData.h</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &lt;stdint.h&gt;</span>
<span style="color: #557799">#include &lt;stdlib.h&gt;</span>
<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#include &quot;lodepng.h&quot;</span>

<span style="color: #557799">#define NUM_FILTERS 8</span>

<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span>
{
  <span style="color: #6666ff; font-weight: bold">int</span> radius;
  <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>filter;
} Filter;

<span style="color: #228899; font-weight: bold">typedef</span> <span style="color: #228899; font-weight: bold">struct</span>
{
  <span style="color: #6666ff; font-weight: bold">int</span> width;
  <span style="color: #6666ff; font-weight: bold">int</span> height;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>red_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>blue_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>green_channel;
  <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>alpha_channel;
} Image;

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">print_pixel</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_Blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height, <span style="color: #6666ff; font-weight: bold">int</span> row, <span style="color: #6666ff; font-weight: bold">int</span> col);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">encode</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>filename,Image <span style="color: #333333">*</span>encode_image);
Image <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">decode</span>(<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">char</span> <span style="color: #333333">*</span>filename);
Filter <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">initialize_filters</span>(<span style="color: #6666ff; font-weight: bold">int</span> radius);
Image <span style="color: #333333">*</span><span style="color: #55eedd; font-weight: bold">generate_output</span>(Image <span style="color: #333333">*</span>input_image);
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">free_image</span>(Image <span style="color: #333333">*</span>input_image);
</pre></div>
<p></p>
                            </section>
                            
        
        
        
        
        
        
        
                            <!--functions.c-->
                            <section>
                                <hnew id="functions.c">functions.c</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &quot;imageData.h&quot;</span>
<span style="color: #557799">#include &quot;functions.h&quot;</span>

<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic"> * AUTHOR:       Lisa Gentil</span>
<span style="color: #666666; font-style: italic"> * NETID:        gentil2</span>
<span style="color: #666666; font-style: italic"> * LECTURE:      BL2</span>
<span style="color: #666666; font-style: italic"> * DISCUSSION:   BD4</span>
<span style="color: #666666; font-style: italic"> * MP/LAB:       MP6: For this machine problem, we had to implement several functions.</span>
<span style="color: #666666; font-style: italic"> * 			The first one is calculate_cosine_filter which calculates the </span>
<span style="color: #666666; font-style: italic"> * 			cosine filter values needed to use the filters. The second one</span>
<span style="color: #666666; font-style: italic"> * 			is the convolve_image function (the most important and challenging)</span>
<span style="color: #666666; font-style: italic"> * 			what this function does is that it blurs a picture more or less </span>
<span style="color: #666666; font-style: italic"> * 			depending on the value of the radius input by the user. The third </span>
<span style="color: #666666; font-style: italic"> * 			function, convert_to_gray, takes a colored picture as input and </span>
<span style="color: #666666; font-style: italic"> * 			outputs the black and white (grayscale) version of it. The </span>
<span style="color: #666666; font-style: italic"> * 			flip_vertical function, the fourth one, turns the input picture</span>
<span style="color: #666666; font-style: italic"> * 			upside down, switching each row i with the row (height-1)-i, so</span>
<span style="color: #666666; font-style: italic"> * 			the first row is switched with the last one, etc. Finally the </span>
<span style="color: #666666; font-style: italic"> * 			fifth function, color_threshold, takes the input picture and </span>
<span style="color: #666666; font-style: italic"> * 			outputs the pixels whose RGB components exceeded a set threshold,</span>
<span style="color: #666666; font-style: italic"> * 			in other words it outputs the pixels whose color is brighter than</span>
<span style="color: #666666; font-style: italic"> * 			the threshold and sets the other pixels to black.  </span>
<span style="color: #666666; font-style: italic"> * TERM:         Spring 2016</span>
<span style="color: #666666; font-style: italic"> * PARTNERS:     N/A</span>
<span style="color: #666666; font-style: italic"> */</span>



<span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic"> * calculate_cosine_filter - calculates the cosine filter values</span>
<span style="color: #666666; font-style: italic"> * INTPUTS:  int radius- integer indicating the size of array. </span>
<span style="color: #666666; font-style: italic"> *           The filter has 2*radius+1 rows and 2*radius+1 columns</span>
<span style="color: #666666; font-style: italic"> * OUTPUTS:  cosine_fitler - pointer to the 1-D array of size </span>
<span style="color: #666666; font-style: italic"> *           (2*radius+1)*(2*radius+1). Appropriate space has already been</span>
<span style="color: #666666; font-style: italic"> *           allocated. This function must compute</span>
<span style="color: #666666; font-style: italic"> *           the appropriate values of this array as described in the wiki</span>
<span style="color: #666666; font-style: italic"> * RETURN VALUE: none</span>
<span style="color: #666666; font-style: italic"> */</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">calculate_cosine_filter</span>(<span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>cos_filter,<span style="color: #6666ff; font-weight: bold">int</span> radius)
{
	<span style="color: #666666; font-style: italic">//declaring variables</span>
	<span style="color: #6666ff; font-weight: bold">double</span> weight <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
	<span style="color: #6666ff; font-weight: bold">int</span> neg_r <span style="color: #333333">=</span> <span style="color: #333333">-</span>radius;
	<span style="color: #6666ff; font-weight: bold">int</span> pos_r <span style="color: #333333">=</span> radius;
	<span style="color: #6666ff; font-weight: bold">int</span> x, y, z;
	
	<span style="color: #666666; font-style: italic">//initializing variables</span>
	z <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

	<span style="color: #228899; font-weight: bold">for</span> (y <span style="color: #333333">=</span> neg_r; y <span style="color: #333333">&lt;=</span> pos_r; y<span style="color: #333333">++</span>)
	{
		<span style="color: #228899; font-weight: bold">for</span> (x <span style="color: #333333">=</span> neg_r; x <span style="color: #333333">&lt;=</span> pos_r; x<span style="color: #333333">++</span>)
		{
			cos_filter[z] <span style="color: #333333">=</span> cos((M_PI <span style="color: #333333">*</span> x) <span style="color: #333333">/</span> (<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> radius)) <span style="color: #333333">+</span> cos((M_PI <span style="color: #333333">*</span> y) <span style="color: #333333">/</span> (<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> radius));
			z<span style="color: #333333">++</span>;
		}<span style="color: #666666; font-style: italic">//end for x</span>
	}<span style="color: #666666; font-style: italic">//end for y</span>
		
	<span style="color: #6666ff; font-weight: bold">int</span> z_last <span style="color: #333333">=</span> z;

	<span style="color: #666666; font-style: italic">//calculate weight of the array</span>
	<span style="color: #228899; font-weight: bold">for</span> (z <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; z <span style="color: #333333">&lt;=</span> z_last; z<span style="color: #333333">++</span> )
	{
		weight <span style="color: #333333">=</span> weight <span style="color: #333333">+</span> cos_filter[z];
	}<span style="color: #666666; font-style: italic">//end for weight </span>

	<span style="color: #6666ff; font-weight: bold">double</span> weight_tot <span style="color: #333333">=</span> weight;
	
	<span style="color: #666666; font-style: italic">//normalizing the filter</span>
	<span style="color: #228899; font-weight: bold">for</span> (z <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; z <span style="color: #333333">&lt;=</span> z_last; z<span style="color: #333333">++</span>)
	{
		cos_filter[z] <span style="color: #333333">=</span> cos_filter[z] <span style="color: #333333">/</span> weight_tot;
	}<span style="color: #666666; font-style: italic">//end for normalize	</span>
}<span style="color: #666666; font-style: italic">//end calculate_cosine_filter</span>

<span style="color: #666666; font-style: italic">/* convolve_image - performs a convolution between a filter and image</span>
<span style="color: #666666; font-style: italic"> * INPUTS: in_red - pointer to the input red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_green - pointer to the input green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_blue - pointer to the input blue channel (1-D array) </span>
<span style="color: #666666; font-style: italic"> *         in_alpha - pointer to the input alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         filter - pointer to the convolution filter (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         radius - radius of the convolution filter</span>
<span style="color: #666666; font-style: italic"> *         width - width of the input image</span>
<span style="color: #666666; font-style: italic"> *         height - height of the input image</span>
<span style="color: #666666; font-style: italic"> * OUTPUTS: out_red - pointer to the output red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_green - pointer to the output green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_blue - pointer to the output blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_alpha - pointer to the output alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> * RETURN VALUES: none</span>
<span style="color: #666666; font-style: italic"> * NOTE: Input image values are already loaded into the input arrays</span>
<span style="color: #666666; font-style: italic"> *       Don&#39;t alter the values of the input image.</span>
<span style="color: #666666; font-style: italic"> *       Filter is already initialized and contains desired values.</span>
<span style="color: #666666; font-style: italic"> *       Appropriate space has been allocated for output arrays. </span>
<span style="color: #666666; font-style: italic"> */</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">convolve_image</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha, <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>filter,
                   <span style="color: #6666ff; font-weight: bold">int</span> radius,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height)
{
	<span style="color: #666666; font-style: italic">//declaring variables</span>
	<span style="color: #6666ff; font-weight: bold">int</span> x, y, i, j, index;
	<span style="color: #6666ff; font-weight: bold">int</span> neg_r <span style="color: #333333">=</span> <span style="color: #333333">-</span>radius;
	<span style="color: #6666ff; font-weight: bold">int</span> pos_r <span style="color: #333333">=</span> radius;
	<span style="color: #6666ff; font-weight: bold">int</span> ii, jj, filter_index, image_index;

	<span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> width; x<span style="color: #333333">++</span>)
	{
		<span style="color: #228899; font-weight: bold">for</span> (y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> height; y<span style="color: #333333">++</span>)
		{
			<span style="color: #666666; font-style: italic">//out_alpha[index] = in_alpha[index];</span>
			index <span style="color: #333333">=</span> y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> x;

			<span style="color: #228899; font-weight: bold">if</span>(radius <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">1</span>)
			{
				out_red[index] <span style="color: #333333">=</span> in_red[index];
				out_green[index] <span style="color: #333333">=</span> in_green[index];
				out_blue[index] <span style="color: #333333">=</span> in_blue[index];
			}<span style="color: #666666; font-style: italic">//end if</span>
		
			<span style="color: #228899; font-weight: bold">else</span>
			{
				<span style="color: #666666; font-style: italic">//declaring and initializing variables </span>
				<span style="color: #6666ff; font-weight: bold">double</span> red_convolution <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
				<span style="color: #6666ff; font-weight: bold">double</span> green_convolution <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
				<span style="color: #6666ff; font-weight: bold">double</span> blue_convolution <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;

				<span style="color: #228899; font-weight: bold">for</span>(i <span style="color: #333333">=</span> neg_r; i <span style="color: #333333">&lt;=</span> pos_r; i<span style="color: #333333">++</span>)
				{
					<span style="color: #228899; font-weight: bold">for</span>(j <span style="color: #333333">=</span> neg_r; j <span style="color: #333333">&lt;=</span> pos_r; j<span style="color: #333333">++</span>)
					{
						<span style="color: #6666ff; font-weight: bold">int</span> current_x <span style="color: #333333">=</span> x <span style="color: #333333">+</span> i;
						<span style="color: #6666ff; font-weight: bold">int</span> current_y <span style="color: #333333">=</span> y <span style="color: #333333">+</span> j;

						<span style="color: #228899; font-weight: bold">if</span>((current_x <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #333333">&amp;&amp;</span> (current_x <span style="color: #333333">&lt;</span> width) <span style="color: #333333">&amp;&amp;</span> (current_y <span style="color: #333333">&gt;=</span> <span style="color: #6666ff; font-weight: bold">0</span>) <span style="color: #333333">&amp;&amp;</span> (current_y <span style="color: #333333">&lt;</span> height))
						{
							<span style="color: #666666; font-style: italic">//initializing variables</span>
				                	ii <span style="color: #333333">=</span> i <span style="color: #333333">+</span> radius;
                                        		jj <span style="color: #333333">=</span> j <span style="color: #333333">+</span> radius;
                                        		filter_index <span style="color: #333333">=</span> jj <span style="color: #333333">*</span> (<span style="color: #6666ff; font-weight: bold">2</span> <span style="color: #333333">*</span> radius <span style="color: #333333">+</span> <span style="color: #6666ff; font-weight: bold">1</span>) <span style="color: #333333">+</span> ii;
                                        		image_index <span style="color: #333333">=</span> current_y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> current_x;

							<span style="color: #666666; font-style: italic">//computing temporary output RGB values</span>
							red_convolution <span style="color: #333333">=</span> red_convolution <span style="color: #333333">+</span> (filter[filter_index] <span style="color: #333333">*</span> in_red[image_index]);
							green_convolution <span style="color: #333333">=</span> green_convolution <span style="color: #333333">+</span> (filter[filter_index] <span style="color: #333333">*</span> in_green[image_index]);
							blue_convolution <span style="color: #333333">=</span> blue_convolution <span style="color: #333333">+</span> (filter[filter_index] <span style="color: #333333">*</span> in_blue[image_index]); 	
						}<span style="color: #666666; font-style: italic">//end if current x y values</span>
                                                     
					}<span style="color: #666666; font-style: italic">//end for j</span>
				}<span style="color: #666666; font-style: italic">//end for i</span>
				
				<span style="color: #666666; font-style: italic">//assigning output RGB values according to conditions:</span>
				<span style="color: #666666; font-style: italic">//if value &lt; 0, value set to 0,</span>
				<span style="color: #666666; font-style: italic">//if value &gt; 255, value set to 255,</span>
				<span style="color: #666666; font-style: italic">//if 0 &gt; value &gt; 255, value set to value.</span>
                                <span style="color: #228899; font-weight: bold">if</span> (red_convolution <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
                                	out_red[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
                              	<span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span> (red_convolution <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">255</span>)
                                	out_red[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
				<span style="color: #228899; font-weight: bold">else</span>
					out_red[index] <span style="color: #333333">=</span> red_convolution;

                              	<span style="color: #228899; font-weight: bold">if</span> (green_convolution <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
                                  	out_green[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
                             	<span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span> (green_convolution <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">255</span>)
                                	out_green[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
				<span style="color: #228899; font-weight: bold">else</span>
					out_green[index] <span style="color: #333333">=</span> green_convolution;

                                <span style="color: #228899; font-weight: bold">if</span> (blue_convolution <span style="color: #333333">&lt;</span> <span style="color: #6666ff; font-weight: bold">0</span>)
                                     	out_blue[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
            			<span style="color: #228899; font-weight: bold">else</span> <span style="color: #228899; font-weight: bold">if</span> (blue_convolution <span style="color: #333333">&gt;</span> <span style="color: #6666ff; font-weight: bold">255</span>)
                                    	out_blue[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
				<span style="color: #228899; font-weight: bold">else</span>
					out_blue[index] <span style="color: #333333">=</span> blue_convolution;
			}<span style="color: #666666; font-style: italic">//end else</span>

                	out_alpha[index] <span style="color: #333333">=</span> in_alpha[index];
		}<span style="color: #666666; font-style: italic">//end for y</span>
	}<span style="color: #666666; font-style: italic">//end outer for x</span>
}<span style="color: #666666; font-style: italic">//end convolve_image</span>

<span style="color: #666666; font-style: italic">/* convert_to_gray - convert the input image to grayscale</span>
<span style="color: #666666; font-style: italic"> * INPUTS: in_red - pointer to the input red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_green - pointer to the input green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_blue - pointer to the input blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_alpha - pointer to the input alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         gmonomult - pointer to array with constants to be multipiled with </span>
<span style="color: #666666; font-style: italic"> *                     RBG channels to convert image to grayscale (3 element array)</span>
<span style="color: #666666; font-style: italic"> *         width - width of the input image</span>
<span style="color: #666666; font-style: italic"> *         height - height of the input image</span>
<span style="color: #666666; font-style: italic"> * OUTPUTS: out_red - pointer to the output red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_green - pointer to the output green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_blue - pointer to the output blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_alpha - pointer to the output alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> * RETURN VALUES: none</span>
<span style="color: #666666; font-style: italic"> * NOTE: Input image values are already loaded into the input arrays</span>
<span style="color: #666666; font-style: italic"> *       gmonomult contains the desired grayscale weights.</span>
<span style="color: #666666; font-style: italic"> *       Appropriate space has been allocated for output arrays. </span>
<span style="color: #666666; font-style: italic"> *       Don&#39;t alter the values of the input image.</span>
<span style="color: #666666; font-style: italic"> */</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">convert_to_gray</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,
                   <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>gmonomult,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height)
{
	<span style="color: #666666; font-style: italic">//declaring and initializing variables</span>
    	<span style="color: #6666ff; font-weight: bold">double</span> grayscale_num <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
	<span style="color: #6666ff; font-weight: bold">int</span> index;
	<span style="color: #6666ff; font-weight: bold">int</span> array_length <span style="color: #333333">=</span> width <span style="color: #333333">*</span> height;
	<span style="color: #6666ff; font-weight: bold">double</span> red, green, blue;

	<span style="color: #666666; font-style: italic">//computing grayscale numbers for each pixel</span>
	<span style="color: #228899; font-weight: bold">for</span> (index <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; index <span style="color: #333333">&lt;</span> array_length; index<span style="color: #333333">++</span>)
	{
		<span style="color: #666666; font-style: italic">//computing value of RGB input channels to corresponding gmonomult weights</span>
		red <span style="color: #333333">=</span> in_red[index] <span style="color: #333333">*</span> gmonomult[<span style="color: #6666ff; font-weight: bold">0</span>];
		green <span style="color: #333333">=</span> in_green[index] <span style="color: #333333">*</span> gmonomult[<span style="color: #6666ff; font-weight: bold">1</span>];
		blue <span style="color: #333333">=</span> in_blue[index] <span style="color: #333333">*</span> gmonomult[<span style="color: #6666ff; font-weight: bold">2</span>];
		
		<span style="color: #666666; font-style: italic">//computing grayscale number</span>
		grayscale_num <span style="color: #333333">=</span> red <span style="color: #333333">+</span> green <span style="color: #333333">+</span> blue;
		
		<span style="color: #666666; font-style: italic">//assigning value to RGB output channels</span>
		out_red[index] <span style="color: #333333">=</span> grayscale_num;
		out_green[index] <span style="color: #333333">=</span> grayscale_num;
		out_blue[index] <span style="color: #333333">=</span> grayscale_num;

		<span style="color: #666666; font-style: italic">//passing on value from alpha input to alpha output</span>
		out_alpha[index] <span style="color: #333333">=</span> in_alpha[index];		
	}<span style="color: #666666; font-style: italic">//end for loop</span>
}<span style="color: #666666; font-style: italic">//end convert_to_gray</span>

<span style="color: #666666; font-style: italic">/* flip_vertical- flips image vertically such that the bottom row of pixels</span>
<span style="color: #666666; font-style: italic"> *                in the input image is the top row of pixels in the output </span>
<span style="color: #666666; font-style: italic"> *                image, the second most bottom row in the input image is the </span>
<span style="color: #666666; font-style: italic"> *                second row from the top of the input image, and so on. This should</span>
<span style="color: #666666; font-style: italic"> *                flip the image upside-down.</span>
<span style="color: #666666; font-style: italic"> * INPUTS: in_red - pointer to the input red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_green - pointer to the input green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_blue - pointer to the input blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_alpha - pointer to the input alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         width - width of the input image</span>
<span style="color: #666666; font-style: italic"> *         height - height of the input image</span>
<span style="color: #666666; font-style: italic"> * OUTPUTS: out_red - pointer to the output red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_green - pointer to the output green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_blue - pointer to the output blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_alpha - pointer to the output alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> * RETURN VALUES: none</span>
<span style="color: #666666; font-style: italic"> * NOTE: Input image values are already loaded into the input arrays</span>
<span style="color: #666666; font-style: italic"> *       Appropriate space has been allocated for output arrays. </span>
<span style="color: #666666; font-style: italic"> *       Don&#39;t alter the values of the input image.</span>
<span style="color: #666666; font-style: italic"> */</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">flip_vertical</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height)
{
	<span style="color: #666666; font-style: italic">//declaring and initializing variables</span>
	<span style="color: #6666ff; font-weight: bold">int</span> x, y;
	<span style="color: #666666; font-style: italic">//x corresponds to the column number</span>
	<span style="color: #666666; font-style: italic">//y corresponds to the row number</span>

	<span style="color: #228899; font-weight: bold">for</span> (y <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; y <span style="color: #333333">&lt;</span> height; y<span style="color: #333333">++</span>)
	{
		<span style="color: #228899; font-weight: bold">for</span>(x <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; x <span style="color: #333333">&lt;</span> width; x<span style="color: #333333">++</span>)
		{
			<span style="color: #666666; font-style: italic">//computing RGB output values column by column and row by row</span>
			out_red[y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> in_red[(height <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">-</span> y) <span style="color: #333333">*</span> width <span style="color: #333333">+</span>x];
                        out_green[y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> in_green[(height <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">-</span> y) <span style="color: #333333">*</span> width <span style="color: #333333">+</span>x];
                        out_blue[y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> in_blue[(height <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">-</span> y) <span style="color: #333333">*</span> width <span style="color: #333333">+</span>x];
                        out_alpha[y <span style="color: #333333">*</span> width <span style="color: #333333">+</span> x] <span style="color: #333333">=</span> in_alpha[(height <span style="color: #333333">-</span> <span style="color: #6666ff; font-weight: bold">1</span> <span style="color: #333333">-</span> y) <span style="color: #333333">*</span> width <span style="color: #333333">+</span>x];
		}<span style="color: #666666; font-style: italic">//end for x</span>
	}<span style="color: #666666; font-style: italic">//end for y</span>
}<span style="color: #666666; font-style: italic">//end flip_vertical</span>

<span style="color: #666666; font-style: italic">/* color_threshold - for each pixel of input image, compares value to red, green, and blue threshold.</span>
<span style="color: #666666; font-style: italic">                     If the values exceed all three thresholds, set the output image to the input image values. </span>
<span style="color: #666666; font-style: italic">                     Otherwise, set them to zero. Alpha should remain unchanged.</span>
<span style="color: #666666; font-style: italic"> * INPUTS: in_red - pointer to the input red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_green - pointer to the input green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_blue - pointer to the input blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         in_alpha - pointer to the input alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *         width - width of the input image</span>
<span style="color: #666666; font-style: italic"> *         height - height of the input image</span>
<span style="color: #666666; font-style: italic"> * OUTPUTS: out_red - pointer to the output red channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_green - pointer to the output green channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_blue - pointer to the output blue channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> *          out_alpha - pointer to the output alpha channel (1-D array)</span>
<span style="color: #666666; font-style: italic"> * RETURN VALUES: none</span>
<span style="color: #666666; font-style: italic"> * NOTE: Input image values are already loaded into the input arrays</span>
<span style="color: #666666; font-style: italic"> *       Appropriate space has been allocated for output arrays. </span>
<span style="color: #666666; font-style: italic"> *       Don&#39;t alter the values of the input image.</span>
<span style="color: #666666; font-style: italic"> */</span>
<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">color_threshold</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height,
                 <span style="color: #6666ff; font-weight: bold">int</span> red_threshold,<span style="color: #6666ff; font-weight: bold">int</span> blue_threshold,<span style="color: #6666ff; font-weight: bold">int</span> green_threshold)
{
	<span style="color: #666666; font-style: italic">//declaring and initializing values</span>
	<span style="color: #6666ff; font-weight: bold">int</span> index;
	<span style="color: #6666ff; font-weight: bold">int</span> array_length <span style="color: #333333">=</span> width <span style="color: #333333">*</span> height;
	
     	<span style="color: #228899; font-weight: bold">for</span>(index <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>; index <span style="color: #333333">&lt;</span> array_length; index<span style="color: #333333">++</span>)
	{
		<span style="color: #228899; font-weight: bold">if</span>((in_red[index] <span style="color: #333333">&gt;</span> red_threshold) <span style="color: #333333">&amp;&amp;</span> (in_green[index] <span style="color: #333333">&gt;</span> green_threshold) <span style="color: #333333">&amp;&amp;</span> (in_blue[index] <span style="color: #333333">&gt;</span> blue_threshold))
		{
			<span style="color: #666666; font-style: italic">//setting output values equals to corresponding input values</span>
			<span style="color: #666666; font-style: italic">//if and only if all three values exceed the threshold </span>
			out_red[index] <span style="color: #333333">=</span> in_red[index];
			out_green[index] <span style="color: #333333">=</span> in_green[index];
			out_blue[index] <span style="color: #333333">=</span> in_blue[index];
			out_alpha[index] <span style="color: #333333">=</span> in_alpha[index];
		}<span style="color: #666666; font-style: italic">//end if</span>

		<span style="color: #228899; font-weight: bold">else</span>
		{
			<span style="color: #666666; font-style: italic">//setting pixels to black if not all input values exceed threshold</span>
			out_red[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
			out_green[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
			out_blue[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">0</span>;
			out_alpha[index] <span style="color: #333333">=</span> <span style="color: #6666ff; font-weight: bold">255</span>;
		}<span style="color: #666666; font-style: italic">//end else</span>
	}<span style="color: #666666; font-style: italic">//end for loop</span>
}<span style="color: #666666; font-style: italic">//end color_threshold</span>
</pre></div>
<p></p>
                            </section>
                            
        
        
        
        
        
        
                            <!--funcions.h-->
                            <section>
                                <hnew id="functions.h">functions.h</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #557799">#include &lt;stdint.h&gt;</span>
<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#include &lt;math.h&gt;</span>

<span style="color: #557799">#ifndef FUNCTIONS_H</span>
<span style="color: #557799">#define FUNCTIONS_H</span>

<span style="color: #666666; font-style: italic">//M_PI missing from c99 standard</span>
<span style="color: #557799">#define M_PI           3.14159265358979323846</span>
<span style="color: #557799">#define max(a,b) (a&gt;b?a:b)</span>
<span style="color: #557799">#define min(a,b) (a&gt;b?b:a)</span>

<span style="color: #557799">#endif</span>

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">calculate_cosine_filter</span>(<span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>cos_filter, <span style="color: #6666ff; font-weight: bold">int</span> radius);

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">convolve_image</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span> out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span><span style="color: #333333">*</span> out_alpha,<span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>filter,
                   <span style="color: #6666ff; font-weight: bold">int</span> radius,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height);

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">convert_to_gray</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                   <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,
                   <span style="color: #228899; font-weight: bold">const</span> <span style="color: #6666ff; font-weight: bold">double</span> <span style="color: #333333">*</span>gmonomult,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height);

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">flip_vertical</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height);

<span style="color: #6666ff; font-weight: bold">void</span> <span style="color: #55eedd; font-weight: bold">color_threshold</span>(<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_green,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_blue,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>in_alpha,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_red,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_green,
                 <span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_blue,<span style="color: #6666ff; font-weight: bold">uint8_t</span> <span style="color: #333333">*</span>out_alpha,<span style="color: #6666ff; font-weight: bold">int</span> width,<span style="color: #6666ff; font-weight: bold">int</span> height,
                 <span style="color: #6666ff; font-weight: bold">int</span> red_threshold,<span style="color: #6666ff; font-weight: bold">int</span> blue_threshold,<span style="color: #6666ff; font-weight: bold">int</span> green_threshold);
</pre></div>
<p></p>
                            </section>
                            
        
                            <!-- LodePNG Doc-->
                            <section>
                                <hnew id="LodePNG Documentation">LodePNG Documentation</hnew><br>  
                                <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #666666; font-style: italic">/*</span>
<span style="color: #666666; font-style: italic">LodePNG Documentation</span>
<span style="color: #666666; font-style: italic">---------------------</span>

<span style="color: #666666; font-style: italic">0. table of contents</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">  1. about</span>
<span style="color: #666666; font-style: italic">   1.1. supported features</span>
<span style="color: #666666; font-style: italic">   1.2. features not supported</span>
<span style="color: #666666; font-style: italic">  2. C and C++ version</span>
<span style="color: #666666; font-style: italic">  3. security</span>
<span style="color: #666666; font-style: italic">  4. decoding</span>
<span style="color: #666666; font-style: italic">  5. encoding</span>
<span style="color: #666666; font-style: italic">  6. color conversions</span>
<span style="color: #666666; font-style: italic">    6.1. PNG color types</span>
<span style="color: #666666; font-style: italic">    6.2. color conversions</span>
<span style="color: #666666; font-style: italic">    6.3. padding bits</span>
<span style="color: #666666; font-style: italic">    6.4. A note about 16-bits per channel and endianness</span>
<span style="color: #666666; font-style: italic">  7. error values</span>
<span style="color: #666666; font-style: italic">  8. chunks and PNG editing</span>
<span style="color: #666666; font-style: italic">  9. compiler support</span>
<span style="color: #666666; font-style: italic">  10. examples</span>
<span style="color: #666666; font-style: italic">   10.1. decoder C++ example</span>
<span style="color: #666666; font-style: italic">   10.2. decoder C example</span>
<span style="color: #666666; font-style: italic">  11. changes</span>
<span style="color: #666666; font-style: italic">  12. contact information</span>


<span style="color: #666666; font-style: italic">1. about</span>
<span style="color: #666666; font-style: italic">--------</span>

<span style="color: #666666; font-style: italic">PNG is a file format to store raster images losslessly with good compression,</span>
<span style="color: #666666; font-style: italic">supporting different color types and alpha channel.</span>

<span style="color: #666666; font-style: italic">LodePNG is a PNG codec according to the Portable Network Graphics (PNG)</span>
<span style="color: #666666; font-style: italic">Specification (Second Edition) - W3C Recommendation 10 November 2003.</span>

<span style="color: #666666; font-style: italic">The specifications used are:</span>

<span style="color: #666666; font-style: italic">*) Portable Network Graphics (PNG) Specification (Second Edition):</span>
<span style="color: #666666; font-style: italic">     http://www.w3.org/TR/2003/REC-PNG-20031110</span>
<span style="color: #666666; font-style: italic">*) RFC 1950 ZLIB Compressed Data Format version 3.3:</span>
<span style="color: #666666; font-style: italic">     http://www.gzip.org/zlib/rfc-zlib.html</span>
<span style="color: #666666; font-style: italic">*) RFC 1951 DEFLATE Compressed Data Format Specification ver 1.3:</span>
<span style="color: #666666; font-style: italic">     http://www.gzip.org/zlib/rfc-deflate.html</span>

<span style="color: #666666; font-style: italic">The most recent version of LodePNG can currently be found at</span>
<span style="color: #666666; font-style: italic">http://lodev.org/lodepng/</span>

<span style="color: #666666; font-style: italic">LodePNG works both in C (ISO C90) and C++, with a C++ wrapper that adds</span>
<span style="color: #666666; font-style: italic">extra functionality.</span>

<span style="color: #666666; font-style: italic">LodePNG exists out of two files:</span>
<span style="color: #666666; font-style: italic">-lodepng.h: the header file for both C and C++</span>
<span style="color: #666666; font-style: italic">-lodepng.c(pp): give it the name lodepng.c or lodepng.cpp (or .cc) depending on your usage</span>

<span style="color: #666666; font-style: italic">If you want to start using LodePNG right away without reading this doc, get the</span>
<span style="color: #666666; font-style: italic">examples from the LodePNG website to see how to use it in code, or check the</span>
<span style="color: #666666; font-style: italic">smaller examples in chapter 13 here.</span>

<span style="color: #666666; font-style: italic">LodePNG is simple but only supports the basic requirements. To achieve</span>
<span style="color: #666666; font-style: italic">simplicity, the following design choices were made: There are no dependencies</span>
<span style="color: #666666; font-style: italic">on any external library. There are functions to decode and encode a PNG with</span>
<span style="color: #666666; font-style: italic">a single function call, and extended versions of these functions taking a</span>
<span style="color: #666666; font-style: italic">LodePNGState struct allowing to specify or get more information. By default</span>
<span style="color: #666666; font-style: italic">the colors of the raw image are always RGB or RGBA, no matter what color type</span>
<span style="color: #666666; font-style: italic">the PNG file uses. To read and write files, there are simple functions to</span>
<span style="color: #666666; font-style: italic">convert the files to/from buffers in memory.</span>

<span style="color: #666666; font-style: italic">This all makes LodePNG suitable for loading textures in games, demos and small</span>
<span style="color: #666666; font-style: italic">programs, ... It&#39;s less suitable for full fledged image editors, loading PNGs</span>
<span style="color: #666666; font-style: italic">over network (it requires all the image data to be available before decoding can</span>
<span style="color: #666666; font-style: italic">begin), life-critical systems, ...</span>

<span style="color: #666666; font-style: italic">1.1. supported features</span>
<span style="color: #666666; font-style: italic">-----------------------</span>

<span style="color: #666666; font-style: italic">The following features are supported by the decoder:</span>

<span style="color: #666666; font-style: italic">*) decoding of PNGs with any color type, bit depth and interlace mode, to a 24- or 32-bit color raw image,</span>
<span style="color: #666666; font-style: italic">   or the same color type as the PNG</span>
<span style="color: #666666; font-style: italic">*) encoding of PNGs, from any raw image to 24- or 32-bit color, or the same color type as the raw image</span>
<span style="color: #666666; font-style: italic">*) Adam7 interlace and deinterlace for any color type</span>
<span style="color: #666666; font-style: italic">*) loading the image from harddisk or decoding it from a buffer from other sources than harddisk</span>
<span style="color: #666666; font-style: italic">*) support for alpha channels, including RGBA color model, translucent palettes and color keying</span>
<span style="color: #666666; font-style: italic">*) zlib decompression (inflate)</span>
<span style="color: #666666; font-style: italic">*) zlib compression (deflate)</span>
<span style="color: #666666; font-style: italic">*) CRC32 and ADLER32 checksums</span>
<span style="color: #666666; font-style: italic">*) handling of unknown chunks, allowing making a PNG editor that stores custom and unknown chunks.</span>
<span style="color: #666666; font-style: italic">*) the following chunks are supported (generated/interpreted) by both encoder and decoder:</span>
<span style="color: #666666; font-style: italic">    IHDR: header information</span>
<span style="color: #666666; font-style: italic">    PLTE: color palette</span>
<span style="color: #666666; font-style: italic">    IDAT: pixel data</span>
<span style="color: #666666; font-style: italic">    IEND: the final chunk</span>
<span style="color: #666666; font-style: italic">    tRNS: transparency for palettized images</span>
<span style="color: #666666; font-style: italic">    tEXt: textual information</span>
<span style="color: #666666; font-style: italic">    zTXt: compressed textual information</span>
<span style="color: #666666; font-style: italic">    iTXt: international textual information</span>
<span style="color: #666666; font-style: italic">    bKGD: suggested background color</span>
<span style="color: #666666; font-style: italic">    pHYs: physical dimensions</span>
<span style="color: #666666; font-style: italic">    tIME: modification time</span>

<span style="color: #666666; font-style: italic">1.2. features not supported</span>
<span style="color: #666666; font-style: italic">---------------------------</span>

<span style="color: #666666; font-style: italic">The following features are _not_ supported:</span>

<span style="color: #666666; font-style: italic">*) some features needed to make a conformant PNG-Editor might be still missing.</span>
<span style="color: #666666; font-style: italic">*) partial loading/stream processing. All data must be available and is processed in one call.</span>
<span style="color: #666666; font-style: italic">*) The following public chunks are not supported but treated as unknown chunks by LodePNG</span>
<span style="color: #666666; font-style: italic">    cHRM, gAMA, iCCP, sRGB, sBIT, hIST, sPLT</span>
<span style="color: #666666; font-style: italic">   Some of these are not supported on purpose: LodePNG wants to provide the RGB values</span>
<span style="color: #666666; font-style: italic">   stored in the pixels, not values modified by system dependent gamma or color models.</span>


<span style="color: #666666; font-style: italic">2. C and C++ version</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">The C version uses buffers allocated with alloc that you need to free()</span>
<span style="color: #666666; font-style: italic">yourself. You need to use init and cleanup functions for each struct whenever</span>
<span style="color: #666666; font-style: italic">using a struct from the C version to avoid exploits and memory leaks.</span>

<span style="color: #666666; font-style: italic">The C++ version has extra functions with std::vectors in the interface and the</span>
<span style="color: #666666; font-style: italic">lodepng::State class which is a LodePNGState with constructor and destructor.</span>

<span style="color: #666666; font-style: italic">These files work without modification for both C and C++ compilers because all</span>
<span style="color: #666666; font-style: italic">the additional C++ code is in &quot;#ifdef __cplusplus&quot; blocks that make C-compilers</span>
<span style="color: #666666; font-style: italic">ignore it, and the C code is made to compile both with strict ISO C90 and C++.</span>

<span style="color: #666666; font-style: italic">To use the C++ version, you need to rename the source file to lodepng.cpp</span>
<span style="color: #666666; font-style: italic">(instead of lodepng.c), and compile it with a C++ compiler.</span>

<span style="color: #666666; font-style: italic">To use the C version, you need to rename the source file to lodepng.c (instead</span>
<span style="color: #666666; font-style: italic">of lodepng.cpp), and compile it with a C compiler.</span>


<span style="color: #666666; font-style: italic">3. Security</span>
<span style="color: #666666; font-style: italic">-----------</span>

<span style="color: #666666; font-style: italic">Even if carefully designed, it&#39;s always possible that LodePNG contains possible</span>
<span style="color: #666666; font-style: italic">exploits. If you discover one, please let me know, and it will be fixed.</span>

<span style="color: #666666; font-style: italic">When using LodePNG, care has to be taken with the C version of LodePNG, as well</span>
<span style="color: #666666; font-style: italic">as the C-style structs when working with C++. The following conventions are used</span>
<span style="color: #666666; font-style: italic">for all C-style structs:</span>

<span style="color: #666666; font-style: italic">-if a struct has a corresponding init function, always call the init function when making a new one</span>
<span style="color: #666666; font-style: italic">-if a struct has a corresponding cleanup function, call it before the struct disappears to avoid memory leaks</span>
<span style="color: #666666; font-style: italic">-if a struct has a corresponding copy function, use the copy function instead of &quot;=&quot;.</span>
<span style="color: #666666; font-style: italic"> The destination must also be inited already.</span>


<span style="color: #666666; font-style: italic">4. Decoding</span>
<span style="color: #666666; font-style: italic">-----------</span>

<span style="color: #666666; font-style: italic">Decoding converts a PNG compressed image to a raw pixel buffer.</span>

<span style="color: #666666; font-style: italic">Most documentation on using the decoder is at its declarations in the header</span>
<span style="color: #666666; font-style: italic">above. For C, simple decoding can be done with functions such as</span>
<span style="color: #666666; font-style: italic">lodepng_decode32, and more advanced decoding can be done with the struct</span>
<span style="color: #666666; font-style: italic">LodePNGState and lodepng_decode. For C++, all decoding can be done with the</span>
<span style="color: #666666; font-style: italic">various lodepng::decode functions, and lodepng::State can be used for advanced</span>
<span style="color: #666666; font-style: italic">features.</span>

<span style="color: #666666; font-style: italic">When using the LodePNGState, it uses the following fields for decoding:</span>
<span style="color: #666666; font-style: italic">*) LodePNGInfo info_png: it stores extra information about the PNG (the input) in here</span>
<span style="color: #666666; font-style: italic">*) LodePNGColorMode info_raw: here you can say what color mode of the raw image (the output) you want to get</span>
<span style="color: #666666; font-style: italic">*) LodePNGDecoderSettings decoder: you can specify a few extra settings for the decoder to use</span>

<span style="color: #666666; font-style: italic">LodePNGInfo info_png</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">After decoding, this contains extra information of the PNG image, except the actual</span>
<span style="color: #666666; font-style: italic">pixels, width and height because these are already gotten directly from the decoder</span>
<span style="color: #666666; font-style: italic">functions.</span>

<span style="color: #666666; font-style: italic">It contains for example the original color type of the PNG image, text comments,</span>
<span style="color: #666666; font-style: italic">suggested background color, etc... More details about the LodePNGInfo struct are</span>
<span style="color: #666666; font-style: italic">at its declaration documentation.</span>

<span style="color: #666666; font-style: italic">LodePNGColorMode info_raw</span>
<span style="color: #666666; font-style: italic">-------------------------</span>

<span style="color: #666666; font-style: italic">When decoding, here you can specify which color type you want</span>
<span style="color: #666666; font-style: italic">the resulting raw image to be. If this is different from the colortype of the</span>
<span style="color: #666666; font-style: italic">PNG, then the decoder will automatically convert the result. This conversion</span>
<span style="color: #666666; font-style: italic">always works, except if you want it to convert a color PNG to greyscale or to</span>
<span style="color: #666666; font-style: italic">a palette with missing colors.</span>

<span style="color: #666666; font-style: italic">By default, 32-bit color is used for the result.</span>

<span style="color: #666666; font-style: italic">LodePNGDecoderSettings decoder</span>
<span style="color: #666666; font-style: italic">------------------------------</span>

<span style="color: #666666; font-style: italic">The settings can be used to ignore the errors created by invalid CRC and Adler32</span>
<span style="color: #666666; font-style: italic">chunks, and to disable the decoding of tEXt chunks.</span>

<span style="color: #666666; font-style: italic">There&#39;s also a setting color_convert, true by default. If false, no conversion</span>
<span style="color: #666666; font-style: italic">is done, the resulting data will be as it was in the PNG (after decompression)</span>
<span style="color: #666666; font-style: italic">and you&#39;ll have to puzzle the colors of the pixels together yourself using the</span>
<span style="color: #666666; font-style: italic">color type information in the LodePNGInfo.</span>


<span style="color: #666666; font-style: italic">5. Encoding</span>
<span style="color: #666666; font-style: italic">-----------</span>

<span style="color: #666666; font-style: italic">Encoding converts a raw pixel buffer to a PNG compressed image.</span>

<span style="color: #666666; font-style: italic">Most documentation on using the encoder is at its declarations in the header</span>
<span style="color: #666666; font-style: italic">above. For C, simple encoding can be done with functions such as</span>
<span style="color: #666666; font-style: italic">lodepng_encode32, and more advanced decoding can be done with the struct</span>
<span style="color: #666666; font-style: italic">LodePNGState and lodepng_encode. For C++, all encoding can be done with the</span>
<span style="color: #666666; font-style: italic">various lodepng::encode functions, and lodepng::State can be used for advanced</span>
<span style="color: #666666; font-style: italic">features.</span>

<span style="color: #666666; font-style: italic">Like the decoder, the encoder can also give errors. However it gives less errors</span>
<span style="color: #666666; font-style: italic">since the encoder input is trusted, the decoder input (a PNG image that could</span>
<span style="color: #666666; font-style: italic">be forged by anyone) is not trusted.</span>

<span style="color: #666666; font-style: italic">When using the LodePNGState, it uses the following fields for encoding:</span>
<span style="color: #666666; font-style: italic">*) LodePNGInfo info_png: here you specify how you want the PNG (the output) to be.</span>
<span style="color: #666666; font-style: italic">*) LodePNGColorMode info_raw: here you say what color type of the raw image (the input) has</span>
<span style="color: #666666; font-style: italic">*) LodePNGEncoderSettings encoder: you can specify a few settings for the encoder to use</span>

<span style="color: #666666; font-style: italic">LodePNGInfo info_png</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">When encoding, you use this the opposite way as when decoding: for encoding,</span>
<span style="color: #666666; font-style: italic">you fill in the values you want the PNG to have before encoding. By default it&#39;s</span>
<span style="color: #666666; font-style: italic">not needed to specify a color type for the PNG since it&#39;s automatically chosen,</span>
<span style="color: #666666; font-style: italic">but it&#39;s possible to choose it yourself given the right settings.</span>

<span style="color: #666666; font-style: italic">The encoder will not always exactly match the LodePNGInfo struct you give,</span>
<span style="color: #666666; font-style: italic">it tries as close as possible. Some things are ignored by the encoder. The</span>
<span style="color: #666666; font-style: italic">encoder uses, for example, the following settings from it when applicable:</span>
<span style="color: #666666; font-style: italic">colortype and bitdepth, text chunks, time chunk, the color key, the palette, the</span>
<span style="color: #666666; font-style: italic">background color, the interlace method, unknown chunks, ...</span>

<span style="color: #666666; font-style: italic">When encoding to a PNG with colortype 3, the encoder will generate a PLTE chunk.</span>
<span style="color: #666666; font-style: italic">If the palette contains any colors for which the alpha channel is not 255 (so</span>
<span style="color: #666666; font-style: italic">there are translucent colors in the palette), it&#39;ll add a tRNS chunk.</span>

<span style="color: #666666; font-style: italic">LodePNGColorMode info_raw</span>
<span style="color: #666666; font-style: italic">-------------------------</span>

<span style="color: #666666; font-style: italic">You specify the color type of the raw image that you give to the input here,</span>
<span style="color: #666666; font-style: italic">including a possible transparent color key and palette you happen to be using in</span>
<span style="color: #666666; font-style: italic">your raw image data.</span>

<span style="color: #666666; font-style: italic">By default, 32-bit color is assumed, meaning your input has to be in RGBA</span>
<span style="color: #666666; font-style: italic">format with 4 bytes (unsigned chars) per pixel.</span>

<span style="color: #666666; font-style: italic">LodePNGEncoderSettings encoder</span>
<span style="color: #666666; font-style: italic">------------------------------</span>

<span style="color: #666666; font-style: italic">The following settings are supported (some are in sub-structs):</span>
<span style="color: #666666; font-style: italic">*) auto_convert: when this option is enabled, the encoder will</span>
<span style="color: #666666; font-style: italic">automatically choose the smallest possible color mode (including color key) that</span>
<span style="color: #666666; font-style: italic">can encode the colors of all pixels without information loss.</span>
<span style="color: #666666; font-style: italic">*) btype: the block type for LZ77. 0 = uncompressed, 1 = fixed huffman tree,</span>
<span style="color: #666666; font-style: italic">   2 = dynamic huffman tree (best compression). Should be 2 for proper</span>
<span style="color: #666666; font-style: italic">   compression.</span>
<span style="color: #666666; font-style: italic">*) use_lz77: whether or not to use LZ77 for compressed block types. Should be</span>
<span style="color: #666666; font-style: italic">   true for proper compression.</span>
<span style="color: #666666; font-style: italic">*) windowsize: the window size used by the LZ77 encoder (1 - 32768). Has value</span>
<span style="color: #666666; font-style: italic">   2048 by default, but can be set to 32768 for better, but slow, compression.</span>
<span style="color: #666666; font-style: italic">*) force_palette: if colortype is 2 or 6, you can make the encoder write a PLTE</span>
<span style="color: #666666; font-style: italic">   chunk if force_palette is true. This can used as suggested palette to convert</span>
<span style="color: #666666; font-style: italic">   to by viewers that don&#39;t support more than 256 colors (if those still exist)</span>
<span style="color: #666666; font-style: italic">*) add_id: add text chunk &quot;Encoder: LodePNG &lt;version&gt;&quot; to the image.</span>
<span style="color: #666666; font-style: italic">*) text_compression: default 1. If 1, it&#39;ll store texts as zTXt instead of tEXt chunks.</span>
<span style="color: #666666; font-style: italic">  zTXt chunks use zlib compression on the text. This gives a smaller result on</span>
<span style="color: #666666; font-style: italic">  large texts but a larger result on small texts (such as a single program name).</span>
<span style="color: #666666; font-style: italic">  It&#39;s all tEXt or all zTXt though, there&#39;s no separate setting per text yet.</span>


<span style="color: #666666; font-style: italic">6. color conversions</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">An important thing to note about LodePNG, is that the color type of the PNG, and</span>
<span style="color: #666666; font-style: italic">the color type of the raw image, are completely independent. By default, when</span>
<span style="color: #666666; font-style: italic">you decode a PNG, you get the result as a raw image in the color type you want,</span>
<span style="color: #666666; font-style: italic">no matter whether the PNG was encoded with a palette, greyscale or RGBA color.</span>
<span style="color: #666666; font-style: italic">And if you encode an image, by default LodePNG will automatically choose the PNG</span>
<span style="color: #666666; font-style: italic">color type that gives good compression based on the values of colors and amount</span>
<span style="color: #666666; font-style: italic">of colors in the image. It can be configured to let you control it instead as</span>
<span style="color: #666666; font-style: italic">well, though.</span>

<span style="color: #666666; font-style: italic">To be able to do this, LodePNG does conversions from one color mode to another.</span>
<span style="color: #666666; font-style: italic">It can convert from almost any color type to any other color type, except the</span>
<span style="color: #666666; font-style: italic">following conversions: RGB to greyscale is not supported, and converting to a</span>
<span style="color: #666666; font-style: italic">palette when the palette doesn&#39;t have a required color is not supported. This is</span>
<span style="color: #666666; font-style: italic">not supported on purpose: this is information loss which requires a color</span>
<span style="color: #666666; font-style: italic">reduction algorithm that is beyong the scope of a PNG encoder (yes, RGB to grey</span>
<span style="color: #666666; font-style: italic">is easy, but there are multiple ways if you want to give some channels more</span>
<span style="color: #666666; font-style: italic">weight).</span>

<span style="color: #666666; font-style: italic">By default, when decoding, you get the raw image in 32-bit RGBA or 24-bit RGB</span>
<span style="color: #666666; font-style: italic">color, no matter what color type the PNG has. And by default when encoding,</span>
<span style="color: #666666; font-style: italic">LodePNG automatically picks the best color model for the output PNG, and expects</span>
<span style="color: #666666; font-style: italic">the input image to be 32-bit RGBA or 24-bit RGB. So, unless you want to control</span>
<span style="color: #666666; font-style: italic">the color format of the images yourself, you can skip this chapter.</span>

<span style="color: #666666; font-style: italic">6.1. PNG color types</span>
<span style="color: #666666; font-style: italic">--------------------</span>

<span style="color: #666666; font-style: italic">A PNG image can have many color types, ranging from 1-bit color to 64-bit color,</span>
<span style="color: #666666; font-style: italic">as well as palettized color modes. After the zlib decompression and unfiltering</span>
<span style="color: #666666; font-style: italic">in the PNG image is done, the raw pixel data will have that color type and thus</span>
<span style="color: #666666; font-style: italic">a certain amount of bits per pixel. If you want the output raw image after</span>
<span style="color: #666666; font-style: italic">decoding to have another color type, a conversion is done by LodePNG.</span>

<span style="color: #666666; font-style: italic">The PNG specification gives the following color types:</span>

<span style="color: #666666; font-style: italic">0: greyscale, bit depths 1, 2, 4, 8, 16</span>
<span style="color: #666666; font-style: italic">2: RGB, bit depths 8 and 16</span>
<span style="color: #666666; font-style: italic">3: palette, bit depths 1, 2, 4 and 8</span>
<span style="color: #666666; font-style: italic">4: greyscale with alpha, bit depths 8 and 16</span>
<span style="color: #666666; font-style: italic">6: RGBA, bit depths 8 and 16</span>

<span style="color: #666666; font-style: italic">Bit depth is the amount of bits per pixel per color channel. So the total amount</span>
<span style="color: #666666; font-style: italic">of bits per pixel is: amount of channels * bitdepth.</span>

<span style="color: #666666; font-style: italic">6.2. color conversions</span>
<span style="color: #666666; font-style: italic">----------------------</span>

<span style="color: #666666; font-style: italic">As explained in the sections about the encoder and decoder, you can specify</span>
<span style="color: #666666; font-style: italic">color types and bit depths in info_png and info_raw to change the default</span>
<span style="color: #666666; font-style: italic">behaviour.</span>

<span style="color: #666666; font-style: italic">If, when decoding, you want the raw image to be something else than the default,</span>
<span style="color: #666666; font-style: italic">you need to set the color type and bit depth you want in the LodePNGColorMode,</span>
<span style="color: #666666; font-style: italic">or the parameters colortype and bitdepth of the simple decoding function.</span>

<span style="color: #666666; font-style: italic">If, when encoding, you use another color type than the default in the raw input</span>
<span style="color: #666666; font-style: italic">image, you need to specify its color type and bit depth in the LodePNGColorMode</span>
<span style="color: #666666; font-style: italic">of the raw image, or use the parameters colortype and bitdepth of the simple</span>
<span style="color: #666666; font-style: italic">encoding function.</span>

<span style="color: #666666; font-style: italic">If, when encoding, you don&#39;t want LodePNG to choose the output PNG color type</span>
<span style="color: #666666; font-style: italic">but control it yourself, you need to set auto_convert in the encoder settings</span>
<span style="color: #666666; font-style: italic">to false, and specify the color type you want in the LodePNGInfo of the</span>
<span style="color: #666666; font-style: italic">encoder (including palette: it can generate a palette if auto_convert is true,</span>
<span style="color: #666666; font-style: italic">otherwise not).</span>

<span style="color: #666666; font-style: italic">If the input and output color type differ (whether user chosen or auto chosen),</span>
<span style="color: #666666; font-style: italic">LodePNG will do a color conversion, which follows the rules below, and may</span>
<span style="color: #666666; font-style: italic">sometimes result in an error.</span>

<span style="color: #666666; font-style: italic">To avoid some confusion:</span>
<span style="color: #666666; font-style: italic">-the decoder converts from PNG to raw image</span>
<span style="color: #666666; font-style: italic">-the encoder converts from raw image to PNG</span>
<span style="color: #666666; font-style: italic">-the colortype and bitdepth in LodePNGColorMode info_raw, are those of the raw image</span>
<span style="color: #666666; font-style: italic">-the colortype and bitdepth in the color field of LodePNGInfo info_png, are those of the PNG</span>
<span style="color: #666666; font-style: italic">-when encoding, the color type in LodePNGInfo is ignored if auto_convert</span>
<span style="color: #666666; font-style: italic"> is enabled, it is automatically generated instead</span>
<span style="color: #666666; font-style: italic">-when decoding, the color type in LodePNGInfo is set by the decoder to that of the original</span>
<span style="color: #666666; font-style: italic"> PNG image, but it can be ignored since the raw image has the color type you requested instead</span>
<span style="color: #666666; font-style: italic">-if the color type of the LodePNGColorMode and PNG image aren&#39;t the same, a conversion</span>
<span style="color: #666666; font-style: italic"> between the color types is done if the color types are supported. If it is not</span>
<span style="color: #666666; font-style: italic"> supported, an error is returned. If the types are the same, no conversion is done.</span>
<span style="color: #666666; font-style: italic">-even though some conversions aren&#39;t supported, LodePNG supports loading PNGs from any</span>
<span style="color: #666666; font-style: italic"> colortype and saving PNGs to any colortype, sometimes it just requires preparing</span>
<span style="color: #666666; font-style: italic"> the raw image correctly before encoding.</span>
<span style="color: #666666; font-style: italic">-both encoder and decoder use the same color converter.</span>

<span style="color: #666666; font-style: italic">Non supported color conversions:</span>
<span style="color: #666666; font-style: italic">-color to greyscale: no error is thrown, but the result will look ugly because</span>
<span style="color: #666666; font-style: italic">only the red channel is taken</span>
<span style="color: #666666; font-style: italic">-anything to palette when that palette does not have that color in it: in this</span>
<span style="color: #666666; font-style: italic">case an error is thrown</span>

<span style="color: #666666; font-style: italic">Supported color conversions:</span>
<span style="color: #666666; font-style: italic">-anything to 8-bit RGB, 8-bit RGBA, 16-bit RGB, 16-bit RGBA</span>
<span style="color: #666666; font-style: italic">-any grey or grey+alpha, to grey or grey+alpha</span>
<span style="color: #666666; font-style: italic">-anything to a palette, as long as the palette has the requested colors in it</span>
<span style="color: #666666; font-style: italic">-removing alpha channel</span>
<span style="color: #666666; font-style: italic">-higher to smaller bitdepth, and vice versa</span>

<span style="color: #666666; font-style: italic">If you want no color conversion to be done (e.g. for speed or control):</span>
<span style="color: #666666; font-style: italic">-In the encoder, you can make it save a PNG with any color type by giving the</span>
<span style="color: #666666; font-style: italic">raw color mode and LodePNGInfo the same color mode, and setting auto_convert to</span>
<span style="color: #666666; font-style: italic">false.</span>
<span style="color: #666666; font-style: italic">-In the decoder, you can make it store the pixel data in the same color type</span>
<span style="color: #666666; font-style: italic">as the PNG has, by setting the color_convert setting to false. Settings in</span>
<span style="color: #666666; font-style: italic">info_raw are then ignored.</span>

<span style="color: #666666; font-style: italic">The function lodepng_convert does the color conversion. It is available in the</span>
<span style="color: #666666; font-style: italic">interface but normally isn&#39;t needed since the encoder and decoder already call</span>
<span style="color: #666666; font-style: italic">it.</span>

<span style="color: #666666; font-style: italic">6.3. padding bits</span>
<span style="color: #666666; font-style: italic">-----------------</span>

<span style="color: #666666; font-style: italic">In the PNG file format, if a less than 8-bit per pixel color type is used and the scanlines</span>
<span style="color: #666666; font-style: italic">have a bit amount that isn&#39;t a multiple of 8, then padding bits are used so that each</span>
<span style="color: #666666; font-style: italic">scanline starts at a fresh byte. But that is NOT true for the LodePNG raw input and output.</span>
<span style="color: #666666; font-style: italic">The raw input image you give to the encoder, and the raw output image you get from the decoder</span>
<span style="color: #666666; font-style: italic">will NOT have these padding bits, e.g. in the case of a 1-bit image with a width</span>
<span style="color: #666666; font-style: italic">of 7 pixels, the first pixel of the second scanline will the the 8th bit of the first byte,</span>
<span style="color: #666666; font-style: italic">not the first bit of a new byte.</span>

<span style="color: #666666; font-style: italic">6.4. A note about 16-bits per channel and endianness</span>
<span style="color: #666666; font-style: italic">----------------------------------------------------</span>

<span style="color: #666666; font-style: italic">LodePNG uses unsigned char arrays for 16-bit per channel colors too, just like</span>
<span style="color: #666666; font-style: italic">for any other color format. The 16-bit values are stored in big endian (most</span>
<span style="color: #666666; font-style: italic">significant byte first) in these arrays. This is the opposite order of the</span>
<span style="color: #666666; font-style: italic">little endian used by x86 CPU&#39;s.</span>

<span style="color: #666666; font-style: italic">LodePNG always uses big endian because the PNG file format does so internally.</span>
<span style="color: #666666; font-style: italic">Conversions to other formats than PNG uses internally are not supported by</span>
<span style="color: #666666; font-style: italic">LodePNG on purpose, there are myriads of formats, including endianness of 16-bit</span>
<span style="color: #666666; font-style: italic">colors, the order in which you store R, G, B and A, and so on. Supporting and</span>
<span style="color: #666666; font-style: italic">converting to/from all that is outside the scope of LodePNG.</span>

<span style="color: #666666; font-style: italic">This may mean that, depending on your use case, you may want to convert the big</span>
<span style="color: #666666; font-style: italic">endian output of LodePNG to little endian with a for loop. This is certainly not</span>
<span style="color: #666666; font-style: italic">always needed, many applications and libraries support big endian 16-bit colors</span>
<span style="color: #666666; font-style: italic">anyway, but it means you cannot simply cast the unsigned char* buffer to an</span>
<span style="color: #666666; font-style: italic">unsigned short* buffer on x86 CPUs.</span>


<span style="color: #666666; font-style: italic">7. error values</span>
<span style="color: #666666; font-style: italic">---------------</span>

<span style="color: #666666; font-style: italic">All functions in LodePNG that return an error code, return 0 if everything went</span>
<span style="color: #666666; font-style: italic">OK, or a non-zero code if there was an error.</span>

<span style="color: #666666; font-style: italic">The meaning of the LodePNG error values can be retrieved with the function</span>
<span style="color: #666666; font-style: italic">lodepng_error_text: given the numerical error code, it returns a description</span>
<span style="color: #666666; font-style: italic">of the error in English as a string.</span>

<span style="color: #666666; font-style: italic">Check the implementation of lodepng_error_text to see the meaning of each code.</span>


<span style="color: #666666; font-style: italic">8. chunks and PNG editing</span>
<span style="color: #666666; font-style: italic">-------------------------</span>

<span style="color: #666666; font-style: italic">If you want to add extra chunks to a PNG you encode, or use LodePNG for a PNG</span>
<span style="color: #666666; font-style: italic">editor that should follow the rules about handling of unknown chunks, or if your</span>
<span style="color: #666666; font-style: italic">program is able to read other types of chunks than the ones handled by LodePNG,</span>
<span style="color: #666666; font-style: italic">then that&#39;s possible with the chunk functions of LodePNG.</span>

<span style="color: #666666; font-style: italic">A PNG chunk has the following layout:</span>

<span style="color: #666666; font-style: italic">4 bytes length</span>
<span style="color: #666666; font-style: italic">4 bytes type name</span>
<span style="color: #666666; font-style: italic">length bytes data</span>
<span style="color: #666666; font-style: italic">4 bytes CRC</span>

<span style="color: #666666; font-style: italic">8.1. iterating through chunks</span>
<span style="color: #666666; font-style: italic">-----------------------------</span>

<span style="color: #666666; font-style: italic">If you have a buffer containing the PNG image data, then the first chunk (the</span>
<span style="color: #666666; font-style: italic">IHDR chunk) starts at byte number 8 of that buffer. The first 8 bytes are the</span>
<span style="color: #666666; font-style: italic">signature of the PNG and are not part of a chunk. But if you start at byte 8</span>
<span style="color: #666666; font-style: italic">then you have a chunk, and can check the following things of it.</span>

<span style="color: #666666; font-style: italic">NOTE: none of these functions check for memory buffer boundaries. To avoid</span>
<span style="color: #666666; font-style: italic">exploits, always make sure the buffer contains all the data of the chunks.</span>
<span style="color: #666666; font-style: italic">When using lodepng_chunk_next, make sure the returned value is within the</span>
<span style="color: #666666; font-style: italic">allocated memory.</span>

<span style="color: #666666; font-style: italic">unsigned lodepng_chunk_length(const unsigned char* chunk):</span>

<span style="color: #666666; font-style: italic">Get the length of the chunk&#39;s data. The total chunk length is this length + 12.</span>

<span style="color: #666666; font-style: italic">void lodepng_chunk_type(char type[5], const unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">unsigned char lodepng_chunk_type_equals(const unsigned char* chunk, const char* type):</span>

<span style="color: #666666; font-style: italic">Get the type of the chunk or compare if it&#39;s a certain type</span>

<span style="color: #666666; font-style: italic">unsigned char lodepng_chunk_critical(const unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">unsigned char lodepng_chunk_private(const unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">unsigned char lodepng_chunk_safetocopy(const unsigned char* chunk):</span>

<span style="color: #666666; font-style: italic">Check if the chunk is critical in the PNG standard (only IHDR, PLTE, IDAT and IEND are).</span>
<span style="color: #666666; font-style: italic">Check if the chunk is private (public chunks are part of the standard, private ones not).</span>
<span style="color: #666666; font-style: italic">Check if the chunk is safe to copy. If it&#39;s not, then, when modifying data in a critical</span>
<span style="color: #666666; font-style: italic">chunk, unsafe to copy chunks of the old image may NOT be saved in the new one if your</span>
<span style="color: #666666; font-style: italic">program doesn&#39;t handle that type of unknown chunk.</span>

<span style="color: #666666; font-style: italic">unsigned char* lodepng_chunk_data(unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">const unsigned char* lodepng_chunk_data_const(const unsigned char* chunk):</span>

<span style="color: #666666; font-style: italic">Get a pointer to the start of the data of the chunk.</span>

<span style="color: #666666; font-style: italic">unsigned lodepng_chunk_check_crc(const unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">void lodepng_chunk_generate_crc(unsigned char* chunk):</span>

<span style="color: #666666; font-style: italic">Check if the crc is correct or generate a correct one.</span>

<span style="color: #666666; font-style: italic">unsigned char* lodepng_chunk_next(unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">const unsigned char* lodepng_chunk_next_const(const unsigned char* chunk):</span>

<span style="color: #666666; font-style: italic">Iterate to the next chunk. This works if you have a buffer with consecutive chunks. Note that these</span>
<span style="color: #666666; font-style: italic">functions do no boundary checking of the allocated data whatsoever, so make sure there is enough</span>
<span style="color: #666666; font-style: italic">data available in the buffer to be able to go to the next chunk.</span>

<span style="color: #666666; font-style: italic">unsigned lodepng_chunk_append(unsigned char** out, size_t* outlength, const unsigned char* chunk):</span>
<span style="color: #666666; font-style: italic">unsigned lodepng_chunk_create(unsigned char** out, size_t* outlength, unsigned length,</span>
<span style="color: #666666; font-style: italic">                              const char* type, const unsigned char* data):</span>

<span style="color: #666666; font-style: italic">These functions are used to create new chunks that are appended to the data in *out that has</span>
<span style="color: #666666; font-style: italic">length *outlength. The append function appends an existing chunk to the new data. The create</span>
<span style="color: #666666; font-style: italic">function creates a new chunk with the given parameters and appends it. Type is the 4-letter</span>
<span style="color: #666666; font-style: italic">name of the chunk.</span>

<span style="color: #666666; font-style: italic">8.2. chunks in info_png</span>
<span style="color: #666666; font-style: italic">-----------------------</span>

<span style="color: #666666; font-style: italic">The LodePNGInfo struct contains fields with the unknown chunk in it. It has 3</span>
<span style="color: #666666; font-style: italic">buffers (each with size) to contain 3 types of unknown chunks:</span>
<span style="color: #666666; font-style: italic">the ones that come before the PLTE chunk, the ones that come between the PLTE</span>
<span style="color: #666666; font-style: italic">and the IDAT chunks, and the ones that come after the IDAT chunks.</span>
<span style="color: #666666; font-style: italic">It&#39;s necessary to make the distionction between these 3 cases because the PNG</span>
<span style="color: #666666; font-style: italic">standard forces to keep the ordering of unknown chunks compared to the critical</span>
<span style="color: #666666; font-style: italic">chunks, but does not force any other ordering rules.</span>

<span style="color: #666666; font-style: italic">info_png.unknown_chunks_data[0] is the chunks before PLTE</span>
<span style="color: #666666; font-style: italic">info_png.unknown_chunks_data[1] is the chunks after PLTE, before IDAT</span>
<span style="color: #666666; font-style: italic">info_png.unknown_chunks_data[2] is the chunks after IDAT</span>

<span style="color: #666666; font-style: italic">The chunks in these 3 buffers can be iterated through and read by using the same</span>
<span style="color: #666666; font-style: italic">way described in the previous subchapter.</span>

<span style="color: #666666; font-style: italic">When using the decoder to decode a PNG, you can make it store all unknown chunks</span>
<span style="color: #666666; font-style: italic">if you set the option settings.remember_unknown_chunks to 1. By default, this</span>
<span style="color: #666666; font-style: italic">option is off (0).</span>

<span style="color: #666666; font-style: italic">The encoder will always encode unknown chunks that are stored in the info_png.</span>
<span style="color: #666666; font-style: italic">If you need it to add a particular chunk that isn&#39;t known by LodePNG, you can</span>
<span style="color: #666666; font-style: italic">use lodepng_chunk_append or lodepng_chunk_create to the chunk data in</span>
<span style="color: #666666; font-style: italic">info_png.unknown_chunks_data[x].</span>

<span style="color: #666666; font-style: italic">Chunks that are known by LodePNG should not be added in that way. E.g. to make</span>
<span style="color: #666666; font-style: italic">LodePNG add a bKGD chunk, set background_defined to true and add the correct</span>
<span style="color: #666666; font-style: italic">parameters there instead.</span>


<span style="color: #666666; font-style: italic">9. compiler support</span>
<span style="color: #666666; font-style: italic">-------------------</span>

<span style="color: #666666; font-style: italic">No libraries other than the current standard C library are needed to compile</span>
<span style="color: #666666; font-style: italic">LodePNG. For the C++ version, only the standard C++ library is needed on top.</span>
<span style="color: #666666; font-style: italic">Add the files lodepng.c(pp) and lodepng.h to your project, include</span>
<span style="color: #666666; font-style: italic">lodepng.h where needed, and your program can read/write PNG files.</span>

<span style="color: #666666; font-style: italic">It is compatible with C90 and up, and C++03 and up.</span>

<span style="color: #666666; font-style: italic">If performance is important, use optimization when compiling! For both the</span>
<span style="color: #666666; font-style: italic">encoder and decoder, this makes a large difference.</span>

<span style="color: #666666; font-style: italic">Make sure that LodePNG is compiled with the same compiler of the same version</span>
<span style="color: #666666; font-style: italic">and with the same settings as the rest of the program, or the interfaces with</span>
<span style="color: #666666; font-style: italic">std::vectors and std::strings in C++ can be incompatible.</span>

<span style="color: #666666; font-style: italic">CHAR_BITS must be 8 or higher, because LodePNG uses unsigned chars for octets.</span>

<span style="color: #666666; font-style: italic">*) gcc and g++</span>

<span style="color: #666666; font-style: italic">LodePNG is developed in gcc so this compiler is natively supported. It gives no</span>
<span style="color: #666666; font-style: italic">warnings with compiler options &quot;-Wall -Wextra -pedantic -ansi&quot;, with gcc and g++</span>
<span style="color: #666666; font-style: italic">version 4.7.1 on Linux, 32-bit and 64-bit.</span>

<span style="color: #666666; font-style: italic">*) Clang</span>

<span style="color: #666666; font-style: italic">Fully supported and warning-free.</span>

<span style="color: #666666; font-style: italic">*) Mingw</span>

<span style="color: #666666; font-style: italic">The Mingw compiler (a port of gcc for Windows) should be fully supported by</span>
<span style="color: #666666; font-style: italic">LodePNG.</span>

<span style="color: #666666; font-style: italic">*) Visual Studio and Visual C++ Express Edition</span>

<span style="color: #666666; font-style: italic">LodePNG should be warning-free with warning level W4. Two warnings were disabled</span>
<span style="color: #666666; font-style: italic">with pragmas though: warning 4244 about implicit conversions, and warning 4996</span>
<span style="color: #666666; font-style: italic">where it wants to use a non-standard function fopen_s instead of the standard C</span>
<span style="color: #666666; font-style: italic">fopen.</span>

<span style="color: #666666; font-style: italic">Visual Studio may want &quot;stdafx.h&quot; files to be included in each source file and</span>
<span style="color: #666666; font-style: italic">give an error &quot;unexpected end of file while looking for precompiled header&quot;.</span>
<span style="color: #666666; font-style: italic">This is not standard C++ and will not be added to the stock LodePNG. You can</span>
<span style="color: #666666; font-style: italic">disable it for lodepng.cpp only by right clicking it, Properties, C/C++,</span>
<span style="color: #666666; font-style: italic">Precompiled Headers, and set it to Not Using Precompiled Headers there.</span>

<span style="color: #666666; font-style: italic">NOTE: Modern versions of VS should be fully supported, but old versions, e.g.</span>
<span style="color: #666666; font-style: italic">VS6, are not guaranteed to work.</span>

<span style="color: #666666; font-style: italic">*) Compilers on Macintosh</span>

<span style="color: #666666; font-style: italic">LodePNG has been reported to work both with gcc and LLVM for Macintosh, both for</span>
<span style="color: #666666; font-style: italic">C and C++.</span>

<span style="color: #666666; font-style: italic">*) Other Compilers</span>

<span style="color: #666666; font-style: italic">If you encounter problems on any compilers, feel free to let me know and I may</span>
<span style="color: #666666; font-style: italic">try to fix it if the compiler is modern and standards complient.</span>


<span style="color: #666666; font-style: italic">10. examples</span>
<span style="color: #666666; font-style: italic">------------</span>

<span style="color: #666666; font-style: italic">This decoder example shows the most basic usage of LodePNG. More complex</span>
<span style="color: #666666; font-style: italic">examples can be found on the LodePNG website.</span>

<span style="color: #666666; font-style: italic">10.1. decoder C++ example</span>
<span style="color: #666666; font-style: italic">-------------------------</span>

<span style="color: #666666; font-style: italic">#include &quot;lodepng.h&quot;</span>
<span style="color: #666666; font-style: italic">#include &lt;iostream&gt;</span>

<span style="color: #666666; font-style: italic">int main(int argc, char *argv[])</span>
<span style="color: #666666; font-style: italic">{</span>
<span style="color: #666666; font-style: italic">  const char* filename = argc &gt; 1 ? argv[1] : &quot;test.png&quot;;</span>

<span style="color: #666666; font-style: italic">  //load and decode</span>
<span style="color: #666666; font-style: italic">  std::vector&lt;unsigned char&gt; image;</span>
<span style="color: #666666; font-style: italic">  unsigned width, height;</span>
<span style="color: #666666; font-style: italic">  unsigned error = lodepng::decode(image, width, height, filename);</span>

<span style="color: #666666; font-style: italic">  //if there&#39;s an error, display it</span>
<span style="color: #666666; font-style: italic">  if(error) std::cout &lt;&lt; &quot;decoder error &quot; &lt;&lt; error &lt;&lt; &quot;: &quot; &lt;&lt; lodepng_error_text(error) &lt;&lt; std::endl;</span>

<span style="color: #666666; font-style: italic">  //the pixels are now in the vector &quot;image&quot;, 4 bytes per pixel, ordered RGBARGBA..., use it as texture, draw it, ...</span>
<span style="color: #666666; font-style: italic">}</span>

<span style="color: #666666; font-style: italic">10.2. decoder C example</span>
<span style="color: #666666; font-style: italic">-----------------------</span>

<span style="color: #666666; font-style: italic">#include &quot;lodepng.h&quot;</span>

<span style="color: #666666; font-style: italic">int main(int argc, char *argv[])</span>
<span style="color: #666666; font-style: italic">{</span>
<span style="color: #666666; font-style: italic">  unsigned error;</span>
<span style="color: #666666; font-style: italic">  unsigned char* image;</span>
<span style="color: #666666; font-style: italic">  size_t width, height;</span>
<span style="color: #666666; font-style: italic">  const char* filename = argc &gt; 1 ? argv[1] : &quot;test.png&quot;;</span>

<span style="color: #666666; font-style: italic">  error = lodepng_decode32_file(&amp;image, &amp;width, &amp;height, filename);</span>

<span style="color: #666666; font-style: italic">  if(error) printf(&quot;decoder error %u: %s\n&quot;, error, lodepng_error_text(error));</span>

<span style="color: #666666; font-style: italic">  / * use image here * /</span>

<span style="color: #666666; font-style: italic">  free(image);</span>
<span style="color: #666666; font-style: italic">  return 0;</span>
<span style="color: #666666; font-style: italic">}</span>


<span style="color: #666666; font-style: italic">11. changes</span>
<span style="color: #666666; font-style: italic">-----------</span>

<span style="color: #666666; font-style: italic">The version number of LodePNG is the date of the change given in the format</span>
<span style="color: #666666; font-style: italic">yyyymmdd.</span>

<span style="color: #666666; font-style: italic">Some changes aren&#39;t backwards compatible. Those are indicated with a (!)</span>
<span style="color: #666666; font-style: italic">symbol.</span>

<span style="color: #666666; font-style: italic">*) 23 aug 2014: Reduced needless memory usage of decoder.</span>
<span style="color: #666666; font-style: italic">*) 28 jun 2014: Removed fix_png setting, always support palette OOB for</span>
<span style="color: #666666; font-style: italic">    simplicity. Made ColorProfile public.</span>
<span style="color: #666666; font-style: italic">*) 09 jun 2014: Faster encoder by fixing hash bug and more zeros optimization.</span>
<span style="color: #666666; font-style: italic">*) 22 dec 2013: Power of two windowsize required for optimization.</span>
<span style="color: #666666; font-style: italic">*) 15 apr 2013: Fixed bug with LAC_ALPHA and color key.</span>
<span style="color: #666666; font-style: italic">*) 25 mar 2013: Added an optional feature to ignore some PNG errors (fix_png).</span>
<span style="color: #666666; font-style: italic">*) 11 mar 2013 (!): Bugfix with custom free. Changed from &quot;my&quot; to &quot;lodepng_&quot;</span>
<span style="color: #666666; font-style: italic">    prefix for the custom allocators and made it possible with a new #define to</span>
<span style="color: #666666; font-style: italic">    use custom ones in your project without needing to change lodepng&#39;s code.</span>
<span style="color: #666666; font-style: italic">*) 28 jan 2013: Bugfix with color key.</span>
<span style="color: #666666; font-style: italic">*) 27 okt 2012: Tweaks in text chunk keyword length error handling.</span>
<span style="color: #666666; font-style: italic">*) 8 okt 2012 (!): Added new filter strategy (entropy) and new auto color mode.</span>
<span style="color: #666666; font-style: italic">    (no palette). Better deflate tree encoding. New compression tweak settings.</span>
<span style="color: #666666; font-style: italic">    Faster color conversions while decoding. Some internal cleanups.</span>
<span style="color: #666666; font-style: italic">*) 23 sep 2012: Reduced warnings in Visual Studio a little bit.</span>
<span style="color: #666666; font-style: italic">*) 1 sep 2012 (!): Removed #define&#39;s for giving custom (de)compression functions</span>
<span style="color: #666666; font-style: italic">    and made it work with function pointers instead.</span>
<span style="color: #666666; font-style: italic">*) 23 jun 2012: Added more filter strategies. Made it easier to use custom alloc</span>
<span style="color: #666666; font-style: italic">    and free functions and toggle #defines from compiler flags. Small fixes.</span>
<span style="color: #666666; font-style: italic">*) 6 may 2012 (!): Made plugging in custom zlib/deflate functions more flexible.</span>
<span style="color: #666666; font-style: italic">*) 22 apr 2012 (!): Made interface more consistent, renaming a lot. Removed</span>
<span style="color: #666666; font-style: italic">    redundant C++ codec classes. Reduced amount of structs. Everything changed,</span>
<span style="color: #666666; font-style: italic">    but it is cleaner now imho and functionality remains the same. Also fixed</span>
<span style="color: #666666; font-style: italic">    several bugs and shrinked the implementation code. Made new samples.</span>
<span style="color: #666666; font-style: italic">*) 6 nov 2011 (!): By default, the encoder now automatically chooses the best</span>
<span style="color: #666666; font-style: italic">    PNG color model and bit depth, based on the amount and type of colors of the</span>
<span style="color: #666666; font-style: italic">    raw image. For this, autoLeaveOutAlphaChannel replaced by auto_choose_color.</span>
<span style="color: #666666; font-style: italic">*) 9 okt 2011: simpler hash chain implementation for the encoder.</span>
<span style="color: #666666; font-style: italic">*) 8 sep 2011: lz77 encoder lazy matching instead of greedy matching.</span>
<span style="color: #666666; font-style: italic">*) 23 aug 2011: tweaked the zlib compression parameters after benchmarking.</span>
<span style="color: #666666; font-style: italic">    A bug with the PNG filtertype heuristic was fixed, so that it chooses much</span>
<span style="color: #666666; font-style: italic">    better ones (it&#39;s quite significant). A setting to do an experimental, slow,</span>
<span style="color: #666666; font-style: italic">    brute force search for PNG filter types is added.</span>
<span style="color: #666666; font-style: italic">*) 17 aug 2011 (!): changed some C zlib related function names.</span>
<span style="color: #666666; font-style: italic">*) 16 aug 2011: made the code less wide (max 120 characters per line).</span>
<span style="color: #666666; font-style: italic">*) 17 apr 2011: code cleanup. Bugfixes. Convert low to 16-bit per sample colors.</span>
<span style="color: #666666; font-style: italic">*) 21 feb 2011: fixed compiling for C90. Fixed compiling with sections disabled.</span>
<span style="color: #666666; font-style: italic">*) 11 dec 2010: encoding is made faster, based on suggestion by Peter Eastman</span>
<span style="color: #666666; font-style: italic">    to optimize long sequences of zeros.</span>
<span style="color: #666666; font-style: italic">*) 13 nov 2010: added LodePNG_InfoColor_hasPaletteAlpha and</span>
<span style="color: #666666; font-style: italic">    LodePNG_InfoColor_canHaveAlpha functions for convenience.</span>
<span style="color: #666666; font-style: italic">*) 7 nov 2010: added LodePNG_error_text function to get error code description.</span>
<span style="color: #666666; font-style: italic">*) 30 okt 2010: made decoding slightly faster</span>
<span style="color: #666666; font-style: italic">*) 26 okt 2010: (!) changed some C function and struct names (more consistent).</span>
<span style="color: #666666; font-style: italic">     Reorganized the documentation and the declaration order in the header.</span>
<span style="color: #666666; font-style: italic">*) 08 aug 2010: only changed some comments and external samples.</span>
<span style="color: #666666; font-style: italic">*) 05 jul 2010: fixed bug thanks to warnings in the new gcc version.</span>
<span style="color: #666666; font-style: italic">*) 14 mar 2010: fixed bug where too much memory was allocated for char buffers.</span>
<span style="color: #666666; font-style: italic">*) 02 sep 2008: fixed bug where it could create empty tree that linux apps could</span>
<span style="color: #666666; font-style: italic">    read by ignoring the problem but windows apps couldn&#39;t.</span>
<span style="color: #666666; font-style: italic">*) 06 jun 2008: added more error checks for out of memory cases.</span>
<span style="color: #666666; font-style: italic">*) 26 apr 2008: added a few more checks here and there to ensure more safety.</span>
<span style="color: #666666; font-style: italic">*) 06 mar 2008: crash with encoding of strings fixed</span>
<span style="color: #666666; font-style: italic">*) 02 feb 2008: support for international text chunks added (iTXt)</span>
<span style="color: #666666; font-style: italic">*) 23 jan 2008: small cleanups, and #defines to divide code in sections</span>
<span style="color: #666666; font-style: italic">*) 20 jan 2008: support for unknown chunks allowing using LodePNG for an editor.</span>
<span style="color: #666666; font-style: italic">*) 18 jan 2008: support for tIME and pHYs chunks added to encoder and decoder.</span>
<span style="color: #666666; font-style: italic">*) 17 jan 2008: ability to encode and decode compressed zTXt chunks added</span>
<span style="color: #666666; font-style: italic">    Also vareous fixes, such as in the deflate and the padding bits code.</span>
<span style="color: #666666; font-style: italic">*) 13 jan 2008: Added ability to encode Adam7-interlaced images. Improved</span>
<span style="color: #666666; font-style: italic">    filtering code of encoder.</span>
<span style="color: #666666; font-style: italic">*) 07 jan 2008: (!) changed LodePNG to use ISO C90 instead of C++. A</span>
<span style="color: #666666; font-style: italic">    C++ wrapper around this provides an interface almost identical to before.</span>
<span style="color: #666666; font-style: italic">    Having LodePNG be pure ISO C90 makes it more portable. The C and C++ code</span>
<span style="color: #666666; font-style: italic">    are together in these files but it works both for C and C++ compilers.</span>
<span style="color: #666666; font-style: italic">*) 29 dec 2007: (!) changed most integer types to unsigned int + other tweaks</span>
<span style="color: #666666; font-style: italic">*) 30 aug 2007: bug fixed which makes this Borland C++ compatible</span>
<span style="color: #666666; font-style: italic">*) 09 aug 2007: some VS2005 warnings removed again</span>
<span style="color: #666666; font-style: italic">*) 21 jul 2007: deflate code placed in new namespace separate from zlib code</span>
<span style="color: #666666; font-style: italic">*) 08 jun 2007: fixed bug with 2- and 4-bit color, and small interlaced images</span>
<span style="color: #666666; font-style: italic">*) 04 jun 2007: improved support for Visual Studio 2005: crash with accessing</span>
<span style="color: #666666; font-style: italic">    invalid std::vector element [0] fixed, and level 3 and 4 warnings removed</span>
<span style="color: #666666; font-style: italic">*) 02 jun 2007: made the encoder add a tag with version by default</span>
<span style="color: #666666; font-style: italic">*) 27 may 2007: zlib and png code separated (but still in the same file),</span>
<span style="color: #666666; font-style: italic">    simple encoder/decoder functions added for more simple usage cases</span>
<span style="color: #666666; font-style: italic">*) 19 may 2007: minor fixes, some code cleaning, new error added (error 69),</span>
<span style="color: #666666; font-style: italic">    moved some examples from here to lodepng_examples.cpp</span>
<span style="color: #666666; font-style: italic">*) 12 may 2007: palette decoding bug fixed</span>
<span style="color: #666666; font-style: italic">*) 24 apr 2007: changed the license from BSD to the zlib license</span>
<span style="color: #666666; font-style: italic">*) 11 mar 2007: very simple addition: ability to encode bKGD chunks.</span>
<span style="color: #666666; font-style: italic">*) 04 mar 2007: (!) tEXt chunk related fixes, and support for encoding</span>
<span style="color: #666666; font-style: italic">    palettized PNG images. Plus little interface change with palette and texts.</span>
<span style="color: #666666; font-style: italic">*) 03 mar 2007: Made it encode dynamic Huffman shorter with repeat codes.</span>
<span style="color: #666666; font-style: italic">    Fixed a bug where the end code of a block had length 0 in the Huffman tree.</span>
<span style="color: #666666; font-style: italic">*) 26 feb 2007: Huffman compression with dynamic trees (BTYPE 2) now implemented</span>
<span style="color: #666666; font-style: italic">    and supported by the encoder, resulting in smaller PNGs at the output.</span>
<span style="color: #666666; font-style: italic">*) 27 jan 2007: Made the Adler-32 test faster so that a timewaste is gone.</span>
<span style="color: #666666; font-style: italic">*) 24 jan 2007: gave encoder an error interface. Added color conversion from any</span>
<span style="color: #666666; font-style: italic">    greyscale type to 8-bit greyscale with or without alpha.</span>
<span style="color: #666666; font-style: italic">*) 21 jan 2007: (!) Totally changed the interface. It allows more color types</span>
<span style="color: #666666; font-style: italic">    to convert to and is more uniform. See the manual for how it works now.</span>
<span style="color: #666666; font-style: italic">*) 07 jan 2007: Some cleanup &amp; fixes, and a few changes over the last days:</span>
<span style="color: #666666; font-style: italic">    encode/decode custom tEXt chunks, separate classes for zlib &amp; deflate, and</span>
<span style="color: #666666; font-style: italic">    at last made the decoder give errors for incorrect Adler32 or Crc.</span>
<span style="color: #666666; font-style: italic">*) 01 jan 2007: Fixed bug with encoding PNGs with less than 8 bits per channel.</span>
<span style="color: #666666; font-style: italic">*) 29 dec 2006: Added support for encoding images without alpha channel, and</span>
<span style="color: #666666; font-style: italic">    cleaned out code as well as making certain parts faster.</span>
<span style="color: #666666; font-style: italic">*) 28 dec 2006: Added &quot;Settings&quot; to the encoder.</span>
<span style="color: #666666; font-style: italic">*) 26 dec 2006: The encoder now does LZ77 encoding and produces much smaller files now.</span>
<span style="color: #666666; font-style: italic">    Removed some code duplication in the decoder. Fixed little bug in an example.</span>
<span style="color: #666666; font-style: italic">*) 09 dec 2006: (!) Placed output parameters of public functions as first parameter.</span>
<span style="color: #666666; font-style: italic">    Fixed a bug of the decoder with 16-bit per color.</span>
<span style="color: #666666; font-style: italic">*) 15 okt 2006: Changed documentation structure</span>
<span style="color: #666666; font-style: italic">*) 09 okt 2006: Encoder class added. It encodes a valid PNG image from the</span>
<span style="color: #666666; font-style: italic">    given image buffer, however for now it&#39;s not compressed.</span>
<span style="color: #666666; font-style: italic">*) 08 sep 2006: (!) Changed to interface with a Decoder class</span>
<span style="color: #666666; font-style: italic">*) 30 jul 2006: (!) LodePNG_InfoPng , width and height are now retrieved in different</span>
<span style="color: #666666; font-style: italic">    way. Renamed decodePNG to decodePNGGeneric.</span>
<span style="color: #666666; font-style: italic">*) 29 jul 2006: (!) Changed the interface: image info is now returned as a</span>
<span style="color: #666666; font-style: italic">    struct of type LodePNG::LodePNG_Info, instead of a vector, which was a bit clumsy.</span>
<span style="color: #666666; font-style: italic">*) 28 jul 2006: Cleaned the code and added new error checks.</span>
<span style="color: #666666; font-style: italic">    Corrected terminology &quot;deflate&quot; into &quot;inflate&quot;.</span>
<span style="color: #666666; font-style: italic">*) 23 jun 2006: Added SDL example in the documentation in the header, this</span>
<span style="color: #666666; font-style: italic">    example allows easy debugging by displaying the PNG and its transparency.</span>
<span style="color: #666666; font-style: italic">*) 22 jun 2006: (!) Changed way to obtain error value. Added</span>
<span style="color: #666666; font-style: italic">    loadFile function for convenience. Made decodePNG32 faster.</span>
<span style="color: #666666; font-style: italic">*) 21 jun 2006: (!) Changed type of info vector to unsigned.</span>
<span style="color: #666666; font-style: italic">    Changed position of palette in info vector. Fixed an important bug that</span>
<span style="color: #666666; font-style: italic">    happened on PNGs with an uncompressed block.</span>
<span style="color: #666666; font-style: italic">*) 16 jun 2006: Internally changed unsigned into unsigned where</span>
<span style="color: #666666; font-style: italic">    needed, and performed some optimizations.</span>
<span style="color: #666666; font-style: italic">*) 07 jun 2006: (!) Renamed functions to decodePNG and placed them</span>
<span style="color: #666666; font-style: italic">    in LodePNG namespace. Changed the order of the parameters. Rewrote the</span>
<span style="color: #666666; font-style: italic">    documentation in the header. Renamed files to lodepng.cpp and lodepng.h</span>
<span style="color: #666666; font-style: italic">*) 22 apr 2006: Optimized and improved some code</span>
<span style="color: #666666; font-style: italic">*) 07 sep 2005: (!) Changed to std::vector interface</span>
<span style="color: #666666; font-style: italic">*) 12 aug 2005: Initial release (C++, decoder only)</span>


<span style="color: #666666; font-style: italic">12. contact information</span>
<span style="color: #666666; font-style: italic">-----------------------</span>

<span style="color: #666666; font-style: italic">Feel free to contact me with suggestions, problems, comments, ... concerning</span>
<span style="color: #666666; font-style: italic">LodePNG. If you encounter a PNG image that doesn&#39;t work properly with this</span>
<span style="color: #666666; font-style: italic">decoder, feel free to send it and I&#39;ll use it to find and fix the problem.</span>

<span style="color: #666666; font-style: italic">My email address is (puzzle the account and domain together with an @ symbol):</span>
<span style="color: #666666; font-style: italic">Domain: gmail dot com.</span>
<span style="color: #666666; font-style: italic">Account: lode dot vandevenne.</span>


<span style="color: #666666; font-style: italic">Copyright (c) 2005-2014 Lode Vandevenne</span>
<span style="color: #666666; font-style: italic">*/</span>
</pre></div>
<p></p>
                            </section>
        
        
        
        
        
        
        
        
        
        
                            <!--Makefile-->
                            <section>
                                <hnew id="Makefile">Makefile</hnew><br>
					               <a href="#" class="buttonBackToTop">BACK TO TOP</a>
                                <!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><pre style="margin: 0; line-height: 125%"><span style="color: #003366">CC</span><span style="color: #333333">=</span>gcc
<span style="color: #003366">CFLAGS</span><span style="color: #333333">=</span>-g -lm -std<span style="color: #333333">=</span>c99 -Wall -Werror 

<span style="color: #55eedd; font-weight: bold">all</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">mp6 test</span>

<span style="color: #55eedd; font-weight: bold">mp6</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">main.o lodepng.o imageData.o functions.o</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> main.o lodepng.o imageData.o functions.o -o mp6 -lm

<span style="color: #55eedd; font-weight: bold">test</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">test.o lodepng.o imageData.o functions.o solution.o</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> test.o lodepng.o imageData.o functions.o solution.o -o <span style="color: #007722">test</span> -lm

<span style="color: #55eedd; font-weight: bold">main.o</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">main.c</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> -c main.c

<span style="color: #55eedd; font-weight: bold">lodepng.o</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">lodepng.c</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> -c lodepng.c

<span style="color: #55eedd; font-weight: bold">imageData.o</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">imageData.c</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> -c imageData.c

<span style="color: #55eedd; font-weight: bold">functions.o</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">functions.c</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> -c functions.c 

<span style="color: #55eedd; font-weight: bold">test.o</span><span style="color: #333333">:</span> <span style="color: #6600EE; font-weight: bold">test.c</span>
	<span style="color: #228899; font-weight: bold">$(</span>CC<span style="color: #228899; font-weight: bold">)</span> <span style="color: #228899; font-weight: bold">$(</span>CFLAGS<span style="color: #228899; font-weight: bold">)</span> -c test.c 

<span style="color: #55eedd; font-weight: bold">clean</span><span style="color: #333333">:</span>
	rm -f functions.o imageData.o lodepng.o main.o test.o mp6 <span style="color: #007722">test</span>
</pre></div>
<p></p>
                            </section>
                            
                            
                            
                _____________________________________________________________________________________________________________________________________________________________
        <br>
        <br>
        
        <!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/jquery.scrollgress.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/jquery.slidertron.min.js"></script>
			<script src="assets/js/skel.min.js"></script>
			<script src="assets/js/util.js"></script>
			<!--[if lte IE 8]><script src="assets/js/ie/respond.min.js"></script><![endif]-->
			<script src="assets/js/main.js"></script>
        
        <!--Back to top-->
        <section id="cta" class="wrapper style3">
				
				<ul class="actions">
					<li><a href="#" class="button big">Back to Top</a></li>
            </ul>
            
            
                <ul class="actions">
					<li><a href="index.html" class="button big">Main Menu</a></li>
				</ul>
			</section>  
        
        <footer id="footer">
				<ul class="icons">
					
					
					
					<li><a href="https://www.linkedin.com/in/lisa-gentil-33b45892/" class="icon fa-linkedin"><span class="label">LinkedIn</span></a></li>
					<li><a href="mailto:gentillisa5@gmail.com" class="icon fa-envelope"><span class="label">Envelope</span></a></li>
				</ul>
				
				<span>
				Lisa Gentil's Portfolio
				</span>
			</footer>
    </body>
</html>